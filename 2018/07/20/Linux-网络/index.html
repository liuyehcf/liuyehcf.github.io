<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="阅读更多">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-网络">
<meta property="og:url" content="http://example.com/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/index.html">
<meta property="og:site_name" content="Liuye Blog">
<meta property="og:description" content="阅读更多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/bridge.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/bond.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/team.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_principle.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_private.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_bridge.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_vepa.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_passthru.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/ipvlan_l2.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/ipvlan_l3.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/netfilter_hook.jpg">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/vm_nat.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/vm_bridge.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/vm_internel.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/vm_host_only.png">
<meta property="og:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/vm_nat_forwarding.png">
<meta property="article:published_time" content="2018-07-20T07:00:52.000Z">
<meta property="article:modified_time" content="2021-08-01T12:26:37.906Z">
<meta property="article:author" content="Liuyehcf">
<meta property="article:tag" content="摘录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Linux-%E7%BD%91%E7%BB%9C/bridge.png">

<link rel="canonical" href="http://example.com/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux-网络 | Liuye Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liuye Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-explore">

    <a href="/explore/" rel="section"><i class="fa fa-sitemap fa-fw"></i>发现</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Liuyehcf">
      <meta itemprop="description" content="大音希声，大象无形">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuye Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux-网络
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-20 15:00:52" itemprop="dateCreated datePublished" datetime="2018-07-20T15:00:52+08:00">2018-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-01 20:26:37" itemprop="dateModified" datetime="2021-08-01T20:26:37+08:00">2021-08-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Operating-System/" itemprop="url" rel="index"><span itemprop="name">Operating System</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Operating-System/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
            <span id="/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/" class="post-meta-item leancloud_visitors" data-flag-title="Linux-网络" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/07/20/Linux-%E7%BD%91%E7%BB%9C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>阅读更多</strong></p>
<a id="more"></a>
<h1 id="1-系统网络参数"><a class="markdownIt-Anchor" href="#1-系统网络参数"></a> 1 系统网络参数</h1>
<p>网络配置参数与内核配置文件的对应关系，例如<code>net.ipv4.ip_forward</code>对应的内核配置文件为<code>/proc/sys/net/ipv4/ip_forward</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">配置项</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>net.ipv4.tcp_syncookies</code></td>
<td style="text-align:left"><code>1</code>表示开启<code>SYN Cookies</code>。当出现SYN等待队列溢出时，启用<code>Cookies</code>来处理，可防范少量SYN攻击，默认为0，表示关闭</td>
</tr>
<tr>
<td style="text-align:left"><code>net.ipv4.tcp_tw_reuse</code></td>
<td style="text-align:left"><code>1</code>表示开启重用。允许将<code>TIME-WAIT</code>状态的<code>sockets</code>重新用于新的TCP连接，默认为0，表示关闭</td>
</tr>
<tr>
<td style="text-align:left"><code>net.ipv4.tcp_tw_recycle</code></td>
<td style="text-align:left"><code>1</code>表示开启TCP连接中<code>TIME-WAIT</code>状态的<code>sockets</code>的快速回收，默认为0，表示关闭</td>
</tr>
<tr>
<td style="text-align:left"><code>net.ipv4.conf.&lt;net_device&gt;.proxy_arp</code></td>
<td style="text-align:left"><code>1</code>表示当ARP请求目标跨网段时，网卡设备收到此ARP请求会用自己的MAC地址返回给请求者</td>
</tr>
<tr>
<td style="text-align:left"><code>net.ipv4.conf.all.rp_filter</code></td>
<td style="text-align:left"><code>1</code>表示过滤反向路由不通的包，比如进来的数据报是<code>srcIp-&gt;dstIp</code>，会校验<code>dstIp-&gt;srcIp</code>的路由是否会经过同一个网卡。换言之，<code>1</code>不允许正反链路不一致，<code>0</code>允许正反链路不一致</td>
</tr>
<tr>
<td style="text-align:left"><code>net.ipv4.ip_local_port_range</code></td>
<td style="text-align:left">可用的临时端口号的范围</td>
</tr>
<tr>
<td style="text-align:left"><code>fs.file-max</code></td>
<td style="text-align:left">整个操作系统最多可打开的文件描述符的数量，一个tcp连接会占用一个文件描述符，因此系统能够打开多少个tcp连接也受到该参数的影响</td>
</tr>
<tr>
<td style="text-align:left"><code>fs.nr_open</code></td>
<td style="text-align:left">单个进程最多可打开的文件描述符的数量，一个tcp连接会占用一个文件描述符，因此进程能够打开多少个tcp连接也受到该参数的影响</td>
</tr>
</tbody>
</table>
<h1 id="2-virtual-networking"><a class="markdownIt-Anchor" href="#2-virtual-networking"></a> 2 Virtual Networking</h1>
<h2 id="21-bridge"><a class="markdownIt-Anchor" href="#21-bridge"></a> 2.1 bridge</h2>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/bridge.png" alt="bridge" /></p>
<p>Linux虚拟网桥类似于一个交换机，它在与其连接的接口之间转发数据包。通常用于在路由器、网关、VM以及网络命名空间之间转发数据包</p>
<p>编写一个脚本，内容如下，这里我取名为<code>bridge.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/bridge.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> namespace=liuye</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ifname_outside_ns=veth1</span><br><span class="line"><span class="built_in">export</span> ifname_inside_ns=veth2</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ip_bridge=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_inside_ns=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ip_net=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> bridge_name=demobridge</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link add <span class="variable">$&#123;bridge_name&#125;</span> <span class="built_in">type</span> bridge</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;bridge_name&#125;</span> up</span><br><span class="line"></span><br><span class="line">	ip addr add <span class="variable">$&#123;ip_bridge&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> broadcast <span class="variable">$&#123;ip_broadcast&#125;</span> dev <span class="variable">$&#123;bridge_name&#125;</span></span><br><span class="line">    </span><br><span class="line">	ip netns add <span class="variable">$&#123;namespace&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link add <span class="variable">$&#123;ifname_outside_ns&#125;</span> <span class="built_in">type</span> veth peer name <span class="variable">$&#123;ifname_inside_ns&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_outside_ns&#125;</span> up</span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_outside_ns&#125;</span> master <span class="variable">$&#123;bridge_name&#125;</span></span><br><span class="line">	</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_inside_ns&#125;</span> netns <span class="variable">$&#123;namespace&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace&#125;</span> ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_inside_ns&#125;</span> up</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace&#125;</span> ip addr add <span class="variable">$&#123;ip_inside_ns&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> broadcast <span class="variable">$&#123;ip_broadcast&#125;</span> dev <span class="variable">$&#123;ifname_inside_ns&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace&#125;</span> ip link <span class="built_in">set</span> lo up</span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace&#125;</span> ip route add default via <span class="variable">$&#123;ip_bridge&#125;</span> dev <span class="variable">$&#123;ifname_inside_ns&#125;</span></span><br><span class="line"></span><br><span class="line">	iptables -t nat -A POSTROUTING -s <span class="variable">$&#123;ip_net&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> -o <span class="variable">$&#123;ifname_external&#125;</span> -j MASQUERADE</span><br><span class="line"></span><br><span class="line">	iptables -t filter -A FORWARD -i <span class="variable">$&#123;ifname_external&#125;</span> -o <span class="variable">$&#123;bridge_name&#125;</span> -j ACCEPT</span><br><span class="line">	iptables -t filter -A FORWARD -i <span class="variable">$&#123;bridge_name&#125;</span> -o <span class="variable">$&#123;ifname_external&#125;</span> -j ACCEPT</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">	mkdir -p /etc/netns/<span class="variable">$&#123;namespace&#125;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/netns/<span class="variable">$&#123;namespace&#125;</span>/resolv.conf</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	iptables -t filter -D FORWARD -i <span class="variable">$&#123;ifname_external&#125;</span> -o <span class="variable">$&#123;bridge_name&#125;</span> -j ACCEPT</span><br><span class="line">	iptables -t filter -D FORWARD -i <span class="variable">$&#123;bridge_name&#125;</span> -o <span class="variable">$&#123;ifname_external&#125;</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line">	iptables -t nat -D POSTROUTING -s <span class="variable">$&#123;ip_net&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> -o <span class="variable">$&#123;ifname_external&#125;</span> -j MASQUERADE</span><br><span class="line"></span><br><span class="line">	ip link delete <span class="variable">$&#123;ifname_outside_ns&#125;</span></span><br><span class="line">	</span><br><span class="line">	ip netns delete <span class="variable">$&#123;namespace&#125;</span></span><br><span class="line">	rm -rf /etc/netns/<span class="variable">$&#123;namespace&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;bridge_name&#125;</span> down</span><br><span class="line"></span><br><span class="line">	brctl delbr <span class="variable">$&#123;bridge_name&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -f setup</span><br><span class="line"><span class="built_in">export</span> -f cleanup</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>下面进行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> bridge.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ip_bridge=192.168.45.2 <span class="comment"># 网桥的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_inside_ns=192.168.45.3 <span class="comment"># 位于网络命名空间内的veth接口的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_net=192.168.45.0 <span class="comment"># 网桥以及veth接口的网络</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=255.255.255.0 <span class="comment"># 子网掩码</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=192.168.45.255 <span class="comment"># 广播ip</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add demobridge <span class="built_in">type</span> bridge</span><br><span class="line">+ ip link <span class="built_in">set</span> demobridge up</span><br><span class="line">+ ip addr add 192.168.45.2/255.255.255.0 broadcast 192.168.45.255 dev demobridge</span><br><span class="line">+ ip netns add liuye</span><br><span class="line">+ ip link add veth1 <span class="built_in">type</span> veth peer name veth2</span><br><span class="line">+ ip link <span class="built_in">set</span> veth1 up</span><br><span class="line">+ ip link <span class="built_in">set</span> veth1 master demobridge</span><br><span class="line">+ ip link <span class="built_in">set</span> veth2 netns liuye</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye ip link <span class="built_in">set</span> veth2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye ip addr add 192.168.45.3/255.255.255.0 broadcast 192.168.45.255 dev veth2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye ip link <span class="built_in">set</span> lo up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye ip route add default via 192.168.45.2 dev veth2</span><br><span class="line">+ iptables -t nat -A POSTROUTING -s 192.168.45.0/255.255.255.0 -o enp0s3 -j MASQUERADE</span><br><span class="line">+ iptables -t filter -A FORWARD -i enp0s3 -o demobridge -j ACCEPT</span><br><span class="line">+ iptables -t filter -A FORWARD -i demobridge -o enp0s3 -j ACCEPT</span><br><span class="line">+ <span class="built_in">echo</span> 1</span><br><span class="line">+ mkdir -p /etc/netns/liuye</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span></span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试网络连通性（如果不通的话，可能是被防火墙拦截了）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace&#125;</span> ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.173) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.173 (47.88.251.173): icmp_seq=1 ttl=32 time=74.8 ms</span><br><span class="line">64 bytes from 47.88.251.173 (47.88.251.173): icmp_seq=2 ttl=32 time=73.1 ms</span><br><span class="line">64 bytes from 47.88.251.173 (47.88.251.173): icmp_seq=3 ttl=32 time=74.3 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2025ms</span><br><span class="line">rtt min/avg/max/mdev = 73.192/74.111/74.808/0.747 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ iptables -t filter -D FORWARD -i enp0s3 -o demobridge -j ACCEPT</span><br><span class="line">+ iptables -t filter -D FORWARD -i demobridge -o enp0s3 -j ACCEPT</span><br><span class="line">+ iptables -t nat -D POSTROUTING -s 192.168.45.0/255.255.255.0 -o enp0s3 -j MASQUERADE</span><br><span class="line">+ ip link delete veth1</span><br><span class="line">+ ip netns delete liuye</span><br><span class="line">+ rm -i -rf /etc/netns/liuye</span><br><span class="line">+ ip link <span class="built_in">set</span> demobridge down</span><br><span class="line">+ brctl delbr demobridge</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h2 id="22-bonded-interface"><a class="markdownIt-Anchor" href="#22-bonded-interface"></a> 2.2 bonded interface</h2>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/bond.png" alt="bond" /></p>
<p><code>bond</code>可以将多张网卡组织成一张逻辑网卡，存在多种组织方式（<code>mode</code>），包括</p>
<ol>
<li><code>balance-rr</code>：轮询（<code>round-robin</code>）</li>
<li><code>active-backup</code>：热备</li>
<li><code>balance-xor</code></li>
<li><code>broadcast</code>：广播，每张slave都会收到消息</li>
<li><code>802.3ad</code></li>
<li><code>balance-tlb</code></li>
<li><code>balance-alb</code></li>
</ol>
<p>下面开始验证，我的测试环境如下：</p>
<ul>
<li>使用kvm虚拟机，安装的镜像为<code>CentOS-7-x86_64-Minimal-1908.iso</code></li>
<li>宿主机上有1个网桥：<code>br0</code>
<ul>
<li><code>br0</code>：ip为<code>10.0.2.1/24</code>，并添加了SNAT配置<code>iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eno1 -j MASQUERADE</code>（<code>eno1</code>为宿主机的外网网卡）</li>
</ul>
</li>
<li>kvm虚拟机包含2个网卡，<code>eth0</code>和<code>ens9</code>，分别接到宿主机上的<code>br0</code></li>
</ul>
<p>编写一个脚本，内容如下，这里我取名为<code>bond.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/bond.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ifname_physics_1=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ifname_physics_2=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> bond_name=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> bond_mode=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_bond=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_gateway=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_net=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link add <span class="variable">$&#123;bond_name&#125;</span> <span class="built_in">type</span> bond miimon 100 updelay 100 downdelay 100 mode <span class="variable">$&#123;bond_mode&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> master <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> master <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;bond_name&#125;</span> up</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> up</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> up</span><br><span class="line"></span><br><span class="line">	ip addr add <span class="variable">$&#123;ip_bond&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> broadcast <span class="variable">$&#123;ip_broadcast&#125;</span> dev <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"></span><br><span class="line">	ip route add default via <span class="variable">$&#123;ip_gateway&#125;</span> dev <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;bond_name&#125;</span> down</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> down</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> down</span><br><span class="line"></span><br><span class="line">	ip link del <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -f setup</span><br><span class="line"><span class="built_in">export</span> -f cleanup</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>开始验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> bond.sh</span><br><span class="line"><span class="built_in">export</span> ifname_physics_1=<span class="string">&quot;eth0&quot;</span> <span class="comment"># 待绑定的子网卡名称1</span></span><br><span class="line"><span class="built_in">export</span> ifname_physics_2=<span class="string">&quot;ens9&quot;</span> <span class="comment"># 待绑定的子网卡名称2</span></span><br><span class="line"><span class="built_in">export</span> bond_name=<span class="string">&quot;bond_liuye&quot;</span> <span class="comment"># bond名称</span></span><br><span class="line"><span class="built_in">export</span> bond_mode=<span class="string">&quot;active-backup&quot;</span> <span class="comment"># bond模式，可以通过`ip link help bond`查询所有的mode</span></span><br><span class="line"><span class="built_in">export</span> ip_bond=<span class="string">&quot;10.0.2.66&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_gateway=<span class="string">&quot;10.0.2.1&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_net=<span class="string">&quot;10.0.2.0&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=<span class="string">&quot;10.0.2.255&quot;</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add bond_liuye <span class="built_in">type</span> bond miimon 100 updelay 100 downdelay 100 mode active-backup</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 master bond_liuye</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 master bond_liuye</span><br><span class="line">+ ip link <span class="built_in">set</span> bond_liuye up</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 up</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 up</span><br><span class="line">+ ip addr add 10.0.2.66/255.255.255.0 broadcast 10.0.2.255 dev bond_liuye</span><br><span class="line">+ ip route add default via 10.0.2.1 dev bond_liuye</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span></span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连通性</span></span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.168) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.168 (47.88.251.168): icmp_seq=1 ttl=31 time=70.6 ms</span><br><span class="line">64 bytes from 47.88.251.168 (47.88.251.168): icmp_seq=2 ttl=31 time=70.3 ms</span><br><span class="line">64 bytes from 47.88.251.168 (47.88.251.168): icmp_seq=3 ttl=31 time=70.5 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 70.335/70.511/70.679/0.258 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将网卡1关掉，查看连通性</span></span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> down</span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.175) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.175 (47.88.251.175): icmp_seq=1 ttl=31 time=81.5 ms</span><br><span class="line">64 bytes from 47.88.251.175 (47.88.251.175): icmp_seq=2 ttl=31 time=81.4 ms</span><br><span class="line">64 bytes from 47.88.251.175 (47.88.251.175): icmp_seq=3 ttl=31 time=81.4 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2003ms</span><br><span class="line">rtt min/avg/max/mdev = 81.432/81.487/81.555/0.238 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看此时生效的网卡</span></span><br><span class="line">ip -d link show dev <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">12: bond_liuye: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:1e:f1:21 brd ff:ff:ff:ff:ff:ff promiscuity 0</span><br><span class="line">    bond mode active-backup active_slave ens9 miimon 100 updelay 100 downdelay 100 use_carrier 1 arp_interval 0 arp_validate none arp_all_targets any primary_reselect always fail_over_mac none xmit_hash_policy layer2 resend_igmp 1 num_grat_arp 1 all_slaves_active 0 min_links 0 lp_interval 1 packets_per_slave 1 lacp_rate slow ad_select stable tlb_dynamic_lb 1 addrgenmode eui64 numtxqueues 16 numrxqueues 16 gso_max_size 65536 gso_max_segs 65535</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"><span class="comment"># 可以看到，此时生效的网卡是ens9（bond mode active-backup active_slave ens9）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开网卡1，关掉网卡2，再看连通性</span></span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> up</span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> down</span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.198.24) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.198.24 (47.88.198.24): icmp_seq=1 ttl=31 time=80.6 ms</span><br><span class="line">64 bytes from 47.88.198.24 (47.88.198.24): icmp_seq=2 ttl=31 time=80.9 ms</span><br><span class="line">64 bytes from 47.88.198.24 (47.88.198.24): icmp_seq=3 ttl=31 time=80.5 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 80.579/80.725/80.995/0.191 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看此时生效的网卡</span></span><br><span class="line">ip -d link show dev <span class="variable">$&#123;bond_name&#125;</span></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">12: bond_liuye: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:1e:f1:21 brd ff:ff:ff:ff:ff:ff promiscuity 0</span><br><span class="line">    bond mode active-backup active_slave eth0 miimon 100 updelay 100 downdelay 100 use_carrier 1 arp_interval 0 arp_validate none arp_all_targets any primary_reselect always fail_over_mac none xmit_hash_policy layer2 resend_igmp 1 num_grat_arp 1 all_slaves_active 0 min_links 0 lp_interval 1 packets_per_slave 1 lacp_rate slow ad_select stable tlb_dynamic_lb 1 addrgenmode eui64 numtxqueues 16 numrxqueues 16 gso_max_size 65536 gso_max_segs 65535</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"><span class="comment"># 可以看到，此时生效的网卡是eth0（bond mode active-backup active_slave eth0）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link <span class="built_in">set</span> bond_liuye down</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 down</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 down</span><br><span class="line">+ ip link del bond_liuye</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h2 id="23-team-device"><a class="markdownIt-Anchor" href="#23-team-device"></a> 2.3 team device</h2>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/team.png" alt="team" /></p>
<p>与<code>bond</code>类似，<code>team</code>也提供了将两个网络接口组合成一个逻辑网络接口的方法，它工作在二层。<code>bond</code>与<code>team</code>之间的差异可以参考<a target="_blank" rel="noopener" href="https://github.com/jpirko/libteam/wiki/Bonding-vs.-Team-features">Bonding vs. Team features</a></p>
<p>下面开始验证，我的测试环境如下：</p>
<ul>
<li>使用kvm虚拟机，安装的镜像为<code>CentOS-7-x86_64-Minimal-1908.iso</code></li>
<li>宿主机上有1个网桥：<code>br0</code>
<ul>
<li><code>br0</code>：ip为<code>10.0.2.1/24</code>，并添加了SNAT配置<code>iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eno1 -j MASQUERADE</code>（<code>eno1</code>为宿主机的外网网卡）</li>
</ul>
</li>
<li>kvm虚拟机包含2个网卡，<code>eth0</code>和<code>ens9</code>，分别接到宿主机上的<code>br0</code></li>
</ul>
<p>编写一个脚本，内容如下，这里我取名为<code>team.sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/team.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ifname_physics_1=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ifname_physics_2=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> team_name=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_team=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_gateway=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_net=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	teamd -o -n -U -d -t <span class="variable">$&#123;team_name&#125;</span> -c <span class="string">&#x27;&#123;&quot;runner&quot;: &#123;&quot;name&quot;: &quot;activebackup&quot;&#125;,&quot;link_watch&quot;: &#123;&quot;name&quot;: &quot;ethtool&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> master <span class="variable">$&#123;team_name&#125;</span></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> master <span class="variable">$&#123;team_name&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;team_name&#125;</span> up</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> up</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> up</span><br><span class="line"></span><br><span class="line">	ip addr add <span class="variable">$&#123;ip_team&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> broadcast <span class="variable">$&#123;ip_broadcast&#125;</span> dev <span class="variable">$&#123;team_name&#125;</span></span><br><span class="line"></span><br><span class="line">	ip route add default via <span class="variable">$&#123;ip_gateway&#125;</span> dev <span class="variable">$&#123;team_name&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>()&#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;team_name&#125;</span> down</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> down</span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> down</span><br><span class="line"></span><br><span class="line">	ip link del <span class="variable">$&#123;team_name&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -f setup</span><br><span class="line"><span class="built_in">export</span> -f cleanup</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>开始验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> team.sh</span><br><span class="line"><span class="built_in">export</span> ifname_physics_1=<span class="string">&quot;eth0&quot;</span> <span class="comment"># 待绑定的子网卡名称1</span></span><br><span class="line"><span class="built_in">export</span> ifname_physics_2=<span class="string">&quot;ens9&quot;</span> <span class="comment"># 待绑定的子网卡名称2</span></span><br><span class="line"><span class="built_in">export</span> team_name=<span class="string">&quot;team_liuye&quot;</span> <span class="comment"># team名称</span></span><br><span class="line"><span class="built_in">export</span> ip_team=<span class="string">&quot;10.0.2.66&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_gateway=<span class="string">&quot;10.0.2.1&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_net=<span class="string">&quot;10.0.2.0&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_broadcast=<span class="string">&quot;10.0.2.255&quot;</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ teamd -o -n -U -d -t team_liuye -c <span class="string">&#x27;&#123;&quot;runner&quot;: &#123;&quot;name&quot;: &quot;activebackup&quot;&#125;,&quot;link_watch&quot;: &#123;&quot;name&quot;: &quot;ethtool&quot;&#125;&#125;&#x27;</span></span><br><span class="line">This program is not intended to be run as root.</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 master team_liuye</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 master team_liuye</span><br><span class="line">+ ip link <span class="built_in">set</span> team_liuye up</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 up</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 up</span><br><span class="line">+ ip addr add 10.0.2.66/255.255.255.0 broadcast 10.0.2.255 dev team_liuye</span><br><span class="line">+ ip route add default via 10.0.2.1 dev team_liuye</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">&#x27;nameserver 8.8.8.8&#x27;</span></span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连通性</span></span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.174) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.174 (47.88.251.174): icmp_seq=1 ttl=30 time=69.2 ms</span><br><span class="line">64 bytes from 47.88.251.174 (47.88.251.174): icmp_seq=2 ttl=30 time=68.8 ms</span><br><span class="line">64 bytes from 47.88.251.174 (47.88.251.174): icmp_seq=3 ttl=30 time=68.6 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 68.633/68.912/69.219/0.386 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将网卡1关掉，查看连通性</span></span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> down</span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.176) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.176 (47.88.251.176): icmp_seq=1 ttl=31 time=70.3 ms</span><br><span class="line">64 bytes from 47.88.251.176 (47.88.251.176): icmp_seq=2 ttl=31 time=70.2 ms</span><br><span class="line">64 bytes from 47.88.251.176 (47.88.251.176): icmp_seq=3 ttl=31 time=70.2 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 70.205/70.266/70.313/0.045 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开网卡1，关掉网卡2，再看连通性</span></span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_1&#125;</span> up</span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_physics_2&#125;</span> down</span><br><span class="line">ping -c 3 www.aliyun.com</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING xjp-adns.aliyun.com.gds.alibabadns.com (47.88.251.171) 56(84) bytes of data.</span><br><span class="line">64 bytes from 47.88.251.171 (47.88.251.171): icmp_seq=1 ttl=30 time=82.7 ms</span><br><span class="line">64 bytes from 47.88.251.171 (47.88.251.171): icmp_seq=2 ttl=30 time=218 ms</span><br><span class="line">64 bytes from 47.88.251.171 (47.88.251.171): icmp_seq=3 ttl=30 time=340 ms</span><br><span class="line"></span><br><span class="line">--- xjp-adns.aliyun.com.gds.alibabadns.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2000ms</span><br><span class="line">rtt min/avg/max/mdev = 82.756/213.799/340.219/105.160 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link <span class="built_in">set</span> team_liuye down</span><br><span class="line">+ ip link <span class="built_in">set</span> eth0 down</span><br><span class="line">+ ip link <span class="built_in">set</span> ens9 down</span><br><span class="line">+ ip link del team_liuye</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h2 id="24-vlanvirtual-lan"><a class="markdownIt-Anchor" href="#24-vlanvirtual-lan"></a> 2.4 vlan（virtual lan）</h2>
<h2 id="25-vxlanvirtual-extensible-lan"><a class="markdownIt-Anchor" href="#25-vxlanvirtual-extensible-lan"></a> 2.5 vxlan（virtual extensible lan）</h2>
<h2 id="26-macvlan"><a class="markdownIt-Anchor" href="#26-macvlan"></a> 2.6 macvlan</h2>
<p>在<code>macvlan</code>出现之前，我们只能为一块以太网卡添加多个<code>IP</code>地址，却不能添加多个<code>MAC</code>地址，因为<code>MAC</code>地址正是通过其全球唯一性来标识一块以太网卡的，即便你使用了创建<code>ethx:y</code>这样的方式，你会发现所有这些“网卡”的<code>MAC</code>地址和<code>ethx</code>都是一样的，本质上，它们还是一块网卡，这将限制你做很多二层的操作。有了<code>macvlan</code>技术，你可以这么做了</p>
<p><code>macvlan</code>允许你在主机的一个网络接口上配置多个虚拟的网络接口，这些网络interface有自己独立的<code>MAC</code>地址，也可以配置上<code>IP</code>地址进行通信。<code>macvlan</code>下的虚拟机或者容器网络和主机在同一个网段中，共享同一个广播域。<code>macvlan</code>和<code>Bridge</code>比较相似，但因为它省去了<code>Bridge</code>的存在，所以配置和调试起来比较简单，而且效率也相对高。除此之外<code>macvlan</code>自身也完美支持<code>VLAN</code></p>
<p>同一<code>VLAN</code>间数据传输是通过二层互访，即<code>MAC</code>地址实现的，不需要使用路由。不同<code>VLAN</code>的用户单播默认不能直接通信，如果想要通信，还需要三层设备做路由，<code>macvlan</code>也是如此。用<code>macvlan</code>技术虚拟出来的虚拟网卡，在逻辑上和物理网卡是对等的。物理网卡也就相当于一个交换机，记录着对应的虚拟网卡和<code>MAC</code>地址，当物理网卡收到数据包后，会根据目的 MAC 地址判断这个包属于哪一个虚拟网卡。<strong>这也就意味着，只要是从<code>macvlan</code>子接口发来的数据包（或者是发往<code>macvlan</code>子接口的数据包），物理网卡只接收数据包，不处理数据包，所以这就引出了一个问题：本机 macvlan 网卡上面的 IP 无法和物理网卡上面的 IP 通信！</strong></p>
<p><strong>macvlan的技术实现：</strong></p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_principle.jpg" alt="macvlan_principle" /></p>
<p><strong><code>macvlan</code>有以下特点：</strong></p>
<ul>
<li>可让使用者在同一张实体网卡上设定多个<code>MAC</code>地址
<ul>
<li>带有上述设定的<code>MAC</code>地址的网卡称为子接口（<code>sub interface</code>）</li>
<li>实体网卡则称为父接口（<code>parent interface</code>）</li>
</ul>
</li>
<li><code>parent interface</code>可以是一个物理接口（eth0），可以是一个<code>802.1q</code>的子接口（<code>eth0.10</code>），也可以是<code>bonding</code>接口</li>
<li>可在<code>parent/sub interface</code>上设定的不只是<code>MAC</code>地址，<code>IP</code>地址同样也可以被设定</li>
<li><code>sub interface</code>无法直接与<code>parent interface</code>通讯 (带有<code>sub interface</code>的<code>VM</code>或容器无法与<code>host</code>直接通讯)
<ul>
<li>若<code>VM</code>或容器需要与<code>host</code>通讯，那就必须额外建立一个<code>sub interface</code>给<code>host</code>用</li>
</ul>
</li>
<li><code>sub interface</code>通常以<code>mac0@eth0</code>的形式来命名以方便区別</li>
</ul>
<p><strong>准备一个脚本，用于验证各个模式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/macvlan.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> macvlan_mode=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> namespace1=liuye1</span><br><span class="line"><span class="built_in">export</span> namespace2=liuye2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ifname_macvlan1=macvlan1</span><br><span class="line"><span class="built_in">export</span> ifname_macvlan2=macvlan2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan1=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan2=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setup</span></span>() &#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link add <span class="variable">$&#123;ifname_macvlan1&#125;</span> link <span class="variable">$&#123;ifname_external&#125;</span> <span class="built_in">type</span> macvlan mode <span class="variable">$&#123;macvlan_mode&#125;</span></span><br><span class="line">	ip link add <span class="variable">$&#123;ifname_macvlan2&#125;</span> link <span class="variable">$&#123;ifname_external&#125;</span> <span class="built_in">type</span> macvlan mode <span class="variable">$&#123;macvlan_mode&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns add <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip netns add <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_macvlan1&#125;</span> netns <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_macvlan2&#125;</span> netns <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_macvlan1&#125;</span> up</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip addr add <span class="variable">$&#123;ip_macvlan1&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> dev <span class="variable">$&#123;ifname_macvlan1&#125;</span></span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;default_gateway&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip route add default dev <span class="variable">$&#123;ifname_macvlan1&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip route add default via <span class="variable">$&#123;default_gateway&#125;</span> dev <span class="variable">$&#123;ifname_macvlan1&#125;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_macvlan2&#125;</span> up</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip addr add <span class="variable">$&#123;ip_macvlan2&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> dev <span class="variable">$&#123;ifname_macvlan2&#125;</span></span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;default_gateway&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip route add default dev <span class="variable">$&#123;ifname_macvlan2&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip route add default via <span class="variable">$&#123;default_gateway&#125;</span> dev <span class="variable">$&#123;ifname_macvlan2&#125;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip link delete <span class="variable">$&#123;ifname_macvlan1&#125;</span></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip link delete <span class="variable">$&#123;ifname_macvlan2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns delete <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip netns delete <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -f setup</span><br><span class="line"><span class="built_in">export</span> -f cleanup</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="261-private-mode"><a class="markdownIt-Anchor" href="#261-private-mode"></a> 2.6.1 private mode</h3>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_private.jpg" alt="macvlan_private" /></p>
<p>此种模式相当于<code>vepa</code>模式的增强模式，其完全阻止共享同一父接口的<code>macvlan</code>虚拟网卡之间的通讯，即使配置了<code>Hairpin</code>让从父接口发出的流量返回到宿主机，相应的通讯流量依然被丢弃。<strong>具体实现方式是丢弃广播/多播数据，这就意味着以太网地址解析<code>arp</code>将不可运行，除非手工探测<code>MAC</code>地址，否则通信将无法在同一宿主机下的多个<code>macvlan</code>网卡间展开</strong>。之所以隔离广播流量，是因为以太网是基于广播的，隔离了广播，以太网将失去了依托</p>
<h3 id="262-bridge-mode"><a class="markdownIt-Anchor" href="#262-bridge-mode"></a> 2.6.2 bridge mode</h3>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_bridge.jpg" alt="macvlan_bridge" /></p>
<p><strong>验证1：macvlan接口与宿主机同一个网段</strong></p>
<ol>
<li>macvlan接口之间是否连通</li>
<li>macvlan接口和主机是否连通</li>
<li>macvlan接口是否能通外网</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> macvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> macvlan_mode=<span class="string">&quot;bridge&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;10.0.2.2&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan1=<span class="string">&quot;10.0.2.16&quot;</span> <span class="comment"># macvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan2=<span class="string">&quot;10.0.2.17&quot;</span> <span class="comment"># macvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># macvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add macvlan1 link enp0s3 <span class="built_in">type</span> macvlan mode bridge</span><br><span class="line">+ ip link add macvlan2 link enp0s3 <span class="built_in">type</span> macvlan mode bridge</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> macvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 10.0.2.16/255.255.255.0 dev macvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default via 10.0.2.2 dev macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> macvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 10.0.2.17/255.255.255.0 dev macvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default via 10.0.2.2 dev macvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping macvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_macvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.17 (10.0.2.17) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=1 ttl=64 time=0.104 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=2 ttl=64 time=0.071 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=3 ttl=64 time=0.105 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.17 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2017ms</span><br><span class="line">rtt min/avg/max/mdev = 0.071/0.093/0.105/0.017 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan2所在的网络命名空间中ping macvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_macvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.16 (10.0.2.16) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=1 ttl=64 time=0.047 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=2 ttl=64 time=0.069 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=3 ttl=64 time=0.174 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.16 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2053ms</span><br><span class="line">rtt min/avg/max/mdev = 0.047/0.096/0.174/0.056 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping 主机的ip（同一个网段）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_host&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.15 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2052ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping 外网ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping 223.5.5.5 -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=1 ttl=117 time=17.9 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=2 ttl=117 time=1.77 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=3 ttl=117 time=1.52 ms</span><br><span class="line"></span><br><span class="line">--- 223.5.5.5 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 1.527/7.075/17.927/7.674 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete macvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论1：两个macvlan子接口可以相互ping通，但是ping不通master接口。在ip正确配置的情况下，能够正常通外网</strong></p>
<ul>
<li>我的实验环境是<code>VirtualBox</code>虚拟机，第一次setup之后，<code>ping 223.5.5.5</code>是可以通的，但是当执行<code>cleanup</code>后再次执行<code>setup</code>，此时发现<code>ping 223.5.5.5</code>是无法ping通的，估计是因为VirtualBox对mac地址是有缓存的，先后两次创建的<code>macvlan</code>的mac地址不同，但是ip是相同的，转发逻辑就出问题了。这时，只需要修改macvlan的ip地址，就能再次ping通<code>223.5.5.5</code>了</li>
</ul>
<p><strong>验证2：macvlan接口与宿主机不同网段</strong></p>
<ol>
<li>macvlan接口之间是否连通</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> macvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> macvlan_mode=<span class="string">&quot;bridge&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan1=<span class="string">&quot;192.168.100.1&quot;</span> <span class="comment"># macvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan2=<span class="string">&quot;192.168.200.1&quot;</span> <span class="comment"># macvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># macvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add macvlan1 link enp0s3 <span class="built_in">type</span> macvlan mode bridge</span><br><span class="line">+ ip link add macvlan2 link enp0s3 <span class="built_in">type</span> macvlan mode bridge</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> macvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 192.168.100.1/255.255.255.0 dev macvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default dev macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> macvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 192.168.200.1/255.255.255.0 dev macvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default dev macvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping macvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_macvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.200.1 (192.168.200.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=1 ttl=64 time=0.243 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=2 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=3 ttl=64 time=0.045 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.200.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2056ms</span><br><span class="line">rtt min/avg/max/mdev = 0.041/0.109/0.243/0.095 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan2所在的网络命名空间中ping macvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_macvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=1 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=2 ttl=64 time=0.126 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=3 ttl=64 time=0.052 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.100.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2280ms</span><br><span class="line">rtt min/avg/max/mdev = 0.042/0.073/0.126/0.038 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete macvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论2：两个macvlan接口，即便配置不同网段的ip，也能相互ping通</strong></p>
<h3 id="263-vepa-mode"><a class="markdownIt-Anchor" href="#263-vepa-mode"></a> 2.6.3 vepa mode</h3>
<p>在<code>vepa</code>模式下，所有从<code>macvlan</code>接口发出的流量，不管目的地全部都发送给父接口，即使流量的目的地是共享同一个父接口的其它<code>macvlan</code>接口。在二层网络场景下，由于生成树协议的原因，两个<code>macvlan</code>接口之间的通讯会被阻塞，这时需要上层路由器上为其添加路由（需要外部交换机配置<code>Hairpin</code>支持，即需要兼容<code>802.1Qbg</code>的交换机支持，其可以把源和目的地址都是本地<code>macvlan</code>接口地址的流量发回给相应的接口）。此模式下从父接口收到的广播包，会泛洪给<code>vepa</code>模式的所有子接口。</p>
<p>现在大多数交换机都不支持<code>Hairpin</code>模式，但<code>Linux</code>主机中可以通过一种<code>Harpin</code>模式的<code>Bridge</code>来让<code>vepa</code>模式下的不同<code>macvlan</code>接口通信(前文已经提到，<code>Bridge</code>其实就是一种旧式交换机)。怎么配置呢？非常简单，通过一条命令就可以解决：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1</span></span><br><span class="line">brctl hairpin br0 eth1 on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2</span></span><br><span class="line">bridge link <span class="built_in">set</span> dev eth0 hairpin on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式3</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/sys/class/net/br0/brif/eth1/hairpin_mode</span><br></pre></td></tr></table></figure>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_vepa.jpg" alt="macvlan_vepa" /></p>
<p><strong>验证1：macvlan接口与宿主机同一个网段</strong></p>
<ol>
<li>macvlan接口之间是否连通</li>
<li>macvlan接口和主机是否连通</li>
<li>macvlan接口是否能通外网</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> macvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> macvlan_mode=<span class="string">&quot;vepa&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;10.0.2.2&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan1=<span class="string">&quot;10.0.2.16&quot;</span> <span class="comment"># macvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan2=<span class="string">&quot;10.0.2.17&quot;</span> <span class="comment"># macvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># macvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add macvlan1 link enp0s3 <span class="built_in">type</span> macvlan mode vepa</span><br><span class="line">+ ip link add macvlan2 link enp0s3 <span class="built_in">type</span> macvlan mode vepa</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> macvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 10.0.2.16/255.255.255.0 dev macvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default via 10.0.2.2 dev macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> macvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 10.0.2.17/255.255.255.0 dev macvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default via 10.0.2.2 dev macvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping macvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_macvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.17 (10.0.2.17) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.17 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2004ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan2所在的网络命名空间中ping macvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_macvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.16 (10.0.2.16) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.16 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2005ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping 主机的ip（同一个网段）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_host&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.15 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2010ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping 外网ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping 223.5.5.5 -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=1 ttl=117 time=16.8 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=2 ttl=117 time=8.12 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=3 ttl=117 time=4.62 ms</span><br><span class="line"></span><br><span class="line">--- 223.5.5.5 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2001ms</span><br><span class="line">rtt min/avg/max/mdev = 4.627/9.862/16.839/5.136 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete macvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论1：macvlan接口之间无法ping通（要求switch支持<code>802.1Qbg/VPEA</code>，我的测试环境是virtualBox虚拟机，估计不支持），macvlan接口与宿主机无法ping通。ip配置正确的情况下，可以通外网</strong></p>
<p><strong>验证2：macvlan接口与宿主机不同网段</strong></p>
<ol>
<li>macvlan接口之间是否连通</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line"><span class="built_in">source</span> macvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> macvlan_mode=<span class="string">&quot;vepa&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan1=<span class="string">&quot;192.168.100.1&quot;</span> <span class="comment"># macvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_macvlan2=<span class="string">&quot;192.168.200.1&quot;</span> <span class="comment"># macvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># macvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add macvlan1 link enp0s3 <span class="built_in">type</span> macvlan mode vepa</span><br><span class="line">+ ip link add macvlan2 link enp0s3 <span class="built_in">type</span> macvlan mode vepa</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> macvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> macvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 192.168.100.1/255.255.255.0 dev macvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default dev macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> macvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 192.168.200.1/255.255.255.0 dev macvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default dev macvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan1所在的网络命名空间中ping macvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_macvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.200.1 (192.168.200.1) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.200.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2031ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在macvlan2所在的网络命名空间中ping macvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_macvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.100.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2037ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete macvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete macvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论2：macvlan接口之间无法ping通（要求switch支持<code>802.1Qbg/VPEA</code>，我的测试环境是virtualBox虚拟机，估计不支持）</strong></p>
<h3 id="264-passthru-mode"><a class="markdownIt-Anchor" href="#264-passthru-mode"></a> 2.6.4 passthru mode</h3>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/macvlan_passthru.jpg" alt="macvlan_passthru" /></p>
<h2 id="27-ipvlan"><a class="markdownIt-Anchor" href="#27-ipvlan"></a> 2.7 ipvlan</h2>
<p><strong>内核版本3.19才支持这一特性</strong></p>
<p>ipvlan和macvlan比较相似，区别就是ipvlan虚拟出来的接口都具有相同的mac地址。对于ipvlan，只要父接口相同，即使子接口不在同一个网络，也可以互相ping通对方，因为ipvlan会在中间做报文的转发工作</p>
<p>内核默认是没有启用ipvlan模块的，需要设置内核参数<code>CONFIG_IPVLAN=y</code>并重新编译内核，如何编译请参考<a href="/2020/10/15/Linux-Kernel/" title="Linux-Kernel">Linux-Kernel</a>，执行<code>make menuconfig</code>时开启该参数，操作如下</p>
<ol>
<li><code>Networking support</code>
<ul>
<li><code>Networking options</code>
<ul>
<li><code>L3 Master device support</code>：选中（对应配置项<code>CONFIG_NET_L3_MASTER_DEV</code>）</li>
</ul>
</li>
</ul>
</li>
<li><code>Device Drivers</code>
<ul>
<li><code>Network device support</code>
<ul>
<li><code>IP-VLAN support</code>：选中（对应配置项<code>CONFIG_IPVLAN</code>）
<ul>
<li><code>IP-VLAN based tap driver</code>：选中（对应配置项<code>CONFIG_IPVTAP</code>）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>ipvlan包含如下三种模式</strong></p>
<ol>
<li><code>l2</code>：该模式下，父接口有点像交换机或者网桥，工作在2层</li>
<li><code>l3</code>：该模式下，父接口有点像路由器的功能，工作在3层</li>
<li><code>l3s</code></li>
</ol>
<p><strong>准备一个脚本，用于验证各个模式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/ipvlan.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> namespace1=liuye1</span><br><span class="line"><span class="built_in">export</span> namespace2=liuye2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ifname_ipvlan1=ipvlan1</span><br><span class="line"><span class="built_in">export</span> ifname_ipvlan2=ipvlan2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">setup</span></span>() &#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip link add <span class="variable">$&#123;ifname_ipvlan1&#125;</span> link <span class="variable">$&#123;ifname_external&#125;</span> <span class="built_in">type</span> ipvlan mode <span class="variable">$&#123;ipvlan_mode&#125;</span></span><br><span class="line">	ip link add <span class="variable">$&#123;ifname_ipvlan2&#125;</span> link <span class="variable">$&#123;ifname_external&#125;</span> <span class="built_in">type</span> ipvlan mode <span class="variable">$&#123;ipvlan_mode&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns add <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip netns add <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_ipvlan1&#125;</span> netns <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_ipvlan2&#125;</span> netns <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_ipvlan1&#125;</span> up</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip addr add <span class="variable">$&#123;ip_ipvlan1&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> dev <span class="variable">$&#123;ifname_ipvlan1&#125;</span></span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;default_gateway&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip route add default dev <span class="variable">$&#123;ifname_ipvlan1&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip route add default via <span class="variable">$&#123;default_gateway&#125;</span> dev <span class="variable">$&#123;ifname_ipvlan1&#125;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip link <span class="built_in">set</span> <span class="variable">$&#123;ifname_ipvlan2&#125;</span> up</span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip addr add <span class="variable">$&#123;ip_ipvlan2&#125;</span>/<span class="variable">$&#123;ip_netmask&#125;</span> dev <span class="variable">$&#123;ifname_ipvlan2&#125;</span></span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$&#123;default_gateway&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip route add default dev <span class="variable">$&#123;ifname_ipvlan2&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip route add default via <span class="variable">$&#123;default_gateway&#125;</span> dev <span class="variable">$&#123;ifname_ipvlan2&#125;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">	<span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ip link delete <span class="variable">$&#123;ifname_ipvlan1&#125;</span></span><br><span class="line">	ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ip link delete <span class="variable">$&#123;ifname_ipvlan2&#125;</span></span><br><span class="line"></span><br><span class="line">	ip netns delete <span class="variable">$&#123;namespace1&#125;</span></span><br><span class="line">	ip netns delete <span class="variable">$&#123;namespace2&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> +x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -f setup</span><br><span class="line"><span class="built_in">export</span> -f cleanup</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="271-l2-mode"><a class="markdownIt-Anchor" href="#271-l2-mode"></a> 2.7.1 l2 mode</h3>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/ipvlan_l2.png" alt="ipvlan_l2" /></p>
<p><strong>验证1：ipvlan接口与宿主机同一个网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
<li>ipvlan接口和主机是否连通</li>
<li>ipvlan接口是否能通外网</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l2&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;10.0.2.2&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;10.0.2.16&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;10.0.2.17&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l2</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l2</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 10.0.2.16/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default via 10.0.2.2 dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 10.0.2.17/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default via 10.0.2.2 dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.17 (10.0.2.17) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=1 ttl=64 time=1.01 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=2 ttl=64 time=0.422 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=3 ttl=64 time=0.050 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.17 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2057ms</span><br><span class="line">rtt min/avg/max/mdev = 0.050/0.494/1.012/0.396 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.16 (10.0.2.16) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=1 ttl=64 time=0.033 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=2 ttl=64 time=0.050 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=3 ttl=64 time=0.043 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.16 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2091ms</span><br><span class="line">rtt min/avg/max/mdev = 0.033/0.042/0.050/0.007 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 主机的ip（同一个网段）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_host&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.15 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2010ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 外网ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping 223.5.5.5 -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=2 ttl=63 time=43.6 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=3 ttl=63 time=94.1 ms</span><br><span class="line"></span><br><span class="line">--- 223.5.5.5 ping statistics ---</span><br><span class="line">3 packets transmitted, 2 received, 33% packet loss, time 2018ms</span><br><span class="line">rtt min/avg/max/mdev = 43.677/68.897/94.118/25.221 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论1：ipvlan接口之间可以相互ping通，但是无法ping通master接口。ip配置正确的情况下，可以通外网</strong></p>
<p><strong>验证2：ipvlan接口与宿主机不同网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l2&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;192.168.100.1&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;192.168.200.1&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l2</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l2</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 192.168.100.1/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 192.168.200.1/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.200.1 (192.168.200.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=1 ttl=64 time=0.783 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=2 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=3 ttl=64 time=0.087 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.200.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2085ms</span><br><span class="line">rtt min/avg/max/mdev = 0.041/0.303/0.783/0.340 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=1 ttl=64 time=0.029 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=2 ttl=64 time=0.089 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=3 ttl=64 time=0.047 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.100.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2074ms</span><br><span class="line">rtt min/avg/max/mdev = 0.029/0.055/0.089/0.025 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论2：ipvlan接口之间可以相互ping通，即便网段不同</strong></p>
<h3 id="272-l3-mode"><a class="markdownIt-Anchor" href="#272-l3-mode"></a> 2.7.2 l3 mode</h3>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/ipvlan_l3.png" alt="ipvlan_l3" /></p>
<p><strong>验证1：ipvlan接口与宿主机同一个网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
<li>ipvlan接口和主机是否连通</li>
<li>ipvlan接口是否能通外网</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l3&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;10.0.2.2&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;10.0.2.16&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;10.0.2.17&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 10.0.2.16/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default via 10.0.2.2 dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 10.0.2.17/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default via 10.0.2.2 dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.17 (10.0.2.17) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=1 ttl=64 time=0.037 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=2 ttl=64 time=0.039 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=3 ttl=64 time=0.055 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.17 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2044ms</span><br><span class="line">rtt min/avg/max/mdev = 0.037/0.043/0.055/0.011 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.16 (10.0.2.16) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=1 ttl=64 time=0.037 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=2 ttl=64 time=0.043 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=3 ttl=64 time=0.206 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.16 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2058ms</span><br><span class="line">rtt min/avg/max/mdev = 0.037/0.095/0.206/0.078 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 主机的ip（同一个网段）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_host&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.15 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2077ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 外网ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping 223.5.5.5 -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=1 ttl=63 time=5.50 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=2 ttl=63 time=7.81 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=3 ttl=63 time=8.21 ms</span><br><span class="line"></span><br><span class="line">--- 223.5.5.5 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2005ms</span><br><span class="line">rtt min/avg/max/mdev = 5.503/7.177/8.215/1.195 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论1：ipvlan接口之间可以相互ping通，但是无法ping通master接口。ip配置正确的情况下，可以通外网</strong></p>
<p><strong>验证2：ipvlan接口与宿主机不同网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l3&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;192.168.100.1&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;192.168.200.1&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l3</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 192.168.100.1/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 192.168.200.1/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.200.1 (192.168.200.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=1 ttl=64 time=0.044 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=2 ttl=64 time=0.066 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=3 ttl=64 time=0.047 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.200.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2149ms</span><br><span class="line">rtt min/avg/max/mdev = 0.044/0.052/0.066/0.011 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=1 ttl=64 time=0.032 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=2 ttl=64 time=0.097 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=3 ttl=64 time=0.042 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.100.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2036ms</span><br><span class="line">rtt min/avg/max/mdev = 0.032/0.057/0.097/0.028 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论2：ipvlan接口之间可以相互ping通，即便网段不同</strong></p>
<h3 id="273-l3s-mode"><a class="markdownIt-Anchor" href="#273-l3s-mode"></a> 2.7.3 l3s mode</h3>
<p><strong>验证1：ipvlan接口与宿主机同一个网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
<li>ipvlan接口和主机是否连通</li>
<li>ipvlan接口是否能通外网</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l3s&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;10.0.2.2&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;10.0.2.16&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;10.0.2.17&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l3s</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l3s</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 10.0.2.16/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default via 10.0.2.2 dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 10.0.2.17/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z 10.0.2.2 <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default via 10.0.2.2 dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.17 (10.0.2.17) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=1 ttl=64 time=0.119 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=2 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from 10.0.2.17: icmp_seq=3 ttl=64 time=0.046 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.17 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2074ms</span><br><span class="line">rtt min/avg/max/mdev = 0.042/0.069/0.119/0.035 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.16 (10.0.2.16) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=1 ttl=64 time=0.078 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=2 ttl=64 time=0.046 ms</span><br><span class="line">64 bytes from 10.0.2.16: icmp_seq=3 ttl=64 time=0.037 ms</span><br><span class="line"></span><br><span class="line">--- 10.0.2.16 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2104ms</span><br><span class="line">rtt min/avg/max/mdev = 0.037/0.053/0.078/0.019 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 主机的ip（同一个网段）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_host&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 10.0.2.15 (10.0.2.15) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 10.0.2.15 ping statistics ---</span><br><span class="line">3 packets transmitted, 0 received, 100% packet loss, time 2061ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping 外网ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping 223.5.5.5 -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=1 ttl=63 time=88.4 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=2 ttl=63 time=66.6 ms</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=3 ttl=63 time=159 ms</span><br><span class="line"></span><br><span class="line">--- 223.5.5.5 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2069ms</span><br><span class="line">rtt min/avg/max/mdev = 66.605/104.814/159.405/39.617 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论1：ipvlan接口之间可以相互ping通，但是无法ping通master接口。ip配置正确的情况下，可以通外网</strong></p>
<p><strong>验证2：ipvlan接口与宿主机不同网段</strong></p>
<ol>
<li>ipvlan接口之间是否连通</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ipvlan.sh</span><br><span class="line"><span class="built_in">export</span> ifname_external=<span class="string">&quot;enp0s3&quot;</span> <span class="comment"># 主机的外网网卡</span></span><br><span class="line"><span class="built_in">export</span> ipvlan_mode=<span class="string">&quot;l3s&quot;</span></span><br><span class="line"><span class="built_in">export</span> ip_host=<span class="string">&quot;10.0.2.15&quot;</span> <span class="comment"># 主机ip</span></span><br><span class="line"><span class="built_in">export</span> default_gateway=<span class="string">&quot;&quot;</span> <span class="comment"># 默认路由网关ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan1=<span class="string">&quot;192.168.100.1&quot;</span> <span class="comment"># ipvlan接口1的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_ipvlan2=<span class="string">&quot;192.168.200.1&quot;</span> <span class="comment"># ipvlan接口2的ip</span></span><br><span class="line"><span class="built_in">export</span> ip_netmask=<span class="string">&quot;255.255.255.0&quot;</span> <span class="comment"># ipvlan接口的子网掩码</span></span><br><span class="line">setup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip link add ipvlan1 link enp0s3 <span class="built_in">type</span> ipvlan mode l3s</span><br><span class="line">+ ip link add ipvlan2 link enp0s3 <span class="built_in">type</span> ipvlan mode l3s</span><br><span class="line">+ ip netns add liuye1</span><br><span class="line">+ ip netns add liuye2</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan1 netns liuye1</span><br><span class="line">+ ip link <span class="built_in">set</span> ipvlan2 netns liuye2</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link <span class="built_in">set</span> ipvlan1 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip addr add 192.168.100.1/255.255.255.0 dev ipvlan1</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip route add default dev ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link <span class="built_in">set</span> ipvlan2 up</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip addr add 192.168.200.1/255.255.255.0 dev ipvlan2</span><br><span class="line">+ <span class="string">&#x27;[&#x27;</span> -z <span class="string">&#x27;&#x27;</span> <span class="string">&#x27;]&#x27;</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip route add default dev ipvlan2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan1所在的网络命名空间中ping ipvlan2的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace1&#125;</span> ping <span class="variable">$&#123;ip_ipvlan2&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.200.1 (192.168.200.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=1 ttl=64 time=0.059 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=2 ttl=64 time=0.045 ms</span><br><span class="line">64 bytes from 192.168.200.1: icmp_seq=3 ttl=64 time=0.122 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.200.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2191ms</span><br><span class="line">rtt min/avg/max/mdev = 0.045/0.075/0.122/0.034 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在ipvlan2所在的网络命名空间中ping ipvlan1的ip</span></span><br><span class="line">ip netns <span class="built_in">exec</span> <span class="variable">$&#123;namespace2&#125;</span> ping <span class="variable">$&#123;ip_ipvlan1&#125;</span> -c 3</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=1 ttl=64 time=0.033 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=2 ttl=64 time=0.043 ms</span><br><span class="line">64 bytes from 192.168.100.1: icmp_seq=3 ttl=64 time=0.049 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.100.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2037ms</span><br><span class="line">rtt min/avg/max/mdev = 0.033/0.041/0.049/0.009 ms</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理</span></span><br><span class="line">cleanup</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye1 ip link delete ipvlan1</span><br><span class="line">+ ip netns <span class="built_in">exec</span> liuye2 ip link delete ipvlan2</span><br><span class="line">+ ip netns delete liuye1</span><br><span class="line">+ ip netns delete liuye2</span><br><span class="line">+ <span class="built_in">set</span> +x</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><strong>结论2：ipvlan接口之间可以相互ping通，但是无法ping通master接口。ip配置正确的情况下，可以通外网</strong></p>
<h2 id="28-macvtapipvtap"><a class="markdownIt-Anchor" href="#28-macvtapipvtap"></a> 2.8 macvtap/ipvtap</h2>
<h2 id="29-macsec"><a class="markdownIt-Anchor" href="#29-macsec"></a> 2.9 macsec</h2>
<h2 id="210-vethvirtual-ethernet"><a class="markdownIt-Anchor" href="#210-vethvirtual-ethernet"></a> 2.10 veth（virtual ethernet）</h2>
<h2 id="211-vcanvirtual-can"><a class="markdownIt-Anchor" href="#211-vcanvirtual-can"></a> 2.11 vcan（virtual can）</h2>
<h2 id="212-vxcanvirtual-can-tunnel"><a class="markdownIt-Anchor" href="#212-vxcanvirtual-can-tunnel"></a> 2.12 vxcan（virtual can tunnel）</h2>
<h2 id="213-ipoibip-over-infiniband"><a class="markdownIt-Anchor" href="#213-ipoibip-over-infiniband"></a> 2.13 ipoib（ip-over-infiniBand）</h2>
<h2 id="214-nlmonnetlink-monitor"><a class="markdownIt-Anchor" href="#214-nlmonnetlink-monitor"></a> 2.14 nlmon（netlink monitor）</h2>
<h2 id="215-dummy-interface"><a class="markdownIt-Anchor" href="#215-dummy-interface"></a> 2.15 dummy interface</h2>
<h2 id="216-ifbintermediate-functional-block"><a class="markdownIt-Anchor" href="#216-ifbintermediate-functional-block"></a> 2.16 ifb（intermediate functional block）</h2>
<h2 id="217-netdevsim"><a class="markdownIt-Anchor" href="#217-netdevsim"></a> 2.17 netdevsim</h2>
<h2 id="218-参考"><a class="markdownIt-Anchor" href="#218-参考"></a> 2.18 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking/">Introduction to Linux interfaces for virtual networking</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/index">CONFIGURING AND MANAGING NETWORKING</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/networking/ipvlan.html">IPVLAN Driver HOWTO</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35616289">VLAN 基础知识</a></li>
<li><a target="_blank" rel="noopener" href="https://kernel.taobao.org/2019/11/ipvlan-for-kubernete-net/">Kubernetes网络的IPVlan方案</a></li>
<li><a target="_blank" rel="noopener" href="https://support.huaweicloud.com/dpmg-kunpengwebs/kunpengnginx_04_0010.html">IPVLAN网络模式</a></li>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2017/02/14/network-virtualization-macvlan/">linux 网络虚拟化： macvlan</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/2019/12/12/5df17e01243b0/">Macvlan与ipvlan解析</a></li>
<li><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/netwnetwork-virtualization-macvlan/">Linux 虚拟网卡技术：Macvlan</a></li>
<li><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/vxlan-protocol-introduction/">VXLAN 基础教程：VXLAN 协议原理介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/vxlan-linux/">VXLAN 基础教程：在 Linux 上配置 VXLAN 网络</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/478834">Linux bonding研究及实现</a></li>
</ul>
<h1 id="3-netfilter"><a class="markdownIt-Anchor" href="#3-netfilter"></a> 3 Netfilter</h1>
<p>Linux中最常用的基本防火墙软件称为<code>iptables</code>。<code>iptables</code>防火墙通过与Linux内核的网络堆栈中的数据包过滤<code>hook</code>进行交互来工作。这些内核<code>hook</code>称为<code>netfilter</code>框架</p>
<p>进入网络系统（<code>incoming</code>或<code>outgoing</code>）的每个数据包将在它通过网络堆栈时触发这些<code>hook</code>，允许注册这些<code>hook</code>的程序与关键点的流量进行交互。与<code>iptables</code>相关联的内核模块在这些<code>hook</code>处注册，以确保流量符合防火墙的设定</p>
<h2 id="31-netfilter-hooks"><a class="markdownIt-Anchor" href="#31-netfilter-hooks"></a> 3.1 Netfilter Hooks</h2>
<p><code>netfilter</code>一共包含5个<code>hook</code>。当数据包通过网络堆栈时，注册到这些<code>hook</code>的内核模块将被触发执行。数据包是否触发<code>hook</code>，取决于数据包是<code>incoming</code>还是<code>outgoing</code>，数据包的目标，以及数据包是否在之前的点已被丢弃或拒绝</p>
<ol>
<li><strong><code>NF_IP_PRE_ROUTING</code></strong>：该<code>hook</code>会在任意<code>incoming</code>数据包进入网络堆栈时触发。并且，会在做出路由决定前处理完毕</li>
<li><strong><code>NF_IP_LOCAL_IN</code></strong>：该<code>hook</code>会在某个<code>incoming</code>数据包被路由到<code>local system</code>时触发</li>
<li><strong><code>NF_IP_FORWARD</code></strong>：该<code>hook</code>会在某个<code>incoming</code>数据包被<code>forwarded</code>到其他主机时触发</li>
<li><strong><code>NF_IP_LOCAL_OUT</code></strong>：该<code>hook</code>会在任意<code>outgoing</code>数据包进入网络堆栈时触发</li>
<li><strong><code>NF_IP_POST_ROUTING</code></strong>：该<code>hook</code>会在任意<code>outgoing</code>或<code>forwarded</code>数据包发生路由之后，传输之前触发</li>
</ol>
<p>在<code>hook</code>处注册的内核模块必须提供优先级编号，来确定触发<code>hook</code>时调用内核模块的顺序。每个模块将按照优先级顺序依次被调用，并在处理后将处理结果返回<code>netfilter</code>，以便让<code>netfilter</code>决定对数据包进行何种操作</p>
<h2 id="32-iptables-tables-and-chains"><a class="markdownIt-Anchor" href="#32-iptables-tables-and-chains"></a> 3.2 IPTables Tables and Chains</h2>
<p><code>iptables</code>防火墙使用<code>table</code>来组织其<code>rule</code>。这些<code>table</code>根据决策类型进行分类。例如，如果<code>rule</code>处理网络地址转换，它将被放入<code>nat table</code>中。如果该<code>rule</code>用于决定是否允许数据包继续到其目的地，则可能会将其添加到<code>filter table</code>中</p>
<p>在每个<code>iptables table</code>中，<code>rule</code>进一步被拆分到不同的<code>chain</code>中。<strong>其中，<code>table</code>代表了决策类型；<code>chain</code>表示由哪个<code>hook</code>来触发，即决定<code>rule</code>何时进行校验</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left"><code>Chain</code></th>
<th style="text-align:left"><code>hoook</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>PREROUTING</code></td>
<td style="text-align:left"><code>NF_IP_PRE_ROUTING</code></td>
</tr>
<tr>
<td style="text-align:left"><code>INPUT</code></td>
<td style="text-align:left"><code>NF_IP_LOCAL_IN</code></td>
</tr>
<tr>
<td style="text-align:left"><code>FORWARD</code></td>
<td style="text-align:left"><code>NF_IP_FORWARD</code></td>
</tr>
<tr>
<td style="text-align:left"><code>OUTPUT</code></td>
<td style="text-align:left"><code>NF_IP_LOCAL_OUT</code></td>
</tr>
<tr>
<td style="text-align:left"><code>POSTROUTING</code></td>
<td style="text-align:left"><code>NF_IP_POST_ROUTING</code></td>
</tr>
</tbody>
</table>
<p><code>chain</code>允许管理员控制数据包的传递路径中的评估<code>rule</code>。由于每个<code>table</code>都有多个<code>chain</code>，因此一个<code>table</code>的作用点可能会有多个（关联到了多个<code>hook</code>）。由于某些类型的决策仅在网络堆栈中的某些点有意义，因此<code>talbe</code>不会在每个内核<code>hook</code>中进行注册</p>
<p>只有五个<code>netfilter</code>内核<code>hook</code>，因此，每个<code>hook</code>注册了多个来自不同<code>table</code>的<code>chian</code>。例如，三个<code>table</code>具有<code>PREROUTING chain</code>。当这些<code>chain</code>在相关的<code>NF_IP_PRE_ROUTING hook</code>处注册时，它们指定一个优先级，该优先级指示每个<code>table</code>的<code>PREROUTING chain</code>被调用的顺序。在进入下一个<code>PREROUTING</code>链之前，将按顺序评估最高优先级<code>PREROUTING chain</code>中的每个<code>rule</code></p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/netfilter_hook.jpg" alt="netfilter_hook" /></p>
<h2 id="33-which-tables-are-available"><a class="markdownIt-Anchor" href="#33-which-tables-are-available"></a> 3.3 Which Tables are Available?</h2>
<h3 id="331-the-filter-table"><a class="markdownIt-Anchor" href="#331-the-filter-table"></a> 3.3.1 The Filter Table</h3>
<p><code>filter table</code>是<code>iptables</code>中最常使用的，<code>filter table</code>用于决定放行数据包，还是拒绝数据包通过</p>
<h3 id="332-the-nat-table"><a class="markdownIt-Anchor" href="#332-the-nat-table"></a> 3.3.2 The NAT Table</h3>
<p><code>net table</code>通常进行网络地址转换（<code>NAT</code>）。当数据包进入网络堆栈，<code>net table</code>中的<code>rule</code>将会决定是否以及怎样修改数据包的<code>源地址</code>以及<code>目的地址</code></p>
<h3 id="333-the-mangle-table"><a class="markdownIt-Anchor" href="#333-the-mangle-table"></a> 3.3.3 The Mangle Table</h3>
<p><code>mangle table</code>用于修改<code>IP header</code>，例如修改数据包的<code>TTL(Time to Live)</code>属性值</p>
<h3 id="334-the-raw-table"><a class="markdownIt-Anchor" href="#334-the-raw-table"></a> 3.3.4 The Raw Table</h3>
<p><code>iptables</code>防火墙是有状态的，这意味着，对于一个数据包的规则校验可以关联到前面若干个数据包。构建在<code>netfilter</code>框架之上的<code>connection tracking</code>功能允许<code>iptables</code>将数据包视为正在进行的<code>connection</code>或<code>session</code>的一部分，而不是作为离散的，无关的数据包</p>
<p><code>connection tracking</code>的处理逻辑会在数据包到达网络接口时被执行。<code>raw table</code>的目的就是绕过<code>connection tracking</code>的功能</p>
<h3 id="335-the-security-table"><a class="markdownIt-Anchor" href="#335-the-security-table"></a> 3.3.5 The Security Table</h3>
<p><code>security table</code>主要用于为数据包设置<code>SELinux</code>的安全上下文</p>
<h2 id="34-which-chains-are-implemented-in-each-table"><a class="markdownIt-Anchor" href="#34-which-chains-are-implemented-in-each-table"></a> 3.4 Which Chains are Implemented in Each Table?</h2>
<p>下标从左到右是五个<code>chain</code>；从上到下是若干个<code>table</code>，上面的<code>table</code>其优先级要比下面的<code>table</code>高。同时，<code>nat table</code>被拆分成两个表，一个是<code>SNAT table</code>（修改<code>source address</code>），另一个是<code>DNAT table</code>（修改<code>destination address</code>）</p>
<table>
<thead>
<tr>
<th style="text-align:left">Tables↓/Chains→</th>
<th style="text-align:center">PREROUTING</th>
<th style="text-align:center">INPUT</th>
<th style="text-align:center">FORWARD</th>
<th style="text-align:center">OUTPUT</th>
<th style="text-align:center">POSTROUTING</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>(routing decision)</code></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>raw</code></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>(connection tracking enabled)</code></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>mangle</code></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
</tr>
<tr>
<td style="text-align:left"><code>nat (DNAT)</code></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>(routing decision)</code></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>filter</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>security</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left"><code>nat (SNAT)</code></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">✓</td>
</tr>
</tbody>
</table>
<p><strong>Chain Traversal Order</strong></p>
<ol>
<li><strong>Incoming packets destined for the local system</strong>：<code>PREROUTING -&gt; INPUT</code></li>
<li><strong>Incoming packets destined to another host</strong>：<code>PREROUTING -&gt; FORWARD -&gt; POSTROUTING</code></li>
<li><strong>Locally generated packets</strong>：<code>OUTPUT -&gt; POSTROUTING</code></li>
</ol>
<p>举个例子，一个<code>incoming</code>数据包，其目的地是<code>local systeml</code>，那么<code>PREROUTING chain</code>会被首先触发，按照优先级顺序，依次是<code>raw table</code>、<code>mangle table</code>、<code>nat table</code>的逻辑会被执行。然后<code>INPUT chain</code>会被触发，按照优先级顺序，依次是<code>mangle table</code>、<code>filter table</code>、<code>security table</code>以及<code>nat table</code></p>
<h2 id="35-iptables-rules"><a class="markdownIt-Anchor" href="#35-iptables-rules"></a> 3.5 IPTables Rules</h2>
<p><strong>一个<code>rule</code>由一个<code>table</code>以及一个<code>chain</code>唯一确定</strong>。每个<code>rule</code>都有一个<code>matching component</code>以及一个<code>action component</code></p>
<p><strong><code>matching component</code>用于指定数据包必须满足的条件，以便执行相关的操作</strong>。匹配系统非常灵活，可以通过系统上的<code>iptables</code>进行配置，允许进行如下粒度的配置</p>
<ol>
<li><strong>协议类型</strong></li>
<li><strong>目的地或源地址</strong></li>
<li><strong>目的地或源端口</strong></li>
<li><strong>目的地或源网络</strong></li>
<li><strong>输入或输出接口</strong></li>
<li><strong>报头或连接状态以及其他标准</strong></li>
</ol>
<ul>
<li>上述规则可以自由组合，用来创建相当复杂的规则集以区分不同的流量</li>
</ul>
<p><strong><code>action component</code>用于在满足规则匹配条件时，输出一个<code>target</code></strong>：<code>target</code>通常分为以下两类</p>
<ol>
<li><strong><code>Terminating targets</code></strong>：执行一个动作，该动作终止<code>chain</code>中的执行逻辑并将控制返回到<code>netfilter</code>的<code>hook</code>中。根据提供的返回值，<code>hook</code>可能会丢弃数据包或允许数据包继续进行下一个处理阶段</li>
<li><strong><code>Non-terminating targets</code></strong>：执行一个动作，并继续<code>chain</code>中的执行逻辑。尽管每个<code>chain</code>最终必须传回<code>Terminating targets</code>，但是可以预先执行任意数量的<code>Non-terminating targets</code></li>
</ol>
<h2 id="36-jumping-to-user-defined-chains"><a class="markdownIt-Anchor" href="#36-jumping-to-user-defined-chains"></a> 3.6 Jumping to User-Defined Chains</h2>
<p>这里需要提到一个特殊的<code>Non-terminating targets</code>，即<code>jump target</code>。<code>jump target</code>可以跳转到其他<code>chain</code>中执行额外的处理逻辑。在上面讨论到的<code>built-in chains</code>已经预先注册到了<code>netfilter hook</code>中，而<code>User-Defined Chains</code>是不允许注册到<code>hook</code>中的。尽管如此，<code>iptables</code>仍然允许用户自定义<code>chain</code>，其原理就是用到了<code>jump target</code></p>
<h2 id="37-iptables-and-connection-tracking"><a class="markdownIt-Anchor" href="#37-iptables-and-connection-tracking"></a> 3.7 IPTables and Connection Tracking</h2>
<p>在讨论<code>raw table</code>时，我们介绍了在<code>netfilter</code>框架之上实现的<code>connection tracking</code>。<code>connection tracking</code>允许<code>iptables</code>在当前连接的上下文中查看数据包。<code>connection tracking</code>为<code>iptables</code>提供执行“有状态”操作所需的功能</p>
<p>数据包进入网络堆栈后很快就会应用<code>connection tracking</code>。<strong><code>raw table chains</code>和一些基本的健全性检查是在将<code>数据包</code>与<code>连接</code>相关联之前对数据包执行的唯一逻辑</strong></p>
<p><strong><code>connection tracking</code>是实现<code>NAT</code>地址转换的灵魂，一个连接仅在首次经过<code>netfilter</code>链条时会计算<code>NAT</code>表，一旦<code>connection tracking</code>记录下这次的改写关系，后续无论是去程包还是回程包都是依据<code>connection tracking</code>表进行改写关系的处理，不会再重复执行<code>NAT</code>表中的<code>DNAT/SNAT</code>规则</strong></p>
<p>系统根据一组现有连接检查每个数据包，将更新数据包所属连接的状态，或增加一个新的连接。<strong>在<code>raw table chains</code>中标记有<code>NOTRACK target</code>的数据包将绕过<code>connection tracking</code>处理流程</strong></p>
<p>在<code>connection tracking</code>中，一个数据包可能被标记为如下几种状态</p>
<ol>
<li><strong><code>NEW</code></strong>：当前数据包不属于任何一个现有的<code>connection</code>，且是一个合法的<code>first package</code>，那么将会创建一个新的<code>connection</code></li>
<li><strong><code>ESTABLISHED</code></strong>：当收到一个<code>response</code>时，<code>connection</code>会从<code>NEW</code>状态变为<code>ESTABLISHED</code>状态。对于<code>TCP</code>，这意味着这是一个<code>SYN/ACK</code>数据包；对于<code>UDP</code>，这意味着这是一个<code>ICMP</code>数据包</li>
<li><strong><code>RELATED</code></strong>：当前数据包不属于任何一个现有的<code>connection</code>，但是关联到某个<code>connection</code>。这通常是一个<code>helper connection</code>，例如<code>FTP data transmission connection</code>或者是<code>ICMP</code>对其他协议的<code>连接尝试</code>的响应</li>
<li><strong><code>INVALID</code></strong>：当前数据包不属于任何一个现有的<code>connection</code>，也不是一个合法的<code>first package</code></li>
<li><strong><code>UNTRACKED</code></strong>：通过<code>raw table</code>的配置，绕过<code>connection tracking</code>的处理流程</li>
<li><strong><code>SNAT</code></strong>：<code>source address</code>被<code>NAT</code>修改时设置的虚拟状态，被记录在<code>connection tracking</code>中，以便在<code>reply package</code>（我回复别人）中更改<code>source address</code></li>
<li><strong><code>DNAT</code></strong>：<code>destination address</code>被<code>NAT</code>修改时设置的虚拟状态，被记录在<code>connection tracking</code>中，以便在路由<code>reply package</code>（别人回复我）时知道更改<code>destination address</code></li>
</ol>
<h4 id="3701-conntrack"><a class="markdownIt-Anchor" href="#3701-conntrack"></a> 3.7.0.1 conntrack</h4>
<p><strong>示例：</strong></p>
<ul>
<li><code>conntrack -S</code>：查看统计信息，以cpu为维度进行聚合，当机器的核数很多时，会输出比cpu核数更多的行，但是多出来的那部分都是冗余的数据，无实际意义</li>
<li><code>conntrack -L</code></li>
</ul>
<h2 id="38-nat原理"><a class="markdownIt-Anchor" href="#38-nat原理"></a> 3.8 NAT原理</h2>
<p><strong>NAT的实现依赖<code>connection tracking</code></strong></p>
<p>以一个示例来进行解释，条件如下：</p>
<ol>
<li><code>Machine A</code>在私网环境下，其<code>IP</code>是<code>192.168.1.2</code></li>
<li><code>NAT Gateway A</code>有两张网卡
<ul>
<li>一张网卡的<code>IP</code>为<code>192.168.1.1</code>，与<code>Machine A</code>在同一个网段，且为<code>Machine A</code>的默认路由地址</li>
<li>一张网卡的<code>IP</code>为<code>100.100.100.1</code>，为公网<code>IP</code></li>
</ul>
</li>
<li><code>Machine B</code>在私网环境下，其IP是<code>192.168.2.2</code></li>
<li><code>NAT Gateway B</code>有两张网卡
<ul>
<li>一张网卡的<code>IP</code>为<code>192.168.2.1</code>，与<code>Machine B</code>在同一个网段，且为<code>Machine B</code>的默认路由地址</li>
<li>一张网卡的<code>IP</code>为<code>200.200.200.1</code>，为公网<code>IP</code></li>
</ul>
</li>
</ol>
<p><strong>Request from Machine A to Machine B</strong></p>
<ol>
<li><code>Request</code>从<code>Machine A</code>发出，经过默认路由到达<code>NAT Gateway A</code></li>
<li><code>NAT Gateway A</code>发现配置了<code>SNAT规则</code>，于是将<code>srcIP</code>从<code>192.168.1.2</code>改为<code>100.100.100.1</code></li>
<li><code>Request</code>从<code>NAT Gateway A</code>经过公网流转到<code>NAT Gateway B</code></li>
<li><code>NAT Gateway B</code>发现配置了<code>DNAT</code>规则，于是将<code>dstIP</code>从<code>200.200.200.1</code>改为<code>192.168.2.2</code></li>
<li><code>Request</code>最终流转至<code>Machine B</code></li>
</ol>
<ul>
<li>对于<code>Machine B</code>来说，它认为<code>Request</code>就是<code>NAT Gateway A</code>发过来的，而完全感知不到<code>Machine A</code></li>
<li>同理，对于<code>Machine A</code>来说，它认为<code>Request</code>最终发给了<code>NAT Gateway B</code>，而完全感知不到<code>Machine B</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                +--------------------------+                                               +--------------------------+</span><br><span class="line">                |  src ip  : 192.168.1.2   |                                               |  src ip  : 100.100.100.1 |</span><br><span class="line">   Machine A    |  src port: 56303         |                                               |  src port: 56303         |    Machine B</span><br><span class="line">  192.168.1.2   +--------------------------+                                               +--------------------------+   192.168.2.2</span><br><span class="line">                |  dst ip  : 200.200.200.1 |                                               |  dst ip  : 192.168.2.2   |</span><br><span class="line">                |  dst port: 443           |                                               |  dst port: 443           |</span><br><span class="line">                +------------+-------------+                                               +------------+-------------+</span><br><span class="line">                             |                                                                          ^</span><br><span class="line">                             |                                                                          |</span><br><span class="line">                             | route                                                                    | route</span><br><span class="line">                             |                                                                          |</span><br><span class="line">                             v                                                                          |</span><br><span class="line">                +------------+-------------+                                               +------------+-------------+</span><br><span class="line">                |  osrc ip : 192.168.1.2   |                                               |  src ip  : 100.100.100.1 |</span><br><span class="line">NAT Gateway A   |  msrc ip : 100.100.100.1 |                   internet                    |  src port: 56303         |   NAT Gateway B</span><br><span class="line"> 192.168.1.1    |  src port: 56303         | +-------------------------------------------&gt; +--------------------------+    192.168.2.1</span><br><span class="line">100.100.100.1   +--------------------------+                                               |  odst ip : 200.200.200.1 |   200.200.200.1</span><br><span class="line">                |  dst ip  : 200.200.200.1 |                                               |  mdst ip : 192.168.2.2   |</span><br><span class="line">                |  dst port: 443           |                                               |  dst port: 443           |</span><br><span class="line">                +--------------------------+                                               +--------------------------+</span><br></pre></td></tr></table></figure>
<p><strong>Response from Machine B to Machine A</strong></p>
<ol>
<li><code>Response</code>从<code>Machine B</code>发出，经过默认路由到达<code>NAT Gateway B</code></li>
<li><code>NAT Gateway B</code>发现配置了<code>DNAT</code>规则，于是将<code>srcIP</code>从<code>192.168.2.2</code>改为<code>200.200.200.1</code></li>
<li><code>Response</code>从<code>NAT Gateway B</code>经过公网流转到<code>NAT Gateway A</code></li>
<li><code>NAT Gateway A</code>发现配置了<code>SNAT</code>规则，于是将<code>dstIP</code>从<code>100.100.100.1</code>改为<code>192.168.1.2</code></li>
<li><code>Response</code>最终流转至<code>Machine A</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                +--------------------------+                                               +--------------------------+</span><br><span class="line">                |  src ip  : 200.200.200.1 |                                               |  src ip  : 192.168.2.2   |</span><br><span class="line">   Machine A    |  src port: 443           |                                               |  src port: 443           |    Machine B</span><br><span class="line">  192.168.1.2   +--------------------------+                                               +--------------------------+   192.168.2.2</span><br><span class="line">                |  dst ip  : 192.168.1.2   |                                               |  dst ip  : 100.100.100.1 |</span><br><span class="line">                |  dst port: 56303         |                                               |  dst port: 56303         |</span><br><span class="line">                +------------+-------------+                                               +-----------+--------------+</span><br><span class="line">                             ^                                                                         |</span><br><span class="line">                             |                                                                         |</span><br><span class="line">                             | route                                                                   |  route</span><br><span class="line">                             |                                                                         |</span><br><span class="line">                             |                                                                         v</span><br><span class="line">                +------------+-------------+                                               +-----------+--------------+</span><br><span class="line">                |  src ip  : 200.200.200.1 |                                               |  osrc ip : 192.168.2.2   |</span><br><span class="line">NAT Gateway A   |  src port: 443           |                   internet                    |  msrc ip : 200.200.200.1 |   NAT Gateway B</span><br><span class="line"> 192.168.1.1    +--------------------------+ &lt;-------------------------------------------+ |  src port: 443           |    192.168.2.1</span><br><span class="line">100.100.100.1   |  odst ip : 100.100.100.1 |                                               +--------------------------+   200.200.200.1</span><br><span class="line">                |  mdst ip ： 192.168.1.2   |                                               |  dst ip  : 100.100.100.1 |</span><br><span class="line">                |  dst port: 56303         |                                               |  dst port: 56303         |</span><br><span class="line">                +--------------------------+                                               +--------------------------+</span><br></pre></td></tr></table></figure>
<p><strong>细心的朋友可能会发现，<code>NAT Gateway A</code>只配置了<code>SNAT</code>，而<code>NAT Gateway B</code>只配置了<code>DNAT</code>，但是在<code>Response</code>的链路中，<code>NAT Gateway A</code>做了<code>DNAT</code>的工作，而<code>NAT Gateway B</code>做了<code>SNAT</code>的工作</strong></p>
<ul>
<li>当<code>Request</code>到达<code>NAT Gateway A</code>时，<code>NAT Gateway A</code>会在<code>NAT</code>表中添加一行，然后再改写<code>srcIP</code>（SNAT）
<ul>
<li>前缀<code>o</code>是<code>original</code>的缩写</li>
<li>前缀<code>m</code>是<code>modified</code>的缩写</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">osrcIP</th>
<th style="text-align:left">osrcPort</th>
<th style="text-align:left">msrcIP</th>
<th style="text-align:left">msrcPort</th>
<th style="text-align:left">protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">192.168.1.2</td>
<td style="text-align:left">56303</td>
<td style="text-align:left">100.100.100.1</td>
<td style="text-align:left">56303</td>
<td style="text-align:left">xxx</td>
</tr>
</tbody>
</table>
<ul>
<li>当<code>Request</code>到达<code>NAT Gateway B</code>时，<code>NAT Gateway B</code>会在<code>NAT</code>表中添加一行，然后再改写<code>dstIP</code>（DNAT）</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">odstIP</th>
<th style="text-align:left">odstPort</th>
<th style="text-align:left">mdstIP</th>
<th style="text-align:left">mdstPort</th>
<th style="text-align:left">protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">200.200.200.1</td>
<td style="text-align:left">443</td>
<td style="text-align:left">192.168.2.2</td>
<td style="text-align:left">443</td>
<td style="text-align:left">xxx</td>
</tr>
</tbody>
</table>
<ul>
<li>当<code>Response</code>到达<code>NAT Gateway B</code>时，会查找<code>srcIP</code>与<code>mdstIP</code>相同且<code>srcPort</code>与<code>mdstPort</code>相同的表项，并将<code>srcIP</code>和<code>srcPort</code>替换成<code>odstIP</code>和<code>odstPort</code>（SNAT）</li>
<li>当<code>Response</code>到达<code>NAT Gateway A</code>时，会查找<code>dstIP</code>与<code>msrcIP</code>相同且<code>dstPort</code>与<code>msrcPort</code>相同的表项，并将<code>dstIP</code>和<code>dstPort</code>替换成<code>osrcIP</code>和<code>osrcPort</code>（DNAT）</li>
</ul>
<p><strong>如此一来，有了IP+端口，一台网关就可以为多台机器配置SNAT；同理，也可以为多台机器配置DNAT</strong></p>
<p><strong>但是，如果两台私网的机器A和B（均在网关上配置了SNAT规则），同时ping某个外网IP的话，NAT又是如何工作的呢？（ICMP协议没有port，而只根据IP是没法区分这两台私网机器的）方法就是：创造端口（下面这种做法是我猜的，与实际情况未必一致，但是思路是相似的）</strong></p>
<ul>
<li>假设A的IP为<code>192.168.1.2</code>，<code>NAT Gateway</code>的IP是<code>100.100.100.1</code>，ping的公网IP是<code>200.200.200.1</code></li>
<li>当<code>ICMP Request</code>报文到达<code>NAT Gateway</code>的时候，根据<code>identifier</code>生成源端口号，修改<code>srcIP</code>，以及<code>identifier</code>并增加如下记录（SNAT）
<ul>
<li>其中，<code>mapFunc</code>表示从<code>identifier</code>转换为端口号的算法</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">osrcIP</th>
<th style="text-align:left">osrcPort</th>
<th style="text-align:left">msrcIP</th>
<th style="text-align:left">msrcPort</th>
<th style="text-align:left">protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">192.168.0.2</td>
<td style="text-align:left">mapFunc(oIdentifier)</td>
<td style="text-align:left">200.10.2.1</td>
<td style="text-align:left">mapFunc(mIdentifier)</td>
<td style="text-align:left">ICMP</td>
</tr>
</tbody>
</table>
<ul>
<li>当<code>ICMP Response</code>报文到达<code>NAT Gateway</code>的时候，会查找<code>dstIP</code>与<code>msrcIP</code>相同且<code>dstPort</code>（通过<code>mapFunc</code>计算<code>ICMP Response</code>中的<code>identifier</code>）与<code>msrcPort</code>相同的表项，并将<code>dstIP</code>替换成<code>osrcIP</code>，<code>identifier</code>替换成<code>mapFuncInv(osrcPort)</code>（DNAT）
<ul>
<li>其中，<code>mapFuncInv</code>表示从端口号转换为<code>identifier</code>的算法</li>
</ul>
</li>
</ul>
<h2 id="39-iptable命令使用"><a class="markdownIt-Anchor" href="#39-iptable命令使用"></a> 3.9 iptable命令使用</h2>
<p>参见<a href="/2017/08/15/Linux-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Linux-常用命令">Linux-常用命令</a></p>
<h2 id="310-参考"><a class="markdownIt-Anchor" href="#310-参考"></a> 3.10 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">A Deep Dive into Iptables and Netfilter Architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_33822516/article/details/81088724">ICMP报文如何通过NAT来地址转换</a></li>
<li><a target="_blank" rel="noopener" href="https://superuser.com/questions/662325/understanding-how-dnat-works-in-iptables">Understanding how dnat works in iptables</a></li>
<li><a target="_blank" rel="noopener" href="https://computer.howstuffworks.com/nat.htm">How Network Address Translation Works</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3022">Traditional IP Network Address Translator (Traditional NAT) - 4.1</a></li>
<li><a target="_blank" rel="noopener" href="http://asciiflow.com/">纯文本作图-asciiflow.com</a></li>
<li><a target="_blank" rel="noopener" href="http://arthurchiao.art/blog/conntrack-design-and-implementation-zh/">连接跟踪（conntrack）：原理、应用及 Linux 内核实现</a></li>
</ul>
<h1 id="4-tcpdump"><a class="markdownIt-Anchor" href="#4-tcpdump"></a> 4 tcpdump</h1>
<p>tcpdump是通过libpcap来抓取报文的，libpcap在不同平台有不同的实现，下面仅以Linux平台来作说明。</p>
<p>首先Linux平台在用户态获取报文的Mac地址等链路层信息并不是什么特殊的事情，通过AF_PACK套接字就可以实现，而tcpdump或libpcap也正是用这种方式抓取报文的(可以strace tcpdump的系统调用来验证)。关于AF_PACK的细节，可查看man 7 packet。</p>
<p>其次，上面已经提到tcpdumap使用的是AF_PACK套接字，不是Netfilter。使用Netfilter至少有2点不合理的地方：</p>
<ol>
<li>数据包进入Netfilter时其实已经在协议栈做过一些处理了，数据包可能已经发生一些改变了。比较明显的一个例子，进入Netfilter前需要重组分片，所以Netfilter中无法抓取到原始的报文分片。而在发送方向，报文离开Netfilter时也未完全结束协议栈的处理，所以抓取到的报文也会有不完整的可能。</li>
<li>在Netfilter抓取的报文，向用户态递送时也会较为复杂。Netfilter的代码处在中断上下文和进程上下文两种运行环境，无法使用传统系统调用，简单的做法就是使用Netlink。而这还不如直接用AF_PACKET抓取报文来得简单（对内核和用户态程序都是如此）。</li>
</ol>
<h2 id="41-参考"><a class="markdownIt-Anchor" href="#41-参考"></a> 4.1 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/41710052">tcpdump 抓包的原理？</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dongzhuangdian/p/5105844.html">NAT技术基本原理与应用</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sld880311/article/details/77650937">Linux-虚拟网络设备-veth pair</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009491002?utm_source=tag-newest">Linux虚拟网络设备之bridge(桥)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/52278720/answer/140914508">VLAN是二层技术还是三层技术？</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tcpdump.org/">tcpdump官网</a></li>
</ul>
<h1 id="5-网桥交换机集线器"><a class="markdownIt-Anchor" href="#5-网桥交换机集线器"></a> 5 网桥/交换机/集线器</h1>
<p><strong>集线器，交换机和网桥之间的主要区别在于：集线器工作在<code>OSI</code>模型的第<code>1</code>层，而网桥和交换机工作在第<code>2</code>层（使用MAC地址）。集线器在所有端口上广播传入的流量，而网桥和交换机仅将流量路由到目的端口（交换机上的端口）</strong></p>
<h2 id="51-什么是hub"><a class="markdownIt-Anchor" href="#51-什么是hub"></a> 5.1 什么是Hub</h2>
<p>集线器为每个设备提供专用的物理连接，这有助于减少一台计算机发生故障将导致所有计算机失去连接的可能性。但是，由于集线器仍是共享带宽的设备，因此连接仅限于半双工。冲突仍然是一个问题，因此集线器无助于提高网络性能</p>
<p>集线器本质上是多端口中继器。他们忽略了以太网帧的内容，只是简单地从集线器的每个接口中重新发送收到的每个帧。挑战在于，以太网帧将显示在连接到集线器的每个设备上，而不仅是预期的目的地（安全漏洞），而且入站帧通常会与出站帧发生冲突（性能问题）</p>
<h2 id="52-什么是bridge"><a class="markdownIt-Anchor" href="#52-什么是bridge"></a> 5.2 什么是Bridge</h2>
<p>在现实世界中，桥梁连接着河流或铁轨两侧的道路。<strong>在技术领域，网桥连接两个物理网段</strong>。每个网桥都跟踪连接到其每个接口的网络上的MAC地址。当网络流量到达网桥并且其目标地址在网桥的那一侧是本地的时，网桥会过滤该以太网帧，因此它仅停留在网桥的本地</p>
<p>如果网桥无法在接收流量的那一侧找到目标地址，它将跨网桥转发帧，希望目的地在另一个网段上。有时，到达目标地址需要经过多个网桥</p>
<p>最大的挑战是广播和多播流量必须在每个网桥之间转发，因此每个设备都有机会读取这些消息。如果网络管理器构建了冗余电路，通常会导致广播或多播流量泛滥，从而阻止单播流量</p>
<h2 id="53-什么是switch"><a class="markdownIt-Anchor" href="#53-什么是switch"></a> 5.3 什么是Switch</h2>
<p>交换机在将数据从一台设备移动到另一台设备中起着至关重要的作用。具体而言，与集线器相比，交换机通过为每个终端设备提供专用带宽，支持全双工连接，利用MAC地址表来做出转发决策以及利用<code>ASIC</code>和<code>CAM</code>表来提高帧速率，从而大大提高了网络性能</p>
<p>交换机会充分利用集线器和桥接器的功能，同时增加更多功能。他们将集线器的多端口功能与网桥过滤一起使用，仅允许目的地查看单播流量。交换机允许冗余链接，并且由于为网桥开发了生成树协议（STP），因此广播和多播的运行不会引起风暴</p>
<p>交换机会跟踪每个接口中的MAC地址，因此它们可以将流量仅快速发送到帧的目的地</p>
<p>这是使用交换机的一些好处：</p>
<ol>
<li>交换机是即插即用设备。一旦第一个数据包到达，他们便开始学习接口或端口以到达所需的地址</li>
<li>交换机通过仅将流量发送到目标设备来提高安全性</li>
<li>交换机提供了一种简单的方法来连接以不同速度运行的网段，例如<code>10 Mbps</code>，<code>100 Mbps</code>，<code>1 Gigabit</code>以及<code>10 Gigabit</code>网络</li>
<li>交换机使用特殊的芯片在硬件中做出决定，从而降低了处理延迟并提高了性能</li>
<li>交换机正在取代网络内部的路由器，因为它们在以太网网络上转发帧的速度快10倍以上</li>
</ol>
<h2 id="54-参考"><a class="markdownIt-Anchor" href="#54-参考"></a> 5.4 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.globalknowledge.com/us-en/resources/resource-library/articles/what-s-the-difference-between-hubs-switches-bridges/">What’s the Difference Between Hubs, Switches &amp; Bridges?</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/dataiyangu/article/details/82496340">集线器、交换机、网桥区别</a></li>
</ul>
<h1 id="6-虚拟机的网络模式"><a class="markdownIt-Anchor" href="#6-虚拟机的网络模式"></a> 6 虚拟机的网络模式</h1>
<h2 id="61-network-address-translation-nat"><a class="markdownIt-Anchor" href="#61-network-address-translation-nat"></a> 6.1 Network Address Translation (NAT)</h2>
<p>在NAT模式下，当一个VM操作系统启动时，它通常通过发送一个<code>DHCP Request</code>来获取一个<code>IP</code>地址。<code>VirtualBox</code>将会处理这个<code>DHCP Request</code>，然后返回一个<code>DHCP Response</code>给VM，这个<code>DHCP Response</code>包含了一个<code>IP</code>地址以及网关地址，其中网关地址用于路由<code>Outbound connections</code></p>
<p>在这种模式下，每一个VM被分配到的都是一个相同的IP（<code>10.0.2.15</code>），因为每一个VM都认为他们处于一个隔离的网络中，也就是说不同的VM之间无法感知到对方的存在</p>
<p>当VM通过网关（<code>10.0.2.2</code>）发送流量时，<code>VirtualBox</code>会重写数据包，使其看起来好像来自主机，而不是来自VM（在主机内运行）</p>
<p>逻辑上，网络看起来像下面这样</p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/vm_nat.png" alt="vm_nat" /></p>
<p>总结一下，NAT包含如下特征</p>
<ol>
<li>VM处于一个私有的局域网</li>
<li><code>VirtualBox</code>扮演着<code>DHCP</code>服务器的角色</li>
<li><code>VirtualBox Engine</code>起到转换地址的作用</li>
<li>适用于当VM作为Client的场景，因此不是适用于VM作为Server的场景</li>
<li>VM可以访问外界网络，而外界网络无法访问VM</li>
</ol>
<h2 id="62-bridged-networking"><a class="markdownIt-Anchor" href="#62-bridged-networking"></a> 6.2 Bridged Networking</h2>
<p>当您希望您的VM成为完整的网络公民，即与网络上的主机相同时，使用<code>Bridged Networking</code>；在此模式下，虚拟NIC“桥接”到主机上的物理网卡</p>
<p>这样做的结果是每个VM都可以像访问主机一样访问物理网络。它可以像访问主机一样访问网络上的任何服务，例如外部DHCP服务，名称查找服务和路由信息</p>
<p>逻辑上，网络看起来像下面这样</p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/vm_bridge.png" alt="vm_bridge" /></p>
<p>总结一下，<code>Bridged Networking</code>网络包含如下特征</p>
<ol>
<li><code>VirtualBox</code>桥接到主机网络</li>
<li>会消耗IP地址</li>
<li>适用于Client VM或Server VM</li>
</ol>
<h2 id="63-internal-networking"><a class="markdownIt-Anchor" href="#63-internal-networking"></a> 6.3 Internal Networking</h2>
<p><code>Internal Networking</code>网络（在本例中为“intnet”）是一个完全隔离的网络，因此非常“安静”。当您需要一个单独的，干净的网络时，这适用于测试，您可以使用VM创建复杂的内部网络，为内部网络提供自己的服务。（例如Active Directory，DHCP等）。<strong>请注意，即使主机也不是内部网络的成员</strong>，但即使主机未连接到网络（例如，在平面上），此模式也允许VM运行</p>
<p>逻辑上，网络看起来像下面这样</p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/vm_internel.png" alt="vm_internel" /></p>
<p>请注意，在此模式下，<code>VirtualBox</code>不提供<code>DHCP</code>等“便利”服务，因此必须静态配置您的计算机，或者VM需要提供<code>DHCP</code>/名称服务</p>
<p>总结一下，<code>Internal Networking</code>网络包含如下特征</p>
<ol>
<li>不同VM之间处于同一个私有网络</li>
<li>VM无法访问外部网络</li>
<li>宿主机断网时，VM也能正常工作（本来就不需要外网）</li>
</ol>
<h2 id="64-host-only-networking"><a class="markdownIt-Anchor" href="#64-host-only-networking"></a> 6.4 Host-only Networking</h2>
<p>坐在这个“vboxnet0”网络上的所有VM都会看到对方，此外，主机也可以看到这些VM。但是，其他外部计算机无法在此网络上看到VM，因此名称为“Host-only”</p>
<p>逻辑上，网络看起来像下面这样</p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/vm_host_only.png" alt="vm_host_only" /></p>
<p>这看起来非常类似于<code>Internal Networking</code>，但主机现在位于“vboxnet0”并且可以提供<code>DHCP</code>服务</p>
<p>总结一下，<code>Host-only Networking</code>网络包含如下特征</p>
<ol>
<li><code>VirtualBox</code>为VM以及宿主机创建了一个私有网络</li>
<li><code>VirtualBox</code>提供DHCP服务</li>
<li>VM无法看到外部网络</li>
<li>宿主机断网时，VM也能正常工作（本来就不需要外网）</li>
</ol>
<h2 id="65-port-forwarding-with-nat-networking"><a class="markdownIt-Anchor" href="#65-port-forwarding-with-nat-networking"></a> 6.5 Port-Forwarding with NAT Networking</h2>
<p>如果您在笔记本电脑上购买移动演示或开发环境并且您有一台或多台VM需要其他机器连接，该怎么办？而且你不断地跳到不同的VM网络上。在这样的场景下</p>
<ol>
<li>NAT：无法满足，因为外部机器无法连接到VM上</li>
<li>Bridged：可以满足，但是会消耗IP资源，且VM网络环境随着外部网络环境的改变而改变</li>
<li>Internal：无法满足，因为外部机器无法连接到VM上</li>
<li>Host-only：无法满足，因为外部机器无法连接到VM上</li>
</ol>
<p>当外部机器连接到宿主机的“host:port”时，<code>VirtualBox</code>会将连接<code>forward</code>到VM的“guest:port”上</p>
<p>逻辑上，网络看起来像下面这样（forward并没有在这张图体现出来，所以这幅图与NAT很像）</p>
<p><img src="/images/Linux-%E7%BD%91%E7%BB%9C/vm_nat_forwarding.png" alt="vm_nat_forwarding" /></p>
<h2 id="66-参考"><a class="markdownIt-Anchor" href="#66-参考"></a> 6.6 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://blogs.oracle.com/scoter/networking-in-virtualbox-v2">Oracle VM VirtualBox: Networking options and how-to manage them</a></li>
<li><a target="_blank" rel="noopener" href="https://www.virtualbox.org/manual/ch06.html#network_bridged">Chapter 6. Virtual networking</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2016-09/135521.htm">VMware虚拟机三种网络模式详解</a></li>
</ul>
<h1 id="7-配网"><a class="markdownIt-Anchor" href="#7-配网"></a> 7 配网</h1>
<h2 id="71-配置文件"><a class="markdownIt-Anchor" href="#71-配置文件"></a> 7.1 配置文件</h2>
<p><code>CentOS</code>的网卡配置文件的位置在<code>/etc/sysconfig/network-scripts/</code>，配置文件的名称为<code>ifcfg-&lt;网卡名&gt;</code>，例如网卡名为<code>eno1</code>时，配置文件名称为<code>ifcfg-eno1</code>。示例配置如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPADDR=10.0.2.20</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.0.2.2</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=enp0s3</span><br><span class="line">UUID=08f8a712-444c-4906-9a94-c9fcf4987d3d</span><br><span class="line">DEVICE=enp0s3</span><br><span class="line">ONBOOT=yes</span><br><span class="line">DNS1=223.5.5.5</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>BOOTPROTO</code></strong>：可选项有<code>static</code>或<code>dhcp</code></li>
<li><strong><code>DEFROUTE</code></strong>：是否生成default路由，注意，一台机器只能有一个网卡可以设置默认路由，否则即便有多个默认路由，第二个默认路由也是无效的</li>
<li><strong><code>IPADDR</code></strong>：ip地址</li>
<li><strong><code>NETMASK</code></strong>：子网掩码</li>
<li><strong><code>GATEWAY</code></strong>：网关ip</li>
<li><strong><code>ONBOOT</code></strong>：是否开机启动</li>
<li><strong><code>DNS1/DNS2/.../DNSx</code></strong>：dns配置</li>
</ul>
<h2 id="72-network-manager"><a class="markdownIt-Anchor" href="#72-network-manager"></a> 7.2 network-manager</h2>
<p><code>NetworkManager</code>是Linux下管理网络的一个服务，此外还有另一个服务<code>network</code>（这个服务已经过时，且与<code>NetworkManager</code>存在冲突</p>
<p><code>NetworkManager</code>服务提供了两个客户端用于网络配置，分别是<code>nmcli</code>以及<code>nmtui</code></p>
<h3 id="721-设计"><a class="markdownIt-Anchor" href="#721-设计"></a> 7.2.1 设计</h3>
<p>在<code>NetworkManager</code>的设计中，存在两种概念，一个是网卡设备<code>device</code>，另一个是连接<code>conn</code>，一个<code>device</code>可以对应多个<code>conn</code>，但是这个多个<code>conn</code>中只有一个是开启状态。如何控制<code>conn</code>的启动优先级呢？可以通过设置<code>connection.autoconnect-priority</code></p>
<h3 id="722-nmcli"><a class="markdownIt-Anchor" href="#722-nmcli"></a> 7.2.2 nmcli</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有网络连接</span></span><br><span class="line">nmcli con show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定网络连接（可以看到所有属性）</span></span><br><span class="line">nmcli conn show &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定网络连接（可以看到所有属性，且有分隔符区分不同类型的配置项）</span></span><br><span class="line">nmcli -p conn show &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络设备</span></span><br><span class="line">nmcli device status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络设备的详细配置</span></span><br><span class="line">nmcli device show</span><br><span class="line">nmcli -p device show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入交互的编辑模式</span></span><br><span class="line">nmcli conn edit &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加网络配置</span></span><br><span class="line">nmcli conn add con-name &lt;conn name&gt; <span class="built_in">type</span> &lt;net <span class="built_in">type</span>&gt; ifname &lt;<span class="keyword">if</span> name&gt; -- ipv4.address &lt;ip/netmask&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改某个配置值</span></span><br><span class="line">nmcli conn modify &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt; ipv4.address &lt;ip/netmask&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用/停用conn</span></span><br><span class="line">nmcli conn up &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt;</span><br><span class="line">nmcli conn down &lt;id&gt;/&lt;uuid&gt;/&lt;path&gt;</span><br></pre></td></tr></table></figure>
<p><strong>重要配置项</strong></p>
<ol>
<li><code>ipv4.never-default</code>：<code>1</code>表示永远不设置为默认路由，<code>0</code>反之
<ul>
<li><code>nmcli conn modify eno1 ipv4.never-defaul 1</code>：连接<code>eno1</code>永远不设置默认路由</li>
</ul>
</li>
<li><code>connection.autoconnect-priority</code>：当一个网卡设备，包含多个<code>conn</code>时，且<code>connection.autoconnect</code>的值都是<code>1</code>（即默认开启）时，可以通过设置该值来改变<code>conn</code>的优先级，优先级高的<code>conn</code>将会生效</li>
</ol>
<h3 id="723-nmtui"><a class="markdownIt-Anchor" href="#723-nmtui"></a> 7.2.3 nmtui</h3>
<p>带有图形化界面的配网工具</p>
<h3 id="724-配置文件"><a class="markdownIt-Anchor" href="#724-配置文件"></a> 7.2.4 配置文件</h3>
<p>路径：<code>/etc/NetworkManager/NetworkManager.conf</code></p>
<p>配置文件详细内容参考<a target="_blank" rel="noopener" href="https://developer.gnome.org/NetworkManager/stable/NetworkManager.conf.html">NetworkManager.conf</a></p>
<h3 id="725-网卡配置文件"><a class="markdownIt-Anchor" href="#725-网卡配置文件"></a> 7.2.5 网卡配置文件</h3>
<p><strong><code>CentOS</code></strong></p>
<ul>
<li>与<code>network</code>共用同一套配置文件，目录是：<code>/etc/sysconfig/network-scripts/</code></li>
<li>文件名：<code>ifcfg-&lt;conn name&gt;</code></li>
</ul>
<p><strong><code>ubuntu</code></strong></p>
<ul>
<li>目录是：<code>/etc/NetworkManager/system-connections</code></li>
<li>文件名：以<code>&lt;conn name&gt;</code>作为文件名</li>
</ul>
<h2 id="73-参考"><a class="markdownIt-Anchor" href="#73-参考"></a> 7.3 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/NetworkManager">NetworkManager官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/networking_guide/index">为 Red Hat Enterprise Linux 7 配置和管理联网</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/Fedora/25/html/Networking_Guide/index.html">Networking Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/Fedora/25/html/Networking_Guide/sec-Connecting_to_a_Network_Using_nmcli.html">Connecting to a Network Using nmcli</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/43556975">Linux DNS 查询剖析（第三部分）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/361111920/answer/1861488526">一台主机上只能保持最多 65535 个 TCP 连接吗？</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%91%98%E5%BD%95/" rel="tag"># 摘录</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/07/20/Linux-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" rel="prev" title="Linux-常用工具">
      <i class="fa fa-chevron-left"></i> Linux-常用工具
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/07/25/Kubernetes-Concept/" rel="next" title="Kubernetes-Concept">
      Kubernetes-Concept <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY0My8xMDE5OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C%E5%8F%82%E6%95%B0"><span class="nav-text"> 1 系统网络参数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-virtual-networking"><span class="nav-text"> 2 Virtual Networking</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-bridge"><span class="nav-text"> 2.1 bridge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-bonded-interface"><span class="nav-text"> 2.2 bonded interface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-team-device"><span class="nav-text"> 2.3 team device</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-vlanvirtual-lan"><span class="nav-text"> 2.4 vlan（virtual lan）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#25-vxlanvirtual-extensible-lan"><span class="nav-text"> 2.5 vxlan（virtual extensible lan）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#26-macvlan"><span class="nav-text"> 2.6 macvlan</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#261-private-mode"><span class="nav-text"> 2.6.1 private mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#262-bridge-mode"><span class="nav-text"> 2.6.2 bridge mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#263-vepa-mode"><span class="nav-text"> 2.6.3 vepa mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#264-passthru-mode"><span class="nav-text"> 2.6.4 passthru mode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#27-ipvlan"><span class="nav-text"> 2.7 ipvlan</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#271-l2-mode"><span class="nav-text"> 2.7.1 l2 mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#272-l3-mode"><span class="nav-text"> 2.7.2 l3 mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#273-l3s-mode"><span class="nav-text"> 2.7.3 l3s mode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#28-macvtapipvtap"><span class="nav-text"> 2.8 macvtap&#x2F;ipvtap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#29-macsec"><span class="nav-text"> 2.9 macsec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#210-vethvirtual-ethernet"><span class="nav-text"> 2.10 veth（virtual ethernet）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#211-vcanvirtual-can"><span class="nav-text"> 2.11 vcan（virtual can）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#212-vxcanvirtual-can-tunnel"><span class="nav-text"> 2.12 vxcan（virtual can tunnel）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#213-ipoibip-over-infiniband"><span class="nav-text"> 2.13 ipoib（ip-over-infiniBand）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#214-nlmonnetlink-monitor"><span class="nav-text"> 2.14 nlmon（netlink monitor）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#215-dummy-interface"><span class="nav-text"> 2.15 dummy interface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#216-ifbintermediate-functional-block"><span class="nav-text"> 2.16 ifb（intermediate functional block）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#217-netdevsim"><span class="nav-text"> 2.17 netdevsim</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#218-%E5%8F%82%E8%80%83"><span class="nav-text"> 2.18 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-netfilter"><span class="nav-text"> 3 Netfilter</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#31-netfilter-hooks"><span class="nav-text"> 3.1 Netfilter Hooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-iptables-tables-and-chains"><span class="nav-text"> 3.2 IPTables Tables and Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#33-which-tables-are-available"><span class="nav-text"> 3.3 Which Tables are Available?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#331-the-filter-table"><span class="nav-text"> 3.3.1 The Filter Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#332-the-nat-table"><span class="nav-text"> 3.3.2 The NAT Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#333-the-mangle-table"><span class="nav-text"> 3.3.3 The Mangle Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#334-the-raw-table"><span class="nav-text"> 3.3.4 The Raw Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#335-the-security-table"><span class="nav-text"> 3.3.5 The Security Table</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#34-which-chains-are-implemented-in-each-table"><span class="nav-text"> 3.4 Which Chains are Implemented in Each Table?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#35-iptables-rules"><span class="nav-text"> 3.5 IPTables Rules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#36-jumping-to-user-defined-chains"><span class="nav-text"> 3.6 Jumping to User-Defined Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#37-iptables-and-connection-tracking"><span class="nav-text"> 3.7 IPTables and Connection Tracking</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3701-conntrack"><span class="nav-text"> 3.7.0.1 conntrack</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#38-nat%E5%8E%9F%E7%90%86"><span class="nav-text"> 3.8 NAT原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#39-iptable%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8"><span class="nav-text"> 3.9 iptable命令使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#310-%E5%8F%82%E8%80%83"><span class="nav-text"> 3.10 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-tcpdump"><span class="nav-text"> 4 tcpdump</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-%E5%8F%82%E8%80%83"><span class="nav-text"> 4.1 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E7%BD%91%E6%A1%A5%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%9B%86%E7%BA%BF%E5%99%A8"><span class="nav-text"> 5 网桥&#x2F;交换机&#x2F;集线器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#51-%E4%BB%80%E4%B9%88%E6%98%AFhub"><span class="nav-text"> 5.1 什么是Hub</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-%E4%BB%80%E4%B9%88%E6%98%AFbridge"><span class="nav-text"> 5.2 什么是Bridge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-%E4%BB%80%E4%B9%88%E6%98%AFswitch"><span class="nav-text"> 5.3 什么是Switch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-%E5%8F%82%E8%80%83"><span class="nav-text"> 5.4 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text"> 6 虚拟机的网络模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#61-network-address-translation-nat"><span class="nav-text"> 6.1 Network Address Translation (NAT)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#62-bridged-networking"><span class="nav-text"> 6.2 Bridged Networking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#63-internal-networking"><span class="nav-text"> 6.3 Internal Networking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#64-host-only-networking"><span class="nav-text"> 6.4 Host-only Networking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#65-port-forwarding-with-nat-networking"><span class="nav-text"> 6.5 Port-Forwarding with NAT Networking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#66-%E5%8F%82%E8%80%83"><span class="nav-text"> 6.6 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E9%85%8D%E7%BD%91"><span class="nav-text"> 7 配网</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#71-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text"> 7.1 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#72-network-manager"><span class="nav-text"> 7.2 network-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#721-%E8%AE%BE%E8%AE%A1"><span class="nav-text"> 7.2.1 设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#722-nmcli"><span class="nav-text"> 7.2.2 nmcli</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#723-nmtui"><span class="nav-text"> 7.2.3 nmtui</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#724-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text"> 7.2.4 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#725-%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text"> 7.2.5 网卡配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#73-%E5%8F%82%E8%80%83"><span class="nav-text"> 7.3 参考</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liuyehcf"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Liuyehcf</p>
  <div class="site-description" itemprop="description">大音希声，大象无形</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">324</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuyehcf</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qhEhLuMeMOy1zgcBhkqUS6P8-gzGzoHsz',
      appKey     : 'uhkruDLNLNdL5rQjRBY2X9Ke',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
