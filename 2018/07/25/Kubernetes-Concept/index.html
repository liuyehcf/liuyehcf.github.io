<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="阅读更多">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes-Concept">
<meta property="og:url" content="http://example.com/2018/07/25/Kubernetes-Concept/index.html">
<meta property="og:site_name" content="Liuye Notebook">
<meta property="og:description" content="阅读更多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Kubernetes-Concept/ccm_1.png">
<meta property="og:image" content="http://example.com/images/Kubernetes-Concept/ccm_2.png">
<meta property="og:image" content="http://example.com/images/Kubernetes-Concept/proxy-mode-userspace.svg">
<meta property="og:image" content="http://example.com/images/Kubernetes-Concept/proxy-mode-iptables.svg">
<meta property="og:image" content="http://example.com/images/Kubernetes-Concept/proxy-mode-ipvs.svg">
<meta property="article:published_time" content="2018-07-25T02:07:12.000Z">
<meta property="article:modified_time" content="2024-03-18T13:37:51.000Z">
<meta property="article:author" content="Liuyehcf">
<meta property="article:tag" content="摘录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Kubernetes-Concept/ccm_1.png">

<link rel="canonical" href="http://example.com/2018/07/25/Kubernetes-Concept/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kubernetes-Concept | Liuye Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liuye Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-explore">

    <a href="/explore/" rel="section"><i class="fa fa-sitemap fa-fw"></i>发现</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/07/25/Kubernetes-Concept/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Liuyehcf">
      <meta itemprop="description" content="大音希声，大象无形">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuye Notebook">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes-Concept
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-25 10:07:12" itemprop="dateCreated datePublished" datetime="2018-07-25T10:07:12+08:00">2018-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-18 21:37:51" itemprop="dateModified" datetime="2024-03-18T21:37:51+08:00">2024-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          
            <span id="/2018/07/25/Kubernetes-Concept/" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes-Concept" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/07/25/Kubernetes-Concept/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/07/25/Kubernetes-Concept/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>阅读更多</strong></p>
<span id="more"></span>
<h1 id="1-overview"><a class="markdownIt-Anchor" href="#1-overview"></a> 1 Overview</h1>
<h2 id="11-kubernetes-components"><a class="markdownIt-Anchor" href="#11-kubernetes-components"></a> 1.1 Kubernetes Components</h2>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/">Kubernetes Components</a></p>
<h3 id="111-master-components"><a class="markdownIt-Anchor" href="#111-master-components"></a> 1.1.1 Master Components</h3>
<p><code>Master Component</code>构成了集群的控制面板。<code>Master Component</code>是整个集群的决策者，检测并响应集群消息</p>
<p><code>Master Component</code>可以运行在集群中的任意一台机器上，不要在<code>Master</code>机器上运行<code>User Container</code></p>
<h4 id="1111-kube-apiserver"><a class="markdownIt-Anchor" href="#1111-kube-apiserver"></a> 1.1.1.1 kube-apiserver</h4>
<p><code>kube-apiserver</code>是整个控制面板的最前端，将<code>Master Component</code>通过<code>Kubernetes API</code>露出，它被设计成易于水平扩展</p>
<h4 id="1112-etcd"><a class="markdownIt-Anchor" href="#1112-etcd"></a> 1.1.1.2 etcd</h4>
<p><code>etcd</code>是高一致性、高可用的<code>key-value</code>存储，用于存储<code>Kubernetes</code>所有的集群数据</p>
<h4 id="1113-kube-shceduler"><a class="markdownIt-Anchor" href="#1113-kube-shceduler"></a> 1.1.1.3 kube-shceduler</h4>
<p><code>kube-shceduler</code>会观测新创建且尚未被分配的<code>Pod</code>，并为其选择一个<code>Node</code>来运行</p>
<h4 id="1114-kube-controller-manager"><a class="markdownIt-Anchor" href="#1114-kube-controller-manager"></a> 1.1.1.4 kube-controller-manager</h4>
<p><code>kube-controller-manager</code>用于在<code>Master</code>上运行<code>Controller</code>。逻辑上讲，每个<code>Controller</code>都是一个独立的进程，但是为了减小实现复杂度，这些被编译进了一个二进制中，运行在同一个进程中</p>
<p><code>Controller</code>包括</p>
<ol>
<li><code>Node Controller</code>: 观测节点，并在节点退出集群时响应</li>
<li><code>Replication Controller</code>: 为系统中每个<code>Replication Controller Object</code>保持一定数量的<code>Pod</code></li>
<li><code>Endpoints Controller</code>:</li>
<li><code>Service Account &amp; Token Controller</code>: 为新<code>Namespace</code>创建默认的账号以及API访问的<code>token</code></li>
</ol>
<h4 id="1115-cloud-controller-manager"><a class="markdownIt-Anchor" href="#1115-cloud-controller-manager"></a> 1.1.1.5 cloud-controller-manager</h4>
<h3 id="112-node"><a class="markdownIt-Anchor" href="#112-node"></a> 1.1.2 Node</h3>
<p><code>Node component</code>运行在每个<code>Node</code>之上，保持<code>Pod</code>的运行，并提供<code>Kubernetes</code>运行环境</p>
<h4 id="1121-kubelet"><a class="markdownIt-Anchor" href="#1121-kubelet"></a> 1.1.2.1 kubelet</h4>
<p><code>kubelet</code>是运行在集群的每个<code>Node</code>上的代理。它确保<code>Container</code>在<code>Pod</code>中正常运行</p>
<p><code>kubelet</code>采用通过各种机制提供的<code>PodSpecs</code>来确保<code>Container</code>以期望的方式健康运行</p>
<p><code>kubelet</code>不会管理不由<code>Kubernetes</code>创建的<code>Container</code></p>
<h4 id="1122-kube-proxy"><a class="markdownIt-Anchor" href="#1122-kube-proxy"></a> 1.1.2.2 kube-proxy</h4>
<p><code>kube-proxy</code>通过维护网络规则并转发网络数据包，来支持<code>Kubernetes Service</code>的抽象机制</p>
<h4 id="1123-container-runtime"><a class="markdownIt-Anchor" href="#1123-container-runtime"></a> 1.1.2.3 Container Runtime</h4>
<p><code>Kubernetes</code>支持多种运行时</p>
<ol>
<li><code>Docker</code></li>
<li><code>rkt</code></li>
<li><code>runc</code></li>
</ol>
<h3 id="113-addons"><a class="markdownIt-Anchor" href="#113-addons"></a> 1.1.3 Addons</h3>
<p>???</p>
<h3 id="114-参考"><a class="markdownIt-Anchor" href="#114-参考"></a> 1.1.4 参考</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/">Kubernetes Components</a></li>
</ul>
<h2 id="12-kubernetes-object"><a class="markdownIt-Anchor" href="#12-kubernetes-object"></a> 1.2 Kubernetes Object</h2>
<p><code>Kubernetes Object</code>作为持久化的实体，存在于<code>Kubernetes</code>系统中，<code>Kubernetes</code>用这些实体来表示集群的状态，具体来说</p>
<ol>
<li>运行着什么容器化的应用程序</li>
<li>可以使用的资源清单</li>
<li>应用程序的策略，包括重启策略、更新、容错等</li>
</ol>
<p>一个<code>Kubernetes Object</code>用于记录我们的意图，一旦我们创建了一个<code>Kubernetes Object</code>，那么<code>Kubernetes</code>系统就会努力保证对象的存活，并朝着我们预期的状态推进。换言之，创建一个<code>Kubernetes Object</code>，意味着告诉<code>Kubernetes</code>系统，我们期望它以何种方式运行</p>
<p>我们必须通过<code>Kubernetes API</code>来使用<code>Kubernetes Object</code>，包括创建、修改、删除等。我们也可以使用<code>kubectl</code>命令行工具，本质上，<code>kubectl</code>为我们封装了一个或多个<code>Kubernetes API</code>的调用。</p>
<p>每个<code>Kubernetes Object</code>都至少包含两个<code>object field</code>，即<code>spec</code>以及<code>status</code></p>
<ul>
<li><code>spec</code>：描述了<code>Kubernetes Object</code>的期望状态</li>
<li><code>status</code>：描述了<code>Kubernetes Object</code>的实际状态，这个状态由<code>Kubernetes system</code>更新</li>
</ul>
<p>当我们需要创建一个<code>Kubernetes Object</code>时，我们需要提供<code>spec</code>来描述这个<code>Kubernetes Object</code>的期望状态，同时，还需要提供一些基本的信息来描述这个<code>Kubernetes Object</code>，例如<code>name</code>等。当我们利用<code>Kubernetes API</code>来创建<code>object</code>时，<code>API request</code>中的<code>request body</code>必须包含这些信息。通常我们将这些信息记录在<code>.ymal</code>文件中，并将文件作为参数传递给<code>Kubernetes API</code></p>
<p><strong>注意，一个<code>.yaml</code>文件中，必须包含如下字段</strong></p>
<ol>
<li><code>apiVersion</code>：指定<code>Kubernetes API</code>的版本</li>
<li><code>kind</code>：指定待创建<code>object</code>的类型</li>
<li><code>metadata</code>：<code>object</code>的元数据，包括
<ul>
<li><code>name</code></li>
<li><code>UID</code></li>
<li><code>namespace</code></li>
</ul>
</li>
</ol>
<h3 id="121-name"><a class="markdownIt-Anchor" href="#121-name"></a> 1.2.1 Name</h3>
<p>所有的<code>Kubernetes Object</code>都用一个<code>Name</code>和一个<code>UID</code>精确确定</p>
<h4 id="1211-nmaes"><a class="markdownIt-Anchor" href="#1211-nmaes"></a> 1.2.1.1 Nmaes</h4>
<p><code>Names</code>是一种用户提供的字符串，表示了一个资源的路径，例如<code>/api/v1/pods/some-name</code></p>
<p>在同一时刻，可以为同一种类型的<code>Kubernetes Object</code>分配一个名字。当然，如果我们删除了这个<code>Kubernetes Object</code>，我们还可以创建一个同名的<code>Kubernetes Object</code></p>
<p>通常，<code>Name</code>最大不超过253个字符，只允许包含小写的字母以及<code>-</code>和<code>.</code>，具体的类型可能还有更加严格的限制</p>
<h4 id="1212-uids"><a class="markdownIt-Anchor" href="#1212-uids"></a> 1.2.1.2 UIDs</h4>
<p><code>UID</code>是<code>Kubernetes</code>系统创建的用于唯一标志<code>Kubernetes Object</code>的字符串。每个<code>Kubernetes Object</code>在整个生命周期中都会有一个唯一的<code>UID</code>，将<code>Kubernetes Object</code>先删除再重新创建，会得到一个新的<code>UID</code></p>
<h3 id="122-namespaces"><a class="markdownIt-Anchor" href="#122-namespaces"></a> 1.2.2 Namespaces</h3>
<p><code>Kubernetes</code>支持同一个物理集群支持多个虚拟集群，这些虚拟集群被称为<code>Namespaces</code>。如果一个<code>Kubernetes</code>集群仅有数十个用户，那么我们完全不必考虑使用<code>Namespaces</code></p>
<h4 id="1221-when-to-use-multiple-namespaces"><a class="markdownIt-Anchor" href="#1221-when-to-use-multiple-namespaces"></a> 1.2.2.1 When to use Multiple Namespaces</h4>
<p><code>Namespaces</code>用于为使用同一集群的多个不同的小组、项目提供一定程度的隔离</p>
<p>在同一个<code>Namespaces</code>中的资源的名称必须唯一，但是在不同<code>Namespaces</code>中的资源名称可以重复</p>
<p>如果仅仅为了隔离资源，例如同一个软件的不同版本，可以使用<code>Label</code>而不需要使用<code>Namespaces</code></p>
<h4 id="1222-working-with-namespaces"><a class="markdownIt-Anchor" href="#1222-working-with-namespaces"></a> 1.2.2.2 Working with Namespaces</h4>
<p>可以通过如下命令查看系统中的<code>Namespaces</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get namespaces</span><br></pre></td></tr></table></figure>
<p><code>Kubernetes</code>默认包含三个<code>Namespaces</code></p>
<ol>
<li><code>default</code>: 在未指定<code>Namespace</code>时，<code>Kubernetes Object</code>默认属于这个<code>Namespace</code></li>
<li><code>kube-system</code>: 由<code>Kubernetes</code>系统创建的<code>Kubernetes Object</code>所属的<code>Namespace</code></li>
<li><code>kube-public</code>: 该<code>Namespace</code>对所有的用户可见，通常用于共享一些资源</li>
</ol>
<p>在使用<code>kubectl</code>时，我们可以加上<code>--namespace</code>来暂时指定<code>Namespace</code></p>
<p>我们可以为<code>kubectl</code>设定<code>Namespace</code>上下文，后续所有的命令都默认指定该<code>Namespace</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context $(kubectl config current-context) --namespace=&lt;insert-namespace-name-here&gt;</span><br><span class="line"><span class="comment"># Validate it</span></span><br><span class="line">kubectl config view | grep namespace:</span><br></pre></td></tr></table></figure>
<h4 id="1223-namespaces-and-dns未完成"><a class="markdownIt-Anchor" href="#1223-namespaces-and-dns未完成"></a> 1.2.2.3 Namespaces and DNS（未完成）</h4>
<p>当我们创建一个<code>Service</code>，它会创建一个相关的<code>DNS entry</code>，其格式为<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code></p>
<h4 id="1224-not-all-objects-are-in-a-namespace"><a class="markdownIt-Anchor" href="#1224-not-all-objects-are-in-a-namespace"></a> 1.2.2.4 Not All Objects are in a Namespace</h4>
<p>大部分<code>Kubernetes</code>资源位于一个<code>Namespace</code>中。某些底层次的资源，例如<code>Node</code>以及<code>PersistentVolume</code>不属于任何<code>Namespace</code></p>
<p>以下命令用于查看哪些资源位于/不位于<code>Namespace</code>中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In a namespace</span></span><br><span class="line">kubectl api-resources --namespaced=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Not in a namespace</span></span><br><span class="line">kubectl api-resources --namespaced=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="123-labels-and-selectors"><a class="markdownIt-Anchor" href="#123-labels-and-selectors"></a> 1.2.3 Labels and Selectors</h3>
<p><code>Labels</code>是一些依附在<code>Kubernetes Object</code>上的键值对。<code>Lebels</code>用于为一些对用户有特殊意义的<code>Kubernetes Object</code>打标，这些标在<code>Kubernetes</code>内核中并无其他含义。<code>Label</code>用于组织和选择<code>Kubernetes Object</code>。我们可以再任何时刻为<code>Kubernetes Object</code>打上<code>Label</code>。对于一个<code>Kubernetes Object</code>来说，<code>key</code>必须是唯一的</p>
<h4 id="1231-motivation"><a class="markdownIt-Anchor" href="#1231-motivation"></a> 1.2.3.1 Motivation</h4>
<p><code>Lebal</code>允许用户以一种松耦合的方式将组织结构与<code>Kubernetes Object</code>关联起来，用户不必自己存储这些映射关系</p>
<p>服务部署以及一些批处理流水线通常是一个多维度的实体，通常需要交叉式的管理，这会破坏层次结构的严格封装，通常这些封装是由基础设施而非用户完成的</p>
<h4 id="1232-label-selectors"><a class="markdownIt-Anchor" href="#1232-label-selectors"></a> 1.2.3.2 Label selectors</h4>
<p>与<code>Name</code>与<code>UID</code>不同，<code>Label</code>并不需要保证唯一性。而且，在通常情况下，我们期望多个<code>Kubernetes Object</code>共享同一个<code>Label</code></p>
<p>通过<code>Label Selector</code>，用户/客户端就可以识别出这些<code>Kubernetes Object</code>，因此<code>Label Selector</code>是<code>Kubernetes</code>管理这些对象的核心</p>
<p>目前，<code>Kubernetes</code>支持两种类型的<code>Selector</code>：<code>equality-based</code>和<code>set-based</code>。<code>Label Selector</code>由多个<code>requirement</code>组成，以逗号分隔，多个<code>requirement</code>之间的关系是逻辑与<code>&amp;&amp;</code>。<strong>这两种类型可以混用</strong></p>
<p><code>Equality-based requirement</code>允许通过<code>Label key</code>以及<code>Label value</code>进行过滤，允许的比较操作包括：<code>=</code>、<code>==</code>、<code>!=</code>，其中<code>=</code>与<code>==</code>都表示相等型比较</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">environment = production</span><br><span class="line">tier != frontend</span><br><span class="line">environment = production, tier != frontend</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个规则表示：匹配<code>key</code>等于<code>environment</code>且<code>value</code>等于<code>production</code>的所有<code>Kubernetes Object</code></li>
<li>第二个规则表示：匹配<code>key</code>等于<code>tier</code>且<code>value</code>不等于<code>frontend</code>的所有<code>Kubernetes Object</code></li>
<li>第三个规则表示：前两个规则的逻辑与关系</li>
</ul>
<p><code>Set-based requirement</code>允许根据一组集合来进行过滤，允许的操作包括：<code>in</code>、<code>notin</code>、<code>exists</code>。<code>Set-based requirement</code>表达能力要大于<code>Equality-based requirement</code>，即<code>Equality-based requirement</code>可以用<code>Set-based requirement</code>的方式表示出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">environment in (production, qa)</span><br><span class="line">tier notin (frontend, backend)</span><br><span class="line">partition</span><br><span class="line">!partition</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个规则表示：匹配<code>key</code>等于<code>environment</code>且<code>value</code>等于<code>production</code>或<code>qa</code>的所有<code>Kubernetes Object</code></li>
<li>第二个规则表示：匹配<code>key</code>等于<code>tier</code>且<code>value</code>不等于<code>frontend</code>且<code>value</code>不等于<code>backend</code>的所有<code>Kubernetes Object</code></li>
<li>第三个规则表示：匹配含有<code>partition</code>这个<code>key</code>的所有<code>Kubernetes Object</code></li>
<li>第四个规则表示：匹配不含有<code>partition</code>这个<code>key</code>的所有<code>Kubernetes Object</code></li>
</ul>
<p><strong>selector配置格式</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">tier</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">cache</span>]&#125;</span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">environment</span>, <span class="attr">operator:</span> <span class="string">NotIn</span>, <span class="attr">values:</span> [<span class="string">dev</span>]&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>matchLabels</code>是一个<code>key-value</code>的map</li>
<li><code>matchExpressions</code>是一系列的<code>selector requirement</code></li>
<li><strong>所有的条件会以逻辑与的方式组合（包括<code>matchLabels</code>和<code>matchExpressions</code>）</strong></li>
</ul>
<h4 id="1233-api"><a class="markdownIt-Anchor" href="#1233-api"></a> 1.2.3.3 API</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l environment=production,tier=frontend</span><br><span class="line">kubectl get pods -l <span class="string">&#x27;environment in (production),tier in (frontend)&#x27;</span></span><br><span class="line">kubectl get pods -l <span class="string">&#x27;environment in (production, qa)&#x27;</span></span><br><span class="line">kubectl get pods -l <span class="string">&#x27;environment,environment notin (frontend)&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="124-annotations"><a class="markdownIt-Anchor" href="#124-annotations"></a> 1.2.4 Annotations</h3>
<p>我们可以通过<code>Label</code>以及<code>Annotation</code>为<code>Kubernetes Object</code>添加一些元数据。<code>Label</code>通常被用于<code>Kubernetes Object</code>的匹配，而<code>Annotation</code>通常用于为<code>Kubernetes Object</code>添加一些配置，这些配置可以包含一些<code>Label</code>不允许的字符</p>
<h3 id="125-field-selectors"><a class="markdownIt-Anchor" href="#125-field-selectors"></a> 1.2.5 Field Selectors</h3>
<p><code>Field Selector</code>允许我们基于<code>Kubernetes Object</code>的字段匹配来过滤<code>Kubernetes Object</code>，支持的匹配操作包括：<code>=</code>、<code>==</code>、<code>!=</code>，其中<code>=</code>与<code>==</code>都表示相等型比较</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --field-selector status.phase=Running</span><br><span class="line">kubectl get statefulsets,services --field-selector metadata.namespace!=default</span><br></pre></td></tr></table></figure>
<h3 id="126-recommended-labels"><a class="markdownIt-Anchor" href="#126-recommended-labels"></a> 1.2.6 Recommended Labels</h3>
<h3 id="127-参考"><a class="markdownIt-Anchor" href="#127-参考"></a> 1.2.7 参考</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/">Understanding Kubernetes Objects</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/imperative-config/">Imperative Management of Kubernetes Objects Using Configuration Files</a></li>
</ul>
<h1 id="2-architecture"><a class="markdownIt-Anchor" href="#2-architecture"></a> 2 Architecture</h1>
<h2 id="21-node"><a class="markdownIt-Anchor" href="#21-node"></a> 2.1 Node</h2>
<p><code>Node</code>是<code>Kubernetes</code>中的一个工作者。<code>Node</code>可能是一个虚拟机或者物理机。每个<code>Node</code>被<code>Master Component</code>管理，包含了一些运行<code>Pod</code>所必须的服务，包括<code>Container runtime</code>、<code>kubelet</code>、<code>kube-proxy</code></p>
<h3 id="211-node-status"><a class="markdownIt-Anchor" href="#211-node-status"></a> 2.1.1 Node Status</h3>
<p><code>Node</code>的状态包括以下几部分</p>
<ol>
<li><code>Address</code></li>
<li><code>Condition</code></li>
<li><code>Capacity</code></li>
<li><code>Info</code></li>
</ol>
<h4 id="2111-addresses"><a class="markdownIt-Anchor" href="#2111-addresses"></a> 2.1.1.1 Addresses</h4>
<p><code>Address</code>包含的字段与服务提供方或者裸机配置有关</p>
<ol>
<li><code>HostName</code>: <code>hostname</code>由<code>Node</code>的内核上报。可以通过<code>kubelet</code>参数<code>--hostname-override</code>覆盖</li>
<li><code>ExternalIP</code>: 公网IP</li>
<li><code>InternalIP</code>: 集群内的IP</li>
</ol>
<h4 id="2112-condition"><a class="markdownIt-Anchor" href="#2112-condition"></a> 2.1.1.2 Condition</h4>
<p><code>conditions</code>字段描述了<code>Node</code>的状态，包括</p>
<ol>
<li><code>OutOfDisk</code>: 如果剩余空间已经无法容纳新的<code>Pod</code>时，为<code>Frue</code>；否则<code>False</code></li>
<li><code>Ready</code>: 如果<code>Node</code>可以接收新的<code>Pod</code>时，为<code>True</code>；如果<code>Node</code>无法接纳新的<code>Pod</code>时，为<code>False</code>；如果<code>Controller</code>与该<code>Node</code>断连一定时间后（由<code>node-monitor-grace-period</code>字段指定，默认40s），为<code>Unknown</code></li>
<li><code>MemoryPressure</code>: 存在内存压力时，为<code>Ture</code>；否则<code>False</code></li>
<li><code>PIDPressure</code>: 存在进程压力时，为<code>True</code>；否则<code>False</code></li>
<li><code>DiskPressure</code>: 存在磁盘压力时，为<code>True</code>；否则<code>False</code></li>
<li><code>NetworkUnavailable</code>: 网络异常时，为<code>True</code>；否则<code>False</code></li>
</ol>
<h4 id="2113-capacity"><a class="markdownIt-Anchor" href="#2113-capacity"></a> 2.1.1.3 Capacity</h4>
<p>描述了可用资源的数量，包括CPU、内存、最大可运行的<code>Pod</code>数量</p>
<h4 id="2114-info"><a class="markdownIt-Anchor" href="#2114-info"></a> 2.1.1.4 Info</h4>
<p>描述了节点的通用信息，包括内核版本，<code>Kubernetes</code>版本，<code>Docker</code>版本，<code>OS</code>名称等等</p>
<h3 id="212-management"><a class="markdownIt-Anchor" href="#212-management"></a> 2.1.2 Management</h3>
<p>与<code>Pod</code>与<code>Service</code>不同，<code>Pod</code>与<code>Service</code>是由<code>Kubernetes</code>负责创建的，而<code>Node</code>是由云服务商或者使用者提供的。当<code>Kubernetes</code>创建了一个<code>Node</code>仅仅意味着创建了一个<code>Kubernetes Object</code>来描述这个<code>Node</code></p>
<p>目前，存在三个与<code>Node</code>交互的组件，他们分别是：<code>Node Controller</code>、<code>kubelet</code>、<code>kubectl</code></p>
<h4 id="2121-node-controller"><a class="markdownIt-Anchor" href="#2121-node-controller"></a> 2.1.2.1 Node Controller</h4>
<p><code>Node Controller</code>是<code>Kubernetes master component</code>，用于管理<code>Node</code>的生命周期</p>
<ol>
<li>当<code>Node</code>注册时，为<code>Node</code>分配一个<code>CIDR block</code></li>
<li>保持<code>Node</code>列表与云服务提供方的可用机器列表一致，当<code>Node</code>变得<code>unhealthy</code>后，<code>Node Controller</code>会询问云服务提供商该<code>VM</code>是否仍然可用，若不可用，则会将其从<code>Node</code>列表中删除</li>
<li>监视<code>Node</code>的健康状况，<code>Node Controller</code>会在<code>Node</code>变得<code>unreachable</code>后将状态从<code>NodeReady</code>变为<code>ConditionUnknown</code>，然后以优雅的方式移除该<code>Node</code>上的所有<code>Pod</code></li>
</ol>
<p>在<code>Kubernetes 1.4</code>版本中，对集群中大批<code>Node</code>同时出故障这一情况的处理做了一些优化，<code>Controller</code>会观测集群中所有<code>Node</code>的状态，来决策<code>Pod</code>以何种方式、何种规模进行移除</p>
<p>在大多数情况下，<code>Node Controller</code>限制了移除率<code>--node-eviction-rate</code>（默认是0.1），意味着，10秒之内最多只有一个<code>Node</code>节点上的<code>Pod</code>会被移除</p>
<p>当一个可用区（<code>Zone</code>）中的某个<code>Node</code>发生故障时，<code>Node</code>移除的行为发生了改变。<code>Node Controller</code>会检测在当前可用区中发生故障的<code>Node</code>的占比，如果这个比例最少为<code>--unhealthy-zone-threshold</code>（默认0.55）时，移除率会降低。如果集群很小（节点数量小于），移除过程会直接停止</p>
<p>将<code>Node</code>分布于不同的可用区的原因是，当一个可用区变得完全不可用时，那这些<code>Pod</code>可以迁移到其他的可用区中</p>
<h3 id="213-node-capacity"><a class="markdownIt-Anchor" href="#213-node-capacity"></a> 2.1.3 Node capacity</h3>
<p><code>Node</code>容量是<code>Node Object</code>的一部分。通常<code>Node</code>在向<code>Master</code>注册时，需要上报容量信息。如果我们是手动创建和管理<code>Node</code>，那么就需要手动设置容量信息</p>
<p><code>Kubernetes Scheduler</code>会保证<code>Node</code>上的资源一定大于所有<code>Pod</code>占用的资源。注意到，它仅仅会计算通过<code>kubelet</code>创建的<code>Container</code>所占用的资源数量，而不会计算由<code>Container runtime</code>或者手动创建的<code>Containter</code>所占用的资源数量</p>
<h2 id="22-master-node-communication"><a class="markdownIt-Anchor" href="#22-master-node-communication"></a> 2.2 Master-Node communication</h2>
<h3 id="221-cluster-to-master"><a class="markdownIt-Anchor" href="#221-cluster-to-master"></a> 2.2.1 Cluster to Master</h3>
<p><code>Node</code>与<code>Master</code>之间的通信全部依靠<code>Api Server</code>，除此之外，其他<code>Master component</code>不会提供远程服务。在一个典型的部署场景中，<code>Api Server</code>会在<code>443</code>端口上监听</p>
<p>应该为<code>Node</code>配置公共根证书，以便它们可以安全地连接到<code>Api Server</code></p>
<p><code>Pod</code>可以借助<code>Service Account</code>来与<code>Api Server</code>进行安全通信，<code>Kubernetes</code>会在<code>Pod</code>实例化的时候，将根证书以及令牌注入到<code>Pod</code>中去</p>
<p><code>Kubernetes</code>会为每个<code>Server</code>分配一个虚拟IP，<code>kube-proxy</code>会将其重定向为<code>Api Server</code>的具体IP</p>
<p>因此，<code>Node</code>与<code>Api Server</code>之间的通信可以在可靠/不可靠的网络下进行</p>
<h3 id="222-master-to-cluster"><a class="markdownIt-Anchor" href="#222-master-to-cluster"></a> 2.2.2 Master to Cluster</h3>
<p><code>Master(Api server)</code>与<code>Node</code>的通信的方式有两种：其一，<code>Api Server</code>通过与每个<code>Node</code>上的<code>kubelet</code>来完成通信；其二，<code>Api Server</code>通过<code>Proxy</code>来完成与<code>Node</code>、<code>Pod</code>、<code>Server</code>的通信</p>
<h4 id="2221-api-server-to-kubelet"><a class="markdownIt-Anchor" href="#2221-api-server-to-kubelet"></a> 2.2.2.1 Api server to kubelet</h4>
<p><code>Api Server</code>与<code>kubelet</code>之间的通信主要用于以下几个用途</p>
<ol>
<li>获取<code>Pod</code>的日志</li>
<li>与运行时的<code>Pod</code>进行交互</li>
<li>为<code>kubelet</code>提供端口转发服务（<code>port-forwarding functionality</code>）</li>
</ol>
<p>默认情况下，<code>Api Server</code>不会校验<code>kubelet</code>的服务端证书，因此有可能受到中间人攻击（<code>man-in-the-middle</code>），因此在不可信的网络中或者公网上是不安全的。我们可以通过<code>--kubelet-certificate-authority</code>来为<code>Api Server</code>提供一个根证书，用来校验<code>kubelet</code>的证书合法性</p>
<h4 id="2222-api-server-to-nodes-pods-and-services"><a class="markdownIt-Anchor" href="#2222-api-server-to-nodes-pods-and-services"></a> 2.2.2.2 Api server to nodes, pods, and services</h4>
<p><code>Api Server</code>与<code>Node</code>、<code>Pod</code>、<code>Service</code>之间的通信默认用的是HTTP协议，显然这是不安全的。我们可以为<code>Node</code>、<code>Pod</code>、<code>Service</code>的<code>API URL</code>指定<code>https</code>前缀，来使用HTTPS协议。但是，<code>Api Server</code>仍然不会校验证书的合法性，也不会为客户端提供任何凭证，因此在不可信的网络中或者公网上是不安全的</p>
<h2 id="23-concepts-underlying-the-cloud-controller-manager"><a class="markdownIt-Anchor" href="#23-concepts-underlying-the-cloud-controller-manager"></a> 2.3 Concepts Underlying the Cloud Controller Manager</h2>
<p>最初提出<code>Cloud Controller Manager(CCM)</code>概念是为了能够让云服务商与<code>Kubernetes</code>可以相互独立地发展</p>
<p><code>CCM</code>是的设计理念是插件化的，这样云服务商就可以以插件的方式与<code>Kubernetes</code>进行集成</p>
<h3 id="231-design"><a class="markdownIt-Anchor" href="#231-design"></a> 2.3.1 Design</h3>
<p>如果没有<code>CCM</code>，<code>Kubernetes</code>的架构如下：</p>
<p><img src="/images/Kubernetes-Concept/ccm_1.png" alt="ccm_1" /></p>
<p>在上面的架构图中，<code>Kubernetes</code>与<code>Cloud Provider</code>通过几个不同的组件进行集成</p>
<ol>
<li><code>kubelet</code></li>
<li><code>Kubernetes Controller Manager(KCM)</code></li>
<li><code>Kubernetes API server</code></li>
</ol>
<p>在引入<code>CCM</code>后，整个<code>Kubernetes</code>的架构变为：</p>
<p><img src="/images/Kubernetes-Concept/ccm_2.png" alt="ccm_2" /></p>
<h3 id="232-components-of-the-ccm"><a class="markdownIt-Anchor" href="#232-components-of-the-ccm"></a> 2.3.2 Components of the CCM</h3>
<p><code>CCM</code>打破了<code>KCM</code>的一些功能，并且作为一个独立的进程运行。具体来说，<code>CCM</code>打破了<code>KCM</code>那些依赖于云的<code>Controller</code></p>
<p><code>KCM</code>具有如下<code>Controller</code>：</p>
<ol>
<li><code>Node Controller</code></li>
<li><code>Volume Controller</code></li>
<li><code>Route Controller</code></li>
<li><code>Service Controller</code></li>
</ol>
<p><code>CCM</code>包含如下<code>Controller</code></p>
<ol>
<li><code>Node Controller</code></li>
<li><code>Route Controller</code></li>
<li><code>Service Controller</code></li>
<li><code>PersistentVolumeLabels Controller</code></li>
</ol>
<h3 id="233-functions-of-the-ccm"><a class="markdownIt-Anchor" href="#233-functions-of-the-ccm"></a> 2.3.3 Functions of the CCM</h3>
<h4 id="2331-kubernetes-controller-manager"><a class="markdownIt-Anchor" href="#2331-kubernetes-controller-manager"></a> 2.3.3.1 Kubernetes Controller Manager</h4>
<p><code>CCM</code>中大部分的功能都是从<code>KCM</code>中继承过来的，包括如下<code>Controller</code></p>
<ol>
<li><code>Node Controller</code></li>
<li><code>Route Controller</code></li>
<li><code>Service Controller</code></li>
<li><code>PersistentVolumeLabels Controller</code></li>
</ol>
<h5 id="23311-node-controller"><a class="markdownIt-Anchor" href="#23311-node-controller"></a> 2.3.3.1.1 Node Controller</h5>
<p><code>Node Controller</code>负责初始化<code>Node</code>，它会从<code>Cloud Provier</code>中获取有关<code>Node</code>的一些信息，具体包括</p>
<ol>
<li>初始化<code>Node</code>时，为其打上<code>zone/region</code>的标签</li>
<li>初始化<code>Node</code>时，记录一些定制化的信息，包括<code>type</code>和<code>size</code></li>
<li>获取<code>Node</code>的<code>hostname</code>和<code>address</code></li>
<li>当<code>Node</code>失联时，询问<code>Cloud Provider</code>该<code>Node</code>是否已被其删除，如果已被删除，那么删除该<code>Node</code>对应的<code>Kubernetes Node Object</code></li>
</ol>
<h5 id="23312-route-controller"><a class="markdownIt-Anchor" href="#23312-route-controller"></a> 2.3.3.1.2 Route Controller</h5>
<p><code>Route Controller</code>负责配置路由信息，以便位于不同<code>Node</code>节点上的<code>Container</code>能够进行相互通信，目前只与<code>Google Compute Engine Cluster</code>兼容</p>
<h5 id="23313-service-controller"><a class="markdownIt-Anchor" href="#23313-service-controller"></a> 2.3.3.1.3 Service Controller</h5>
<p><code>Service Controller</code>负责监听<code>Service</code>的创建、更新、删除对应的事件，确保负载均衡可以时时感知服务的状态</p>
<h5 id="23314-persistentvolumelabels-controller"><a class="markdownIt-Anchor" href="#23314-persistentvolumelabels-controller"></a> 2.3.3.1.4 PersistentVolumeLabels Controller</h5>
<p><code>PersistentVolumeLabels Controller</code>在<code>AWS EBS/GCE PD Volume</code>创建时，为其打上标签。这些标签对于<code>Pod</code>的调度至关重要，因为这些<code>Volume</code>只在特定的区域，因此被调度的<code>Pod</code>也必须位于这些区域才行</p>
<p><code>PersistentVolumeLabels Controller</code>仅用于<code>CCM</code>中</p>
<h4 id="2332-kubelet"><a class="markdownIt-Anchor" href="#2332-kubelet"></a> 2.3.3.2 Kubelet</h4>
<p><code>Node controller</code>包含了<code>kubelet</code>中依赖于云的功能。在引入<code>CCM</code>之前，<code>kubelet</code>在初始化<code>Node</code>时，还需要负责初始化<code>IP</code>地址、区域标签以及实例类型等信息。引入<code>CCM</code>后，这些初始化操作将从<code>kubelet</code>中被移除，完全由<code>CCM</code>负责初始化</p>
<p>在新模式下，<code>kubelet</code>可以单纯地创建一个<code>Node</code>，而不用关心与云相关的一些依赖信息。在<code>CCM</code>完成初始化之前，该<code>Node</code>是无法被调度的</p>
<h4 id="2333-kubernetes-api-server"><a class="markdownIt-Anchor" href="#2333-kubernetes-api-server"></a> 2.3.3.3 Kubernetes API server</h4>
<p>同样地，<code>PersistentVolumeLabels</code>也将<code>Api Server</code>中与云相关的部分迁移到<code>CCM</code>中</p>
<h3 id="234-plugin-mechanism"><a class="markdownIt-Anchor" href="#234-plugin-mechanism"></a> 2.3.4 Plugin mechanism</h3>
<p><code>CCM</code>定义了一系列的接口（<code>Go</code>接口），交由云服务商自行提供实现</p>
<h3 id="235-authorization"><a class="markdownIt-Anchor" href="#235-authorization"></a> 2.3.5 Authorization</h3>
<h4 id="2351-node-controller"><a class="markdownIt-Anchor" href="#2351-node-controller"></a> 2.3.5.1 Node Controller</h4>
<p><code>Node Controller</code>只与<code>Node Object</code>进行交互，可以进行如下操作</p>
<ol>
<li><code>Get</code></li>
<li><code>List</code></li>
<li><code>Create</code></li>
<li><code>Update</code></li>
<li><code>Patch</code></li>
<li><code>Watch</code></li>
<li><code>Delete</code></li>
</ol>
<h4 id="2352-route-controller"><a class="markdownIt-Anchor" href="#2352-route-controller"></a> 2.3.5.2 Route Controller</h4>
<p><code>Route Controller</code>监听<code>Node Object</code>的创建以及配置路由规则，可以进行如下操作</p>
<ol>
<li><code>Get</code></li>
</ol>
<h4 id="2353-service-controller"><a class="markdownIt-Anchor" href="#2353-service-controller"></a> 2.3.5.3 Service Controller</h4>
<p><code>Service Controller</code>监听<code>Service Object</code>的创建、更新、删除，以及配置<code>endpoint</code>，可以进行如下操作</p>
<ol>
<li><code>List</code></li>
<li><code>Get</code></li>
<li><code>Watch</code></li>
<li><code>Patch</code></li>
<li><code>Update</code></li>
</ol>
<h4 id="2354-persistentvolumelabels-controller"><a class="markdownIt-Anchor" href="#2354-persistentvolumelabels-controller"></a> 2.3.5.4 PersistentVolumeLabels Controller</h4>
<p><code>PersistentVolumeLabels Controller</code>监听<code>PersistentVolume (PV)</code>的创建，可以进行如下操作</p>
<ol>
<li><code>Get</code></li>
<li><code>List</code></li>
<li><code>Watch</code></li>
<li><code>Update</code></li>
</ol>
<h2 id="24-参考"><a class="markdownIt-Anchor" href="#24-参考"></a> 2.4 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/architecture/nodes/">Nodes</a></li>
</ul>
<h1 id="3-workloads"><a class="markdownIt-Anchor" href="#3-workloads"></a> 3 Workloads</h1>
<h2 id="31-pods"><a class="markdownIt-Anchor" href="#31-pods"></a> 3.1 Pods</h2>
<h3 id="311-pod-overview"><a class="markdownIt-Anchor" href="#311-pod-overview"></a> 3.1.1 Pod Overview</h3>
<h4 id="3111-understanding-pods"><a class="markdownIt-Anchor" href="#3111-understanding-pods"></a> 3.1.1.1 Understanding Pods</h4>
<p><code>Pod</code>是Kubernetes中，用户能够创建或部署的最小单元，一个<code>Pod</code>代表了一个进程（可能是高耦合的一组进程）。<code>Pod</code>封装了以下资源</p>
<ol>
<li><code>Container</code>：一个或多个应用容器</li>
<li><code>volume</code>：存储资源</li>
<li><code>IP</code>：一个pod会被分配一个IP，在所属的namespace下唯一</li>
<li><code>options</code>：控制容器运行的参数</li>
</ol>
<p>通常，<code>Pod</code>在<code>Kubernetes</code>集群中有两种主要用法</p>
<ol>
<li><code>Pods that run a single container</code>: 该模式是<code>Kubernetes</code>最常用的模式。在这种情况下，我们可以认为<code>Pod</code>对<code>Container</code>做了一层封装，<code>Kubernetes</code>直接管理<code>Pod</code>而不是<code>Container</code></li>
<li><code>Pods that run multiple containers that need to work together</code>: 在这种模式下，<code>Pod</code>封装了由一组高耦合的<code>Container</code>构成的应用，这些<code>Container</code>需要共享资源</li>
</ol>
<p>每一个<code>Pod</code>都运行着一个应用的一个实例。如果我们想要水平扩展，我们必须使用多个<code>Pod</code>，同样，每个<code>Pod</code>运行一个实例。在<code>Kubernetes</code>中，这称为<code>replication</code>。通常，<code>Replicated Pod</code>由<code>Controller</code>统一创建和管理</p>
<p><code>Pod</code>为<code>Container</code>提供了两种共享资源的方式</p>
<ol>
<li><code>networking</code>: 每个<code>Pod</code>被分配了一个唯一的<code>IP</code>地址，每个<code>Container</code>共享网络的<code>Namespace</code>，包括<code>IP</code>地址以及端口号。位于同一个<code>Pod</code>中的<code>Container</code>可以通过<code>localhost</code>来进行通信。位于不同<code>Pod</code>中的<code>Container</code>需要借助<code>host</code>以及<code>port</code>来通信</li>
<li><code>storage</code>: <code>Pod</code>可以分享一些存储卷。位于同一个<code>Pod</code>中的所有<code>Container</code>共享这些卷</li>
</ol>
<h4 id="3112-working-with-pods"><a class="markdownIt-Anchor" href="#3112-working-with-pods"></a> 3.1.1.2 Working with Pods</h4>
<p>在<code>Kubernetes</code>中，我们很少直接创建独立的<code>Pod</code>，<strong>因为<code>Pod</code>被设计成一种相对短暂的、一次性的实体</strong>。当<code>Pod</code>被创建后（被用户直接创建，或者被<code>Controller</code>创建），它就会被调度到某个节点上开始运行。<code>Pod</code>会一直在<code>Node</code>上运行，直至被终结、<code>Pod Object</code>被删除、<code>Node</code>宕机</p>
<p><code>Pod</code>自身并不会自我恢复。也就是说，当<code>Pod</code>部署失败或者挂了，这个<code>Pod</code>的生命周期就结束了。<strong>Kubernetes用一个高层次的概念，即<code>Controller</code>，来管理<code>Pod</code>的生命周期，包括<code>Pod</code>的创建、部署、副本、恢复等工作</strong></p>
<p><code>Controller</code>可以为我们创建和管理多个<code>Pod</code>，水平扩容、提供自我修复能力。例如，当一个<code>Node</code>宕机后，<code>Controller</code>会自动地在另一个<code>Node</code>上重新启动一个新的<code>Pod</code></p>
<h4 id="3113-pod-templates"><a class="markdownIt-Anchor" href="#3113-pod-templates"></a> 3.1.1.3 Pod Templates</h4>
<p><strong><code>Pod Template</code>是<code>Pod</code>的一份声明（如下），可以被其他<code>Kubernetes Object</code>（包括<code>Replication Controllers</code>、<code>Job</code>等）引用</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo Hello Kubernetes! &amp;&amp; sleep 3600&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p><code>Pod Template</code>更像一个饼干模具，而不是指定所有副本的当前期望状态。当一个饼干制作完成后，它与饼干模具毫无关系。<code>Pod Template</code>杜绝了量子纠缠，更新或者替换<code>Pod Template</code>对于已经生产的<code>Pod</code>不会产生任何影响</p>
<h3 id="312-pods"><a class="markdownIt-Anchor" href="#312-pods"></a> 3.1.2 Pods</h3>
<h4 id="3121-what-is-a-pod"><a class="markdownIt-Anchor" href="#3121-what-is-a-pod"></a> 3.1.2.1 What is a Pod?</h4>
<p><code>Pod</code>包含一个或者一组<code>Container</code>，一些共享的存储/网络组件，以及运行应用的方式。<code>Pod</code>中的共享上下文包括：<code>Linux namespaces</code>，<code>cgroups</code>，以及其他可能的隔离因素</p>
<p>在一个<code>Pod</code>中的所有<code>Container</code>共享一个<code>IP</code>地址，以及端口空间，<code>Container</code>之间可以通过<code>localhost</code>进行通信，或者其他<code>IPC</code>方式。不同<code>Pod</code>中的<code>Container</code>具有不同的<code>IP</code>地址，因此，仅能通过<code>Pod IP</code>进行通信</p>
<p>在同一个<code>Pod</code>中的<code>Container</code>可以访问共享卷，共享卷是<code>Pod</code>的一部分，并且可以挂载到文件系统上</p>
<p><code>Pod</code>被设计成一种短暂的、一次性的实体。<code>Pod</code>在创建时会被赋予一个唯一的<code>UID</code>，并且被调度到某个<code>Node</code>上一直运行直至被销毁。如果一个<code>Node</code>宕机了，那些被调度到该<code>Node</code>上的<code>Pod</code>会被删除。一个特定的<code>Pod</code>（<code>UID</code>层面）不会被重新调度到新的<code>Node</code>上，相反，它会被一个新的<code>Pod</code>替代，这个新<code>Pod</code>可以复用之前的名字，但是会被分配一个新的<code>UID</code>，因此那么些共享的卷也会重新创建（旧数据无法保留）</p>
<h4 id="3122-motivation-for-pods"><a class="markdownIt-Anchor" href="#3122-motivation-for-pods"></a> 3.1.2.2 Motivation for pods</h4>
<p>通常一个服务由多个功能单元构成，各模块相互协作，而<code>Pod</code>就是这种多协作过程的模型。<code>Pod</code>通过提供一个高阶抽象来简化应用的部署、管理。<code>Pod</code>是部署，水平扩展和复制的最小单元</p>
<p><code>Pod</code>允许内部的组件共享数据以及相互通信。在一个<code>Pod</code>中的所有组件共享同一个网络<code>Namespace</code>(<code>IP</code>和<code>port</code>)，他们之间可以通过<code>localhost</code>相互通信，因此在一个<code>Pod</code>中的所有组件需要共享<code>port</code>，同时，<code>Pod</code>也允许其组件与外部通信</p>
<p><code>Pod</code>的<code>hostname</code>被设置为<code>Pod</code>的名字</p>
<h4 id="3123-durability-of-pods-or-lack-thereof"><a class="markdownIt-Anchor" href="#3123-durability-of-pods-or-lack-thereof"></a> 3.1.2.3 Durability of pods (or lack thereof)</h4>
<p><code>Pod</code>并不是一个高可用的实体。<code>Pod</code>不会从调度失败、节点宕机或其他错误中恢复</p>
<p>通常情况下，用户不需要直接创建<code>Pod</code>，而应该使用<code>Controller</code>，<code>Controller</code>提供了一个集群层面上的自我修复能力，以及水平扩容能力和删除能力</p>
<p><code>Pod</code>对外直接露出，其原因如下</p>
<ol>
<li>提供可插拔式的调度和控制方式</li>
<li>支持<code>Pod-level</code>的操作，而不需要通过<code>Controller API</code>来代理</li>
<li>解耦<code>Pod</code>生命周期与<code>Controller</code>生命周期</li>
<li>解耦<code>Controller</code>和<code>Service</code></li>
<li>解耦<code>Kubelet-level</code>的功能与<code>cluster-level</code>的功能</li>
<li>高可用性</li>
</ol>
<h4 id="3124-termination-of-pods"><a class="markdownIt-Anchor" href="#3124-termination-of-pods"></a> 3.1.2.4 Termination of Pods</h4>
<p>由于<code>Pod</code>代表了集群中一组运行的进程，因此允许<code>Pod</code>优雅地终结是很有必要的。用户需要发出删除指令，需要了解终结时间，需要确保<code>Pod</code>真的被终结了。当用户发出删除<code>Pod</code>的请求时，系统会记录一个宽限期（发出删除请求到被强制清除的时间间隔），然后向<code>Pod</code>中的所有<code>Container</code>发出<code>TERM signal</code>，如果超过宽限期，<code>Pod</code>还未终结，那么会向<code>Pod</code>中的所有<code>Container</code>发出<code>KILL signal</code>，当<code>Pod</code>终结后，它会被<code>API server</code>删除</p>
<p>一个具体的例子</p>
<ol>
<li>用户发出指令删除<code>Pod</code>，默认的宽限期是30s</li>
<li><code>API server</code>会更新该<code>Pod</code>的状态，并且设定宽限期</li>
<li>当用户通过命令查看<code>Pod</code>状态时，该被删除的<code>Pod</code>会显示<code>Terminating</code>状态</li>
<li><code>Kubelet</code>观测到<code>Pod</code>被标记为<code>Terminating</code>状态，以及宽限期后，就开始终结流程
<ol>
<li>如果有<code>Container</code>定义了<code>preStop hook</code>，那么会运行该钩子方法。如果超过宽限期后，<code>preStop hook</code>方法还在执行，那么步骤2将会被执行，并且会指定一个更小的宽限期（2s）</li>
<li>向<code>Container</code>发送<code>TERM</code>信号</li>
</ol>
</li>
<li><code>Pod</code>被移除服务节点列表。因此，那些终止过程十分缓慢的<code>Pod</code>，在此时也不会继续提供服务</li>
<li><code>Kubelet</code>通过<code>API server</code>将宽限期设置为<code>0</code>来结束删除过程。之后该<code>Pod</code>就对用户彻底不可见了，即彻底被删除了</li>
</ol>
<p><code>Kubernetes</code>允许强制删除<code>Pod</code>，强制删除意味着将该<code>Pod</code>从集群状态以及<code>etcd</code>中立即删除。当强制删除执行时，<code>Api Server</code>不会等待<code>kubelet</code>确认删除<code>Pod</code>，而是直接将该<code>Pod</code>删除，这样一来，一个新的复用了原来名字的<code>Pod</code>就可以被立即创建。而那个被删除的<code>Pod</code>仍然会给定一个比较小的宽限期来进行上述删除操作。<strong>尽量不要使用这种方式</strong></p>
<h3 id="313-pod-lifecycle"><a class="markdownIt-Anchor" href="#313-pod-lifecycle"></a> 3.1.3 Pod Lifecycle</h3>
<h4 id="3131-pod-phase"><a class="markdownIt-Anchor" href="#3131-pod-phase"></a> 3.1.3.1 Pod phase</h4>
<p><code>Pod</code>的<code>status</code>字段是一个<code>PodStatus</code>对象，该对象包含一个<code>phase</code>字段</p>
<p><code>phase</code>是对<code>Pod</code>生命周期中的状态的高度抽象，仅包含以下几个值</p>
<ol>
<li><strong><code>Pending</code></strong>：该<code>Pod</code>已被<code>Kubernetes system</code>接管，但是<code>Container</code>尚未创建完毕。可能处于尚未被调度的状态，或者正在下载容器镜像</li>
<li><strong><code>Running</code></strong>：所有<code>Container</code>已经启动完毕，并且至少有一个<code>Container</code>处于运行状态，或者处于启动或者重启的过程中</li>
<li><strong><code>Succeeded</code></strong>：所有<code>Container</code>成功终止，且不会重启</li>
<li><strong><code>Failed</code></strong>：至少有一个<code>Container</code>终止失败</li>
<li><strong><code>Unkown</code></strong>：系统错误</li>
</ol>
<p>可以通过如下命令查看<code>phase</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n &lt;namespace&gt; &lt;pod-name&gt; -o yaml</span><br></pre></td></tr></table></figure>
<h4 id="3132-pod-conditions"><a class="markdownIt-Anchor" href="#3132-pod-conditions"></a> 3.1.3.2 Pod conditions</h4>
<p><code>Pod</code>的<code>status</code>字段是一个<code>PodStatus</code>对象，该对象包含一个<code>conditions</code>字段，该字段对应的值是一个<code>PodConditions</code>对象的数组</p>
<p>每个<code>PodConditions</code>对象包含如下字段</p>
<ol>
<li><strong><code>lastProbeTime</code></strong>：上一次进行状态监测的时刻</li>
<li><strong><code>lastTransitionTime</code></strong>：上一次发生状态变更的时刻</li>
<li><strong><code>message</code></strong>：状态变更的描述，一个<code>human-readable</code>的描述</li>
<li><strong><code>reason</code></strong>：状态变更的原因，一个较为精确的描述</li>
<li><strong><code>status</code></strong>：<code>True</code>、<code>False</code>、<code>Unknown</code>中的一个</li>
<li><strong><code>type</code></strong>：以下几种可能值中的一个
<ul>
<li><code>PodScheduled</code>：<code>Pod</code>已被调度到一个<code>node</code>上</li>
<li><code>Ready</code>：<code>Pod</code>已经能够提供服务，应该被添加到<code>load balancing pool</code>中去</li>
<li><code>Initialized</code>：所有的<code>Init Container</code>已经执行完毕</li>
<li><code>Unschedulable</code>：调度失败，可能原因是资源不足</li>
<li><code>ContainersReady</code>：<code>Pod</code>中的所有<code>Container</code>已经就绪</li>
</ul>
</li>
</ol>
<h4 id="3133-container-probes"><a class="markdownIt-Anchor" href="#3133-container-probes"></a> 3.1.3.3 Container probes</h4>
<p><code>probe</code>是<code>kubelet</code>对<code>Container</code>定期进行的诊断。为了实现诊断，<code>kubelet</code>通过调用一个<code>handler</code>来完成，该<code>handler</code>由容器实现，以下是三种<code>handler</code>的类型</p>
<ol>
<li><code>ExecAction</code>：在容器中执行一个命令，当命令执行成功（返回状态码是0）时，诊断成功</li>
<li><code>TCPSocketAction</code>：通过<code>Container</code>的<code>IP</code>以及指定的<code>port</code>来进行<code>TCP</code>检测，当检测到<code>port</code>开启时，诊断成功</li>
<li><code>HTTPGetAction</code>：通过<code>Container</code>的<code>IP</code>以及指定的<code>port</code>来进行<code>HTTP Get</code>检测，当<code>HTTP</code>返回码在200至400之间时，诊断成功</li>
</ol>
<p><strong>诊断结果如下</strong></p>
<ol>
<li><strong><code>Success</code></strong></li>
<li><strong><code>Failure</code></strong></li>
<li><strong><code>Unknown</code></strong></li>
</ol>
<p><strong><code>kubelet</code>可以对运行状态下的<code>Container</code>进行如下两种<code>probe</code></strong></p>
<ol>
<li><strong><code>livenessProbe</code></strong>：检测<code>Container</code>是否存活（健康检查），若不存活，将杀死这个<code>Container</code></li>
<li><strong><code>readinessProbe</code></strong>：检测<code>Container</code>是否准备好提供服务，若检查不通过，那么会将这个<code>Pod</code>从<code>service</code>的<code>endpoint</code>列表中移除</li>
</ol>
<p><strong>我们如何决定该使用<code>livenessProbe</code>还是<code>readinessProbe</code></strong></p>
<ul>
<li>如果我们的<code>Container</code>在碰到异常情况时本身就会宕机，那么我们就不需要<code>livenessProbe</code>，<code>kubelet</code>会自动根据<code>restartPolicy</code>采取相应的动作</li>
<li>如果我们想要在<code>probe</code>失败时杀死或者重启<code>Container</code>，那么，我们需要使用<code>livenessProbe</code>，同时将<code>restartPolicy</code>指定为<code>Always</code>或<code>OnFailure</code>模式</li>
<li>如果我们想要在<code>Pod</code>可读时才向其转发网络数据包，那么，我们需要使用<code>readinessProbe</code></li>
<li>如果我们的<code>Container</code>需要读取大量数据，配置文件或者需要在启动时做数据迁移，那么需要<code>readinessProbe</code></li>
<li>如果我们仅仅想要避免流量打到被删除的<code>Pod</code>上来，我们无需使用<code>readinessProbe</code>。在删除过程中，<code>Pod</code>会自动将自己标记为<code>unready</code>状态，无论<code>readinessProbe</code>是否存在</li>
</ul>
<h4 id="3134-pod-readiness-gate"><a class="markdownIt-Anchor" href="#3134-pod-readiness-gate"></a> 3.1.3.4 Pod readiness gate</h4>
<p>为了织入一些回调逻辑或者信号到<code>PodStatsu</code>中来增强<code>Pod readiness</code>的可扩展性，<code>Kubernetes</code>在<code>1.11</code>版本之后引入了一个性特性，称为<code>Pod ready++</code>，我们可以在<code>PodSpec</code>中使用<code>ReadinessGate</code>来增加一些额外的用于判断<code>Pod readiness</code>的条件。如果<code>Kubernetes</code>在<code>status.conditions</code>中没有找到对应于<code>ReadinessGate</code>中声明的条件类型，那么检测结果默认是<code>Flase</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">readinessGates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">conditionType:</span> <span class="string">&quot;www.example.com/feature-1&quot;</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Ready</span>  <span class="comment"># this is a builtin PodCondition</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="number">2018-01-01T00:00:00Z</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">&quot;www.example.com/feature-1&quot;</span>   <span class="comment"># an extra PodCondition</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">      <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="number">2018-01-01T00:00:00Z</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://abcd...</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<h4 id="3135-restart-policy"><a class="markdownIt-Anchor" href="#3135-restart-policy"></a> 3.1.3.5 Restart policy</h4>
<p><code>PodSpec</code>有一个<code>restartPolicy</code>字段，其可选值为<code>Always</code>、<code>OnFailure</code>、<code>Never</code>。默认值为<code>Always</code>。<code>restartPolicy</code>对<code>Pod</code>中的所有<code>Container</code>都会生效。<code>restartPolicy</code>仅针对在同一个<code>Node</code>中重启<code>Container</code>。多次启动之间的时间间隔以指数方式增长（10s、20s、40s…），最多不超过5分钟。在成功重启后10分钟后，时间间隔会恢复默认值</p>
<h4 id="3136-pod-lifetime"><a class="markdownIt-Anchor" href="#3136-pod-lifetime"></a> 3.1.3.6 Pod lifetime</h4>
<p>通常情况下，<code>Pod</code>一旦创建就会永远存在，直至被某人或<code>Controller</code>销毁。唯一例外就是，当<code>Pod</code>的<code>status.phase</code>字段为<code>Succeeded</code>或<code>Failed</code>且超过一段时间后（该时间由<code>terminated-pod-gc-threshold</code>设定），该<code>Pod</code>会被自动销毁</p>
<p>有三种类型的<code>Controller</code>可供选择</p>
<ol>
<li>使用<code>Job</code>，这类<code>Pod</code>预期会终止，例如<code>batch computations</code>。此时<code>restartPolicy</code>通常设置为<code>OnFailure</code>或<code>Never</code></li>
<li>使用<code>ReplicationController</code>、<code>ReplicaSet</code>、<code>Deployment</code>，这类<code>Pod</code>预期会一直运行，例如<code>web servers</code>。此时<code>restartPolicy</code>通常设置为<code>Always</code></li>
<li>使用<code>DaemonSet</code>，这类<code>Pod</code>通常每台机器都会运行一个</li>
</ol>
<p>这三种类型的<code>Controller</code>都含有一个<code>PodTemplate</code>。通常，创建一个<code>Controller</code>，然后利用它来创建<code>Pod</code>是最常规的选择，而不是自己创建<code>Pod</code>，因为<code>Pod</code>自身是不具有错误恢复能力的，但是<code>Controller</code>具备该能力</p>
<p>当某个<code>Node</code>宕机或者失联后，<code>Kubernetes</code>会将位于这些<code>Node</code>上的<code>Pod</code>全部标记为<code>Failed</code></p>
<h3 id="314-init-containers"><a class="markdownIt-Anchor" href="#314-init-containers"></a> 3.1.4 Init Containers</h3>
<h4 id="3141-understanding-init-containers"><a class="markdownIt-Anchor" href="#3141-understanding-init-containers"></a> 3.1.4.1 Understanding Init Containers</h4>
<p>一个<code>Pod</code>中可以运行一个或多个<code>Container</code>，同时，一个<code>Pod</code>中也可以运行一个或多个<code>Init Container</code>（<code>Init Container</code>会优先于<code>Container</code>运行）</p>
<p><code>Init Container</code>具有如下特性</p>
<ol>
<li>他们总会结束运行，即并不是一个常驻进程</li>
<li><code>Init Container</code>总是一个接一个地运行，上一个<code>Init Container</code>运行结束后，下一个<code>Init Container</code>才开始运行</li>
</ol>
<p>如果<code>Init Container</code>执行失败，<code>Kubernetes</code>会重启<code>Pod</code>直至<code>Init Container</code>成功执行（至于<code>Pod</code>是否重启依赖于<code>restartPolicy</code>）</p>
<p>为了将一个<code>Container</code>指定为<code>Init Container</code>，我们需要在<code>PodSpec</code>中添加<code>initContainers</code>字段</p>
<p><code>Init Container</code>支持所有普通<code>Container</code>的字段，唯独不支持<code>readiness probe</code>，因为<code>Init Container</code>在<code>ready</code>之前已经结束了</p>
<h4 id="3142-detailed-behavior"><a class="markdownIt-Anchor" href="#3142-detailed-behavior"></a> 3.1.4.2 Detailed behavior</h4>
<p>在<code>Pod</code>的启动过程中，在网络以及磁盘初始化后，<code>Init Container</code>以配置的顺序启动。<code>Init Container</code>会一个接一个地启动，且只有前一个启动成功后，后一个才会启动。如果<code>Init Container</code>启动失败，会根据<code>restartPolicy</code>来决定是否重新启动。特别地，如果<code>Pod</code>的<code>restartPolicy</code>被设置为<code>Always</code>，那么对于<code>Init Container</code>而言，就为<code>OnFailure</code></p>
<p>如果<code>Pod</code>重启（可能仅仅指重新启动container？并不是销毁<code>Pod</code>后再创建一个新的<code>Pod</code>），那么所有的<code>Init Container</code>都会重新执行</p>
<h3 id="315-pod-preset"><a class="markdownIt-Anchor" href="#315-pod-preset"></a> 3.1.5 Pod Preset</h3>
<p><code>Pod Preset</code>用于在<code>Pod</code>创建时注入一些运行时的依赖项，我们可以使用<code>Label Selector</code>来指定需要注入的<code>Pod</code></p>
<p><strong>原理</strong>：Kubernetes提供了一个准入控制器（<code>PodPreset</code>）。在创建<code>Pod</code>时，系统会执行以下操作：</p>
<ol>
<li>获取所有的<code>PodPreset</code></li>
<li>检查正在创建的<code>Pod</code>的<code>Label</code>是否匹配某个或某些<code>PodPreset</code>的<code>Label Selector</code></li>
<li>将匹配的<code>PodPreset</code>所指定的资源注入到待创建的<code>Pod</code>中去</li>
<li>如果发生错误，抛出一个事件，该事件记录了错误信息，然后以纯净的方式创建<code>Pod</code>（无视所有<code>PodPreset</code>中的资源）</li>
<li>修改<code>Pod</code>的<code>status</code>字段，记录其被<code>PodPreset</code>修改过。描述信息如下
<ul>
<li><code>podpreset.admission.kubernetes.io/podpreset-&lt;pod-preset name&gt;: &quot;&lt;resource version&gt;&quot;.</code></li>
</ul>
</li>
</ol>
<p>一个<code>Pod Preset</code>可以应用于多个<code>Pod</code>，同样，一个<code>Pod</code>也可以关联多个<code>Pod Preset</code></p>
<h3 id="316-disruptions"><a class="markdownIt-Anchor" href="#316-disruptions"></a> 3.1.6 Disruptions</h3>
<h4 id="3161-voluntary-and-involuntary-disruptions"><a class="markdownIt-Anchor" href="#3161-voluntary-and-involuntary-disruptions"></a> 3.1.6.1 Voluntary and Involuntary Disruptions</h4>
<p><code>Pod</code>会一直存在，直到某人或者<code>Controller</code>摧毁它，或者碰到一个无法避免的硬件或者系统问题。我们将这些异常称为<code>involutary disruption</code>，包括</p>
<ol>
<li>硬件错误</li>
<li>集群管理员误删VM实例</li>
<li>内核错误</li>
<li>网络抖动</li>
<li>由于资源耗尽而导致<code>Pod</code>被移出<code>Node</code></li>
</ol>
<p>对于其他的情况，我们称之为<code>voluntary disruption</code>，包括</p>
<ol>
<li>删除管理<code>Pod</code>的<code>Node</code></li>
<li>更新了<code>PodSpec</code>而导致的<code>Pod</code>重启</li>
<li>删除<code>Pod</code></li>
<li>将<code>Node</code>从集群中移出，对其进行维护或升级</li>
<li>将<code>Node</code>从集群中移出，进行缩容</li>
</ol>
<h4 id="3162-dealing-with-disruptions"><a class="markdownIt-Anchor" href="#3162-dealing-with-disruptions"></a> 3.1.6.2 Dealing with Disruptions</h4>
<p>下列方法可以减轻<code>involuntary disruption</code>造成的影响</p>
<ol>
<li>确保<code>Pod</code>只拿它需要的资源</li>
<li>复制应用，以获得高可用性</li>
<li>将应用副本分别部署到不同的区域的节点上，以获得更高的可用性</li>
</ol>
<h4 id="3163-how-disruption-budgets-work"><a class="markdownIt-Anchor" href="#3163-how-disruption-budgets-work"></a> 3.1.6.3 How Disruption Budgets Work</h4>
<p>应用<code>Owner</code>可以为每个应用创建一个<code>PodDisruptionBudget(PDB)</code>对象。<code>PDB</code>限制了应用同时缩容的最大数量，即保证应用在任何时候都有一定数量的<code>Pod</code>在运行</p>
<p>当集群管理员利用<code>kubectl drains</code>命令将某个<code>Node</code>移除时，<code>Kubernetes</code>会尝试移除该<code>Node</code>上的所有<code>Pod</code>，但是这个移除请求可能会被拒绝，然后<code>Kubernetes</code>会周期性的重试，直至所有<code>Pod</code>都被终结或者超过配置的时间（超过后，直接发送<code>KILL signal</code>）</p>
<p><code>PDB</code>无法阻止<code>involuntary disruptions</code>。<code>Pod</code>由于灰度升级造成的<code>voluntary disruption</code>可以被<code>PDB</code>管控。但是<code>Controller</code>灰度升级不会被<code>PDB</code>管控</p>
<h3 id="317-参考"><a class="markdownIt-Anchor" href="#317-参考"></a> 3.1.7 参考</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod Overview</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">Pod Lifecycle</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/podpreset/">Pod Preset</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">Disruptions</a></li>
</ul>
<h2 id="32-controller"><a class="markdownIt-Anchor" href="#32-controller"></a> 3.2 Controller</h2>
<h3 id="321-replicaset"><a class="markdownIt-Anchor" href="#321-replicaset"></a> 3.2.1 ReplicaSet</h3>
<p><code>ReplicaSet</code>是新一代的<code>Replication Controller</code>，<code>ReplicaSet</code>与<code>Replication Controller</code>之间的唯一区别就是<code>select</code>的方式不同。<code>ReplicaSet</code>支持<code>set-based selector</code>，而<code>Replication Controller</code>仅支持<code>equality-based selector</code></p>
<h4 id="3211-how-to-use-a-replicaset"><a class="markdownIt-Anchor" href="#3211-how-to-use-a-replicaset"></a> 3.2.1.1 How to use a ReplicaSet</h4>
<p>大部分支持<code>Replication Controller</code>的<code>kubectl</code>命令都支持<code>ReplicaSet</code>，其中一个例外就是<code>rolling-update</code>命令。如果我们想要进行灰度升级，更推荐使用<code>Deploymenet</code></p>
<p>尽管<code>ReplicaSet</code>可以独立使用，但到目前为止，它主要的用途就是为<code>Deployment</code>提供一种机制—编排<code>Pod</code>创建、删除、更新</p>
<h4 id="3212-when-to-use-a-replicaset"><a class="markdownIt-Anchor" href="#3212-when-to-use-a-replicaset"></a> 3.2.1.2 When to use a ReplicaSet</h4>
<p><code>ReplicaSet</code>保证了在任何时候，都运行着指定数量的<code>Pod</code>副本。然而，<code>Deployment</code>是一个更高阶的概念，它管理着<code>ReplicaSet</code>、提供声明式的<code>Pod</code>升级方式，以及一些其他的特性。因此，推荐使用<code>Deployment</code>而不是直接使用<code>ReplicaSet</code>，除非我们要使用自定义的升级策略或者根本不需要升级</p>
<h4 id="3213-writing-a-replicaset-manifest"><a class="markdownIt-Anchor" href="#3213-writing-a-replicaset-manifest"></a> 3.2.1.3 Writing a ReplicaSet manifest</h4>
<p><strong>示例</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># modify replicas according to your case</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">tier</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">frontend</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">gcr.io/google_samples/gb-frontend:v3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">          <span class="comment"># If your cluster config does not include a dns service, then to</span></span><br><span class="line">          <span class="comment"># instead access environment variables to find service host</span></span><br><span class="line">          <span class="comment"># info, comment out the &#x27;value: dns&#x27; line above, and uncomment the</span></span><br><span class="line">          <span class="comment"># line below.</span></span><br><span class="line">          <span class="comment"># value: env</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>与其他<code>Kubernetes Object</code>相同，<code>ReplicaSet</code>同样需要<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>三个字段。除此之外，还需要以下字段</p>
<ol>
<li><code>.spec.template</code>: 该字段是<code>.spec</code>字段的唯一要求的字段，<code>.spec.template</code>描述了一个<code>Pod Template</code>，其格式与<code>Pod</code>几乎完全一致，除了不需要<code>apiVersion</code>、<code>kind</code>这两个字段</li>
<li><code>.spec.selector</code>: <code>ReplicaSet</code>会管理所有匹配该<code>Selector</code>的<code>Pod</code>。注意到<code>ReplicaSet</code>并不会区分由它创建或删除的<code>Pod</code>与其他人或过程创建或删除的<code>Pod</code>，因此，我们可以替换掉<code>ReplicaSet</code>，而不会影响到正在执行的<code>Pod</code>，它们仍然会被这个新的<code>ReplicaSet</code>所管理。此外，<code>.spec.template.metadata.labels</code>必须与<code>.spec.selector</code>匹配，否则会被<code>API</code>拒绝</li>
<li><code>.metadata.labels</code>: <code>ReplicaSet</code>还允许拥有自己的<code>Label</code>，通常来说，<code>.spec.template.metadata.labels</code>与<code>.metadata.labels</code>是一致的。同样，它们也可以不一致，<strong>但要注意的是，<code>.metadata.labels</code>与<code>.spec.selector</code>无关</strong></li>
<li><code>.spec.replicas</code>: 该字段指定了<code>Pod</code>副本的数量，默认为1</li>
</ol>
<h4 id="3214-working-with-replicasets"><a class="markdownIt-Anchor" href="#3214-working-with-replicasets"></a> 3.2.1.4 Working with ReplicaSets</h4>
<h5 id="32141-deleting-a-replicaset-and-its-pods"><a class="markdownIt-Anchor" href="#32141-deleting-a-replicaset-and-its-pods"></a> 3.2.1.4.1 Deleting a ReplicaSet and its Pods</h5>
<p>如果我们要删除<code>ReplicaSet</code>以及所有相关的<code>Pod</code>，我们只需要使用<code>kubectl delete</code>来删除<code>ReplicaSet</code>。<code>Garbage Controller</code>默认会自动删除所有相关的<code>Pod</code></p>
<h5 id="32142-deleting-just-a-replicaset"><a class="markdownIt-Anchor" href="#32142-deleting-just-a-replicaset"></a> 3.2.1.4.2 Deleting just a ReplicaSet</h5>
<p>如果我们仅仅要删除<code>ReplicaSet</code>，那么需要在<code>kubectl delete</code>命令加上<code>--cascade=false</code>参数</p>
<p>一旦<code>ReplicaSet</code>被删除后，我们就可以创建一个新的<code>ReplicaSet</code>，如果新的<code>ReplicaSet</code>名字与原来的相同，那么它将会接管之前由原来的<code>ReplicaSet</code>创建的<code>Pod</code>。尽管如此，它不会要求已存在的<code>Pod</code>来满足新的<code>Pod Template</code>。如果要更新<code>Pod</code>使其匹配新的<code>Spec</code>，那么需要使用<code>Rolling Update</code></p>
<h5 id="32143-isolating-pods-from-a-replicaset"><a class="markdownIt-Anchor" href="#32143-isolating-pods-from-a-replicaset"></a> 3.2.1.4.3 Isolating Pods from a ReplicaSet</h5>
<p>我们可以通过改变<code>Pod</code>的<code>Label</code>来将其与<code>ReplicaSet</code>分离（通常用于分离那些用于<code>Debug</code>、<code>Data recovery</code>的<code>Pod</code>），通过这种方式移除<code>Pod</code>后，新的<code>Pod</code>随之会被创建出来</p>
<h5 id="32144-scaling-a-replicaset"><a class="markdownIt-Anchor" href="#32144-scaling-a-replicaset"></a> 3.2.1.4.4 Scaling a ReplicaSet</h5>
<p>我们可以简单的修改<code>ReplicaSet</code>的<code>.spec.replicas</code>字段来进行扩容或缩容。<code>ReplicaSet Controller</code>会保证<code>Pod</code>的数量与<code>ReplicaSet</code>保持一致</p>
<h5 id="32145-replicaset-as-a-horizontal-pod-autoscaler-target"><a class="markdownIt-Anchor" href="#32145-replicaset-as-a-horizontal-pod-autoscaler-target"></a> 3.2.1.4.5 ReplicaSet as a Horizontal Pod Autoscaler Target</h5>
<p><code>ReplicaSet</code>也可以是<code>Horizontal Pod Autoscalers（HPA）</code>的目标。也就是说，<code>HPA</code>可以自动缩放<code>ReplicaSet</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-scaler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>
<h4 id="3215-alternatives-to-replicaset"><a class="markdownIt-Anchor" href="#3215-alternatives-to-replicaset"></a> 3.2.1.5 Alternatives to ReplicaSet</h4>
<h5 id="32151-deploymentrecommended"><a class="markdownIt-Anchor" href="#32151-deploymentrecommended"></a> 3.2.1.5.1 Deployment(recommended)</h5>
<p><code>Deployment</code>是一个<code>Kubernetes Object</code>，它可以包含<code>ReplicaSet</code>，并且可以更新<code>ReplicaSet</code>以及相关的<code>Pod</code>。尽管<code>ReplicaSet</code>可以独立使用，但是通常<code>ReplicaSet</code>都作为<code>Deployment</code>的一种机制来组织<code>Pod</code>的创建、删除和更新。当我们使用<code>Deployment</code>时，<code>ReplicaSet</code>的创建完全由<code>Deployment</code>来管控</p>
<h5 id="32152-bare-pods"><a class="markdownIt-Anchor" href="#32152-bare-pods"></a> 3.2.1.5.2 Bare Pods</h5>
<p>与直接创建<code>Pod</code>不同，<code>ReplicaSet</code>会在<code>Pod</code>删除或者不可用时创建新的<code>Pod</code>来替换原有的<code>Pod</code>，例如<code>Node</code>宕机，或者进行破坏性的维护，例如内核升级。即便我们的应用只需要一个<code>Pod</code>，也应该使用<code>ReplicaSet</code>而不是直接管理<code>Pod</code></p>
<h5 id="32153-job"><a class="markdownIt-Anchor" href="#32153-job"></a> 3.2.1.5.3 Job</h5>
<p>对于预期会终止的<code>Pod</code>而言，推荐使用<code>Job</code>而不是<code>ReplicaSet</code></p>
<h5 id="32154-daemonset"><a class="markdownIt-Anchor" href="#32154-daemonset"></a> 3.2.1.5.4 DaemonSet</h5>
<p><code>DaemonSet</code>可以提供机器级别的功能，例如机器监控，机器日志等。这些<code>Pod</code>有着与机器强相关的生命周期，且优先于其他普通<code>Pod</code>运行。当机器重启或者关机时，可以安全地终止这些<code>Pod</code></p>
<h5 id="32155-replicationcontroller"><a class="markdownIt-Anchor" href="#32155-replicationcontroller"></a> 3.2.1.5.5 ReplicationController</h5>
<p><code>ReplicaSet</code>可以看做是新一代的<code>ReplicationController</code>，他们有着相同的使命，且行为相同。此外，<code>ReplicationController</code>不支持<code>set-based Selector</code></p>
<h3 id="322-replicationcontroller"><a class="markdownIt-Anchor" href="#322-replicationcontroller"></a> 3.2.2 ReplicationController</h3>
<p><code>ReplicationController</code>确保：在任何时候，应用都运行着一定数量的副本</p>
<h4 id="3221-how-a-replicationcontroller-works"><a class="markdownIt-Anchor" href="#3221-how-a-replicationcontroller-works"></a> 3.2.2.1 How a ReplicationController Works</h4>
<p>如果<code>Pod</code>过多，<code>ReplicationController</code>会停止多余的<code>Pod</code>。如果<code>Pod</code>过少，<code>ReplicationController</code>会启动更多的<code>Pod</code>。与人工创建的<code>Pod</code>不同，如果<code>Pod</code>终结了，或者被删除了，那么<code>ReplicationController</code>重新启动一个新的<code>Pod</code>来代替它</p>
<p>在<code>Kubernetes</code>中，我们用缩写<code>rc</code>或<code>rcs</code>来表示<code>ReplicationController</code></p>
<h4 id="3222-writing-a-replicationcontroller-spec"><a class="markdownIt-Anchor" href="#3222-writing-a-replicationcontroller-spec"></a> 3.2.2.2 Writing a ReplicationController Spec</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>与其他<code>Kubernetes Config</code>类似，<code>ReplicationController</code>包含<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>以及<code>spec</code>这四个字段</p>
<ol>
<li><code>.spec.template</code>: 该字段是<code>.spec</code>字段的唯一要求的字段。该字段描述的是一个<code>Pod Template</code>，它拥有与<code>Pod</code>几乎完全一样的<code>schema</code>（没有<code>apiVersion</code>与<code>kind</code>）。除此之外，必须制定<code>Label</code>以及<code>Restart Policy</code>（默认是<code>Always</code>）</li>
<li><code>.metadata.labels</code>: 通常该字段的值与<code>.spec.template.metadata.labels</code>一致。如果<code>.metadata.labels</code>未设置，那么其值默认与<code>.spec.template.metadata.labels</code>相同。尽管如此，这两个字段的值可以不同，但是<code>.metadata.labels</code>不影响<code>ReplicationController</code>的行为</li>
<li><code>.spec.selector</code>: 该字段定义了一个<code>Label Selector</code>，<code>ReplicationController</code>会管理所有与该<code>Label Selector</code>匹配的<code>Pod</code>（无论该<code>Pod</code>是否由<code>ReplicationController</code>创建，<strong>因此要特别注意重叠问题</strong>），这就允许在<code>Pod</code>运行时替换<code>ReplicationController</code>。如果指定了该字段，那么<code>.spec.template.metadata.labels</code>与<code>.spec.selector</code>的值必须相同，否则会被<code>Api Server</code>拒绝，若<code>.spec.selector</code>未指定，那么默认与<code>.spec.template.metadata.labels</code>相同</li>
<li><code>.spec.replicas</code>: 指定同时运行的副本数量，默认为1</li>
</ol>
<h4 id="3223-working-with-replicationcontrollers"><a class="markdownIt-Anchor" href="#3223-working-with-replicationcontrollers"></a> 3.2.2.3 Working with ReplicationControllers</h4>
<h5 id="32231-deleting-a-replicationcontroller-and-its-pods"><a class="markdownIt-Anchor" href="#32231-deleting-a-replicationcontroller-and-its-pods"></a> 3.2.2.3.1 Deleting a ReplicationController and its Pods</h5>
<p>若要删除一个<code>ReplicationController</code>以及相关联的<code>Pod</code>，那么使用<code>kubectl delete</code>命令，<code>kubectl</code>会负责删除所有相关的<code>Pod</code></p>
<h5 id="32232-deleting-just-a-replicationcontroller"><a class="markdownIt-Anchor" href="#32232-deleting-just-a-replicationcontroller"></a> 3.2.2.3.2 Deleting just a ReplicationController</h5>
<p>若仅仅要删除<code>ReplicationController</code>，那么在使用<code>kubectl delete</code>命令时，需要加上<code>--cascade=false</code>选项。当<code>ReplicationController</code>被删除后，我们便可以创建一个新的<code>ReplicationController</code>，若新旧<code>ReplicationController</code>的<code>.spec.selector</code>也相同的话，那么新的<code>ReplicationController</code>会接管先前的<code>Pod</code>，且不会产生影响（即便<code>Pod Template</code>不同）。若要更新<code>Pod</code>使其匹配新的<code>Pod Template</code>，那么需要使用<code>Rolling Update</code></p>
<h5 id="32233-isolating-pods-from-a-replicationcontroller"><a class="markdownIt-Anchor" href="#32233-isolating-pods-from-a-replicationcontroller"></a> 3.2.2.3.3 Isolating pods from a ReplicationController</h5>
<p>我们可以通过改变<code>Pod</code>的<code>Label</code>来将其与<code>ReplicationController</code>分离，这种方式通常用于分离那些用于<code>Debug</code>或<code>Data Recovery</code>的<code>Pod</code>，移除后，<code>ReplicationController</code>会重新补足<code>Pod</code></p>
<h4 id="3224-common-usage-patterns"><a class="markdownIt-Anchor" href="#3224-common-usage-patterns"></a> 3.2.2.4 Common usage patterns</h4>
<h5 id="32241-rescheduling"><a class="markdownIt-Anchor" href="#32241-rescheduling"></a> 3.2.2.4.1 Rescheduling</h5>
<p><code>ReplicationController</code>会保证运行一定数量的副本</p>
<h5 id="32242-scaling"><a class="markdownIt-Anchor" href="#32242-scaling"></a> 3.2.2.4.2 Scaling</h5>
<p>我们可以通过修改<code>replicas</code>字段来进行扩容和缩容</p>
<h5 id="32243-rolling-updates"><a class="markdownIt-Anchor" href="#32243-rolling-updates"></a> 3.2.2.4.3 Rolling updates</h5>
<p><code>ReplicationController</code>旨在通过逐个替换<code>Pod</code>来对<code>Service</code>进行滚动更新</p>
<p>建议的方法是创建一个具有1个副本的新<code>ReplicationController</code>，逐个扩展新的（+1）和旧的（-1）<code>ReplicationController</code>，然后在旧的<code>ReplicationController</code>达到0个副本后删除它</p>
<p><code>ReplicationController</code>需要考虑到应用的准备情况，且保证在任意时刻都运行着一定数量的副本。因此这两个<code>ReplicationController</code>创建的<code>Pod</code>的<code>Label</code>需要有区分度，例如<code>image tage</code>的差异</p>
<p>我们可以通过<code>kubectl rolling-update</code>命令来进行滚动更新</p>
<h5 id="32244-multiple-release-tracks"><a class="markdownIt-Anchor" href="#32244-multiple-release-tracks"></a> 3.2.2.4.4 Multiple release tracks</h5>
<p>在进行滚动升级时，可能同时运行着多个不同的版本，且通常会持续一段时间，我们要对这多个不同版本进行追踪，追踪将依据<code>Label</code>来进行区分</p>
<p>举例来说，最初一个<code>Service</code>中的所有<code>Pod</code>（10个），其<code>Label</code>都是<code>tier in (frontend), environment in (prod)</code>。此时，我们需要引入一个新的版本<code>canary</code>。我们可以创建一个<code>ReplicationController</code>，将其副本数量设定为9，且<code>Label</code>为<code>tier=frontend, environment=prod, track=stable</code>；另一个<code>ReplicationController</code>，将其副本数量设定为1，<code>Label</code>为<code>tier=frontend, environment=prod, track=canary</code>。于是该<code>Service</code>包含了<code>canary</code>以及<code>non-canary</code>两部分</p>
<h5 id="32245-using-replicationcontrollers-with-services"><a class="markdownIt-Anchor" href="#32245-using-replicationcontrollers-with-services"></a> 3.2.2.4.5 Using ReplicationControllers with Services</h5>
<p>同一个<code>Service</code>可以有多个不同的<code>ReplicationController</code>，这样一来，流量可以根据版本进行分流</p>
<p><code>ReplicationController</code>不会自我终结，但是它的生命周期与<code>Service</code>不同。一个<code>Service</code>包含了由不同<code>ReplicationController</code>创建的<code>Pod</code>，且在一个<code>Service</code>的生命中期中可能会有很多<code>ReplicationController</code>被创建和销毁，这些对于<code>Client</code>来说是不感知的</p>
<h4 id="3225-writing-programs-for-replication"><a class="markdownIt-Anchor" href="#3225-writing-programs-for-replication"></a> 3.2.2.5 Writing programs for Replication</h4>
<p>由<code>ReplicationController</code>创建的<code>Pod</code>是可替换的，且在语义上是等价的，尽管随着时间的推移，它们会产生一些差异性。显然，这种特性非常适用于无状态的微服务架构。但是<code>ReplicationController</code>同样可以保持有状态服务架构的高可用性，例如<code>master-elected</code>、<code>shared</code>、<code>worker-pool</code>架构的应用。这些应用需要使用动态的分配机制，而不是静态的一次性的配置。这些动态分配的动作应该由另一个控制器来完成（该控制器是应用的一部分）而不是由<code>ReplicationController</code>来完成</p>
<h4 id="3226-responsibilities-of-the-replicationcontroller"><a class="markdownIt-Anchor" href="#3226-responsibilities-of-the-replicationcontroller"></a> 3.2.2.6 Responsibilities of the ReplicationController</h4>
<p><code>ReplicationController</code>仅确保<code>Pod</code>保持额定的数量。在未来，可能会在<code>Replacement Policy</code>上增加更多的控制，同时引入可供外部用户使用的事件，用来处理更为复杂的<code>Replacement</code></p>
<p><code>ReplicationController</code>的责任仅限于此，<code>ReplicationController</code>自身并不会引入<code>Readiness Probe</code>或<code>Liveness Probe</code>。它通过外部缩放控制器来修改<code>replicas</code>字段，而不是提供自动缩放的机制。<code>ReplicationController</code>不会引入<code>Scheduling Policy</code></p>
<h4 id="3227-api-object"><a class="markdownIt-Anchor" href="#3227-api-object"></a> 3.2.2.7 API Object</h4>
<p><code>ReplicationController</code>是一个顶层的<code>Kubernetes Rest API</code></p>
<h4 id="3228-alternatives-to-replicationcontroller"><a class="markdownIt-Anchor" href="#3228-alternatives-to-replicationcontroller"></a> 3.2.2.8 Alternatives to ReplicationController</h4>
<h5 id="32281-replicaset"><a class="markdownIt-Anchor" href="#32281-replicaset"></a> 3.2.2.8.1 ReplicaSet</h5>
<p><code>ReplicaSet</code>可以看做是下一代的<code>ReplicationController</code>。<code>ReplicaSet</code>支持<code>set-based Label Selector</code>。<code>ReplicaSet</code>作为<code>Deployment</code>的一种机制来组织<code>Pod</code>的创建、删除和更新。我们强烈推荐使用<code>Deployement</code>而不是直接使用<code>ReplicaSet</code></p>
<h5 id="32282-deploymentrecommended"><a class="markdownIt-Anchor" href="#32282-deploymentrecommended"></a> 3.2.2.8.2 Deployment(Recommended)</h5>
<p><code>Deployment</code>是一种高阶的<code>API Object</code>，用于以一种非常简单的方式更新<code>ReplicaSet</code>以及<code>Pod</code>。<code>Deployment</code>具有<code>Rolling Update</code>的能力，且它是声明式的，服务级别的，且拥有额外的功能</p>
<h5 id="32283-bare-pods"><a class="markdownIt-Anchor" href="#32283-bare-pods"></a> 3.2.2.8.3 Bare Pods</h5>
<p>与直接创建<code>Pod</code>不同，<code>ReplicationController</code>会在<code>Pod</code>删除或者不可用时创建新的<code>Pod</code>来替换原有的<code>Pod</code>，例如<code>Node</code>宕机，或者进行破坏性的维护，例如内核升级。即便我们的应用只需要一个<code>Pod</code>，也应该使用<code>ReplicationController</code>而不是直接管理<code>Pod</code></p>
<h5 id="32284-job"><a class="markdownIt-Anchor" href="#32284-job"></a> 3.2.2.8.4 Job</h5>
<p>对于预期会终止的<code>Pod</code>而言，推荐使用<code>Job</code>而不是<code>ReplicationController</code></p>
<h5 id="32285-daemonset"><a class="markdownIt-Anchor" href="#32285-daemonset"></a> 3.2.2.8.5 DaemonSet</h5>
<p><code>DaemonSet</code>可以提供机器级别的功能，例如机器监控，机器日志等。这些<code>Pod</code>有着与机器强相关的生命周期，且优先于其他普通<code>Pod</code>运行。当机器重启或者关机时，可以安全地终止这些<code>Pod</code></p>
<h3 id="323-deployments"><a class="markdownIt-Anchor" href="#323-deployments"></a> 3.2.3 Deployments</h3>
<p><code>Deployment</code>提供了一种声明式的更新<code>Pod</code>或<code>ReplicaSet</code>的方式</p>
<h4 id="3231-creating-a-deployment"><a class="markdownIt-Anchor" href="#3231-creating-a-deployment"></a> 3.2.3.1 Creating a Deployment</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过<code>.metadata.name</code>字段来指定<code>Deployment</code>的名字</li>
<li>通过<code>.spec.replicas</code>字段来指定副本数量</li>
<li>通过<code>.sepc.selector</code>字段来指定匹配何种标签的<code>Pod</code></li>
<li>通过<code>.spec.template</code>字段来描述一个<code>Pod Template</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create deployment</span></span><br><span class="line">kubectl create -f &lt;filepath or url&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># get deployment</span></span><br><span class="line">kubectl get deployments</span><br><span class="line"></span><br><span class="line"><span class="comment"># get replicaSet</span></span><br><span class="line">kubectl get rs</span><br><span class="line"></span><br><span class="line"><span class="comment"># get pods</span></span><br><span class="line">kubectl get pods --show-labels</span><br></pre></td></tr></table></figure>
<h4 id="3232-updating-a-deployment"><a class="markdownIt-Anchor" href="#3232-updating-a-deployment"></a> 3.2.3.2 Updating a Deployment</h4>
<p><code>Deployment</code>会保证同时只有一小部分的<code>Pod</code>处于升级的过程中（可能会暂时无法提供服务），最多25%</p>
<p><code>Deployment</code>会保证同时只有一小部分的<code>Pod</code>处于创建过程中，最多25%</p>
<p><code>Deployment</code>不建议更新<code>Label Selector</code>，这意味着，我们最初就需要定义好<code>Label Selector</code>。但<code>Deployment</code>仍允许我们更新<code>Label Selector</code></p>
<ul>
<li>增加<code>Label Selector</code>，那么<code>Deployment</code>要求<code>Pod Template</code>的<code>Label</code>必须匹配<code>Label Selector</code>。这个操作是非重叠的，意味着所有旧有的<code>ReplicaSet</code>以及<code>Pod</code>将会被孤立，新的<code>ReplicaSet</code>以及<code>Pod</code>会被创建出来</li>
<li>修改<code>Label Selector</code>，会导致增加<code>Label Selector</code>相同的结果</li>
<li>删除<code>Label Selector</code>中的<code>key</code>，不需要修改<code>Pod Template</code>的<code>Label</code>。现有的<code>ReplicaSet</code>不会被孤立，新的<code>ReplicaSet</code>不会被创建</li>
</ul>
<h4 id="3233-rolling-back-a-deployment"><a class="markdownIt-Anchor" href="#3233-rolling-back-a-deployment"></a> 3.2.3.3 Rolling Back a Deployment</h4>
<p>有时候，我们会想要进行回滚，比如新版本不够稳定，或者出现了很严重的错误。<code>Deployment</code>允许我们回滚到任意一次版本</p>
<p>注意到，只有在<code>Deployment rollout</code>触发时，才会创建<code>revision</code>，这意味着，当且仅当<code>Pod Template</code>发生变化时（例如修改<code>Label</code>或者镜像），才会创建<code>revision</code>。其他的更新，例如进行缩容或者扩容，不会创建<code>revision</code>。这意味着回滚到一个早期的版本，回滚的仅仅是<code>Pod Template</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check the revisions of this deployment</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># see details of specific revision</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment.v1.apps/nginx-deployment --revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># undo the current rollout</span></span><br><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># rollback to previous revision</span></span><br><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment --to-revision=2</span><br></pre></td></tr></table></figure>
<h4 id="3234-scaling-a-deployment"><a class="markdownIt-Anchor" href="#3234-scaling-a-deployment"></a> 3.2.3.4 Scaling a Deployment</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scale a deployment</span></span><br><span class="line">kubectl scale deployment.v1.apps/nginx-deployment --replicas=10</span><br><span class="line"></span><br><span class="line"><span class="comment"># autoscale</span></span><br><span class="line">kubectl autoscale deployment.v1.apps/nginx-deployment --min=10 --max=15 --cpu-percent=80</span><br></pre></td></tr></table></figure>
<h4 id="3235-pausing-and-resuming-a-deployment"><a class="markdownIt-Anchor" href="#3235-pausing-and-resuming-a-deployment"></a> 3.2.3.5 Pausing and Resuming a Deployment</h4>
<p>我们可以暂停一个<code>Deployment</code>，然后进行一些更新操作，再还原该<code>Deployment</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pause deployment</span></span><br><span class="line">kubectl rollout pause deployment.v1.apps/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># update image</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># update resource</span></span><br><span class="line">kubectl <span class="built_in">set</span> resources deployment.v1.apps/nginx-deployment -c=nginx --limits=cpu=200m,memory=512Mi</span><br><span class="line"></span><br><span class="line"><span class="comment"># resume deployment</span></span><br><span class="line">kubectl rollout resume deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
<h4 id="3236-deployment-status"><a class="markdownIt-Anchor" href="#3236-deployment-status"></a> 3.2.3.6 Deployment Status</h4>
<p><code>Deployment</code>在生命周期中会经历多个不同的状态</p>
<ol>
<li><code>progressing</code></li>
<li><code>complete</code></li>
<li><code>failed</code></li>
</ol>
<p><strong>progressing</strong></p>
<ol>
<li>正在创建<code>ReplicaSet</code></li>
<li>正在扩容</li>
<li>正在缩容</li>
</ol>
<p><strong>complete</strong></p>
<ol>
<li>所有副本都更新到期望的版本了</li>
<li>所有副本都可用了</li>
<li>没有正在运行的旧版本的副本</li>
</ol>
<p><strong>failed</strong></p>
<ol>
<li>配额不足</li>
<li><code>Readiness Probe</code>失败了</li>
<li>拉取镜像失败</li>
<li>权限不足</li>
<li>应用配置有问题</li>
</ol>
<h4 id="3237-clean-up-policy"><a class="markdownIt-Anchor" href="#3237-clean-up-policy"></a> 3.2.3.7 Clean up Policy</h4>
<p>我们可以通过设置<code>.spec.revisionHistoryLimit</code>来控制<code>Deployment</code>保留多少个历史版本，默认是10，超过该数值的<code>ReplicaSet</code>会被回收</p>
<h4 id="3238-writing-a-deployment-spec"><a class="markdownIt-Anchor" href="#3238-writing-a-deployment-spec"></a> 3.2.3.8 Writing a Deployment Spec</h4>
<p>与其他<code>Kubernetes Config</code>类似，<code>Deploymenet</code>必须包含<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>、<code>spec</code>四个字段</p>
<p><strong>Pod Template</strong></p>
<ul>
<li><code>.spec.template</code>: <code>.spec</code>的唯一必须的字段，它描述了一个<code>Pod Template</code>，<code>Pod Tempalte</code>的schema与<code>Pod</code>几乎完全一致（不需要<code>apiVersion</code>和<code>kind</code>）</li>
<li><code>Pod Template</code>必须指定<code>Label</code>以及<code>Restart Policy</code>，其中<code>.spec.template.spec.restartPolicy</code>只允许设置成<code>Always</code>，默认就是<code>Always</code></li>
</ul>
<p><strong>Replicas</strong></p>
<ul>
<li><code>.spec.replicas</code>: 指定副本数量，默认1</li>
</ul>
<p><strong>Selector</strong></p>
<ul>
<li><code>.spec.selector</code>: 定义了一个<code>Label Selector</code></li>
<li><code>.spec.selector</code>与<code>.spec.template.metadata.labels</code>必须匹配，否则会被拒绝</li>
</ul>
<p><strong>Strategy</strong></p>
<ul>
<li><code>.spec.strategy</code>: 定义了新老<code>Pod</code>更替的策略，可选项有<code>Recreate</code>、<code>RollingUpdate</code>，默认是<code>RollingUpdate</code></li>
<li><code>Recreate</code>在更新时，旧的<code>Pod</code>全部被终结后，新的<code>Pod</code>才会创建</li>
<li><code>RollingUpdate</code>: 灰度更新，仅允许一小部分的<code>Pod</code>进行更替，始终保持服务的可用状态</li>
</ul>
<h4 id="3239-alternative-to-deployments"><a class="markdownIt-Anchor" href="#3239-alternative-to-deployments"></a> 3.2.3.9 Alternative to Deployments</h4>
<p>使用<code>kubectl rolling update</code>来滚动升级<code>Pod</code>和<code>ReplicationController</code>与<code>Deployment</code>是类似的。但是<code>Deployment</code>是更推荐的方式，因为它是声明式的，服务级别的，未来可能会有新的功能</p>
<h3 id="324-statefulsets"><a class="markdownIt-Anchor" href="#324-statefulsets"></a> 3.2.4 StatefulSets</h3>
<p>与<code>Deployment</code>相同，<code>StagefulSet</code>管理基于相同容器规范的<code>Pod</code>。与<code>Deployment</code>不同，<code>StagefulSet</code>为每个<code>Pod</code>都生成一个唯一且不可变的标志符，这些标志符全局唯一</p>
<h4 id="3241-using-statefulsets"><a class="markdownIt-Anchor" href="#3241-using-statefulsets"></a> 3.2.4.1 Using StatefulSets</h4>
<p><code>StagefulSet</code>有如下特点</p>
<ol>
<li>稳定，唯一的网络标志</li>
<li>稳定的持久化存储</li>
<li>有序且优雅的部署以及扩缩容</li>
<li>有序自动的滚动更新</li>
</ol>
<h4 id="3242-limitations"><a class="markdownIt-Anchor" href="#3242-limitations"></a> 3.2.4.2 Limitations</h4>
<h4 id="3243-components"><a class="markdownIt-Anchor" href="#3243-components"></a> 3.2.4.3 Components</h4>
<h4 id="3244-pod-selector"><a class="markdownIt-Anchor" href="#3244-pod-selector"></a> 3.2.4.4 Pod Selector</h4>
<h4 id="3245-pod-indentity"><a class="markdownIt-Anchor" href="#3245-pod-indentity"></a> 3.2.4.5 Pod Indentity</h4>
<h4 id="3246-deployment-and-scaling-guarantees"><a class="markdownIt-Anchor" href="#3246-deployment-and-scaling-guarantees"></a> 3.2.4.6 Deployment and Scaling Guarantees</h4>
<h4 id="3247-update-strategies"><a class="markdownIt-Anchor" href="#3247-update-strategies"></a> 3.2.4.7 Update Strategies</h4>
<h3 id="325-daemonset"><a class="markdownIt-Anchor" href="#325-daemonset"></a> 3.2.5 DaemonSet</h3>
<h3 id="326-garbage-collection"><a class="markdownIt-Anchor" href="#326-garbage-collection"></a> 3.2.6 Garbage Collection</h3>
<h3 id="327-ttl-controller-for-finished-resources"><a class="markdownIt-Anchor" href="#327-ttl-controller-for-finished-resources"></a> 3.2.7 TTL Controller for Finished Resources</h3>
<h3 id="328-jobs-run-to-completion"><a class="markdownIt-Anchor" href="#328-jobs-run-to-completion"></a> 3.2.8 Jobs - Run to Completion</h3>
<h3 id="329-cronjob"><a class="markdownIt-Anchor" href="#329-cronjob"></a> 3.2.9 CronJob</h3>
<h1 id="4-services-load-balancing-and-networking"><a class="markdownIt-Anchor" href="#4-services-load-balancing-and-networking"></a> 4 Services, Load Balancing and Networking</h1>
<h2 id="41-services"><a class="markdownIt-Anchor" href="#41-services"></a> 4.1 Services</h2>
<p><code>Pod</code>是无法再生的。<code>ReplicaSet</code>可以动态地创建或删除<code>Pod</code>，每个<code>Pod</code>都会分配一个<code>IP</code>，显然随着<code>Pod</code>的新老更替，这些<code>IP</code>是不固定的。这就导致了一个问题，如果一个<code>Pod</code>提供了某种服务给其他位于同一集群中的<code>Pod</code>，那么这些<code>Pod</code>如何找到服务提供方呢</p>
<p><code>Service</code>的引入解决了这个问题，<strong><code>Service</code>是一组<code>Pod</code>以及他们访问方式的抽象</strong>。<code>Service</code>通过<code>Label Selector</code>来匹配对应的<code>Pod</code>。<code>Service</code>解耦了<code>Consumer</code>和<code>Provider</code>（从这个角度来说，<code>Service</code>与RPC框架解决了类似的问题）</p>
<h3 id="411-defining-a-service"><a class="markdownIt-Anchor" href="#411-defining-a-service"></a> 4.1.1 Defining a service</h3>
<p>与<code>Pod</code>类似，<code>Service</code>也是一个<code>Rest Object</code>，可以通过<code>Api Server</code>来创建实例，例如</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br></pre></td></tr></table></figure>
<p>通过上面这份配置，会创建一个名为<code>my-service</code>，该<code>Service</code>会将<code>80</code>端口的流量路由到任意包含标签<code>app=MyApp</code>的<code>Pod</code>的<code>9376</code>端口</p>
<p>每个<code>Service</code>都会被分配一个<code>Cluster IP</code>，<code>Service Proxy</code>会用到这个<code>Cluster IP</code>，<code>Service</code>的<code>Label Selector</code>匹配会持续进行，其结果过会同步到同名的<code>Endpoint</code>，<strong><code>Endpoint</code>维护了<code>Service</code>与<code>Pod</code>的映射关系</strong></p>
<p><code>Service</code>可以将一个入口端口映射成任意<code>targetPort</code>，<code>targetPort</code>默认与<code>port</code>相同，此外<code>targetPort</code>还可以是一个字符串，指代端口的名称，不同的<code>Pod</code>包含的端口名与端口的映射关系可以不同，这提供了非常多的灵活性</p>
<p><code>Service</code>支持<code>TCP</code>、<code>UDP</code>、<code>SCTP</code>协议，默认是<code>TCP</code>协议</p>
<h4 id="4111-services-without-selectors"><a class="markdownIt-Anchor" href="#4111-services-without-selectors"></a> 4.1.1.1 Services without selectors</h4>
<p><code>Service</code>通常抽象了访问<code>Pod</code>的方式，但是它也可以抽象其他后端实体的访问方式，例如</p>
<ol>
<li>在生产环境以及测试环境中使用的<code>database</code>是不同的</li>
<li>我们想将<code>Service</code>暴露给另一个<code>Namespace</code>或者另一个集群</li>
<li>应用的多分实例中，一部分部署在<code>Kubernetes</code>集群中，另一部分部署在<code>Kubernetes</code>集群外</li>
</ol>
<p>在以上这些情况中，我们可以定义一个没有<code>Label Selector</code>的<code>Service</code>，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br></pre></td></tr></table></figure>
<p>由于这个<code>Service</code>没有配置<code>Label Selector</code>，因此不会有<code>Endpoint</code>对象生成。但是，我们可以手动配置<code>Endpoint</code>，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9376</span></span><br></pre></td></tr></table></figure>
<p>在无<code>Label Selector</code>的场景下，<code>Service</code>的工作方式还是一样的。流量会被路由到<code>Endpoint</code>中</p>
<p><code>ExternalName Service</code>是无<code>Label Selector</code>的，且使用的是<code>DNS</code></p>
<h3 id="412-virtual-ips-and-service-proxies"><a class="markdownIt-Anchor" href="#412-virtual-ips-and-service-proxies"></a> 4.1.2 Virtual IPs and service proxies</h3>
<p>每个<code>Node</code>都运行着<code>kube-proxy</code>这个组件。<code>kube-proxy</code>为除了<code>ExternalName</code>类型之外的<code>Service</code>提供了一种虚拟IP</p>
<h4 id="4121-proxy-mode-userspace"><a class="markdownIt-Anchor" href="#4121-proxy-mode-userspace"></a> 4.1.2.1 Proxy-mode: userspace</h4>
<ol>
<li><strong>该模式最主要的特征是：流量重定向工作是由<code>kube-proxy</code>完成的，也就是在用户空间完成的</strong></li>
<li><code>kube-proxy</code>会监听<code>Service</code>的创建和删除，当发现新的<code>Service</code>创建出来后，<code>kube-proxy</code>会在<code>localhost</code>网络开启一个随机端口（记为<code>loPort</code>）进行监听，同时向<code>iptable</code>写入路由规则（<code>Cluster IP:Port</code>-&gt;<code>localhost:loPort</code>），即将流向<code>Service</code>的流量转发到本地监听的端口上来</li>
<li><code>kube-proxy</code>会监听<code>Endpoint</code>的变更，并将<code>Service</code>及其对应的<code>Pod</code>列表保存起来</li>
</ol>
<p><img src="/images/Kubernetes-Concept/proxy-mode-userspace.svg" alt="proxy-mode-userspace" /></p>
<p>在<code>Pod</code>中访问<code>Service</code>的时序图如下</p>
<img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjM2NXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MTA0MnB4O2hlaWdodDozNjVweDtiYWNrZ3JvdW5kOiNFRUVCREM7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMDQyIDM2NSIgd2lkdGg9IjEwNDJweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PGRlZnMvPjxnPjxyZWN0IGZpbGw9IiNFRUVCREMiIGhlaWdodD0iMzY1IiBzdHlsZT0ic3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMTA0MiIgeD0iMCIgeT0iMCIvPjxyZWN0IGZpbGw9IiNGRkZGQ0MiIGhlaWdodD0iMjYuNjQwNiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojRkZERDg4O3N0cm9rZS13aWR0aDozOyIgd2lkdGg9IjEwMzEuNTA2NyIgeD0iNSIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTAiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzU1LjIxIiB4PSIxMCIgeT0iMjAiPlBsZWFzZSYjMTYwO3VzZSYjMTYwOychb3B0aW9uJiMxNjA7aGFuZHdyaXR0ZW4mIzE2MDt0cnVlJyYjMTYwO3RvJiMxNjA7ZW5hYmxlJiMxNjA7aGFuZHdyaXR0ZW48L3RleHQ+PGc+PHRpdGxlPlBvZDwvdGl0bGU+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBwb2ludHM9IjIzLjcyMTcsNzYuNDI5NywyMy43MjE3LDc2LjQ5OTcsMjUuMzIxNyw3Ni4yOTE2LDI2LjkyMTcsNzYuNDk0MSwyOC41MjE3LDc2LjU2MjksMzAuMTIxNyw3Ni4xOTE5LDMxLjcyMTcsNzYuNDI5NywzMS42NDQsNzYuNDI5NywzMS4yOTUyLDg2LjQyNjksMzEuMzM4Miw5Ni40MjQxLDMxLjY1MzUsMTA2LjQyMTMsMzEuMDMwMywxMTYuNDE4NCwzMi4yNzUzLDEyNi40MTU2LDMxLjA5MTQsMTM2LjQxMjgsMzEuNTIzOSwxNDYuNDEsMzIuMTUzNiwxNTYuNDA3MiwzMS42MzU5LDE2Ni40MDQ0LDMxLjc4OTksMTc2LjQwMTYsMzEuNjg5NywxODYuMzk4OCwzMS45MDAyLDE5Ni4zOTU5LDMxLjk2MDgsMjA2LjM5MzEsMzIuMzA3NCwyMTYuMzkwMywzMi4zOTI3LDIyNi4zODc1LDMyLjQwMDksMjM2LjM4NDcsMzEuOTc2MywyNDYuMzgxOSwzMi4xODUzLDI1Ni4zNzkxLDMyLjQyMzksMjY2LjM3NjMsMzEuMDAwNSwyNzYuMzczNCwzMi40MDAyLDI4Ni4zNzA2LDMxLjQyNTIsMjk2LjM2NzgsMzIuMjU1NSwzMDYuMzY1LDMxLjIyNjcsMzE2LjM2MjIsMzEuNzIxNywzMjYuMzU5NCwzMS43MjE3LDMyNi4zMzY1LDMwLjEyMTcsMzI2LjYwNjYsMjguNTIxNywzMjYuMzQzMSwyNi45MjE3LDMyNi4zOTQ1LDI1LjMyMTcsMzI2LjQ3MjMsMjMuNzIxNywzMjYuMzU5NCwyNC4xMzc5LDMyNi4zNTk0LDIzLjcxNzgsMzE2LjM2MjIsMjQuMDA4OSwzMDYuMzY1LDIzLjE0OTMsMjk2LjM2NzgsMjQuMDA2MSwyODYuMzcwNiwyNC4yNjk5LDI3Ni4zNzM0LDI0LjE2NjIsMjY2LjM3NjMsMjQuMzM0NywyNTYuMzc5MSwyMy4yMzg2LDI0Ni4zODE5LDIzLjA2OTUsMjM2LjM4NDcsMjMuMTAwMywyMjYuMzg3NSwyMy42NjI4LDIxNi4zOTAzLDIzLjUyNTIsMjA2LjM5MzEsMjQuNDAzMSwxOTYuMzk1OSwyMy41NDcsMTg2LjM5ODcsMjMuMzc4NiwxNzYuNDAxNiwyMy45NDk5LDE2Ni40MDQ0LDIzLjA1NDgsMTU2LjQwNzIsMjMuMjAyNiwxNDYuNDEsMjQuMzcwNiwxMzYuNDEyOCwyNC4xNTczLDEyNi40MTU2LDI0LjQ1NjIsMTE2LjQxODQsMjMuMzk5OSwxMDYuNDIxMiwyNC4wNDA5LDk2LjQyNDEsMjQuMzEyMSw4Ni40MjY5LDIzLjcyMTcsNzYuNDI5NyIvPjxwYXRoIGQ9Ik0yNyw3Ni40Mjk3IEwyNy4yODAyLDc2LjQyOTcgTDI2LjQ0NzYsODYuNDI2OSBMMjcuMjU3Nyw5Ni40MjQxIEwyNy41MzI5LDEwNi40MjEzIEwyNi4wNDg4LDExNi40MTg0IEwyNi44OTY0LDEyNi40MTU2IEwyNi40MzEzLDEzNi40MTI4IEwyNi40ODg3LDE0Ni40MSBMMjYuOTA5MSwxNTYuNDA3MiBMMjYuMDc4MiwxNjYuNDA0NCBMMjcuNzM4MiwxNzYuNDAxNiBMMjYuMTU5NiwxODYuMzk4OCBMMjYuNzM2MywxOTYuMzk1OSBMMjcuNTc1OSwyMDYuMzkzMSBMMjYuODg1NiwyMTYuMzkwMyBMMjcuMDkxLDIyNi4zODc1IEwyNi45NTc0LDIzNi4zODQ3IEwyNy4yMzgsMjQ2LjM4MTkgTDI3LjMxODgsMjU2LjM3OTEgTDI3Ljc4MDksMjY2LjM3NjMgTDI3Ljg5NDcsMjc2LjM3MzQgTDI3LjkwNTcsMjg2LjM3MDYgTDI3LjMzOTUsMjk2LjM2NzggTDI3LjYxODEsMzA2LjM2NSBMMjcuOTM2MywzMTYuMzYyMiBMMjcsMzI2LjM1OTQiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwMDBGRjtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiLz48L2c+PGc+PHRpdGxlPmxvY2FsRE5TPC90aXRsZT48cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIHBvaW50cz0iMjU5LjU4NzUsNzYuNDI5NywyNTkuNTg3NSw3Ni40OTk3LDI2MS4xODc1LDc2LjI5MTYsMjYyLjc4NzUsNzYuNDk0MSwyNjQuMzg3NSw3Ni41NjI5LDI2NS45ODc1LDc2LjE5MTksMjY3LjU4NzUsNzYuNDI5NywyNjcuNTA5OCw3Ni40Mjk3LDI2Ny4xNjEsODYuNDI2OSwyNjcuMjA0LDk2LjQyNDEsMjY3LjUxOTMsMTA2LjQyMTMsMjY2Ljg5NjEsMTE2LjQxODQsMjY4LjE0MTEsMTI2LjQxNTYsMjY2Ljk1NzIsMTM2LjQxMjgsMjY3LjM4OTcsMTQ2LjQxLDI2OC4wMTk0LDE1Ni40MDcyLDI2Ny41MDE3LDE2Ni40MDQ0LDI2Ny42NTU3LDE3Ni40MDE2LDI2Ny41NTU1LDE4Ni4zOTg4LDI2Ny43NjYsMTk2LjM5NTksMjY3LjgyNjYsMjA2LjM5MzEsMjY4LjE3MzIsMjE2LjM5MDMsMjY4LjI1ODUsMjI2LjM4NzUsMjY4LjI2NjcsMjM2LjM4NDcsMjY3Ljg0MjEsMjQ2LjM4MTksMjY4LjA1MTEsMjU2LjM3OTEsMjY4LjI4OTcsMjY2LjM3NjMsMjY2Ljg2NjMsMjc2LjM3MzQsMjY4LjI2NiwyODYuMzcwNiwyNjcuMjkxLDI5Ni4zNjc4LDI2OC4xMjEzLDMwNi4zNjUsMjY3LjA5MjUsMzE2LjM2MjIsMjY3LjU4NzUsMzI2LjM1OTQsMjY3LjU4NzUsMzI2LjMzNjUsMjY1Ljk4NzUsMzI2LjYwNjYsMjY0LjM4NzUsMzI2LjM0MzEsMjYyLjc4NzUsMzI2LjM5NDUsMjYxLjE4NzUsMzI2LjQ3MjMsMjU5LjU4NzUsMzI2LjM1OTQsMjYwLjAwMzcsMzI2LjM1OTQsMjU5LjU4MzYsMzE2LjM2MjIsMjU5Ljg3NDcsMzA2LjM2NSwyNTkuMDE1MSwyOTYuMzY3OCwyNTkuODcxOSwyODYuMzcwNiwyNjAuMTM1NywyNzYuMzczNCwyNjAuMDMyLDI2Ni4zNzYzLDI2MC4yMDA1LDI1Ni4zNzkxLDI1OS4xMDQ0LDI0Ni4zODE5LDI1OC45MzUzLDIzNi4zODQ3LDI1OC45NjYxLDIyNi4zODc1LDI1OS41Mjg2LDIxNi4zOTAzLDI1OS4zOTEsMjA2LjM5MzEsMjYwLjI2ODksMTk2LjM5NTksMjU5LjQxMjgsMTg2LjM5ODcsMjU5LjI0NDQsMTc2LjQwMTYsMjU5LjgxNTcsMTY2LjQwNDQsMjU4LjkyMDYsMTU2LjQwNzIsMjU5LjA2ODQsMTQ2LjQxLDI2MC4yMzY0LDEzNi40MTI4LDI2MC4wMjMxLDEyNi40MTU2LDI2MC4zMjIsMTE2LjQxODQsMjU5LjI2NTcsMTA2LjQyMTIsMjU5LjkwNjcsOTYuNDI0MSwyNjAuMTc3OSw4Ni40MjY5LDI1OS41ODc1LDc2LjQyOTciLz48cGF0aCBkPSJNMjYzLjQ4MjcsNzYuNDI5NyBMMjYzLjc2Myw3Ni40Mjk3IEwyNjIuOTMwMyw4Ni40MjY5IEwyNjMuNzQwNSw5Ni40MjQxIEwyNjQuMDE1NiwxMDYuNDIxMyBMMjYyLjUzMTUsMTE2LjQxODQgTDI2My4zNzkxLDEyNi40MTU2IEwyNjIuOTE0MSwxMzYuNDEyOCBMMjYyLjk3MTQsMTQ2LjQxIEwyNjMuMzkxOSwxNTYuNDA3MiBMMjYyLjU2MDksMTY2LjQwNDQgTDI2NC4yMjA5LDE3Ni40MDE2IEwyNjIuNjQyNCwxODYuMzk4OCBMMjYzLjIxOTEsMTk2LjM5NTkgTDI2NC4wNTg3LDIwNi4zOTMxIEwyNjMuMzY4NCwyMTYuMzkwMyBMMjYzLjU3MzcsMjI2LjM4NzUgTDI2My40NDAxLDIzNi4zODQ3IEwyNjMuNzIwOCwyNDYuMzgxOSBMMjYzLjgwMTYsMjU2LjM3OTEgTDI2NC4yNjM3LDI2Ni4zNzYzIEwyNjQuMzc3NSwyNzYuMzczNCBMMjY0LjM4ODQsMjg2LjM3MDYgTDI2My44MjIyLDI5Ni4zNjc4IEwyNjQuMTAwOSwzMDYuMzY1IEwyNjQuNDE5MSwzMTYuMzYyMiBMMjYzLjQ4MjcsMzI2LjM1OTQiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwMDBGRjtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiLz48L2c+PGc+PHRpdGxlPmlwdGFibGU8L3RpdGxlPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgcG9pbnRzPSIzNTAuOTc3NCw3Ni40Mjk3LDM1MC45Nzc0LDc2LjQ5OTcsMzUyLjU3NzQsNzYuMjkxNiwzNTQuMTc3NCw3Ni40OTQxLDM1NS43Nzc0LDc2LjU2MjksMzU3LjM3NzQsNzYuMTkxOSwzNTguOTc3NCw3Ni40Mjk3LDM1OC44OTk3LDc2LjQyOTcsMzU4LjU1MDksODYuNDI2OSwzNTguNTkzOSw5Ni40MjQxLDM1OC45MDkyLDEwNi40MjEzLDM1OC4yODYsMTE2LjQxODQsMzU5LjUzMSwxMjYuNDE1NiwzNTguMzQ3MSwxMzYuNDEyOCwzNTguNzc5NiwxNDYuNDEsMzU5LjQwOTMsMTU2LjQwNzIsMzU4Ljg5MTYsMTY2LjQwNDQsMzU5LjA0NTYsMTc2LjQwMTYsMzU4Ljk0NTQsMTg2LjM5ODgsMzU5LjE1NTksMTk2LjM5NTksMzU5LjIxNjUsMjA2LjM5MzEsMzU5LjU2MzEsMjE2LjM5MDMsMzU5LjY0ODQsMjI2LjM4NzUsMzU5LjY1NjYsMjM2LjM4NDcsMzU5LjIzMiwyNDYuMzgxOSwzNTkuNDQxLDI1Ni4zNzkxLDM1OS42Nzk2LDI2Ni4zNzYzLDM1OC4yNTYyLDI3Ni4zNzM0LDM1OS42NTU5LDI4Ni4zNzA2LDM1OC42ODA5LDI5Ni4zNjc4LDM1OS41MTEyLDMwNi4zNjUsMzU4LjQ4MjMsMzE2LjM2MjIsMzU4Ljk3NzQsMzI2LjM1OTQsMzU4Ljk3NzQsMzI2LjMzNjUsMzU3LjM3NzQsMzI2LjYwNjYsMzU1Ljc3NzQsMzI2LjM0MzEsMzU0LjE3NzQsMzI2LjM5NDUsMzUyLjU3NzQsMzI2LjQ3MjMsMzUwLjk3NzQsMzI2LjM1OTQsMzUxLjM5MzYsMzI2LjM1OTQsMzUwLjk3MzUsMzE2LjM2MjIsMzUxLjI2NDYsMzA2LjM2NSwzNTAuNDA1LDI5Ni4zNjc4LDM1MS4yNjE4LDI4Ni4zNzA2LDM1MS41MjU2LDI3Ni4zNzM0LDM1MS40MjE5LDI2Ni4zNzYzLDM1MS41OTA0LDI1Ni4zNzkxLDM1MC40OTQzLDI0Ni4zODE5LDM1MC4zMjUyLDIzNi4zODQ3LDM1MC4zNTYsMjI2LjM4NzUsMzUwLjkxODUsMjE2LjM5MDMsMzUwLjc4MDgsMjA2LjM5MzEsMzUxLjY1ODgsMTk2LjM5NTksMzUwLjgwMjcsMTg2LjM5ODcsMzUwLjYzNDMsMTc2LjQwMTYsMzUxLjIwNTYsMTY2LjQwNDQsMzUwLjMxMDUsMTU2LjQwNzIsMzUwLjQ1ODIsMTQ2LjQxLDM1MS42MjYzLDEzNi40MTI4LDM1MS40MTMsMTI2LjQxNTYsMzUxLjcxMTksMTE2LjQxODQsMzUwLjY1NTYsMTA2LjQyMTIsMzUxLjI5NjYsOTYuNDI0MSwzNTEuNTY3OCw4Ni40MjY5LDM1MC45Nzc0LDc2LjQyOTciLz48cGF0aCBkPSJNMzU0LjY5MjIsNzYuNDI5NyBMMzU0Ljk3MjUsNzYuNDI5NyBMMzU0LjEzOTgsODYuNDI2OSBMMzU0Ljk0OTksOTYuNDI0MSBMMzU1LjIyNTEsMTA2LjQyMTMgTDM1My43NDEsMTE2LjQxODQgTDM1NC41ODg2LDEyNi40MTU2IEwzNTQuMTIzNiwxMzYuNDEyOCBMMzU0LjE4MDksMTQ2LjQxIEwzNTQuNjAxMywxNTYuNDA3MiBMMzUzLjc3MDQsMTY2LjQwNDQgTDM1NS40MzA0LDE3Ni40MDE2IEwzNTMuODUxOCwxODYuMzk4OCBMMzU0LjQyODUsMTk2LjM5NTkgTDM1NS4yNjgxLDIwNi4zOTMxIEwzNTQuNTc3OCwyMTYuMzkwMyBMMzU0Ljc4MzIsMjI2LjM4NzUgTDM1NC42NDk2LDIzNi4zODQ3IEwzNTQuOTMwMiwyNDYuMzgxOSBMMzU1LjAxMTEsMjU2LjM3OTEgTDM1NS40NzMxLDI2Ni4zNzYzIEwzNTUuNTg3LDI3Ni4zNzM0IEwzNTUuNTk3OSwyODYuMzcwNiBMMzU1LjAzMTcsMjk2LjM2NzggTDM1NS4zMTAzLDMwNi4zNjUgTDM1NS42Mjg1LDMxNi4zNjIyIEwzNTQuNjkyMiwzMjYuMzU5NCIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDAwMEZGO3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIvPjwvZz48Zz48dGl0bGU+a3ViZV9wcm94eTwvdGl0bGU+PHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBwb2ludHM9IjUxMC4wNjgyLDc2LjQyOTcsNTEwLjA2ODIsNzYuNDk5Nyw1MTEuNjY4Miw3Ni4yOTE2LDUxMy4yNjgyLDc2LjQ5NDEsNTE0Ljg2ODIsNzYuNTYyOSw1MTYuNDY4Miw3Ni4xOTE5LDUxOC4wNjgyLDc2LjQyOTcsNTE3Ljk5MDUsNzYuNDI5Nyw1MTcuNjQxNyw4Ni40MjY5LDUxNy42ODQ3LDk2LjQyNDEsNTE4LDEwNi40MjEzLDUxNy4zNzY4LDExNi40MTg0LDUxOC42MjE4LDEyNi40MTU2LDUxNy40Mzc5LDEzNi40MTI4LDUxNy44NzA0LDE0Ni40MSw1MTguNTAwMSwxNTYuNDA3Miw1MTcuOTgyNCwxNjYuNDA0NCw1MTguMTM2NCwxNzYuNDAxNiw1MTguMDM2MiwxODYuMzk4OCw1MTguMjQ2NywxOTYuMzk1OSw1MTguMzA3MywyMDYuMzkzMSw1MTguNjUzOSwyMTYuMzkwMyw1MTguNzM5MiwyMjYuMzg3NSw1MTguNzQ3NCwyMzYuMzg0Nyw1MTguMzIyOCwyNDYuMzgxOSw1MTguNTMxOCwyNTYuMzc5MSw1MTguNzcwNCwyNjYuMzc2Myw1MTcuMzQ3LDI3Ni4zNzM0LDUxOC43NDY3LDI4Ni4zNzA2LDUxNy43NzE3LDI5Ni4zNjc4LDUxOC42MDIsMzA2LjM2NSw1MTcuNTczMiwzMTYuMzYyMiw1MTguMDY4MiwzMjYuMzU5NCw1MTguMDY4MiwzMjYuMzM2NSw1MTYuNDY4MiwzMjYuNjA2Niw1MTQuODY4MiwzMjYuMzQzMSw1MTMuMjY4MiwzMjYuMzk0NSw1MTEuNjY4MiwzMjYuNDcyMyw1MTAuMDY4MiwzMjYuMzU5NCw1MTAuNDg0NCwzMjYuMzU5NCw1MTAuMDY0MywzMTYuMzYyMiw1MTAuMzU1NCwzMDYuMzY1LDUwOS40OTU4LDI5Ni4zNjc4LDUxMC4zNTI2LDI4Ni4zNzA2LDUxMC42MTY0LDI3Ni4zNzM0LDUxMC41MTI3LDI2Ni4zNzYzLDUxMC42ODEyLDI1Ni4zNzkxLDUwOS41ODUxLDI0Ni4zODE5LDUwOS40MTYsMjM2LjM4NDcsNTA5LjQ0NjgsMjI2LjM4NzUsNTEwLjAwOTMsMjE2LjM5MDMsNTA5Ljg3MTcsMjA2LjM5MzEsNTEwLjc0OTYsMTk2LjM5NTksNTA5Ljg5MzUsMTg2LjM5ODcsNTA5LjcyNTEsMTc2LjQwMTYsNTEwLjI5NjUsMTY2LjQwNDQsNTA5LjQwMTQsMTU2LjQwNzIsNTA5LjU0OTEsMTQ2LjQxLDUxMC43MTcxLDEzNi40MTI4LDUxMC41MDM5LDEyNi40MTU2LDUxMC44MDI3LDExNi40MTg0LDUwOS43NDY0LDEwNi40MjEyLDUxMC4zODc0LDk2LjQyNDEsNTEwLjY1ODYsODYuNDI2OSw1MTAuMDY4Miw3Ni40Mjk3Ii8+PHBhdGggZD0iTTUxMy43MzI1LDc2LjQyOTcgTDUxNC4wMTI3LDc2LjQyOTcgTDUxMy4xODAxLDg2LjQyNjkgTDUxMy45OTAyLDk2LjQyNDEgTDUxNC4yNjU0LDEwNi40MjEzIEw1MTIuNzgxMywxMTYuNDE4NCBMNTEzLjYyODksMTI2LjQxNTYgTDUxMy4xNjM4LDEzNi40MTI4IEw1MTMuMjIxMiwxNDYuNDEgTDUxMy42NDE2LDE1Ni40MDcyIEw1MTIuODEwNywxNjYuNDA0NCBMNTE0LjQ3MDcsMTc2LjQwMTYgTDUxMi44OTIxLDE4Ni4zOTg4IEw1MTMuNDY4OCwxOTYuMzk1OSBMNTE0LjMwODQsMjA2LjM5MzEgTDUxMy42MTgxLDIxNi4zOTAzIEw1MTMuODIzNSwyMjYuMzg3NSBMNTEzLjY4OTksMjM2LjM4NDcgTDUxMy45NzA1LDI0Ni4zODE5IEw1MTQuMDUxMywyNTYuMzc5MSBMNTE0LjUxMzQsMjY2LjM3NjMgTDUxNC42MjcyLDI3Ni4zNzM0IEw1MTQuNjM4MiwyODYuMzcwNiBMNTE0LjA3MiwyOTYuMzY3OCBMNTE0LjM1MDYsMzA2LjM2NSBMNTE0LjY2ODgsMzE2LjM2MjIgTDUxMy43MzI1LDMyNi4zNTk0IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMDAwRkY7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7Ii8+PC9nPjxnPjx0aXRsZT5yZW1vdGVQb2Q8L3RpdGxlPjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgcG9pbnRzPSI5NjQuMDE4MSw3Ni40Mjk3LDk2NC4wMTgxLDc2LjQ5OTcsOTY1LjYxODEsNzYuMjkxNiw5NjcuMjE4MSw3Ni40OTQxLDk2OC44MTgxLDc2LjU2MjksOTcwLjQxODEsNzYuMTkxOSw5NzIuMDE4MSw3Ni40Mjk3LDk3MS45NDA0LDc2LjQyOTcsOTcxLjU5MTYsODYuNDI2OSw5NzEuNjM0Niw5Ni40MjQxLDk3MS45NSwxMDYuNDIxMyw5NzEuMzI2OCwxMTYuNDE4NCw5NzIuNTcxOCwxMjYuNDE1Niw5NzEuMzg3OSwxMzYuNDEyOCw5NzEuODIwNCwxNDYuNDEsOTcyLjQ1MDEsMTU2LjQwNzIsOTcxLjkzMjQsMTY2LjQwNDQsOTcyLjA4NjQsMTc2LjQwMTYsOTcxLjk4NjIsMTg2LjM5ODgsOTcyLjE5NjcsMTk2LjM5NTksOTcyLjI1NzMsMjA2LjM5MzEsOTcyLjYwMzgsMjE2LjM5MDMsOTcyLjY4OTIsMjI2LjM4NzUsOTcyLjY5NzQsMjM2LjM4NDcsOTcyLjI3MjgsMjQ2LjM4MTksOTcyLjQ4MTcsMjU2LjM3OTEsOTcyLjcyMDQsMjY2LjM3NjMsOTcxLjI5NywyNzYuMzczNCw5NzIuNjk2NywyODYuMzcwNiw5NzEuNzIxNiwyOTYuMzY3OCw5NzIuNTUyLDMwNi4zNjUsOTcxLjUyMzEsMzE2LjM2MjIsOTcyLjAxODEsMzI2LjM1OTQsOTcyLjAxODEsMzI2LjMzNjUsOTcwLjQxODEsMzI2LjYwNjYsOTY4LjgxODEsMzI2LjM0MzEsOTY3LjIxODEsMzI2LjM5NDUsOTY1LjYxODEsMzI2LjQ3MjMsOTY0LjAxODEsMzI2LjM1OTQsOTY0LjQzNDQsMzI2LjM1OTQsOTY0LjAxNDIsMzE2LjM2MjIsOTY0LjMwNTQsMzA2LjM2NSw5NjMuNDQ1NywyOTYuMzY3OCw5NjQuMzAyNSwyODYuMzcwNiw5NjQuNTY2MywyNzYuMzczNCw5NjQuNDYyNywyNjYuMzc2Myw5NjQuNjMxMiwyNTYuMzc5MSw5NjMuNTM1MSwyNDYuMzgxOSw5NjMuMzY2LDIzNi4zODQ3LDk2My4zOTY3LDIyNi4zODc1LDk2My45NTkzLDIxNi4zOTAzLDk2My44MjE2LDIwNi4zOTMxLDk2NC42OTk2LDE5Ni4zOTU5LDk2My44NDM1LDE4Ni4zOTg3LDk2My42NzUxLDE3Ni40MDE2LDk2NC4yNDY0LDE2Ni40MDQ0LDk2My4zNTEzLDE1Ni40MDcyLDk2My40OTksMTQ2LjQxLDk2NC42NjcxLDEzNi40MTI4LDk2NC40NTM4LDEyNi40MTU2LDk2NC43NTI2LDExNi40MTg0LDk2My42OTYzLDEwNi40MjEyLDk2NC4zMzczLDk2LjQyNDEsOTY0LjYwODYsODYuNDI2OSw5NjQuMDE4MSw3Ni40Mjk3Ii8+PHBhdGggZD0iTTk2Ny41Mjk2LDc2LjQyOTcgTDk2Ny44MDk5LDc2LjQyOTcgTDk2Ni45NzcyLDg2LjQyNjkgTDk2Ny43ODczLDk2LjQyNDEgTDk2OC4wNjI1LDEwNi40MjEzIEw5NjYuNTc4NCwxMTYuNDE4NCBMOTY3LjQyNiwxMjYuNDE1NiBMOTY2Ljk2MSwxMzYuNDEyOCBMOTY3LjAxODMsMTQ2LjQxIEw5NjcuNDM4NywxNTYuNDA3MiBMOTY2LjYwNzgsMTY2LjQwNDQgTDk2OC4yNjc4LDE3Ni40MDE2IEw5NjYuNjg5MiwxODYuMzk4OCBMOTY3LjI2NTksMTk2LjM5NTkgTDk2OC4xMDU1LDIwNi4zOTMxIEw5NjcuNDE1MiwyMTYuMzkwMyBMOTY3LjYyMDYsMjI2LjM4NzUgTDk2Ny40ODcsMjM2LjM4NDcgTDk2Ny43Njc3LDI0Ni4zODE5IEw5NjcuODQ4NSwyNTYuMzc5MSBMOTY4LjMxMDUsMjY2LjM3NjMgTDk2OC40MjQ0LDI3Ni4zNzM0IEw5NjguNDM1MywyODYuMzcwNiBMOTY3Ljg2OTEsMjk2LjM2NzggTDk2OC4xNDc3LDMwNi4zNjUgTDk2OC40NjU5LDMxNi4zNjIyIEw5NjcuNTI5NiwzMjYuMzU5NCIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDAwMEZGO3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iUG9kIj48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjcuNSw0MS42NDA2LDcuNSw0MS43MTA3LDE1LjU4ODcsNDEuNTAyNSwyMy42NzczLDQxLjcwNTEsMzEuNzY2LDQxLjc3MzksMzkuODU0Nyw0MS40MDI4LDQ3Ljk0MzQsNDEuNjQwNiw0Ny45MzM0LDQxLjYxNjcsNDguMjQyNSw0MS42NTU3LDQ4LjYwMTUsNDEuODE1NCw0OC45OTUzLDQyLjA1OSw0OS4yNjk0LDQyLjAxMzUsNDkuNzExMSw0Mi4zNzI5LDQ5Ljg4MTYsNDIuNDQzNSw0OS42NjM1LDQyLjY0Niw0OS45NDMxLDQzLjA1NDcsNTAuMjgzNSw0My40ODg2LDUwLjI3MDUsNDMuNzc2MSw1MC40NDM0LDQ0LjE0MDYsNTAuNDY2MSw0NC4xNDA2LDUwLjQzMjcsNDkuODk4NCw1MC41MDI5LDU1LjY1NjMsNTAuNTIzMSw2MS40MTQxLDUwLjYzODYsNjcuMTcxOSw1MC40NDM0LDcyLjkyOTcsNTAuNjUsNzMuMDE1Myw1MC41MDYxLDczLjM2OTksNTAuMjI4OSw3My42NjkzLDUwLjE0NjgsNzQuMDQ5NSw1MC4wNzM4LDc0LjQzMzUsNDkuNzExMSw3NC42OTc1LDQ5LjYxOTEsNzQuNDc1NCw0OS40NDQxLDc1LjA1MjksNDguOTY2Miw3NC44OTksNDguNzE4Niw3NS4zMDEyLDQ4LjIzMzgsNzUuMTMwOCw0Ny45NDM0LDc1LjQyOTcsNDcuOTQzNCw3NS40MDY5LDM5Ljg1NDcsNzUuNjc2OSwzMS43NjYsNzUuNDEzNCwyMy42NzczLDc1LjQ2NDgsMTUuNTg4Nyw3NS41NDI2LDcuNSw3NS40Mjk3LDcuNTUzMSw3NS41NTc5LDcuMTQ1OSw3NS4yODIsNi44Mjk1LDc1LjIyNTIsNi4zNjYzLDc0LjgxNDEsNi4xMjIxLDc0LjkzMTUsNS43MzIyLDc0LjY5NzUsNS45MDExLDc0Ljc2NzQsNS43MjI3LDc0LjQwMDYsNS42MjgxLDc0LjA2ODUsNS4xNDQxLDczLjU3NTIsNC45NDU2LDczLjIsNSw3Mi45Mjk3LDQuNzkyOSw3Mi45Mjk3LDQuOTgwNCw2Ny4xNzE5LDQuOTM0NSw2MS40MTQxLDUuMjI3MSw1NS42NTYzLDQuOTQxOCw0OS44OTg0LDUsNDQuMTQwNiw0Ljg5NDQsNDQuMDk2OSw1LjIxNjcsNDMuODE2Miw1LjA4NzUsNDMuMzQ4NSw1LjI3OTUsNDMuMDEzNyw1Ljc4NTYsNDIuODA5Miw1LjczMjIsNDIuMzcyOSw1Ljc4NzgsNDIuNTA3LDYuMTc5NSw0Mi40NTI2LDYuMzk4Myw0MS45ODA5LDYuODMzNiw0Mi4wMzE4LDcuMjIxOCw0MS45Njg5LDcuNSw0MS42NDA2IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMxLjQ0MzQiIHg9IjEyIiB5PSI2NC40MjA0Ij5Qb2Q8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJQb2QiPjxwb2x5Z29uIGZpbGw9IiMxRTkwRkYiIHBvaW50cz0iNy41LDMyNS4zNTk0LDcuNSwzMjUuNDI5NCwxNS41ODg3LDMyNS4yMjEzLDIzLjY3NzMsMzI1LjQyMzgsMzEuNzY2LDMyNS40OTI2LDM5Ljg1NDcsMzI1LjEyMTYsNDcuOTQzNCwzMjUuMzU5NCw0Ny45MzM0LDMyNS4zMzU0LDQ4LjI0MjUsMzI1LjM3NDUsNDguNjAxNSwzMjUuNTM0Miw0OC45OTUzLDMyNS43Nzc3LDQ5LjI2OTQsMzI1LjczMjIsNDkuNzExMSwzMjYuMDkxNiw0OS44ODE2LDMyNi4xNjIyLDQ5LjY2MzUsMzI2LjM2NDgsNDkuOTQzMSwzMjYuNzczNSw1MC4yODM1LDMyNy4yMDc0LDUwLjI3MDUsMzI3LjQ5NDksNTAuNDQzNCwzMjcuODU5NCw1MC40NjYxLDMyNy44NTk0LDUwLjQzMjcsMzMzLjYxNzIsNTAuNTAyOSwzMzkuMzc1LDUwLjUyMzEsMzQ1LjEzMjgsNTAuNjM4NiwzNTAuODkwNiw1MC40NDM0LDM1Ni42NDg0LDUwLjY1LDM1Ni43MzQsNTAuNTA2MSwzNTcuMDg4Niw1MC4yMjg5LDM1Ny4zODgsNTAuMTQ2OCwzNTcuNzY4Miw1MC4wNzM4LDM1OC4xNTIyLDQ5LjcxMTEsMzU4LjQxNjIsNDkuNjE5MSwzNTguMTk0MSw0OS40NDQxLDM1OC43NzE2LDQ4Ljk2NjIsMzU4LjYxNzgsNDguNzE4NiwzNTkuMDE5OSw0OC4yMzM4LDM1OC44NDk1LDQ3Ljk0MzQsMzU5LjE0ODQsNDcuOTQzNCwzNTkuMTI1NiwzOS44NTQ3LDM1OS4zOTU2LDMxLjc2NiwzNTkuMTMyMiwyMy42NzczLDM1OS4xODM1LDE1LjU4ODcsMzU5LjI2MTMsNy41LDM1OS4xNDg0LDcuNTUzMSwzNTkuMjc2Niw3LjE0NTksMzU5LjAwMDgsNi44Mjk1LDM1OC45NDQsNi4zNjYzLDM1OC41MzI4LDYuMTIyMSwzNTguNjUwMiw1LjczMjIsMzU4LjQxNjIsNS45MDExLDM1OC40ODYxLDUuNzIyNywzNTguMTE5NCw1LjYyODEsMzU3Ljc4NzMsNS4xNDQxLDM1Ny4yOTM5LDQuOTQ1NiwzNTYuOTE4OCw1LDM1Ni42NDg0LDQuNzkyOSwzNTYuNjQ4NCw0Ljk4MDQsMzUwLjg5MDYsNC45MzQ1LDM0NS4xMzI4LDUuMjI3MSwzMzkuMzc1LDQuOTQxOCwzMzMuNjE3Miw1LDMyNy44NTk0LDQuODk0NCwzMjcuODE1Niw1LjIxNjcsMzI3LjUzNDksNS4wODc1LDMyNy4wNjcyLDUuMjc5NSwzMjYuNzMyNSw1Ljc4NTYsMzI2LjUyNzksNS43MzIyLDMyNi4wOTE2LDUuNzg3OCwzMjYuMjI1OCw2LjE3OTUsMzI2LjE3MTQsNi4zOTgzLDMyNS42OTk2LDYuODMzNiwzMjUuNzUwNiw3LjIyMTgsMzI1LjY4NzYsNy41LDMyNS4zNTk0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMxLjQ0MzQiIHg9IjEyIiB5PSIzNDguMTM5MiI+UG9kPC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0ibG9jYWxETlMiPjxwb2x5Z29uIGZpbGw9IiMxRTkwRkYiIHBvaW50cz0iMjIwLjk4MjcsNDEuNjQwNiwyMjAuOTgyNyw0MS44NTA4LDIzMC40NTA1LDQxLjIyNjMsMjM5LjkxODIsNDEuODMzOSwyNDkuMzg1OSw0Mi4wNDAzLDI1OC44NTM2LDQwLjkyNzIsMjY4LjMyMTMsNDEuNTYyOSwyNzcuNzg5MSw0MS4yMTQxLDI4Ny4yNTY4LDQxLjI1NzEsMjk2LjcyNDUsNDEuNTcyNSwzMDYuMTkyMiw0MS42NDA2LDMwNi4xMDQsNDEuNDI3NywzMDYuNjE2NCw0MS45NTc2LDMwNi44MTg5LDQxLjczOTQsMzA3LjIyNzYsNDIuMDE5MSwzMDcuNjYxNSw0Mi4zNTk0LDMwNy45Niw0Mi4zNzI5LDMwNy45MzM2LDQyLjM2MTksMzA4LjEyNzQsNDIuNzM1MSwzMDguMjQzLDQzLjA3NTksMzA4LjQ1NDMsNDMuNDU2MywzMDguNjE5NCw0My44MTc2LDMwOC42OTIyLDQ0LjE0MDYsMzA4Ljg4NzQsNDQuMTQwNiwzMDguOTE1OSw0OS44OTg0LDMwOC45MTg2LDU1LjY1NjMsMzA4Ljc3NzEsNjEuNDE0MSwzMDguODQ2Nyw2Ny4xNzE5LDMwOC42OTIyLDcyLjkyOTcsMzA4LjkwODUsNzMuMDE5MywzMDguMzIzNyw3My4xOTEyLDMwOC42MDgzLDczLjcyMzMsMzA4LjE2MTYsNzMuOTUyNSwzMDguMjcwOCw3NC40MTIsMzA3Ljk2LDc0LjY5NzUsMzA3Ljg5NjgsNzQuNTQ1LDMwNy41OTc3LDc0LjgyMjgsMzA3LjM0NzUsNzUuMjE4NywzMDYuODkzMSw3NS4xMjE4LDMwNi41NTkyLDc1LjMxNTcsMzA2LjE5MjIsNzUuNDI5NywzMDYuMTkyMiw3NS43NjgzLDI5Ni43MjQ1LDc1Ljg0NTksMjg3LjI1NjgsNzUuNDI1OCwyNzcuNzg5MSw3NS43MTY5LDI2OC4zMjEzLDc0Ljg1NzMsMjU4Ljg1MzYsNzUuNzE0MSwyNDkuMzg1OSw3NS45Nzc5LDIzOS45MTgyLDc1Ljg3NDIsMjMwLjQ1MDUsNzYuMDQyNywyMjAuOTgyNyw3NS40Mjk3LDIyMC45MjExLDc1LjI4MDksMjIwLjU0Niw3NS4wODI0LDIyMC4xOTY0LDc0Ljk0NTQsMjE5LjkxNDYsNzQuOTcyMiwyMTkuNTQzNSw3NC43ODM0LDIxOS4yMTUsNzQuNjk3NSwyMTkuNDI0OCw3NC43ODQ0LDIxOS4wMTQ3LDc0LjMyMTYsMjE4LjgxNjQsNzMuOTQ2NiwyMTguODQ1OSw3My42NjU5LDIxOC40MjM4LDczLjE5ODIsMjE4LjQ4MjcsNzIuOTI5NywyMTguMzA5Nyw3Mi45Mjk3LDIxOC42OTkxLDY3LjE3MTksMjE4LjYyOCw2MS40MTQxLDIxOC43Mjc2LDU1LjY1NjMsMjE4LjM3NTUsNDkuODk4NCwyMTguNDgyNyw0NC4xNDA2LDIxOC41ODEsNDQuMTgxMywyMTguODExLDQzLjg2MjQsMjE4LjYzMDIsNDMuMzczMywyMTguODkyNiw0My4wNjc3LDIxOS4xMDczLDQyLjc0MjUsMjE5LjIxNSw0Mi4zNzI5LDIxOS4yOTgxLDQyLjU3MzYsMjE5LjU2OCw0Mi4yMjUxLDIxOS45ODExLDQyLjIyMjQsMjIwLjIwNSw0MS43NjMsMjIwLjU0MjgsNDEuNTc4NSwyMjAuOTgyNyw0MS42NDA2IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc2LjIwOTUiIHg9IjIyNS40ODI3IiB5PSI2NC40MjA0Ij5sb2NhbEROUzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9ImxvY2FsRE5TIj48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjIyMC45ODI3LDMyNS4zNTk0LDIyMC45ODI3LDMyNS41Njk2LDIzMC40NTA1LDMyNC45NDUxLDIzOS45MTgyLDMyNS41NTI3LDI0OS4zODU5LDMyNS43NTkxLDI1OC44NTM2LDMyNC42NDYsMjY4LjMyMTMsMzI1LjI4MTcsMjc3Ljc4OTEsMzI0LjkzMjksMjg3LjI1NjgsMzI0Ljk3NTksMjk2LjcyNDUsMzI1LjI5MTIsMzA2LjE5MjIsMzI1LjM1OTQsMzA2LjEwNCwzMjUuMTQ2NSwzMDYuNjE2NCwzMjUuNjc2MywzMDYuODE4OSwzMjUuNDU4MiwzMDcuMjI3NiwzMjUuNzM3OCwzMDcuNjYxNSwzMjYuMDc4MiwzMDcuOTYsMzI2LjA5MTYsMzA3LjkzMzYsMzI2LjA4MDcsMzA4LjEyNzQsMzI2LjQ1MzksMzA4LjI0MywzMjYuNzk0NiwzMDguNDU0MywzMjcuMTc1LDMwOC42MTk0LDMyNy41MzYzLDMwOC42OTIyLDMyNy44NTk0LDMwOC44ODc0LDMyNy44NTk0LDMwOC45MTU5LDMzMy42MTcyLDMwOC45MTg2LDMzOS4zNzUsMzA4Ljc3NzEsMzQ1LjEzMjgsMzA4Ljg0NjcsMzUwLjg5MDYsMzA4LjY5MjIsMzU2LjY0ODQsMzA4LjkwODUsMzU2LjczOCwzMDguMzIzNywzNTYuOTEsMzA4LjYwODMsMzU3LjQ0MjEsMzA4LjE2MTYsMzU3LjY3MTMsMzA4LjI3MDgsMzU4LjEzMDcsMzA3Ljk2LDM1OC40MTYyLDMwNy44OTY4LDM1OC4yNjM4LDMwNy41OTc3LDM1OC41NDE2LDMwNy4zNDc1LDM1OC45Mzc1LDMwNi44OTMxLDM1OC44NDA1LDMwNi41NTkyLDM1OS4wMzQ0LDMwNi4xOTIyLDM1OS4xNDg0LDMwNi4xOTIyLDM1OS40ODcxLDI5Ni43MjQ1LDM1OS41NjQ3LDI4Ny4yNTY4LDM1OS4xNDQ1LDI3Ny43ODkxLDM1OS40MzU3LDI2OC4zMjEzLDM1OC41NzYsMjU4Ljg1MzYsMzU5LjQzMjgsMjQ5LjM4NTksMzU5LjY5NjYsMjM5LjkxODIsMzU5LjU5MywyMzAuNDUwNSwzNTkuNzYxNSwyMjAuOTgyNywzNTkuMTQ4NCwyMjAuOTIxMSwzNTguOTk5NywyMjAuNTQ2LDM1OC44MDExLDIyMC4xOTY0LDM1OC42NjQyLDIxOS45MTQ2LDM1OC42OTEsMjE5LjU0MzUsMzU4LjUwMjEsMjE5LjIxNSwzNTguNDE2MiwyMTkuNDI0OCwzNTguNTAzMSwyMTkuMDE0NywzNTguMDQwNCwyMTguODE2NCwzNTcuNjY1MywyMTguODQ1OSwzNTcuMzg0NywyMTguNDIzOCwzNTYuOTE2OSwyMTguNDgyNywzNTYuNjQ4NCwyMTguMzA5NywzNTYuNjQ4NCwyMTguNjk5MSwzNTAuODkwNiwyMTguNjI4LDM0NS4xMzI4LDIxOC43Mjc2LDMzOS4zNzUsMjE4LjM3NTUsMzMzLjYxNzIsMjE4LjQ4MjcsMzI3Ljg1OTQsMjE4LjU4MSwzMjcuOTAwMSwyMTguODExLDMyNy41ODExLDIxOC42MzAyLDMyNy4wOTIsMjE4Ljg5MjYsMzI2Ljc4NjUsMjE5LjEwNzMsMzI2LjQ2MTIsMjE5LjIxNSwzMjYuMDkxNiwyMTkuMjk4MSwzMjYuMjkyMywyMTkuNTY4LDMyNS45NDM5LDIxOS45ODExLDMyNS45NDEyLDIyMC4yMDUsMzI1LjQ4MTcsMjIwLjU0MjgsMzI1LjI5NzMsMjIwLjk4MjcsMzI1LjM1OTQiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiNBOURDREYiIGZvbnQtZmFtaWx5PSJJbXBhY3QiIGZvbnQtc2l6ZT0iMTciIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzYuMjA5NSIgeD0iMjI1LjQ4MjciIHk9IjM0OC4xMzkyIj5sb2NhbEROUzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtcGFydGljaXBhbnQ9ImlwdGFibGUiPjxwb2x5Z29uIGZpbGw9IiMxRTkwRkYiIHBvaW50cz0iMzIxLjE5MjIsNDEuNjQwNiwzMjEuMTkyMiw0MS44NTA4LDMzMC44NDUxLDQxLjIyNjMsMzQwLjQ5OCw0MS44MzM5LDM1MC4xNTA5LDQyLjA0MDMsMzU5LjgwMzgsNDAuOTI3MiwzNjkuNDU2Nyw0MS41NjI5LDM3OS4xMDk2LDQxLjIxNDEsMzg4Ljc2MjUsNDEuNjQwNiwzODguNzEzNiw0MS41MjI1LDM4OS4xMDc0LDQxLjc2NjEsMzg5LjM4MTQsNDEuNzIwNiwzODkuODkzOCw0Mi4yNTA1LDM5MC4wOTYzLDQyLjAzMjMsMzkwLjUzMDMsNDIuMzcyOSwzOTAuNDY5NCw0Mi4zNDc2LDM5MC44MDk4LDQyLjc4MTUsMzkwLjc5NjgsNDMuMDY5LDM5MC45OTA2LDQzLjQ0MjIsMzkxLjEwNjIsNDMuNzgzLDM5MS4yNjI1LDQ0LjE0MDYsMzkxLjMyMiw0NC4xNDA2LDM5MS4zNDIyLDQ5Ljg5ODQsMzkxLjQ1NzgsNTUuNjU2MywzOTEuNDg2Miw2MS40MTQxLDM5MS40ODg5LDY3LjE3MTksMzkxLjI2MjUsNzIuOTI5NywzOTEuMzQwOSw3Mi45NjIyLDM5MS4yNTg4LDczLjM0MjQsMzkxLjE4NTksNzMuNzI2NCwzOTAuNjAxMSw3My44OTg0LDM5MC44ODU3LDc0LjQzMDUsMzkwLjUzMDMsNzQuNjk3NSwzOTAuNDkyNSw3NC42MDYxLDM5MC4yNDQ4LDc1LjAwODMsMzg5Ljc2LDc0LjgzNzksMzg5LjQ2MDksNzUuMTE1NywzODkuMjEwNyw3NS41MTE2LDM4OC43NjI1LDc1LjQyOTcsMzg4Ljc2MjUsNzUuMzgxLDM3OS4xMDk2LDc1LjUzNSwzNjkuNDU2Nyw3NS43NjgzLDM1OS44MDM4LDc1Ljg0NTksMzUwLjE1MDksNzUuNDI1OCwzNDAuNDk4LDc1LjcxNjksMzMwLjg0NTEsNzQuODU3MywzMjEuMTkyMiw3NS40Mjk3LDMyMS4yMjg1LDc1LjUxNzMsMzIwLjkwODYsNzUuNDUyMSwzMjAuNTQxOCw3NS4yNzM3LDMyMC4yMDk4LDc1LjE3OTEsMzE5LjcxNjQsNzQuNjk1MSwzMTkuNDI0NCw3NC42OTc1LDMxOS4yMjM2LDc0LjYxNDMsMzE5LjA4NjYsNzQuMjY0NiwzMTkuMTEzNCw3My45ODI4LDMxOC45MjQ2LDczLjYxMTcsMzE5LjA0ODUsNzMuMzcwMiwzMTguNjkyMiw3Mi45Mjk3LDMxOC42MzQsNzIuOTI5NywzMTguNTc3OSw2Ny4xNzE5LDMxOC43NjgzLDYxLjQxNDEsMzE4LjQ2OTksNTUuNjU2MywzMTguNTE5Miw0OS44OTg0LDMxOC42OTIyLDQ0LjE0MDYsMzE4Ljg5MjEsNDQuMjIzNCwzMTguOTcyOCw0My44NDI2LDMxOS4yMTEzLDQzLjUyNzIsMzE5LjAzMjUsNDMuMDM4OSwzMTkuMzc2Myw0Mi43NjcxLDMxOS40MjQ0LDQyLjM3MjksMzE5LjQ5OTgsNDIuNTU0NywzMTkuNzE3Nyw0Mi4wODA5LDMyMC4xMTkzLDQyLjA1MDQsMzIwLjUwMTIsNDEuOTcyMywzMjAuOTIxOCw0MS45ODc4LDMyMS4xOTIyLDQxLjY0MDYiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiNBOURDREYiIGZvbnQtZmFtaWx5PSJJbXBhY3QiIGZvbnQtc2l6ZT0iMTciIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTguNTcwMyIgeD0iMzI1LjY5MjIiIHk9IjY0LjQyMDQiPmlwdGFibGU8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJpcHRhYmxlIj48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjMyMS4xOTIyLDMyNS4zNTk0LDMyMS4xOTIyLDMyNS41Njk2LDMzMC44NDUxLDMyNC45NDUxLDM0MC40OTgsMzI1LjU1MjcsMzUwLjE1MDksMzI1Ljc1OTEsMzU5LjgwMzgsMzI0LjY0NiwzNjkuNDU2NywzMjUuMjgxNywzNzkuMTA5NiwzMjQuOTMyOSwzODguNzYyNSwzMjUuMzU5NCwzODguNzEzNiwzMjUuMjQxMywzODkuMTA3NCwzMjUuNDg0OCwzODkuMzgxNCwzMjUuNDM5NCwzODkuODkzOCwzMjUuOTY5MiwzOTAuMDk2MywzMjUuNzUxMSwzOTAuNTMwMywzMjYuMDkxNiwzOTAuNDY5NCwzMjYuMDY2NCwzOTAuODA5OCwzMjYuNTAwMywzOTAuNzk2OCwzMjYuNzg3OCwzOTAuOTkwNiwzMjcuMTYxLDM5MS4xMDYyLDMyNy41MDE3LDM5MS4yNjI1LDMyNy44NTk0LDM5MS4zMjIsMzI3Ljg1OTQsMzkxLjM0MjIsMzMzLjYxNzIsMzkxLjQ1NzgsMzM5LjM3NSwzOTEuNDg2MiwzNDUuMTMyOCwzOTEuNDg4OSwzNTAuODkwNiwzOTEuMjYyNSwzNTYuNjQ4NCwzOTEuMzQwOSwzNTYuNjgwOSwzOTEuMjU4OCwzNTcuMDYxMSwzOTEuMTg1OSwzNTcuNDQ1MSwzOTAuNjAxMSwzNTcuNjE3MSwzOTAuODg1NywzNTguMTQ5MiwzOTAuNTMwMywzNTguNDE2MiwzOTAuNDkyNSwzNTguMzI0OSwzOTAuMjQ0OCwzNTguNzI3LDM4OS43NiwzNTguNTU2NywzODkuNDYwOSwzNTguODM0NCwzODkuMjEwNywzNTkuMjMwNCwzODguNzYyNSwzNTkuMTQ4NCwzODguNzYyNSwzNTkuMDk5NywzNzkuMTA5NiwzNTkuMjUzNywzNjkuNDU2NywzNTkuNDg3MSwzNTkuODAzOCwzNTkuNTY0NywzNTAuMTUwOSwzNTkuMTQ0NSwzNDAuNDk4LDM1OS40MzU3LDMzMC44NDUxLDM1OC41NzYsMzIxLjE5MjIsMzU5LjE0ODQsMzIxLjIyODUsMzU5LjIzNiwzMjAuOTA4NiwzNTkuMTcwOCwzMjAuNTQxOCwzNTguOTkyNCwzMjAuMjA5OCwzNTguODk3OSwzMTkuNzE2NCwzNTguNDEzOSwzMTkuNDI0NCwzNTguNDE2MiwzMTkuMjIzNiwzNTguMzMzLDMxOS4wODY2LDM1Ny45ODM0LDMxOS4xMTM0LDM1Ny43MDE2LDMxOC45MjQ2LDM1Ny4zMzA1LDMxOS4wNDg1LDM1Ny4wODg5LDMxOC42OTIyLDM1Ni42NDg0LDMxOC42MzQsMzU2LjY0ODQsMzE4LjU3NzksMzUwLjg5MDYsMzE4Ljc2ODMsMzQ1LjEzMjgsMzE4LjQ2OTksMzM5LjM3NSwzMTguNTE5MiwzMzMuNjE3MiwzMTguNjkyMiwzMjcuODU5NCwzMTguODkyMSwzMjcuOTQyMiwzMTguOTcyOCwzMjcuNTYxNCwzMTkuMjExMywzMjcuMjQ2LDMxOS4wMzI1LDMyNi43NTc3LDMxOS4zNzYzLDMyNi40ODU5LDMxOS40MjQ0LDMyNi4wOTE2LDMxOS40OTk4LDMyNi4yNzM0LDMxOS43MTc3LDMyNS43OTk3LDMyMC4xMTkzLDMyNS43NjkyLDMyMC41MDEyLDMyNS42OTExLDMyMC45MjE4LDMyNS43MDY1LDMyMS4xOTIyLDMyNS4zNTk0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU4LjU3MDMiIHg9IjMyNS42OTIyIiB5PSIzNDguMTM5MiI+aXB0YWJsZTwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtcGFydGljaXBhbnQ9Imt1YmVfcHJveHkiPjxwb2x5Z29uIGZpbGw9IiMxRTkwRkYiIHBvaW50cz0iNDYwLjIzMjUsNDEuNjQwNiw0NjAuMjMyNSw0MS44NTA4LDQ3MC4wMjA4LDQxLjIyNjMsNDc5LjgwOTEsNDEuODMzOSw0ODkuNTk3NCw0Mi4wNDAzLDQ5OS4zODU3LDQwLjkyNzIsNTA5LjE3NCw0MS41NjI5LDUxOC45NjIzLDQxLjIxNDEsNTI4Ljc1MDcsNDEuMjU3MSw1MzguNTM5LDQxLjU3MjUsNTQ4LjMyNzMsNDAuOTQ5Myw1NTguMTE1Niw0Mi4xOTQzLDU2Ny45MDM5LDQxLjY0MDYsNTY3LjgyMzUsNDEuNDQ2NSw1NjguMjMyMiw0MS43MjYyLDU2OC42NjYxLDQyLjA2NjUsNTY4Ljk1MzYsNDIuMDUzNSw1NjkuMzI2OCw0Mi4yNDc0LDU2OS42NzE3LDQyLjM3MjksNTY5LjY2MTgsNDIuMzY4OCw1NjkuODczMSw0Mi43NDkyLDU3MC4wMzgyLDQzLjExMDUsNTcwLjI5MTQsNDMuNTA4Miw1NzAuNDY0MSw0My44NzI3LDU3MC40MDM5LDQ0LjE0MDYsNTcwLjYzMDMsNDQuMTQwNiw1NzAuNDg4OCw0OS44OTg0LDU3MC41NTg0LDU1LjY1NjMsNTcwLjYzOCw2MS40MTQxLDU3MC4xNjM1LDY3LjE3MTksNTcwLjQwMzksNzIuOTI5Nyw1NzAuNjEyOCw3My4wMTYyLDU3MC4xNjYxLDczLjI0NTQsNTcwLjI3NTQsNzMuNzA0OSw1NjkuODEyMSw3My45MjcyLDU2OS43OTcsNzQuMzM1Miw1NjkuNjcxNyw3NC42OTc1LDU2OS43NjYzLDc0LjkyNTgsNTY5LjMxMTksNzQuODI4OSw1NjguOTc4LDc1LjAyMjgsNTY4LjY1NDIsNzUuMjQxMSw1NjguMzEwNSw3NS40MTE0LDU2Ny45MDM5LDc1LjQyOTcsNTY3LjkwMzksNzUuNDI1OCw1NTguMTE1Niw3NS43MTY5LDU0OC4zMjczLDc0Ljg1NzMsNTM4LjUzOSw3NS43MTQxLDUyOC43NTA3LDc1Ljk3NzksNTE4Ljk2MjMsNzUuODc0Miw1MDkuMTc0LDc2LjA0MjcsNDk5LjM4NTcsNzQuOTQ2Niw0ODkuNTk3NCw3NC43Nzc1LDQ3OS44MDkxLDc0LjgwODMsNDcwLjAyMDgsNzUuMzcwOCw0NjAuMjMyNSw3NS40Mjk3LDQ2MC4yMDc0LDc1LjM2OTIsNDU5Ljk2NTksNzUuNDkzMSw0NTkuNTAzMSw3NS4wODMsNDU5LjEyODEsNzQuODg0Nyw0NTguODQ3NCw3NC45MTQyLDQ1OC40NjQ3LDc0LjY5NzUsNDU4LjI1OTQsNzQuNjEyNCw0NTguMTU4NCw3NC4yNzc3LDQ1OC4zNzE3LDc0LjA3MzEsNDU4LjE1OTYsNzMuNjkyNCw0NTguMTA1MSw3My4zNzY5LDQ1Ny43MzI1LDcyLjkyOTcsNDU3LjYyNTIsNzIuOTI5Nyw0NTcuODM4OSw2Ny4xNzE5LDQ1Ny45MjkzLDYxLjQxNDEsNDU3LjU3NSw1NS42NTYzLDQ1Ny43MDA1LDQ5Ljg5ODQsNDU3LjczMjUsNDQuMTQwNiw0NTcuNzcxMyw0NC4xNTY3LDQ1OC4wNzk3LDQzLjg3MDIsNDU4LjAyNDEsNDMuNDMzLDQ1OC4zMTQzLDQzLjEzOSw0NTguMTQ3Nyw0Mi42NTU4LDQ1OC40NjQ3LDQyLjM3MjksNDU4LjM3ODMsNDIuMTY0Myw0NTguODgyNSw0Mi4zODE1LDQ1OS4wODA0LDQxLjg1OTIsNDU5LjU5MDMsNDIuMDkwMyw0NTkuOTA1Myw0MS44NTA3LDQ2MC4yMzI1LDQxLjY0MDYiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiNBOURDREYiIGZvbnQtZmFtaWx5PSJJbXBhY3QiIGZvbnQtc2l6ZT0iMTciIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTguNjcxNCIgeD0iNDY0LjczMjUiIHk9IjY0LjQyMDQiPmt1YmVfcHJveHk8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJrdWJlX3Byb3h5Ij48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjQ2MC4yMzI1LDMyNS4zNTk0LDQ2MC4yMzI1LDMyNS41Njk2LDQ3MC4wMjA4LDMyNC45NDUxLDQ3OS44MDkxLDMyNS41NTI3LDQ4OS41OTc0LDMyNS43NTkxLDQ5OS4zODU3LDMyNC42NDYsNTA5LjE3NCwzMjUuMjgxNyw1MTguOTYyMywzMjQuOTMyOSw1MjguNzUwNywzMjQuOTc1OSw1MzguNTM5LDMyNS4yOTEyLDU0OC4zMjczLDMyNC42NjgsNTU4LjExNTYsMzI1LjkxMyw1NjcuOTAzOSwzMjUuMzU5NCw1NjcuODIzNSwzMjUuMTY1Myw1NjguMjMyMiwzMjUuNDQ0OSw1NjguNjY2MSwzMjUuNzg1Myw1NjguOTUzNiwzMjUuNzcyMyw1NjkuMzI2OCwzMjUuOTY2Miw1NjkuNjcxNywzMjYuMDkxNiw1NjkuNjYxOCwzMjYuMDg3NSw1NjkuODczMSwzMjYuNDY3OSw1NzAuMDM4MiwzMjYuODI5Miw1NzAuMjkxNCwzMjcuMjI3LDU3MC40NjQxLDMyNy41OTE0LDU3MC40MDM5LDMyNy44NTk0LDU3MC42MzAzLDMyNy44NTk0LDU3MC40ODg4LDMzMy42MTcyLDU3MC41NTg0LDMzOS4zNzUsNTcwLjYzOCwzNDUuMTMyOCw1NzAuMTYzNSwzNTAuODkwNiw1NzAuNDAzOSwzNTYuNjQ4NCw1NzAuNjEyOCwzNTYuNzM1LDU3MC4xNjYxLDM1Ni45NjQyLDU3MC4yNzU0LDM1Ny40MjM2LDU2OS44MTIxLDM1Ny42NDYsNTY5Ljc5NywzNTguMDUzOSw1NjkuNjcxNywzNTguNDE2Miw1NjkuNzY2MywzNTguNjQ0Niw1NjkuMzExOSwzNTguNTQ3Niw1NjguOTc4LDM1OC43NDE1LDU2OC42NTQyLDM1OC45NTk4LDU2OC4zMTA1LDM1OS4xMzAyLDU2Ny45MDM5LDM1OS4xNDg0LDU2Ny45MDM5LDM1OS4xNDQ1LDU1OC4xMTU2LDM1OS40MzU3LDU0OC4zMjczLDM1OC41NzYsNTM4LjUzOSwzNTkuNDMyOCw1MjguNzUwNywzNTkuNjk2Niw1MTguOTYyMywzNTkuNTkzLDUwOS4xNzQsMzU5Ljc2MTUsNDk5LjM4NTcsMzU4LjY2NTQsNDg5LjU5NzQsMzU4LjQ5NjMsNDc5LjgwOTEsMzU4LjUyNyw0NzAuMDIwOCwzNTkuMDg5Niw0NjAuMjMyNSwzNTkuMTQ4NCw0NjAuMjA3NCwzNTkuMDg3OSw0NTkuOTY1OSwzNTkuMjExOCw0NTkuNTAzMSwzNTguODAxOCw0NTkuMTI4MSwzNTguNjAzNSw0NTguODQ3NCwzNTguNjMyOSw0NTguNDY0NywzNTguNDE2Miw0NTguMjU5NCwzNTguMzMxMSw0NTguMTU4NCwzNTcuOTk2NCw0NTguMzcxNywzNTcuNzkxOSw0NTguMTU5NiwzNTcuNDExMSw0NTguMTA1MSwzNTcuMDk1Nyw0NTcuNzMyNSwzNTYuNjQ4NCw0NTcuNjI1MiwzNTYuNjQ4NCw0NTcuODM4OSwzNTAuODkwNiw0NTcuOTI5MywzNDUuMTMyOCw0NTcuNTc1LDMzOS4zNzUsNDU3LjcwMDUsMzMzLjYxNzIsNDU3LjczMjUsMzI3Ljg1OTQsNDU3Ljc3MTMsMzI3Ljg3NTQsNDU4LjA3OTcsMzI3LjU4OSw0NTguMDI0MSwzMjcuMTUxNyw0NTguMzE0MywzMjYuODU3Nyw0NTguMTQ3NywzMjYuMzc0NSw0NTguNDY0NywzMjYuMDkxNiw0NTguMzc4MywzMjUuODgzLDQ1OC44ODI1LDMyNi4xMDAzLDQ1OS4wODA0LDMyNS41Nzc5LDQ1OS41OTAzLDMyNS44MDksNDU5LjkwNTMsMzI1LjU2OTUsNDYwLjIzMjUsMzI1LjM1OTQiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiNBOURDREYiIGZvbnQtZmFtaWx5PSJJbXBhY3QiIGZvbnQtc2l6ZT0iMTciIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTguNjcxNCIgeD0iNDY0LjczMjUiIHk9IjM0OC4xMzkyIj5rdWJlX3Byb3h5PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0icmVtb3RlUG9kIj48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjkxNy4wMjk2LDQxLjY0MDYsOTE3LjAyOTYsNDEuODUwOCw5MjcuMjI3Myw0MS4yMjYzLDkzNy40MjUsNDEuODMzOSw5NDcuNjIyNyw0Mi4wNDAzLDk1Ny44MjA0LDQwLjkyNzIsOTY4LjAxODEsNDEuNTYyOSw5NzguMjE1OCw0MS4yMTQxLDk4OC40MTM2LDQxLjI1NzEsOTk4LjYxMTMsNDEuNTcyNSwxMDA4LjgwOSw0MC45NDkzLDEwMTkuMDA2Nyw0MS42NDA2LDEwMTkuMDc3Myw0MS44MTExLDEwMTkuMjc5OCw0MS41OTMsMTAxOS42ODg1LDQxLjg3MjYsMTAyMC4xMjI0LDQyLjIxMywxMDIwLjQwOTksNDIuMiwxMDIwLjc3NDQsNDIuMzcyOSwxMDIwLjc5NTQsNDIuMzgxNiwxMDIwLjkxMSw0Mi43MjIzLDEwMjEuMTIyMyw0My4xMDI3LDEwMjEuMjg3NCw0My40NjQsMTAyMS41NDA2LDQzLjg2MTgsMTAyMS41MDY3LDQ0LjE0MDYsMTAyMS43MzA0LDQ0LjE0MDYsMTAyMS43MzMxLDQ5Ljg5ODQsMTAyMS41OTE1LDU1LjY1NjMsMTAyMS42NjEyLDYxLjQxNDEsMTAyMS43NDA3LDY3LjE3MTksMTAyMS41MDY3LDcyLjkyOTcsMTAyMS4yODQ2LDcyLjgzNzcsMTAyMS41NjkyLDczLjM2OTgsMTAyMS4xMjI1LDczLjU5OSwxMDIxLjIzMTcsNzQuMDU4NCwxMDIwLjc2ODQsNzQuMjgwOCwxMDIwLjc3NDQsNzQuNjk3NSwxMDIwLjc2NTcsNzQuNjc2NCwxMDIwLjUxNTUsNzUuMDcyMywxMDIwLjA2MTEsNzQuOTc1MywxMDE5LjcyNzIsNzUuMTY5MiwxMDE5LjQwMzQsNzUuMzg3NSwxMDE5LjAwNjcsNzUuNDI5NywxMDE5LjAwNjcsNzUuODQ1OSwxMDA4LjgwOSw3NS40MjU4LDk5OC42MTEzLDc1LjcxNjksOTg4LjQxMzYsNzQuODU3Myw5NzguMjE1OCw3NS43MTQxLDk2OC4wMTgxLDc1Ljk3NzksOTU3LjgyMDQsNzUuODc0Miw5NDcuNjIyNyw3Ni4wNDI3LDkzNy40MjUsNzQuOTQ2Niw5MjcuMjI3Myw3NC43Nzc1LDkxNy4wMjk2LDc1LjQyOTcsOTE2Ljk1MDQsNzUuMjM4Myw5MTYuNjY4Niw3NS4yNjUxLDkxNi4yOTc0LDc1LjA3NjMsOTE2LjA1NTksNzUuMjAwMiw5MTUuNTkzMSw3NC43OTAxLDkxNS4yNjE5LDc0LjY5NzUsOTE1LjE1NjIsNzQuNjUzNyw5MTUuMTg1Nyw3NC4zNzMsOTE0Ljc2MzYsNzMuOTA1Myw5MTQuNjYyNiw3My41NzA2LDkxNC44NzU5LDczLjM2Niw5MTQuNTI5Niw3Mi45Mjk3LDkxNC42NzQ4LDcyLjkyOTcsOTE0Ljc3NDQsNjcuMTcxOSw5MTQuNDIyNCw2MS40MTQxLDkxNC42MzYsNTUuNjU2Myw5MTQuNzI2NCw0OS44OTg0LDkxNC41Mjk2LDQ0LjE0MDYsOTE0LjM4NDEsNDQuMDgwNCw5MTQuNjQ2NSw0My43NzQ4LDkxNC44NjEzLDQzLjQ0OTYsOTE1LjE2OTcsNDMuMTYzMSw5MTUuMTE0MSw0Mi43MjU5LDkxNS4yNjE5LDQyLjM3MjksOTE1LjMyMDksNDIuNTE1Myw5MTUuNTQ0OCw0Mi4wNTU5LDkxNS44ODI2LDQxLjg3MTQsOTE2LjM4NjgsNDIuMDg4Niw5MTYuNTg0Niw0MS41NjYzLDkxNy4wMjk2LDQxLjY0MDYiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiNBOURDREYiIGZvbnQtZmFtaWx5PSJJbXBhY3QiIGZvbnQtc2l6ZT0iMTciIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTIuOTc3MSIgeD0iOTIxLjUyOTYiIHk9IjY0LjQyMDQiPnJlbW90ZVBvZDwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9InJlbW90ZVBvZCI+PHBvbHlnb24gZmlsbD0iIzFFOTBGRiIgcG9pbnRzPSI5MTcuMDI5NiwzMjUuMzU5NCw5MTcuMDI5NiwzMjUuNTY5Niw5MjcuMjI3MywzMjQuOTQ1MSw5MzcuNDI1LDMyNS41NTI3LDk0Ny42MjI3LDMyNS43NTkxLDk1Ny44MjA0LDMyNC42NDYsOTY4LjAxODEsMzI1LjI4MTcsOTc4LjIxNTgsMzI0LjkzMjksOTg4LjQxMzYsMzI0Ljk3NTksOTk4LjYxMTMsMzI1LjI5MTIsMTAwOC44MDksMzI0LjY2OCwxMDE5LjAwNjcsMzI1LjM1OTQsMTAxOS4wNzczLDMyNS41Mjk5LDEwMTkuMjc5OCwzMjUuMzExNywxMDE5LjY4ODUsMzI1LjU5MTQsMTAyMC4xMjI0LDMyNS45MzE3LDEwMjAuNDA5OSwzMjUuOTE4NywxMDIwLjc3NDQsMzI2LjA5MTYsMTAyMC43OTU0LDMyNi4xMDAzLDEwMjAuOTExLDMyNi40NDExLDEwMjEuMTIyMywzMjYuODIxNSwxMDIxLjI4NzQsMzI3LjE4MjgsMTAyMS41NDA2LDMyNy41ODA1LDEwMjEuNTA2NywzMjcuODU5NCwxMDIxLjczMDQsMzI3Ljg1OTQsMTAyMS43MzMxLDMzMy42MTcyLDEwMjEuNTkxNSwzMzkuMzc1LDEwMjEuNjYxMiwzNDUuMTMyOCwxMDIxLjc0MDcsMzUwLjg5MDYsMTAyMS41MDY3LDM1Ni42NDg0LDEwMjEuMjg0NiwzNTYuNTU2NCwxMDIxLjU2OTIsMzU3LjA4ODUsMTAyMS4xMjI1LDM1Ny4zMTc3LDEwMjEuMjMxNywzNTcuNzc3MiwxMDIwLjc2ODQsMzU3Ljk5OTUsMTAyMC43NzQ0LDM1OC40MTYyLDEwMjAuNzY1NywzNTguMzk1MSwxMDIwLjUxNTUsMzU4Ljc5MSwxMDIwLjA2MTEsMzU4LjY5NDEsMTAxOS43MjcyLDM1OC44ODgsMTAxOS40MDM0LDM1OS4xMDYzLDEwMTkuMDA2NywzNTkuMTQ4NCwxMDE5LjAwNjcsMzU5LjU2NDcsMTAwOC44MDksMzU5LjE0NDUsOTk4LjYxMTMsMzU5LjQzNTcsOTg4LjQxMzYsMzU4LjU3Niw5NzguMjE1OCwzNTkuNDMyOCw5NjguMDE4MSwzNTkuNjk2Niw5NTcuODIwNCwzNTkuNTkzLDk0Ny42MjI3LDM1OS43NjE1LDkzNy40MjUsMzU4LjY2NTQsOTI3LjIyNzMsMzU4LjQ5NjMsOTE3LjAyOTYsMzU5LjE0ODQsOTE2Ljk1MDQsMzU4Ljk1NzEsOTE2LjY2ODYsMzU4Ljk4MzksOTE2LjI5NzQsMzU4Ljc5NSw5MTYuMDU1OSwzNTguOTE4OSw5MTUuNTkzMSwzNTguNTA4OSw5MTUuMjYxOSwzNTguNDE2Miw5MTUuMTU2MiwzNTguMzcyNCw5MTUuMTg1NywzNTguMDkxOCw5MTQuNzYzNiwzNTcuNjI0LDkxNC42NjI2LDM1Ny4yODkzLDkxNC44NzU5LDM1Ny4wODQ4LDkxNC41Mjk2LDM1Ni42NDg0LDkxNC42NzQ4LDM1Ni42NDg0LDkxNC43NzQ0LDM1MC44OTA2LDkxNC40MjI0LDM0NS4xMzI4LDkxNC42MzYsMzM5LjM3NSw5MTQuNzI2NCwzMzMuNjE3Miw5MTQuNTI5NiwzMjcuODU5NCw5MTQuMzg0MSwzMjcuNzk5MSw5MTQuNjQ2NSwzMjcuNDkzNiw5MTQuODYxMywzMjcuMTY4Myw5MTUuMTY5NywzMjYuODgxOSw5MTUuMTE0MSwzMjYuNDQ0Niw5MTUuMjYxOSwzMjYuMDkxNiw5MTUuMzIwOSwzMjYuMjM0MSw5MTUuNTQ0OCwzMjUuNzc0Niw5MTUuODgyNiwzMjUuNTkwMSw5MTYuMzg2OCwzMjUuODA3NCw5MTYuNTg0NiwzMjUuMjg1LDkxNy4wMjk2LDMyNS4zNTk0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkyLjk3NzEiIHg9IjkyMS41Mjk2IiB5PSIzNDguMTM5MiI+cmVtb3RlUG9kPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJQb2QiIGRhdGEtcGFydGljaXBhbnQtMj0ibG9jYWxETlMiPjxwb2x5Z29uIGZpbGw9IiMwMEJGRkYiIHBvaW50cz0iMjUxLjU4NzUsMTAzLjU2MjUsMjUxLjYxMzUsMTAzLjYyNzUsMjUzLjUzNjIsMTA0LjIzNDMsMjU1LjYxMTQsMTA1LjIyMjMsMjU3LjYzNywxMDYuMDg2MiwyNTkuNDk5MiwxMDYuNTQxNywyNjEuNTg3NSwxMDcuNTYyNSwyNjEuNTc3OSwxMDcuNTM4NCwyNTkuNTM0NywxMDguMjMwNSwyNTcuNTQsMTA5LjA0MzgsMjU1LjU3OSwxMDkuOTQxNCwyNTMuNTAxOSwxMTAuNTQ4NSwyNTEuNTg3NSwxMTEuNTYyNSwyNTEuNzE4LDExMS42OTMsMjUyLjIzODksMTEwLjYxMzksMjUzLjE0MDksMTA5LjkxNTksMjU0LjA4OTMsMTA5LjI2NDMsMjU0Ljc2NzMsMTA4LjM0MjMsMjU1LjU4NzUsMTA3LjU2MjUsMjU1LjYwMzYsMTA3LjU3ODYsMjU0Ljc3OTksMTA2Ljc1NSwyNTQuMDI5NiwxMDYuMDA0NiwyNTMuMjQzOCwxMDUuMjE4OSwyNTIuNTI1NSwxMDQuNTAwNSwyNTEuNTg3NSwxMDMuNTYyNSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0yNy43MjE3LDEwNy41NjI1IEwyNy43MjE3LDEwNy44NDI3IEwzNy43MTU4LDEwNy4wMTAxIEw0Ny43MSwxMDcuODIwMiBMNTcuNzA0MiwxMDguMDk1NCBMNjcuNjk4MywxMDYuNjExMyBMNzcuNjkyNSwxMDcuNDU4OSBMODcuNjg2NywxMDYuOTkzOCBMOTcuNjgwOCwxMDcuMDUxMiBMMTA3LjY3NSwxMDcuNDcxNiBMMTE3LjY2OTIsMTA2LjY0MDcgTDEyNy42NjMzLDEwOC4zMDA3IEwxMzcuNjU3NSwxMDYuNzIyMSBMMTQ3LjY1MTcsMTA3LjI5ODggTDE1Ny42NDU4LDEwOC4xMzg0IEwxNjcuNjQsMTA3LjQ0ODEgTDE3Ny42MzQyLDEwNy42NTM1IEwxODcuNjI4MywxMDcuNTE5OSBMMTk3LjYyMjUsMTA3LjgwMDUgTDIwNy42MTY3LDEwNy44ODEzIEwyMTcuNjEwOCwxMDguMzQzNCBMMjI3LjYwNSwxMDguNDU3MiBMMjM3LjU5OTEsMTA4LjQ2ODIgTDI0Ny41OTMzLDEwNy45MDIgTDI1Ny41ODc1LDEwNy41NjI1IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjExLjg2NTgiIHg9IjM0LjcyMTciIHk9IjEwMi40OTY2Ij4mIzI2NTk3OyYjMzU4MTA7c2VydmljZU5hbWUmIzIzNTQ1OyYjMjQyMTI7JiMzMDM0MDtDbHVzdGVyIElQPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJsb2NhbEROUyIgZGF0YS1wYXJ0aWNpcGFudC0yPSJQb2QiPjxwb2x5Z29uIGZpbGw9IiMwMEJGRkYiIHBvaW50cz0iMzguNzIxNywxMzIuNjk1MywzOC43NDc3LDEzMi43NjA0LDM2LjY3MDQsMTMzLjM2NzEsMzQuNzQ1NiwxMzQuMzU1MSwzMi43NzEyLDEzNS4yMTksMzAuNjMzNCwxMzUuNjc0NSwyOC43MjE3LDEzNi42OTUzLDI4LjcxMjEsMTM2LjY3MTMsMzAuNjY4OSwxMzcuMzYzMywzMi42NzQyLDEzOC4xNzY2LDM0LjcxMzIsMTM5LjA3NDIsMzYuNjM2MSwxMzkuNjgxMywzOC43MjE3LDE0MC42OTUzLDM4Ljg1MjIsMTQwLjgyNTgsMzcuNzczMSwxMzkuNzQ2OCwzNy4wNzUxLDEzOS4wNDg3LDM2LjQyMzUsMTM4LjM5NzEsMzUuNTAxNSwxMzcuNDc1MSwzNC43MjE3LDEzNi42OTUzLDM0LjczNzgsMTM2LjcxMTQsMzUuNTE0MSwxMzUuODg3OCwzNi4zNjM4LDEzNS4xMzc0LDM3LjE3OCwxMzQuMzUxNywzOC4wNTk3LDEzMy42MzM0LDM4LjcyMTcsMTMyLjY5NTMiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMzIuNzIxNywxMzYuNjk1MyBMMzIuNzIxNywxMzYuOTc1NiBMNDIuNzE1OCwxMzYuMTQyOSBMNTIuNzEsMTM2Ljk1MyBMNjIuNzA0MiwxMzcuMjI4MiBMNzIuNjk4MywxMzUuNzQ0MSBMODIuNjkyNSwxMzYuNTkxNyBMOTIuNjg2NywxMzYuMTI2NyBMMTAyLjY4MDgsMTM2LjE4NCBMMTEyLjY3NSwxMzYuNjA0NCBMMTIyLjY2OTIsMTM1Ljc3MzUgTDEzMi42NjMzLDEzNy40MzM1IEwxNDIuNjU3NSwxMzUuODU0OSBMMTUyLjY1MTcsMTM2LjQzMTYgTDE2Mi42NDU4LDEzNy4yNzEyIEwxNzIuNjQsMTM2LjU4MDkgTDE4Mi42MzQyLDEzNi43ODYzIEwxOTIuNjI4MywxMzYuNjUyNyBMMjAyLjYyMjUsMTM2LjkzMzMgTDIxMi42MTY3LDEzNy4wMTQyIEwyMjIuNjEwOCwxMzcuNDc2MiBMMjMyLjYwNSwxMzcuNTkwMSBMMjQyLjU5OTEsMTM3LjYwMSBMMjUyLjU5MzMsMTM3LjAzNDggTDI2Mi41ODc1LDEzNi42OTUzIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQwLjI2MzIiIHg9IjQ0LjcyMTciIHk9IjEzMS42Mjk0Ij5yZXR1cm48L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9IlBvZCIgZGF0YS1wYXJ0aWNpcGFudC0yPSJpcHRhYmxlIj48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9IjM0Mi45Nzc0LDE2MS44MjgxLDM0My4wMDM0LDE2MS44OTMyLDM0NC45MjYxLDE2Mi40OTk5LDM0Ny4wMDEzLDE2My40ODc5LDM0OS4wMjY5LDE2NC4zNTE4LDM1MC44ODkxLDE2NC44MDczLDM1Mi45Nzc0LDE2NS44MjgxLDM1Mi45Njc4LDE2NS44MDQxLDM1MC45MjQ2LDE2Ni40OTYxLDM0OC45Mjk5LDE2Ny4zMDk0LDM0Ni45Njg5LDE2OC4yMDcsMzQ0Ljg5MTgsMTY4LjgxNDIsMzQyLjk3NzQsMTY5LjgyODEsMzQzLjEwNzksMTY5Ljk1ODYsMzQzLjYyODgsMTY4Ljg3OTYsMzQ0LjUzMDgsMTY4LjE4MTUsMzQ1LjQ3OTIsMTY3LjUyOTksMzQ2LjE1NzIsMTY2LjYwNzksMzQ2Ljk3NzQsMTY1LjgyODEsMzQ2Ljk5MzUsMTY1Ljg0NDIsMzQ2LjE2OTgsMTY1LjAyMDYsMzQ1LjQxOTUsMTY0LjI3MDIsMzQ0LjYzMzcsMTYzLjQ4NDUsMzQzLjkxNTQsMTYyLjc2NjIsMzQyLjk3NzQsMTYxLjgyODEiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjcuNzIxNywxNjUuODI4MSBMMjcuNzIxNywxNjYuMTA4NCBMMzcuNzYwOSwxNjUuMjc1NyBMNDcuODAwMiwxNjYuMDg1OCBMNTcuODM5NCwxNjYuMzYxIEw2Ny44Nzg2LDE2NC44NzY5IEw3Ny45MTc5LDE2NS43MjQ1IEw4Ny45NTcxLDE2NS4yNTk1IEw5Ny45OTY0LDE2NS4zMTY4IEwxMDguMDM1NiwxNjUuNzM3MiBMMTE4LjA3NDgsMTY0LjkwNjMgTDEyOC4xMTQxLDE2Ni41NjYzIEwxMzguMTUzMywxNjQuOTg3OCBMMTQ4LjE5MjYsMTY1LjU2NDQgTDE1OC4yMzE4LDE2Ni40MDQxIEwxNjguMjcxLDE2NS43MTM4IEwxNzguMzEwMywxNjUuOTE5MSBMMTg4LjM0OTUsMTY1Ljc4NTUgTDE5OC4zODg4LDE2Ni4wNjYyIEwyMDguNDI4LDE2Ni4xNDcgTDIxOC40NjcyLDE2Ni42MDkgTDIyOC41MDY1LDE2Ni43MjI5IEwyMzguNTQ1NywxNjYuNzMzOCBMMjQ4LjU4NSwxNjYuMTY3NiBMMjU4LjYyNDIsMTY2LjQ0NjIgTDI2OC42NjM0LDE2Ni43NjQ0IEwyNzguNzAyNywxNjQuODY2NSBMMjg4Ljc0MTksMTY2LjczMjggTDI5OC43ODEyLDE2NS40MzI4IEwzMDguODIwNCwxNjYuNTM5OSBMMzE4Ljg1OTcsMTY1LjE2ODEgTDMyOC44OTg5LDE2NS43MzY4IEwzMzguOTM4MSwxNjYuODE2OSBMMzQ4Ljk3NzQsMTY1LjgyODEiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjEuNTgzIiB4PSIzNC43MjE3IiB5PSIxNjAuNzYyMiI+dHJhZmZpYyB0byBDbHVzdGVyIElQPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJpcHRhYmxlIiBkYXRhLXBhcnRpY2lwYW50LTI9ImlwdGFibGUiPjxwYXRoIGQ9Ik0zNTQuOTc3NCwxOTQuOTYwOSBMMzU0Ljk3NzQsMTk1LjA1NDQgTDM2My4zNzc0LDE5NC43NzY4IEwzNzEuNzc3NCwxOTUuMDQ2OCBMMzgwLjE3NzQsMTk1LjEzODYgTDM4OC41Nzc0LDE5NC42NDM5IEwzOTYuOTc3NCwxOTQuOTYwOSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0zOTYuOTc3NCwxOTQuOTYwOSBMMzk3LjA3MDgsMTk0Ljk2MDkgTDM5Ni43OTMyLDE5Ny41NjA5IEwzOTcuMDYzMywyMDAuMTYwOSBMMzk3LjE1NSwyMDIuNzYwOSBMMzk2LjY2MDMsMjA1LjM2MDkgTDM5Ni45Nzc0LDIwNy45NjA5IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTM1NS45Nzc0LDIwNy45NjA5IEwzNTUuOTc3NCwyMDguMDU0NCBMMzY0LjE3NzQsMjA3Ljc3NjggTDM3Mi4zNzc0LDIwOC4wNDY4IEwzODAuNTc3NCwyMDguMTM4NiBMMzg4Ljc3NzQsMjA3LjY0MzkgTDM5Ni45Nzc0LDIwNy45NjA5IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzAwQkZGRiIgcG9pbnRzPSIzNjUuOTc3NCwyMDMuOTYwOSwzNjYuMDAzNCwyMDQuMDI2LDM2My45MjYxLDIwNC42MzI3LDM2Mi4wMDEzLDIwNS42MjA4LDM2MC4wMjY5LDIwNi40ODQ2LDM1Ny44ODkxLDIwNi45NDAxLDM1NS45Nzc0LDIwNy45NjA5LDM1NS45Njc4LDIwNy45MzY5LDM1Ny45MjQ2LDIwOC42Mjg5LDM1OS45Mjk5LDIwOS40NDIyLDM2MS45Njg5LDIxMC4zMzk4LDM2My44OTE4LDIxMC45NDcsMzY1Ljk3NzQsMjExLjk2MDksMzY2LjEwNzksMjEyLjA5MTQsMzY1LjAyODgsMjExLjAxMjQsMzY0LjMzMDgsMjEwLjMxNDMsMzYzLjY3OTIsMjA5LjY2MjcsMzYyLjc1NzIsMjA4Ljc0MDcsMzYxLjk3NzQsMjA3Ljk2MDksMzYxLjk5MzUsMjA3Ljk3NywzNjIuNzY5OCwyMDcuMTUzNCwzNjMuNjE5NSwyMDYuNDAzLDM2NC40MzM3LDIwNS42MTczLDM2NS4zMTU0LDIwNC44OTksMzY1Ljk3NzQsMjAzLjk2MDkiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSIzNjEuOTc3NCIgeT0iMTg5Ljg5NSI+JiMzNTI2ODsmIzIxMDE3OyYjMjEzMDU7JiMzNzE5Nzs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9ImlwdGFibGUiIGRhdGEtcGFydGljaXBhbnQtMj0ia3ViZV9wcm94eSI+PHBvbHlnb24gZmlsbD0iIzAwQkZGRiIgcG9pbnRzPSI1MDIuMDY4MiwyMzMuMDkzOCw1MDIuMDk0MiwyMzMuMTU4OCw1MDQuMDE2OSwyMzMuNzY1NSw1MDYuMDkyMSwyMzQuNzUzNiw1MDguMTE3NywyMzUuNjE3NCw1MDkuOTc5OSwyMzYuMDczLDUxMi4wNjgyLDIzNy4wOTM4LDUxMi4wNTg2LDIzNy4wNjk3LDUxMC4wMTU0LDIzNy43NjE4LDUwOC4wMjA3LDIzOC41NzUxLDUwNi4wNTk4LDIzOS40NzI3LDUwMy45ODI2LDI0MC4wNzk4LDUwMi4wNjgyLDI0MS4wOTM4LDUwMi4xOTg3LDI0MS4yMjQyLDUwMi43MTk2LDI0MC4xNDUyLDUwMy42MjE2LDIzOS40NDcxLDUwNC41NywyMzguNzk1Niw1MDUuMjQ4LDIzNy44NzM1LDUwNi4wNjgyLDIzNy4wOTM4LDUwNi4wODQzLDIzNy4xMDk4LDUwNS4yNjA3LDIzNi4yODYyLDUwNC41MTAzLDIzNS41MzU4LDUwMy43MjQ2LDIzNC43NTAxLDUwMy4wMDYyLDIzNC4wMzE4LDUwMi4wNjgyLDIzMy4wOTM4IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBhdGggZD0iTTM1NC45Nzc0LDIzNy4wOTM4IEwzNTQuOTc3NCwyMzcuMzc0IEwzNjUuMTgzNCwyMzYuNTQxMyBMMzc1LjM4OTUsMjM3LjM1MTUgTDM4NS41OTU1LDIzNy42MjY3IEwzOTUuODAxNiwyMzYuMTQyNiBMNDA2LjAwNzYsMjM2Ljk5MDEgTDQxNi4yMTM3LDIzNi41MjUxIEw0MjYuNDE5OCwyMzYuNTgyNCBMNDM2LjYyNTgsMjM3LjAwMjkgTDQ0Ni44MzE5LDIzNi4xNzE5IEw0NTcuMDM3OSwyMzcuODMxOSBMNDY3LjI0NCwyMzYuMjUzNCBMNDc3LjQ1LDIzNi44MzAxIEw0ODcuNjU2MSwyMzcuNjY5NyBMNDk3Ljg2MjEsMjM2Ljk3OTQgTDUwOC4wNjgyLDIzNy4wOTM4IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM1LjA5MDgiIHg9IjM2MS45Nzc0IiB5PSIyMzIuMDI3OCI+dHJhZmZpYyB0byBrdWJlX3Byb3h5PC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJrdWJlX3Byb3h5IiBkYXRhLXBhcnRpY2lwYW50LTI9Imt1YmVfcHJveHkiPjxwYXRoIGQ9Ik01MTQuMDY4MiwyNjYuMjI2NiBMNTE0LjA2ODIsMjY2LjMyIEw1MjIuNDY4MiwyNjYuMDQyNCBMNTMwLjg2ODIsMjY2LjMxMjUgTDUzOS4yNjgyLDI2Ni40MDQyIEw1NDcuNjY4MiwyNjUuOTA5NSBMNTU2LjA2ODIsMjY2LjIyNjYiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNNTU2LjA2ODIsMjY2LjIyNjYgTDU1Ni4xNjE2LDI2Ni4yMjY2IEw1NTUuODg0LDI2OC44MjY2IEw1NTYuMTU0MSwyNzEuNDI2NiBMNTU2LjI0NTgsMjc0LjAyNjYgTDU1NS43NTExLDI3Ni42MjY2IEw1NTYuMDY4MiwyNzkuMjI2NiIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik01MTUuMDY4MiwyNzkuMjI2NiBMNTE1LjA2ODIsMjc5LjMyIEw1MjMuMjY4MiwyNzkuMDQyNCBMNTMxLjQ2ODIsMjc5LjMxMjUgTDUzOS42NjgyLDI3OS40MDQyIEw1NDcuODY4MiwyNzguOTA5NSBMNTU2LjA2ODIsMjc5LjIyNjYiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9IjUyNS4wNjgyLDI3NS4yMjY2LDUyNS4wOTQyLDI3NS4yOTE2LDUyMy4wMTY5LDI3NS44OTgzLDUyMS4wOTIxLDI3Ni44ODY0LDUxOS4xMTc3LDI3Ny43NTAzLDUxNi45Nzk5LDI3OC4yMDU4LDUxNS4wNjgyLDI3OS4yMjY2LDUxNS4wNTg2LDI3OS4yMDI1LDUxNy4wMTU0LDI3OS44OTQ2LDUxOS4wMjA3LDI4MC43MDc5LDUyMS4wNTk4LDI4MS42MDU1LDUyMi45ODI2LDI4Mi4yMTI2LDUyNS4wNjgyLDI4My4yMjY2LDUyNS4xOTg3LDI4My4zNTcxLDUyNC4xMTk2LDI4Mi4yNzgsNTIzLjQyMTYsMjgxLjU3OTksNTIyLjc3LDI4MC45Mjg0LDUyMS44NDgsMjgwLjAwNjMsNTIxLjA2ODIsMjc5LjIyNjYsNTIxLjA4NDMsMjc5LjI0MjYsNTIxLjg2MDcsMjc4LjQxOSw1MjIuNzEwMywyNzcuNjY4Niw1MjMuNTI0NiwyNzYuODgyOSw1MjQuNDA2MiwyNzYuMTY0Niw1MjUuMDY4MiwyNzUuMjI2NiIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQzOS45NSIgeD0iNTIxLjA2ODIiIHk9IjI2MS4xNjA2Ij4mIzI2NTk3OyYjMzU4MTA7JiMyMDE5NTsmIzI5NzAyOyYjMzE0NzE7JiMyMTQ3NTsmIzIxNDk1OyYjMjE2NDQ7U2VydmljZSYjMzAzNDA7JiMyNjE0NDsmIzIzNTU2OyYjMjA4NTE7JiMzMTk5NTsmIzY1MjkyOyYjMjAxOTc7JiMyMTQ1MDtTZXJ2aWNlJiMyMTY0NDtFbmRwb2ludCYjMzAzNDA7JiMyNjE0NDsmIzIzNTU2OyYjMjA4NTE7JiMzMTk5NTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9Imt1YmVfcHJveHkiIGRhdGEtcGFydGljaXBhbnQtMj0icmVtb3RlUG9kIj48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9Ijk1Ni4wMTgxLDMwNC4zNTk0LDk1Ni4wNDQyLDMwNC40MjQ0LDk1Ny45NjY5LDMwNS4wMzExLDk2MC4wNDIxLDMwNi4wMTkyLDk2Mi4wNjc2LDMwNi44ODMxLDk2My45Mjk4LDMwNy4zMzg2LDk2Ni4wMTgxLDMwOC4zNTk0LDk2Ni4wMDg1LDMwOC4zMzUzLDk2My45NjUzLDMwOS4wMjc0LDk2MS45NzA3LDMwOS44NDA3LDk2MC4wMDk3LDMxMC43MzgzLDk1Ny45MzI2LDMxMS4zNDU0LDk1Ni4wMTgxLDMxMi4zNTk0LDk1Ni4xNDg2LDMxMi40ODk5LDk1Ni42Njk2LDMxMS40MTA4LDk1Ny41NzE1LDMxMC43MTI4LDk1OC41MiwzMTAuMDYxMiw5NTkuMTk3OSwzMDkuMTM5Miw5NjAuMDE4MSwzMDguMzU5NCw5NjAuMDM0MiwzMDguMzc1NSw5NTkuMjEwNiwzMDcuNTUxOCw5NTguNDYwMiwzMDYuODAxNSw5NTcuNjc0NSwzMDYuMDE1Nyw5NTYuOTU2MiwzMDUuMjk3NCw5NTYuMDE4MSwzMDQuMzU5NCIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik01MTQuMDY4MiwzMDguMzU5NCBMNTE0LjA2ODIsMzA4LjYzOTYgTDUyNC4wMjI2LDMwNy44MDY5IEw1MzMuOTc3MSwzMDguNjE3MSBMNTQzLjkzMTUsMzA4Ljg5MjMgTDU1My44ODYsMzA3LjQwODIgTDU2My44NDA0LDMwOC4yNTU4IEw1NzMuNzk0OSwzMDcuNzkwNyBMNTgzLjc0OTMsMzA3Ljg0OCBMNTkzLjcwMzcsMzA4LjI2ODUgTDYwMy42NTgyLDMwNy40Mzc1IEw2MTMuNjEyNiwzMDkuMDk3NiBMNjIzLjU2NzEsMzA3LjUxOSBMNjMzLjUyMTUsMzA4LjA5NTcgTDY0My40NzYsMzA4LjkzNTMgTDY1My40MzA0LDMwOC4yNDUgTDY2My4zODQ4LDMwOC40NTA0IEw2NzMuMzM5MywzMDguMzE2OCBMNjgzLjI5MzcsMzA4LjU5NzQgTDY5My4yNDgyLDMwOC42NzgyIEw3MDMuMjAyNiwzMDkuMTQwMyBMNzEzLjE1NzEsMzA5LjI1NDEgTDcyMy4xMTE1LDMwOS4yNjUxIEw3MzMuMDY1OSwzMDguNjk4OSBMNzQzLjAyMDQsMzA4Ljk3NzUgTDc1Mi45NzQ4LDMwOS4yOTU3IEw3NjIuOTI5MywzMDcuMzk3OCBMNzcyLjg4MzcsMzA5LjI2NDEgTDc4Mi44MzgyLDMwNy45NjQgTDc5Mi43OTI2LDMwOS4wNzExIEw4MDIuNzQ3LDMwNy42OTkzIEw4MTIuNzAxNSwzMDguMjY4IEw4MjIuNjU1OSwzMDkuMzQ4MiBMODMyLjYxMDQsMzA4LjI5NDQgTDg0Mi41NjQ4LDMwOC40OTk4IEw4NTIuNTE5MywzMDguODEwOSBMODYyLjQ3MzcsMzA4LjkxNDQgTDg3Mi40MjgyLDMwOC4zNTQyIEw4ODIuMzgyNiwzMDguNzQyMyBMODkyLjMzNywzMDcuNTk2MiBMOTAyLjI5MTUsMzA4LjczODYgTDkxMi4yNDU5LDMwOS4wOTAzIEw5MjIuMjAwNCwzMDguOTUyMSBMOTMyLjE1NDgsMzA5LjE3NjcgTDk0Mi4xMDkzLDMwNy43MTUzIEw5NTIuMDYzNywzMDcuNDg5OCBMOTYyLjAxODEsMzA4LjM1OTQiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzAuNzM2MyIgeD0iNTIxLjA2ODIiIHk9IjMwMy4yOTM1Ij50cmFmZmljIHRvIHJlbW90ZVBvZDwvdGV4dD48L2c+PCEtLVNSQz1bVExBeklXRDE2QW9wSng1V2RTOUFKMjRha0dZMkkyMEY4OWt4QnhoYWloai1qLVNsVGI1NDhYNm5LMWw1ODFPTTRJbjR1LUV1SFlqVm1URUJrVGtTRGlsanA3bXB5b3FOREJiRzM1Y0JyZmRSTjQ0UDJneWlWT2JxZ2JBZmI5bW8yU1FBTElReTNVSFFXdzBRR28wZkJlMnI0OEdCVDhWYVllWG84cFBuMDVJamtMTm84dE1rdzZnOTlPYVV1MV9pOGNfMDhYVUc1akhqUGg5WFNUT2ZFX0NhSHQ5TFhmZ3hOMzZYX21yOFFvUVM3RWNqMDZQYXlyQmU5VE8ya2oxSXBES1BoaVF0V0t4RlBGMUNsTlpwWUwyczVoOEhiR25iN3ltQTZZQ19qT2ZDbUlSUDlJZzlmck5mTU5UVmtpbnRiY2VNbzlMY1RIeWloMWRNT0xjWHREb29POElNckYzaklnOFpGX1ZoTHcxbGJwVmxfVWkwUzlzeHlEdDd6OV9DeS1kbWVidHNtcTAzcWVLZy1QTmR5dEZIVTI2b3FvNkFzNmhLZVgzekpBcEh1MnhMYWdQNkh0SEF6dHhSRFdWZGZsRnFpTlVLcTRibm9vY3JKXzlmZy1DRE5XVXp1VjcteUF2bGtadEpWSkdkZExneUt4SjlzemNMa00tUmxPVlhtLTNwZlZDd2szN1RtbjRUMklsMkt2OEJGUTZxMGlTRlFCS1JlcnkwXS0tPjwvZz48L3N2Zz4='>
<h4 id="4122-proxy-mode-iptables"><a class="markdownIt-Anchor" href="#4122-proxy-mode-iptables"></a> 4.1.2.2 Proxy-mode: iptables</h4>
<ol>
<li><strong>该模式最主要的特征是：流量重定向的工作是由<code>iptable</code>完成的，也就是在内核空间完成的</strong></li>
<li><code>kube-proxy</code>会监听<code>Service</code>、<code>Endpoint</code>的变化，并且更新<code>iptable</code>的路由表</li>
<li>更高效、安全，但是灵活性较差（当某个<code>Pod</code>没有应答时，不会尝试其他<code>Pod</code>）</li>
</ol>
<p><img src="/images/Kubernetes-Concept/proxy-mode-iptables.svg" alt="proxy-mode-iptables" /></p>
<p>在<code>Pod</code>中访问<code>Service</code>的时序图如下</p>
<img src='data:image/svg+xml;base64,iVBORw0KGgoAAAANSUhEUgAAA2EAAADHAQAAAAC42mb8AAAJ/ElEQVR4AezYB67cNhAG4FEYYB4qD5DClAsE1d1MTpUeSnG7Fhc+SJiObqYTMM0/Q0rc8tzk3rYNZkeEPlVqsITn+BqflnbUjtpRO2pH7agdtQnwtlejfnZaJkIhV4i3VXWvsYUBf6qWLIAAgB9FS2QLbQ2iZ6tFMoWGvloi90y1QLps9yjva9k+QLvxmNpFXcy4GInDTkvmAZp6DE0DvnBB6JrOz1wD4nLQoinPVpug9jSL56ClnYZnd5WIpsTb19bfb6+aZl4rjbHZHcGkAQxA0csgB++22qYtg+SuakkjBANGNGu1wvCiuUVj+ZJLF5VC+MIW0oVM15hcIueR3icxkvUKgVi0kddp5GYtLFpWIpNJZ+kKQrKJOBN37W2ysiwgXSSu2kiiKdFoWKnpWRuxaCQy6fTJrEXiRKprJFTTzs4aiSYQF6KVGjct9eGFLPw3nD7ebLBJNhiOZthqX+jwjY4ufmFU1VRwwYzgzN6t09SsbQ8FaUzgxH81zbvfg9t0bSj6x9I0d6VqkornOJm4UhtmjXvVM67gStK3PSbR8F9A6Joq/Ds42vAlNlWzyQZE0SRZowl3at+CAotmECTaCdjsNAbfqkq4PWuuaZajW6mBvmva9omdCIybVXMq2StVi3saRDEes4aqparllZpvGrZaIeh6xhAdN+2mZAdaNpsDzXBENo+kBbstf7dolzlZBq7cpelpTxOIw2otXG5aFG0cGn+ZaKhruqybNhLta4WLvgJMTYuLRrRSi7OWTNfCg7XYtDw0bXxMLW+1+P6ivXtPbeTCCqFpmR5ZswrToaYB0fK7ZjlvwE4rgwQxP6taPFk0AI+ppa6d3EvLQr3FGDZVC2efQAP2tXJi9zQFTFVLhvG9Ltw0n55Q+080njWatanVuxYdY9TZNO1K19xaLdgJ6kAzswZyy1xyWvOma30uWa+5pqVF++s+2lA/ogVULdmm8SNr3o2F7+y6oHpoZ22UOPXmZ0RRXQt2X4ui2XXaLYzwhbOLXXNBiDtdq08cBweMNvG9tfZ8ww9rtB8LIZzVWXu3aGa0I/7Yau73YLMDvA730bxoGmaNFmiQr85EXZPM26lqG9GCuRF1cHUg6aZ9x4gumalqKtrgRnBWaaWmBDCiLcU0dzZdi8RJ/LYVpmrxYtWyHqo2Bdu7oJUaC2CzoL3nGhBn7WfMHV7TamwakUv1lxFtJDV3eCu1SAb54B8MyTJx1wr1ZlFi1dJQtUKfVs2fqNgOsCe3RkMdNgDe9GqQjMQC/m/HPnQbR+4wgFPhwkwV06tgpgc95RqJJTzpPfEjpFwROqxcowHFI2OLLoAhpicCBM9bpBc5XpgphoiOoGWp0NCg3pLglSE0N//MULTW5fpJTuOn+lHlB7ANyaeLLyEYmsV0szwhkGsswHax+0hcEwon0avrXJVWaZX2f6dVWqVVWqVVWqVVWqV1tHeCDKsxKF6BpcAYnAvHi9Q071hLIFm+Zs81HJ3R/IVpYLFC4e+ca2i4dA0KbXqhWia11HrsjAZL0mKl+a9eprYPhtIYOrCGttSuv1NqwmSo9ya+ZcZd8K8AaHibCbTzrVesabwGjNuRecPoKO1PttS4HpmPvZox/Z86+BoIbUtrb6HGJ/Er1Wy+obaAuLsfFHMy8qTGsrh75e+MjaOnoecCb7ddt2013FestT0mNe9WEMSFlhTaNAi6jKXpGKC3Box7oiG1LfRKNd7iWO25jjXGlAZ+7PNWzGKpIUi4B6v2qrsgDW5rzxQaPqFZkPIW9OzeIrQNrdC6pQZK41ZH9/n7Ik1qvlFo/jt32gvTuHFSE4bUxAdm2vZMe9ONRWit2f7xCyc1uOKD1GJQWrR4LQ2UhpNSG0sNjJnGcKFdifgCNK/QYqVxNC61NFBaWmhcah5Yi9LwXLP2Zto0DaZKE1LrccyU1k0WobVdpY2vBfH4H5quNA2x8Tj2wWee0mys9iUoSBehbWlKS2pBnFgds9T0RJca15SmAdfklxaj4RowSdwbxAxFaKYJg5k+3BT6bAtQYwDcmr5irTp6rbRKq7RKq7RKqzSVxHoWLQwghLPJAYBC+aQSwPMkP/mSwSxoaIAKPa11T2r8rIYAgAB0QUXg59Oc01p3rF74GQ29GA29dM1Kn1WbnpuTN8/OSaWVefp55uTNmSZUW8McVM5q2TmNPI9Gn0cjM61gXO8Qn9dGZvTnLVNYxs+Ju3ovT+D78n1uXkmoL6z3Ucfcg0FX1Otexq+vfWe1vRcxzPMklxWttKG7d4S2wZDFcMDYh+1s78/eHZPPWG70de/N7+QNCub+0cdva8Oha/C6/v2ve/VP8Qh3vBWDGbVh02KGRm2jAwNdvN6wKb+0ulFvbw83kHhw6GSy6g7onWi1JvSiCEODzoOd4cfumLzKdIP6xhvf6L2eckOL3ntiTgaNmD/e6o02Dy5zinsOJSzeDB9AOW007XiABy1wY6llvdZBm47u+KN4MJRa1sscuDy4t7cpykJc2H3wd0Ejm2wGTrjbfHB0+ZDyp106wLe1sJ/xdk5GD04wj4HckZE8y8kRzrK1ppOt4UEOTvbmL/BMfqNNycdBfIT0JRBmbwFrrXmYgypS293C5A4eDqRGHbLbvCNEhzQXW83dk9rPdeHWyFGygnlaaimJYKZpSrP1H66XWscGKLX4R+BrSotVKTV2Sts5r/UBGkCOMoE5K7XvkaNSQyA1B+Ya4RjMmfaWLgSISu0tqpTajWNtkNwRul99Vu0QSKo0gWeaQyb4lBZYxxog8KWmagCZ0sSDqpTa4Fiz2YOhc3heG0yfGX2XpPlTmD+OiUNJTp2QopwqjWCpudNSs2n4yzvAD+14pj1ImqPNmVauJVJLD6TW+3iWKc0Fl57QkvWBzus1krIVzCNMbOMKM5xhkzBDaZ1C02ca1SK5ggMZurqqIeid5qh2rF3RoKO0d65sUntPLzVDO6mxdWII6wqZijrmCZA1a59bnaQZCktpEUgNGbf+WGg7SeI9CCQRd/AsrIXQjWhYg5oqDuyrrXu4vtt4YJO6sS/npHuJImN/rr2cTOc7MgJnM5/CsfimBfMsWROIh2QR2tPzkQc9twbmeDEavCito0fWQjQ+V59HS6wE/w8cc1VapVVapTF84mQhX7YWoYvUgj9epBbCXKNiE4BchEYLrbVsLeDtvkmS+7Dl6Mkd6JK5VC1O3L6Jom+6ptQ+sbpkLc0GHkUH9zaoE/J00ERL1Vg8yCd41Pz5RGrZgC5X402l7Tb7k02p9ZesCakdQaH5LOtPlq39PD2Cwfq7Ji2Sx/0DvFTtd/c6WQo7I3t0L8mpPVqu1kmUNhy26/oV9hG3rt+xTG2P5VkGN4YCvWWff8RdX66mkl3oaEr/h7XwQjX/v+MoqNIqrdIqrdIqrdL+BRHP3ADfQwzjAAAAAElFTkSuQmCC'>
<h4 id="4123-proxy-mode-ipvs"><a class="markdownIt-Anchor" href="#4123-proxy-mode-ipvs"></a> 4.1.2.3 Proxy-mode: ipvs</h4>
<p>与<code>iptable</code>模式类似，<code>ipvs</code>也是利用<code>netfilter</code>的<code>hook function</code>来实现的，但是<code>ipvs</code>利用的是哈希表，且工作在内核空间，因此效率非常高，同时<code>ipvs</code>还支持多种负载均衡算法</p>
<ol>
<li><code>rr</code>: round-rogin</li>
<li><code>lc</code>: least connection</li>
<li><code>dh</code>: destination hashing</li>
<li><code>sh</code>: source hashing</li>
<li><code>sed</code>: shortest expected delay</li>
<li><code>nq</code>: never queue</li>
</ol>
<p><img src="/images/Kubernetes-Concept/proxy-mode-ipvs.svg" alt="proxy-mode-ipvs" /></p>
<p>在以上任何一种模式中，来自<code>Cluster IP:Port</code>的流量都会被重定向到其中一个后端<code>Pod</code>中，且用户不感知这些过程</p>
<h3 id="413-multi-port-services"><a class="markdownIt-Anchor" href="#413-multi-port-services"></a> 4.1.3 Multi-Port Services</h3>
<p>很多<code>Service</code>需要暴露多个端口。<code>Kubernetes</code>支持一个<code>Service</code>暴露多个端口，在这种方式下，我们必须为每个端口定义一个端口名（端口名只允许包含数字、小写字母以及<code>-</code>，且必须以数字或小写字母开头和记为）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br></pre></td></tr></table></figure>
<h3 id="414-choosing-your-own-ip-address"><a class="markdownIt-Anchor" href="#414-choosing-your-own-ip-address"></a> 4.1.4 Choosing your own IP address</h3>
<p>我们可以通过<code>.spec.clusterIP</code>字段为<code>Service</code>分配静态的<code>Cluster IP</code>。该<code>IP</code>必须是一个合法的<code>Cluster IP</code>，否则会被<code>Api Server</code>拒绝（返回<code>422</code>错误码）</p>
<h3 id="415-discovering-services"><a class="markdownIt-Anchor" href="#415-discovering-services"></a> 4.1.5 Discovering services</h3>
<p><code>Kubernetes</code>提供了两种服务发现的方式</p>
<ol>
<li><code>Environment Variables</code></li>
<li><code>DNS</code></li>
</ol>
<h4 id="4151-environment-variables"><a class="markdownIt-Anchor" href="#4151-environment-variables"></a> 4.1.5.1 Environment Variables</h4>
<p><code>kubelet</code>会为每个<code>Service</code>设置一系列的环境变量，格式为<code>&lt;SERVICE_NAME&gt;_&lt;VARIABLE_NAME&gt;</code>，服务名和变量名都会被转成大写+下划线的方式</p>
<p>这种方式会引入顺序的问题，如果<code>Pod</code>想要访问一个<code>Service</code>，那么这个<code>Service</code>必须优先于<code>Pod</code>创建</p>
<h4 id="4152-dns"><a class="markdownIt-Anchor" href="#4152-dns"></a> 4.1.5.2 DNS</h4>
<p><code>DNS Server</code>会监听<code>Service</code>的创建，并为其创建<code>DNS Record</code>，如此一来，<code>Pod</code>就可以通过服务名来访问服务了</p>
<p>举个例子，如果我们有一个<code>Service</code>，起名字为<code>my-service</code>，其对应的<code>Namesapce</code>为<code>my-ns</code>，那么<code>DNS Server</code>会为这个<code>Service</code>创建一个<code>my-service.my-ns</code>的记录。所有在<code>my-ns</code>下的<code>Pod</code>可以通过服务名来访问，即<code>my-service</code>；对于在其他<code>Namespace</code>下的<code>Pod</code>必须通过<code>my-service.my-ns</code>来访问</p>
<h3 id="416-headless-services"><a class="markdownIt-Anchor" href="#416-headless-services"></a> 4.1.6 Headless services</h3>
<p>有时候，我们不需要负载均衡，也不需要<code>Service IP</code>，我们可以通过<code>.spec.clusterIP = None</code>来进行配置。这种方式允许开发者与<code>Kubernetes</code>的服务发现机制解耦，允许开发者使用其他的服务发现机制</p>
<p>在这种模式下，<code>Service</code>不会被分配<code>Cluster IP</code>，<code>kube-proxy</code>也不会处理这些<code>Service</code></p>
<p>如果该模式的<code>Service</code>包含<code>Selector</code>，<code>Endpoint Controller</code>会创建<code>Endpoint</code>来记录这个<code>Service</code>，并且会修改<code>DNS</code>记录（<code>ServiceName</code>-&gt;<code>Backend Pod IP</code>）</p>
<p>如果该模式的<code>Service</code>不包含<code>Selector</code>，那么<code>Endpoint Controller</code>不会为<code>Service</code>创建任何<code>Endponit</code></p>
<h3 id="417-publishing-services-service-types"><a class="markdownIt-Anchor" href="#417-publishing-services-service-types"></a> 4.1.7 Publishing services - service types</h3>
<p>有时候，我们的服务需要对外暴露（不仅仅对其他<code>Pod</code>提供服务，而是对整个Internet提供服务），<code>Kubernetes</code>允许我们为<code>Service</code>指定<code>ServiceType</code>，默认的类型是<code>ClusterIP</code>，所有的可选类型如下</p>
<ol>
<li><code>ClusterIP</code>: 通过<code>Cluster IP</code>暴露该<code>Service</code>，意味着只有在集群内才能访问这个<code>Service</code>。这是默认的类型</li>
<li><code>NodePort</code>: 通过<code>NodePort</code>暴露该<code>Service</code>，即在集群中所有<code>Node</code>上都分配一个静态的端口。在该类型下，会自动为<code>Service</code>创建<code>Cluster IP</code>用于路由，我们也可以从外部通过<code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code>来访问这个<code>Service</code></li>
<li><code>LoadBalancer</code>: 通过<code>Load Balancer</code>对外暴露该<code>Service</code>。在该类型下，会自动为<code>Service</code>创建<code>Cluster IP</code>以及<code>NodePort</code>用于路由</li>
<li><code>ExternalName</code>: 通过<code>CNAME</code>暴露该服务，将服务映射到<code>externalName</code>字段对应的域名中，完全由<code>DNS</code>负责路由</li>
</ol>
<h4 id="4171-type-nodeport"><a class="markdownIt-Anchor" href="#4171-type-nodeport"></a> 4.1.7.1 Type NodePort</h4>
<p>对于这种模式的<code>Service</code>，集群中所有的<code>Node</code>都会代理该相同的<code>Port</code>，该端口号对应于<code>Service</code>的<code>.spec.ports[*].nodePort</code>配置项</p>
<p>我们可以通过<code>--nodeport-addresses</code>选项来指定一个或一组<code>IP</code>的范围（多个的话，以<code>,</code>分隔），该选项的默认是是空<code>[]</code>，意味着最大的<code>IP</code>范围</p>
<p>我们可以通过<code>nodePort</code>来指定暴露的<code>Port</code>，因此我们需要注意端口冲突的问题，且必须属于合法的<code>NodePort</code>范围</p>
<p>这种方式给予了开发者更多的自由度，允许配置自己的负载均衡服务，允许在精简版的<code>Kubernetes</code>环境中使用<code>Service</code>，允许我们直接暴露<code>Node</code>的<code>IP</code>来使用<code>Service</code></p>
<p><strong>服务可以通过<code>&lt;NodeIP&gt;:spec.ports[*].nodePort</code>或者<code>.spec.clusterIP:spec.ports[*].port</code>两种方式进行访问</strong></p>
<h4 id="4172-type-loadbalancer"><a class="markdownIt-Anchor" href="#4172-type-loadbalancer"></a> 4.1.7.2 Type LoadBalancer</h4>
<p>对于提供负载均衡服务的云环境，我们可以将<code>Service</code>指定为<code>LoadBalancer</code>类型，<code>Kubernetes</code>会为<code>Service</code>创建<code>LoadBalancer</code>，事实上，<code>LoadBalancer</code>的创建过程与<code>Service</code>的创建过程是异步的。当<code>LoadBalancer</code>发布后，会更新<code>Service</code>的<code>.status.loadBalancer</code>字段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.0</span><span class="number">.171</span><span class="number">.239</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">78.11</span><span class="number">.24</span><span class="number">.19</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">146.148</span><span class="number">.47</span><span class="number">.155</span></span><br></pre></td></tr></table></figure>
<p><code>LoadBalancer</code>接收到来自外部的流量后，会直接路由到提供服务的<code>Pod</code>，具体方式依赖于云服务提供商的实现。一些云服务提供商允许指定<code>loadBalancerIP</code>，在这种情况下会以配置的<code>IP</code>来创建<code>LoadBalancer</code>，若<code>loadBalancerIP</code>未配置，则会分配一个随机的IP。如果云服务商不提供这个功能，那么这个字段将会被忽略</p>
<h3 id="418-the-gory-details-of-virtual-ips"><a class="markdownIt-Anchor" href="#418-the-gory-details-of-virtual-ips"></a> 4.1.8 The gory details of virtual IPs</h3>
<p>本小节将介绍<code>Service</code>的一些细节问题</p>
<h4 id="4181-avoiding-collisions"><a class="markdownIt-Anchor" href="#4181-avoiding-collisions"></a> 4.1.8.1 Avoiding collisions</h4>
<p><code>Kubernetes</code>的哲学之一就是尽量避免用户因为自身以外的因素，导致应用无法正常工作。对于端口而言，用户自己选择端口号，将会有一定概率导致冲突，因此，<code>Kubernetes</code>为用户自动分配端口号</p>
<p><code>Kubernetes</code>确保每个<code>Service</code>分配到的<code>IP</code>在集群中是唯一的。具体做法是，<code>Kubernetes</code>会在<code>etcd</code>中维护一个全局的分配映射表</p>
<h4 id="4182-ips-and-vips"><a class="markdownIt-Anchor" href="#4182-ips-and-vips"></a> 4.1.8.2 IPs and VIPs</h4>
<p><code>Pod IP</code>通常可以定位到一个确定的<code>Pod</code>，但是<code>Service</code>的<code>Cluster IP(Virtual IP, VIP)</code>通常映射为一组<code>Pod</code>，因此，<code>Kubernetes</code>利用<code>iptables</code>将<code>Cluster IP</code>进行重定向。因此，所有导入<code>VIP</code>的流量都会自动路由到一个或一组<code>Endpoint</code>中去。<code>Service</code>的环境变量和DNS实际上是根据服务的<code>VIP</code>和端口填充的</p>
<p><code>Kubernetes</code>支持三种不同的模式，分别是<code>userspace</code>、<code>iptables</code>、<code>ipvs</code>，这三者之间有微小的差异</p>
<h2 id="42-dns-for-services-and-pods"><a class="markdownIt-Anchor" href="#42-dns-for-services-and-pods"></a> 4.2 DNS for Services and Pods</h2>
<h3 id="421-introduction"><a class="markdownIt-Anchor" href="#421-introduction"></a> 4.2.1 Introduction</h3>
<p>每个<code>Service</code>都会分配一个<code>DNS Name</code>。通常情况下，一个<code>Pod</code>的<code>DNS</code>搜索范围包括<code>Pod</code>所在的<code>Namespace</code>以及集群的默认<code>domain</code>。举例来说，<code>Namspace bar</code>中包含<code>Service foo</code>，一个运行在<code>Namspace bar</code>中的<code>Pod</code>可以通过<code>foo</code>来搜索这个<code>Service</code>，一个运行在<code>Namspace quux</code>中的<code>Pod</code>可以通过<code>foo.bar</code>来搜索这个<code>Service</code></p>
<h3 id="422-services"><a class="markdownIt-Anchor" href="#422-services"></a> 4.2.2 Services</h3>
<h4 id="4221-a-records"><a class="markdownIt-Anchor" href="#4221-a-records"></a> 4.2.2.1 A Records</h4>
<ol>
<li><code>Pod</code>会被分配一个<code>A Record</code>，其格式为<code>&lt;pod-ip-address&gt;.&lt;my-namespace&gt;.pod.cluster.local</code></li>
<li>例如一个<code>Pod</code>，其<code>IP</code>为<code>1.2.3.4</code>，其<code>Namespace</code>为<code>default</code>，且<code>DNS Name</code>为<code>cluster.locals</code>，那么对应的<code>A Record</code>为<code>1-2-3-4.default.pod.cluster.local</code></li>
</ol>
<h3 id="423-pods"><a class="markdownIt-Anchor" href="#423-pods"></a> 4.2.3 Pods</h3>
<h4 id="4231-pods-hostname-and-subdomain-fields"><a class="markdownIt-Anchor" href="#4231-pods-hostname-and-subdomain-fields"></a> 4.2.3.1 Pod’s hostname and subdomain fields</h4>
<ol>
<li>当一个<code>Pod</code>创建时，它的<code>hostname</code>就是<code>metadata.name</code>的值</li>
<li><code>Pod</code>还可以指定<code>spec.hostname</code>，若<code>spec.hostname</code>与<code>metadata.name</code>同时存在时，以<code>spec.hostname</code>为准</li>
<li><code>Pod</code>还可以指定<code>spec.subdomain</code>。例如，若一个<code>Pod</code>，其<code>spec.hostname</code>为<code>foo</code>，<code>spec.subdomain</code>为<code>bar</code>，<code>Namespace</code>为<code>my-namespace</code>，则对应的<code>FQDN</code>为<code>foo.bar.my-namespace.pod.cluster.local</code></li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-subdomain</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span> <span class="comment"># Actually, no port is needed.</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">1234</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-1</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-2</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure>
<h4 id="4232-pods-dns-policy"><a class="markdownIt-Anchor" href="#4232-pods-dns-policy"></a> 4.2.3.2 Pod’s DNS Policy</h4>
<p>可以基于每个<code>Pod</code>设置<code>DNS Policy</code>。目前，<code>Kubernetes</code>支持以下几种<code>DNS Policy</code></p>
<ol>
<li><code>Default</code>: 从<code>Node</code>中继承<code>DNS</code>配置</li>
<li><code>ClusterFirst</code>: 任何不匹配集群域名后缀的<code>DNS Query</code>都会转发到从<code>Node</code>中继承而来的上游<code>DNS</code>服务器</li>
<li><code>ClusterFirstWithHostNet</code>: 若<code>Pod</code>以<code>hostNetwork</code>模式运行，那么<code>DNS</code>必须设置为<code>ClusterFirstWithHostNet</code></li>
<li><code>None</code>: 忽略<code>Kubernetes</code>的<code>DNS Policy</code>，同时依赖<code>spec.dnsConfig</code>提供更细粒度的配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br></pre></td></tr></table></figure>
<h4 id="4233-pods-dns-config"><a class="markdownIt-Anchor" href="#4233-pods-dns-config"></a> 4.2.3.3 Pod’s DNS Config</h4>
<p><code>Kubernetes</code>在<code>v1.9</code>版本后允许用户进行更细粒度的<code>DNS</code>配置，需要通过<code>--feature-gates=CustomPodDNS=true</code>选项来开启该功能。开启功能后，我们就可以将<code>spec.dnsPolicy</code>字段设置为<code>None</code>，并且新增一个字段<code>dnsConfig</code>，来进行更细粒度的配置</p>
<p><code>dnsConfig</code>支持以下几项配置</p>
<ol>
<li><code>nameservers</code>: <code>DNS</code>服务器列表，最多可以设置3个，最少包含一个</li>
<li><code>searches</code>: <code>DNS Search Domain</code>列表，最多支持6个</li>
<li><code>options</code>: 一些键值对的列表，每个键值对必须包含<code>Key</code>，但是<code>Value</code>可以没有</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dns-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">nameservers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">searches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ns1.svc.cluster.local</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my.dns.search.suffix</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">edns0</span></span><br></pre></td></tr></table></figure>
<h2 id="43-connecting-applications-with-services"><a class="markdownIt-Anchor" href="#43-connecting-applications-with-services"></a> 4.3 Connecting Applications with Services</h2>
<p>在讨论<code>Kubernetes</code>的网络通信之前，我们先对比一下<code>Docker</code>的常规网络通信方式</p>
<p>默认情况下，<code>Docker</code>使用的是<code>host-private</code>网络，因此，只有处于同一个机器上的不同<code>Container</code>之间才可以通信。因此要想跨<code>Node</code>进行通信，那么必须为<code>Container</code>所在的机器分配<code>IP</code>用以代理该<code>Container</code>，这样一来就必须处理<code>IP</code>以及<code>Port</code>冲突的问题</p>
<p>在不同的开发者之间进行<code>Port</code>的统一分配是一件非常困难的事情，并且会增加扩容/缩容的复杂度。<code>Kubernetes</code>首先假设<code>Pod</code>可以与其他<code>Pod</code>进行通信，且无视他们所属的<code>Node</code>，<code>Kubernetes</code>会为每个<code>Pod</code>分配一个<code>cluster-private-IP</code>，且我们无需处理这些映射关系。这意味着，位于同一个<code>Node</code>上的<code>Pod</code>自然可以通过<code>localhost</code>进行通信，位于不同<code>Node</code>上的<code>Pod</code>无需使用<code>NAT</code>也可以进行通信，下面将详细介绍<code>Kubernetes</code>的实现方式</p>
<h3 id="431-exposing-pods-to-the-cluster"><a class="markdownIt-Anchor" href="#431-exposing-pods-to-the-cluster"></a> 4.3.1 Exposing pods to the cluster</h3>
<p>下面，我们用一个<code>Nginx Pod</code>作为例子，进行介绍</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>下面创建一个<code>Deployment Object</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Deployment</span></span><br><span class="line">kubectl create -f ./run-my-nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">deployment.apps/my-nginx created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod</span></span><br><span class="line">kubectl get pods -l run=my-nginx -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       IP           NODE</span><br><span class="line">my-nginx-59497d7745-9z9f7   1/1       Running   0          3m        10.244.1.8   k8s-node-1</span><br><span class="line">my-nginx-59497d7745-kww92   1/1       Running   0          3m        10.244.2.5   k8s-node-2</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod ip</span></span><br><span class="line">kubectl get pods -l run=my-nginx -o yaml | grep podIP</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">    podIP: 10.244.1.8</span><br><span class="line">    podIP: 10.244.2.5</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p>注意到，这些<code>Pod</code>并没有用附属<code>Node</code>的<code>80</code>端口，也没有配置任何<code>NAT</code>规则来路由流量，这意味着，我们可以在同一个<code>Node</code>上部署多个<code>Pod</code>，并且利用<code>IP</code>来访问这些<code>Pod</code></p>
<p>登录<code>Pod</code>的命令如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -n &lt;namespace&gt; -- bash</span><br></pre></td></tr></table></figure>
<h3 id="432-create-a-service"><a class="markdownIt-Anchor" href="#432-create-a-service"></a> 4.3.2 Create a Service</h3>
<p>理论上，我们可以直接使用这些<code>Pod</code>的<code>IP</code>来与之通信，但是一旦<code>Node</code>挂了之后，又会被<code>Deployment</code>部署到其他健康的<code>Node</code>中，并分配一个新的<code>Pod IP</code>，因此，会带来非常大的复杂度</p>
<p><code>Serivce</code>抽象了一组功能相同的<code>Pod</code>。每个<code>Service</code>在创建之初就会被分配一个独有的<code>IP</code>，称为<code>Cluster IP</code>，该<code>IP</code>在<code>Service</code>的生命周期中保持不变，进入<code>Service</code>的流量会通过负载均衡后，路由到其中一个<code>Pod</code>上</p>
<p>接着上面的例子，我们可以通过<code>kubectl expose</code>来创建一个<code>Service</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建service</span></span><br><span class="line">kubectl expose deployment/my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">service/my-nginx exposed</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看service</span></span><br><span class="line">kubectl get svc my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">my-nginx   ClusterIP   10.96.104.176   &lt;none&gt;        80/TCP    3m</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看service的状态</span></span><br><span class="line">kubectl describe svc my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Name:              my-nginx</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            run=my-nginx</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=my-nginx</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.104.176</span><br><span class="line">Port:              &lt;<span class="built_in">unset</span>&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.1.8:80,10.244.2.5:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line">kubectl describe svc my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Name:              my-nginx</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            run=my-nginx</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=my-nginx</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.104.176</span><br><span class="line">Port:              &lt;<span class="built_in">unset</span>&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.1.8:80,10.244.2.5:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看endpoint</span></span><br><span class="line">kubectl get ep my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME       ENDPOINTS                     AGE</span><br><span class="line">my-nginx   10.244.1.8:80,10.244.2.5:80   11m</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p><code>kubectl expose</code>等价于<code>kubectl create -f &lt;如下配置文件&gt;</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br></pre></td></tr></table></figure>
<p>根据上面的定义，该<code>Serivce</code>会代理所有匹配<code>run: my-nginx</code>的<code>Pod</code>。其中<code>port</code>是<code>Serivce</code>的流量入口端口；<code>targetPort</code>是<code>Pod</code>的流量入口端口，默认与<code>port</code>相同</p>
<p>这些<code>Pod</code>通过<code>Endpoint</code>露出，<code>Service</code>会持续筛选匹配<code>Selector</code>的<code>Pod</code>，并将结果输送到与<code>Pod</code>同名的<code>Endpoint</code>对象中。当一个<code>Pod</code>挂了之后，它会自动从<code>Endpoint</code>中被移除，新的<code>Pod</code>随即会被创建，并添加到<code>Endpoint</code>中</p>
<h3 id="433-accessing-the-service"><a class="markdownIt-Anchor" href="#433-accessing-the-service"></a> 4.3.3 Accessing the Service</h3>
<p><code>Kubernetes</code>提供了两种服务发现的方式：<code>Environment Variables</code>以及<code>DNS</code></p>
<h4 id="4331-environment-variables"><a class="markdownIt-Anchor" href="#4331-environment-variables"></a> 4.3.3.1 Environment Variables</h4>
<p>当<code>Pod</code>运行在<code>Node</code>之后，<code>kubectl</code>会为每个<code>Service</code>设置一些环境变量。这种方式会引入顺序问题</p>
<p>首先，我们查看一下现有<code>Pod</code>的环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> &lt;pod name&gt; -- <span class="built_in">printenv</span> | grep SERVICE</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p>可以看到，这里没有我们创建的<code>Service</code>的相关信息，这是因为我们在创建<code>Service</code>之前，首先创建了<code>Pod</code>。另一个弊端是，<code>Scheduler</code>可能会将上述两个<code>Pod</code>部署到同一个<code>Node</code>中，这会导致整个<code>Service</code>不可用，我们可以通过杀死这两个<code>Pod</code>并等待<code>Deployment</code>重新创建两个新的<code>Pod</code>来修复这个问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 杀死现有的Pod，并创建新的Pod</span></span><br><span class="line">kubectl scale deployment my-nginx --replicas=0; kubectl scale deployment my-nginx --replicas=2;</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">deployment.extensions/my-nginx scaled</span><br><span class="line">deployment.extensions/my-nginx scaled</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod</span></span><br><span class="line">kubectl get pods -l run=my-nginx -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       IP           NODE</span><br><span class="line">my-nginx-59497d7745-jb8zm   1/1       Running   0          1m        10.244.1.9   k8s-node-1</span><br><span class="line">my-nginx-59497d7745-nrxj7   1/1       Running   0          1m        10.244.2.6   k8s-node-2</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看环境变量</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod name&gt; -- <span class="built_in">printenv</span> | grep SERVICE</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">MY_NGINX_SERVICE_HOST=10.96.104.176</span><br><span class="line">MY_NGINX_SERVICE_PORT=80</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h4 id="4332-dns"><a class="markdownIt-Anchor" href="#4332-dns"></a> 4.3.3.2 DNS</h4>
<p><code>Kubernetes</code>提供了一个<code>DNS cluster addon Service</code>，它会为每个<code>Service</code>分配一个<code>DNS Name</code>，我们可以通过如下命令查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get services kube-dns --namespace=kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP   212d</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p>在集群中的任何<code>Pod</code>都可以用标准的方式来访问<code>Service</code>，我们运行另一个<code>curl</code>应用来进行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以交互的方式运行一个 container</span></span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --<span class="built_in">tty</span></span><br><span class="line"></span><br><span class="line">nslookup my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      my-nginx</span><br><span class="line">Address 1: 10.96.104.176 my-nginx.default.svc.cluster.local</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="434-securing-the-service"><a class="markdownIt-Anchor" href="#434-securing-the-service"></a> 4.3.4 Securing the Service</h3>
<p>对于需要对外露出的<code>Service</code>，我们可以为其添加<code>TLS/SSL</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#create a public private key pair</span></span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /tmp/nginx.key -out /tmp/nginx.crt -subj <span class="string">&quot;/CN=my-nginx/O=my-nginx&quot;</span></span><br><span class="line"><span class="comment">#convert the keys to base64 encoding</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/nginx.crt | <span class="built_in">base64</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/nginx.key | <span class="built_in">base64</span></span><br></pre></td></tr></table></figure>
<p>下面创建一个<code>Secret</code>，配置如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;v1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;Secret&quot;</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;nginxsecret&quot;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nginx.crt:</span> <span class="string">&quot;&lt;cat /tmp/nginx.crt | base64 的输出&gt;&quot;</span></span><br><span class="line">  <span class="attr">nginx.key:</span> <span class="string">&quot;&lt;cat /tmp/nginx.key | base64 的输出&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginxsecrets.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">secret/nginxsecret created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line">kubectl get secrets</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME                  TYPE                                  DATA      AGE</span><br><span class="line">default-token-m7tnl   kubernetes.io/service-account-token   3         212d</span><br><span class="line">nginxsecret           Opaque                                2         14s</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p>现在需要替换掉之前的<code>nginx</code>服务，配置如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">nginxsecret</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxhttps</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">bprashanth/nginxhttps:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/nginx/ssl</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">secret-volume</span></span><br></pre></td></tr></table></figure>
<p>上述的配置清单包括</p>
<ol>
<li><code>Deployment</code>以及<code>Service</code></li>
<li><code>nginx</code>暴露了<code>80</code>以及<code>443</code>端口，<code>Service</code>露出了这两个端口，分别是<code>8080</code>以及<code>443</code>端口</li>
<li><code>Container</code>通过挂载到<code>/etc/nginx/ssl</code>上的卷来获取<code>secret key</code></li>
</ol>
<p>利用上述配置，替换原先的<code>nginx</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments,svc my-nginx; kubectl create -f ./nginx-secure-app.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">deployment.extensions <span class="string">&quot;my-nginx&quot;</span> deleted</span><br><span class="line">service <span class="string">&quot;my-nginx&quot;</span> deleted</span><br><span class="line">service/my-nginx created</span><br><span class="line">deployment.apps/my-nginx created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<p>于是我们就能通过<code>Service</code>来访问<code>Nginx Server</code>了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询Server的Cluster Ip</span></span><br><span class="line">kubectl get svc -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                        AGE       SELECTOR</span><br><span class="line">kubernetes            ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                        212d      &lt;none&gt;</span><br><span class="line">my-nginx              NodePort    10.102.252.181   &lt;none&gt;        8080:31530/TCP,443:32730/TCP   24m       run=my-nginx</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过Cluster IP访问nginx</span></span><br><span class="line">curl -k https://10.102.252.181</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line">curl -k http://10.102.252.181:8080</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">curl-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">curlpod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">curlpod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">nginxsecret</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">curlpod</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span> <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">radial/busyboxplus:curl</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/nginx/ssl</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">secret-volume</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建另一个curl pod</span></span><br><span class="line">kubectl create -f ./curlpod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">deployment.apps/curl-deployment created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取pod名称</span></span><br><span class="line">kubectl get pods -l app=curlpod</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">curl-deployment-d74d885b7-tc7z8   1/1       Running   0          25s</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用指定的pod执行curl命令访问ngix服务</span></span><br><span class="line">kubectl <span class="built_in">exec</span> curl-deployment-d74d885b7-tc7z8 -- curl https://my-nginx --cacert /etc/nginx/ssl/nginx.crt </span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">...</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="435-exposing-the-service未完成"><a class="markdownIt-Anchor" href="#435-exposing-the-service未完成"></a> 4.3.5 Exposing the Service（未完成）</h3>
<p>如果我们的应用想要对外露出，<code>Kubernetes</code>提供了两种方式，即<code>NodePort</code>以及<code>LoadBalancer</code>，上面的例子中，使用的是<code>NodePort</code>方式，因此如果<code>Node</code>本身就有<code>Public IP</code>，那么就可以对外提供服务了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看nodePort</span></span><br><span class="line">kubectl get svc my-nginx -o yaml | grep nodePort -C 5</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.102.252.181</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    nodePort: 31530</span><br><span class="line">    port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  - name: https</span><br><span class="line">    nodePort: 32730</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 443</span><br><span class="line">  selector:</span><br><span class="line">    run: my-nginx</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看externalIP</span></span><br><span class="line">kubectl get nodes -o yaml | grep ExternalIP -C 1</span><br></pre></td></tr></table></figure>
<h2 id="44-ingress"><a class="markdownIt-Anchor" href="#44-ingress"></a> 4.4 Ingress</h2>
<p><code>Ingress</code>用于管理<code>Service</code>的访问方式（通常是<code>HTTP</code>）</p>
<p><code>Ingress</code>可以提供<code>Load Balancing</code>、<code>SSL Termination</code>以及<code>Virtual Host</code>等服务</p>
<h3 id="441-terminology"><a class="markdownIt-Anchor" href="#441-terminology"></a> 4.4.1 Terminology</h3>
<p>涉及到的相关术语</p>
<ol>
<li><code>Node</code>: <code>Kubernetes</code>集群中的虚拟机或者物理机</li>
<li><code>Cluster</code>: 由一组<code>Node</code>组成，通常它们由<code>Kubernetes</code>进行管理</li>
<li><code>Edge Router</code>: 用于执行防火墙策略的路由器，通常形态是云服务商提供的网关或者是一个硬件</li>
<li><code>Cluster Network</code>: 用于进群内通信的网络基础设施</li>
<li><code>Service</code>: 定义了一组满足特定<code>Label Selector</code>的<code>Pod</code>，<code>Serivce</code>含有一个仅在集群内有效的<code>Virtual IP</code></li>
</ol>
<h3 id="442-what-is-ingress"><a class="markdownIt-Anchor" href="#442-what-is-ingress"></a> 4.4.2 What is Ingress?</h3>
<p><code>Ingress</code>定义从<code>Internet</code>到<code>Service</code>的路由规则，因此<code>Ingress</code>可以控制外来访问流量</p>
<p><code>Ingress</code>通常包含<code>LoadBalancer</code>、<code>Edge Router</code>以及一些其他用于处理流量的组件</p>
<p><code>Ingress</code>不露出任何协议以及端口，要想暴露<code>Service</code>而不是<code>HTTP/HTTPS</code>的话，应该使用<code>Service.Type</code>（设置成<code>NodePort</code>或者<code>LoadBalancer</code>方式）</p>
<h3 id="443-ingress-controllers"><a class="markdownIt-Anchor" href="#443-ingress-controllers"></a> 4.4.3 Ingress controllers</h3>
<p>为了使得<code>Ingress</code>能够正常工作，必须要在集群运行一个<code>Ingress Controller</code>，该<code>Ingress Controller</code>与其他<code>Controller</code>不同，它不属于<code>kube-controller-manager</code>的一部分，且不会自动启动</p>
<h3 id="444-the-ingress-resource"><a class="markdownIt-Anchor" href="#444-the-ingress-resource"></a> 4.4.4 The Ingress Resource</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/testpath</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>与其他<code>Kubernetes Object</code>相同，<code>Ingress</code>需要<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>三个字段</p>
<p>每个<code>HTTP Rule</code>都包含了如下的信息</p>
<ol>
<li><code>host</code>: 匹配指定的<code>host</code></li>
<li><code>path</code>: 匹配指定的<code>path</code>，每个<code>path</code>都包含了一个后端的<code>serviceName</code>以及<code>servicePort</code></li>
<li><code>backend</code>: 任何匹配<code>host</code>以及<code>path</code>的请求，都会被路由到<code>backend</code>对应的<code>Service</code>中</li>
</ol>
<p>如果一个<code>Ingress</code>没有配置任何的<code>rule</code>，那么所有流量都会被路由到一个<code>default backend</code>；如果流量不匹配任何的<code>host</code>以及<code>path</code>，那么该流量也会被路由到<code>default backend</code></p>
<p><code>default backend</code>可以在<code>Ingress Controller</code>中进行配置</p>
<h3 id="445-types-of-ingress"><a class="markdownIt-Anchor" href="#445-types-of-ingress"></a> 4.4.5 Types of Ingress</h3>
<h4 id="4451-single-service-ingress"><a class="markdownIt-Anchor" href="#4451-single-service-ingress"></a> 4.4.5.1 Single Service Ingress</h4>
<p>一个<code>Ingress</code>只对应了一个后端的<code>Service</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">serviceName:</span> <span class="string">testsvc</span></span><br><span class="line">    <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="4452-simple-fanout"><a class="markdownIt-Anchor" href="#4452-simple-fanout"></a> 4.4.5.2 Simple fanout</h4>
<p>一个<code>Ingress</code>对应着多个<code>Service</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo.bar.com -&gt; 178.91.123.132 -&gt; / foo    service1:4200</span><br><span class="line">                                 / bar    service2:8080</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-fanout-example</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/foo</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">4200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h4 id="4453-name-based-virtual-hosting"><a class="markdownIt-Anchor" href="#4453-name-based-virtual-hosting"></a> 4.4.5.3 Name based virtual hosting</h4>
<p>该类型常用于将多个<code>Service</code>通过同一个IP暴露出去，且对外的域名是不同的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo.bar.com --|                 |-&gt; foo.bar.com s1:80</span><br><span class="line">              | 178.91.123.132  |</span><br><span class="line">bar.foo.com --|                 |-&gt; bar.foo.com s2:80</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">bar.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="4454-tls"><a class="markdownIt-Anchor" href="#4454-tls"></a> 4.4.5.4 TLS</h4>
<p>我们可以在<code>Ingress</code>之上增加<code>TSL/SSL</code>协议</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">cert</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">key</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sslexample.foo.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">sslexample.foo.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="4455-loadbalancing"><a class="markdownIt-Anchor" href="#4455-loadbalancing"></a> 4.4.5.5 Loadbalancing</h4>
<p>一个<code>Ingress Controller</code>通常支持一些负载均衡的设置，包括负载均衡算法、权重策略等，目前尚不支持一些负载均衡的高级配置</p>
<h3 id="446-updating-an-ingress"><a class="markdownIt-Anchor" href="#446-updating-an-ingress"></a> 4.4.6 Updating an Ingress</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit ingress <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h2 id="45-ingress-controller"><a class="markdownIt-Anchor" href="#45-ingress-controller"></a> 4.5 Ingress Controller</h2>
<p>为了使得<code>Ingress</code>能够生效，我们必须运行一个<code>Ingress Controller</code>。与其他<code>Controller</code>不同，<code>Ingress Controller</code>不会默认启动</p>
<h3 id="451-additional-controllers"><a class="markdownIt-Anchor" href="#451-additional-controllers"></a> 4.5.1 Additional controllers</h3>
<p><code>Ingress Controller</code>有许多不同的实现</p>
<ol>
<li><code>Ambassador</code></li>
<li><code>AppsCode Inc</code></li>
<li><code>Contour</code></li>
<li><code>Citrix</code></li>
<li><code>F5 Networks</code></li>
<li><code>Gloo</code></li>
<li><code>HAProxy</code></li>
<li><code>Istio</code></li>
<li><code>Kong</code></li>
<li><code>NGINX, Inc</code></li>
<li><code>Traefik</code></li>
</ol>
<h2 id="46-network-policies"><a class="markdownIt-Anchor" href="#46-network-policies"></a> 4.6 Network Policies</h2>
<p><code>Network Policy</code>定义了<code>Pod</code>之间或者<code>Pod</code>与其他<code>Endpoint</code>之间的通信方式</p>
<h3 id="461-isolated-and-non-isolated-pods"><a class="markdownIt-Anchor" href="#461-isolated-and-non-isolated-pods"></a> 4.6.1 Isolated and Non-isolated Pods</h3>
<p>默认情况下，<code>Pod</code>都是<code>non-isolated</code>，意味着，它可以接收来自任何源的流量</p>
<p>当<code>Pod</code>匹配某个<code>NetworkPolicy</code>后，它就变成<code>isolated</code>的了，于是，它会拒绝所有不满足<code>NetworkPolicy</code>规则的流量</p>
<h3 id="462-the-networkpolicy-resource"><a class="markdownIt-Anchor" href="#462-the-networkpolicy-resource"></a> 4.6.2 The NetworkPolicy Resource</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-network-policy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">        <span class="attr">except:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">172.17</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">project:</span> <span class="string">myproject</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5978</span></span><br></pre></td></tr></table></figure>
<ol>
<li>与其他<code>Kubernetes Object</code>相同，<code>NetworkPolicy</code>需要<code>apiVersion</code>、<code>Kind</code>、<code>metadata</code>三个字段</li>
<li><code>spec</code>: 描述<code>NetworkPolicy</code>的最主要的字段</li>
<li><code>spec.podSelector</code>: 用于匹配<code>Pod</code>的<code>Selector</code>。一个空的<code>podSelector</code>会选择当前<code>Namespace</code>下的所有<code>Pod</code></li>
<li><code>spec.policyTypes</code>: 可以是<code>Ingress</code>、<code>Egress</code>或者两者。默认情况下，会包含<code>Ingress</code>，且如果包含任何<code>Egress</code>规则，那么也会包含<code>Egress</code>
<ul>
<li>
<blockquote>
<p><code>ingress</code>: 每个<code>NetworkPolicy</code>都包含了一个<code>ingress rule</code>列表，每项规则包含<code>from</code>以及<code>ports</code>两项。其类型可以是<code>ipBlock</code>、<code>namespaceSelector</code>或者<code>podSelector</code></p>
</blockquote>
</li>
<li>
<blockquote>
<p><code>egress</code>: 每个<code>NetworkPolicy</code>都包含另一个<code>egress rule</code>列表，每项规则包含<code>to</code>以及<code>ports</code>两项</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3 id="463-behavior-of-to-and-from-selectors"><a class="markdownIt-Anchor" href="#463-behavior-of-to-and-from-selectors"></a> 4.6.3 Behavior of to and from selectors</h3>
<p><code>igress</code>的<code>from</code>部分与<code>egress</code>的<code>to</code>部分可以包含如下四种类型</p>
<ol>
<li><code>podSelector</code>: 在<code>NetworkPolicy</code>所在的<code>Namespace</code>下选择特定的<code>Pod</code></li>
<li><code>namespaceSelector</code>: 选择特定的<code>Namespace</code>下的所有<code>Pod</code></li>
<li><code>podSelector</code>和<code>namespaceSelector</code>: 选择特定<code>Namespace</code>下的特定<code>Pod</code></li>
<li><code>ipBlock</code>: 选择特定的<code>IP CIDR</code>范围，且必须是<code>cluster-external IP</code></li>
</ol>
<p><strong>区分以下两种配置的区别</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">user:</span> <span class="string">alice</span></span><br><span class="line">      <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">client</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>这种配置包含一个规则: <code>podSelector</code>和<code>namespaceSelector</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">user:</span> <span class="string">alice</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">role:</span> <span class="string">client</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>这种配置包含两种规则: <code>podSelector</code>或<code>namespaceSelector</code></p>
<h3 id="464-default-policies"><a class="markdownIt-Anchor" href="#464-default-policies"></a> 4.6.4 Default policies</h3>
<p>默认情况下，不存在任何<code>Policy</code>，但是我们可以修改默认的行为</p>
<h4 id="4641-default-deny-all-ingress-traffic"><a class="markdownIt-Anchor" href="#4641-default-deny-all-ingress-traffic"></a> 4.6.4.1 Default deny all ingress traffic</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure>
<h4 id="4642-default-allow-all-ingress-traffic"><a class="markdownIt-Anchor" href="#4642-default-allow-all-ingress-traffic"></a> 4.6.4.2 Default allow all ingress traffic</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></table></figure>
<h4 id="4643-default-deny-all-egress-traffic"><a class="markdownIt-Anchor" href="#4643-default-deny-all-egress-traffic"></a> 4.6.4.3 Default deny all egress traffic</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>
<h4 id="4644-default-allow-all-egress-traffic"><a class="markdownIt-Anchor" href="#4644-default-allow-all-egress-traffic"></a> 4.6.4.4 Default allow all egress traffic</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>
<h4 id="4645-default-deny-all-ingress-and-all-egress-traffic"><a class="markdownIt-Anchor" href="#4645-default-deny-all-ingress-and-all-egress-traffic"></a> 4.6.4.5 Default deny all ingress and all egress traffic</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure>
<h2 id="47-adding-entries-to-pod-etchosts-with-hostaliases"><a class="markdownIt-Anchor" href="#47-adding-entries-to-pod-etchosts-with-hostaliases"></a> 4.7 Adding entries to Pod /etc/hosts with HostAliases</h2>
<p>当没有DNS的时候，我们可以通过配置<code>/etc/hosts</code>来提供一种<code>Pod-Level</code>的域名解决方案</p>
<h3 id="471-default-hosts-file-content"><a class="markdownIt-Anchor" href="#471-default-hosts-file-content"></a> 4.7.1 Default Hosts File Content</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image nginx --generator=run-pod/v1</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">pod/nginx created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod ip</span></span><br><span class="line">kubectl get pods --output=wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">nginx         1/1       Running   0          8m        10.244.2.49   k8s-node-2</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看nginx的/etc/hosts文件的默认内容</span></span><br><span class="line">kubectl <span class="built_in">exec</span> nginx -- <span class="built_in">cat</span> /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line"><span class="comment"># Kubernetes-managed hosts file.</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">fe00::0	ip6-mcastprefix</span><br><span class="line">fe00::1	ip6-allnodes</span><br><span class="line">fe00::2	ip6-allrouters</span><br><span class="line">10.244.2.49	nginx</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="472-adding-additional-entries-with-hostaliases"><a class="markdownIt-Anchor" href="#472-adding-additional-entries-with-hostaliases"></a> 4.7.2 Adding Additional Entries with HostAliases</h3>
<p>通过为<code>Pod</code>配置<code>.spec.hostAliases</code>属性，可以增加额外的域名解析规则，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostaliases-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">hostAliases:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;foo.local&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;bar.local&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">&quot;10.1.2.3&quot;</span></span><br><span class="line">    <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;foo.remote&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;bar.remote&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cat-hosts</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/etc/hosts&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hostaliases-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">pod/hostaliases-pod created</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod IP</span></span><br><span class="line">kubectl get pod -o=wide</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">NAME              READY     STATUS      RESTARTS   AGE       IP            NODE</span><br><span class="line">hello-world       1/1       Running     16         225d      10.244.1.49   k8s-node-1</span><br><span class="line">hostaliases-pod   0/1       Completed   0          1m        10.244.2.50   k8s-node-2</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line">kubectl logs hostaliases-pod</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line"><span class="comment"># Kubernetes-managed hosts file.</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">fe00::0	ip6-mcastprefix</span><br><span class="line">fe00::1	ip6-allnodes</span><br><span class="line">fe00::2	ip6-allrouters</span><br><span class="line">10.244.2.50	hostaliases-pod</span><br><span class="line"><span class="comment"># Entries added by HostAliases.</span></span><br><span class="line">127.0.0.1	foo.local</span><br><span class="line">127.0.0.1	bar.local</span><br><span class="line">10.1.2.3	foo.remote</span><br><span class="line">10.1.2.3	bar.remote</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="473-why-does-kubelet-manage-the-hosts-file"><a class="markdownIt-Anchor" href="#473-why-does-kubelet-manage-the-hosts-file"></a> 4.7.3 Why Does Kubelet Manage the Hosts File?</h3>
<p><code>kubelet</code>为每个<code>Container</code>管理<code>host</code>文件，是为了避免<code>Docker</code>在启动容器后修改该文件</p>
<p>由于文件托管的性质，只要在<code>Container</code>重新启动或者<code>Pod</code>重新被调度的情况下，<code>kubelet</code>都会重新载入<code>host</code>文件，任何用户编写的内容都将被覆盖，因此，不建议修改文件的内容</p>
<h1 id="5-storage"><a class="markdownIt-Anchor" href="#5-storage"></a> 5 Storage</h1>
<h2 id="51-volumes"><a class="markdownIt-Anchor" href="#51-volumes"></a> 5.1 Volumes</h2>
<p><code>Container</code>中的磁盘文件是短暂的，这会带来一些问题。首先，当一个<code>Container</code>崩溃之后，<code>kubelet</code>会重启该<code>Container</code>，但是这些磁盘文件会丢失。其次，在一个<code>Pod</code>中运行的不同<code>Container</code>之间可能需要共享一些文件。因此<code>Kubernetes</code>利用<code>Volume</code>来解决上述问题</p>
<h3 id="511-backgroud"><a class="markdownIt-Anchor" href="#511-backgroud"></a> 5.1.1 Backgroud</h3>
<p><code>Docker</code>也有<code>Volume</code>的相关概念，但是其能力相比于<code>Kubernetes</code>较弱。在<code>Docker</code>中，一个<code>Volume</code>就是磁盘中或者其他<code>Container</code>中的一个目录，<code>Volume</code>的生命周期不受管控。<code>Docker</code>现在还提供了<code>Volume Driver</code>，但是其功能还是非常薄弱</p>
<p><code>Kubernetes</code>中的<code>Volume</code>有明确的生命周期，<code>Volume</code>的生命周期比<code>Pod</code>中任何<code>Container</code>的生命周期更长，因此数据能够在<code>Container</code>重启时保留。当然，如果一个<code>Pod</code>停止了，那么<code>Volume</code>也会相应停止。此外，<code>Kubernetes</code>提供了多种类型的<code>Volume</code>，且<code>Pod</code>可以同时使用任意类型，任意数量的<code>Volume</code></p>
<p>本质上而言，<code>Volume</code>就是一个包含数据的可被<code>Container</code>访问的目录，至于该目录是如何形成的，支持它的介质以及存储的内容是由具体的类型决定的</p>
<p>我们可以通过配置<code>.spec.volumes</code>字段来指定<code>Volume</code>的类型以及相应的参数，通过<code>.spec.containers.volumeMounts</code>来指定具体的挂载目录</p>
<p>在<code>Container</code>中的应用可以看到由<code>Docker Image</code>以及<code>Volume</code>组成的文件系统视图。<code>Docker Image</code>位于文件系统的顶层，所有的<code>Volume</code>必须挂载到<code>Image</code>中。<code>Volume</code>不能挂载到其他<code>Volume</code>中或者与其他<code>Volume</code>存在<code>hard link</code>。在<code>Pod</code>中的每个<code>Container</code>必须独立地指定每个<code>Volume</code>的挂载目录</p>
<h3 id="512-types-of-volumes"><a class="markdownIt-Anchor" href="#512-types-of-volumes"></a> 5.1.2 Types of Volumes</h3>
<ol>
<li>awsElasticBlockStore</li>
<li>azureDisk</li>
<li>azureFile</li>
<li>cephfs</li>
<li>configMap</li>
<li>csi</li>
<li>downwardAPI</li>
<li><strong>emptyDir</strong>：由容器运行时管理，容器退出就销毁了</li>
<li>fc (fibre channel)</li>
<li>flexVolume</li>
<li>flocker</li>
<li>gcePersistentDisk</li>
<li>gitRepo (deprecated)</li>
<li>glusterfs</li>
<li><strong>hostPath</strong></li>
<li>iscsi</li>
<li>local</li>
<li>nfs</li>
<li>persistentVolumeClaim</li>
<li>projected</li>
<li>portworxVolume</li>
<li>quobyte</li>
<li>rbd</li>
<li>scaleIO</li>
<li>secret</li>
<li>storageos</li>
<li>vsphereVolume</li>
</ol>
<h2 id="52-persistent-volumes"><a class="markdownIt-Anchor" href="#52-persistent-volumes"></a> 5.2 Persistent Volumes</h2>
<h2 id="53-storage-classes"><a class="markdownIt-Anchor" href="#53-storage-classes"></a> 5.3 Storage Classes</h2>
<h2 id="54-volume-snapshot-classes"><a class="markdownIt-Anchor" href="#54-volume-snapshot-classes"></a> 5.4 Volume Snapshot Classes</h2>
<h2 id="55-dynamic-volume-provisioning"><a class="markdownIt-Anchor" href="#55-dynamic-volume-provisioning"></a> 5.5 Dynamic Volume Provisioning</h2>
<h2 id="56-node-specific-volume-limits"><a class="markdownIt-Anchor" href="#56-node-specific-volume-limits"></a> 5.6 Node-specific Volume Limits</h2>
<h1 id="6-network"><a class="markdownIt-Anchor" href="#6-network"></a> 6 Network</h1>
<h2 id="61-overview"><a class="markdownIt-Anchor" href="#61-overview"></a> 6.1 Overview</h2>
<p>首先，我们来明确一下，Kubernetes面临的网络问题</p>
<ol>
<li><strong>Highly-coupled Container-to-Container communications</strong>：高耦合的<code>Container</code>之间的网络通信，通过<code>pods</code>以及<code>localhost</code>通信来解决</li>
<li><strong>Pod-to-Pod communications</strong>：本小节将详细展开说明</li>
<li><strong>Pod-to-Service communications</strong>：通过<code>services</code>来解决</li>
<li><strong>External-to-Service communications</strong>：通过<code>services</code>来解决</li>
</ol>
<h2 id="62-docker-model"><a class="markdownIt-Anchor" href="#62-docker-model"></a> 6.2 Docker Model</h2>
<p>我们先来回顾一下Docker的网络模型，这对于理解Kubernetes的网络模型是很有必要的。<strong>在默认情况下，<code>Docker</code>利用<code>host-private networking</code>，<code>Docker</code>创建了一个虚拟网桥（virtual bridge），默认为<code>docker0</code></strong>。对于<code>Docker</code>创建的每个<code>Container</code>都会有一个连接到网桥的虚拟以太网卡（virtual Ethernet device）<code>veth</code>，从<code>Container</code>内部来看，<code>veth</code>就被映射成了<code>eth0</code>网卡</p>
<p>在这种网络模型下，只要位于同一个物理机上（或者同一个虚拟网桥上），所有的<code>Container</code>之间可以进行通信。但是位于不同物理机上的<code>Container</code>是无法进行通信的</p>
<p>为了让<code>Container</code>可以跨<code>node</code>进行交互，必须为它们分配一个宿主物理机的<code>ip</code>。这样一来，我们就需要付出额外的精力维护<code>ip</code>以及<code>port</code></p>
<h2 id="63-kubernetes-model"><a class="markdownIt-Anchor" href="#63-kubernetes-model"></a> 6.3 Kubernetes model</h2>
<p><code>Kubernetes</code>要求网络模型必须满足如下条件</p>
<ol>
<li>所有<code>Container</code>之间的通信不能依赖NAT</li>
<li>所有<code>node</code>与<code>Container</code>之间的通信不能依赖NAT</li>
<li>某个<code>Container</code>在内部、外部看到的<code>ip</code>一致</li>
</ol>
<p>这种模式不仅总体上不那么复杂，而且主要与Kubernetes希望将应用程序从VM轻松移植到容器的愿望兼容</p>
<p>到目前为止，都在讨论<code>Container</code>，但事实上，<code>Kubernetes</code>在<code>Pod</code>范围上使用<code>ip</code>地址，因此，在一个<code>Pod</code>内的所有<code>Container</code>共享网络命名空间（network namespaces），当然包括ip地址。这意味着，在一个<code>Pod</code>内的<code>Container</code>可以通过<code>localhost</code>与其他<code>Container</code>进行通信。<strong>这称为“IP-per-pod”模式，在这种模式下，一个<code>Pod</code>需要有一个<code>pod contaner</code>来管理网络命名空间，其他<code>app container</code>利用<code>Docker</code>的<code>--net=container:&lt;id&gt;</code>参数来加入这个网络命名空间即可</strong></p>
<h2 id="64-kubernetes-networking-model-implements"><a class="markdownIt-Anchor" href="#64-kubernetes-networking-model-implements"></a> 6.4 Kubernetes networking model implements</h2>
<p><strong>Kubernetes的网络模型有很多种实现方式，包括但不仅限如下几种</strong></p>
<ol>
<li>ACI</li>
<li>AOS from Apstra</li>
<li>Big Cloud Fabric from Big Switch Networks</li>
<li>Cilium</li>
<li>CNI-Genie from Huawei</li>
<li>Contiv</li>
<li>Contrail</li>
<li>Flannel</li>
<li>Google Compute Engine (GCE)</li>
<li>Kube-router</li>
<li>L2 networks and linux bridging</li>
<li>Multus (a Multi Network plugin)</li>
<li>NSX-T</li>
<li>Nuage Networks VCS (Virtualized Cloud Services)</li>
<li>OpenVSwitch</li>
<li>OVN (Open Virtual Networking)</li>
<li>Project Calico</li>
<li>Romana</li>
<li>Weave Net from Weaveworks</li>
</ol>
<h2 id="65-参考"><a class="markdownIt-Anchor" href="#65-参考"></a> 6.5 参考</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">Cluster Networking</a></li>
</ul>
<h1 id="7-question"><a class="markdownIt-Anchor" href="#7-question"></a> 7 Question</h1>
<ol>
<li><code>Pod IP</code>在Namespace下唯一，既然可以通过<code>Namespace</code>+<code>Pod IP</code>准确定位一个<code>Pod</code>，为什么还需要<code>flannel</code></li>
<li><code>flannel</code>保证了在同一个集群中的<code>Pod</code>的ip不重复</li>
</ol>
<h1 id="8-参考"><a class="markdownIt-Anchor" href="#8-参考"></a> 8 参考</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/">英文文档1</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.kubernetes.org.cn/">中文文档1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/kubernetes%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84">中文文档2</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/">k8s-api-reference</a></li>
<li><a target="_blank" rel="noopener" href="https://edu.aliyun.com/course/1651?spm=5176.10731542.0.0.785020be217oeD">k8s-阿里云公开课</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#prerequisite-generic-deployment-command">nginx ingress doc</a></li>
<li><a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/">metallb doc</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004667502">Borg、Omega 和 Kubernetes：谷歌十几年来从这三个容器管理系统中得到的经验教训</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhenyuyaodidiao/p/6500720.html">Kubernetes核心概念总结</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/dkfajsldfsdfsd/article/details/81200411">Kubernetes之Service</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_29115985/article/details/78963125">Kubernetes学习4–容器之间通讯方式及Flannel工作原理</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/165a256fb1da">Flannel网络原理</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/be48159fa795">解决Flannel跨主机互联网络问题【Docker】</a></li>
<li><a target="_blank" rel="noopener" href="https://mritd.me/2017/03/04/how-to-use-nginx-ingress/">Kubernetes Nginx Ingress 教程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/4619.html">使用kubeadm安装Kubernetes 1.12</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fnproject/fn-helm/issues/21">forbidden: User “system:serviceaccount:kube-system:default” cannot get namespaces in the namespace &quot;default</a></li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%91%98%E5%BD%95/" rel="tag"># 摘录</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/07/20/Linux-Network/" rel="prev" title="Linux-Network">
      <i class="fa fa-chevron-left"></i> Linux-Network
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/07/25/Flowable-Overview/" rel="next" title="Flowable-Overview">
      Flowable-Overview <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY0My8xMDE5OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-overview"><span class="nav-text"> 1 Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-kubernetes-components"><span class="nav-text"> 1.1 Kubernetes Components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#111-master-components"><span class="nav-text"> 1.1.1 Master Components</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1111-kube-apiserver"><span class="nav-text"> 1.1.1.1 kube-apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1112-etcd"><span class="nav-text"> 1.1.1.2 etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1113-kube-shceduler"><span class="nav-text"> 1.1.1.3 kube-shceduler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1114-kube-controller-manager"><span class="nav-text"> 1.1.1.4 kube-controller-manager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1115-cloud-controller-manager"><span class="nav-text"> 1.1.1.5 cloud-controller-manager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#112-node"><span class="nav-text"> 1.1.2 Node</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1121-kubelet"><span class="nav-text"> 1.1.2.1 kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1122-kube-proxy"><span class="nav-text"> 1.1.2.2 kube-proxy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1123-container-runtime"><span class="nav-text"> 1.1.2.3 Container Runtime</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#113-addons"><span class="nav-text"> 1.1.3 Addons</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#114-%E5%8F%82%E8%80%83"><span class="nav-text"> 1.1.4 参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-kubernetes-object"><span class="nav-text"> 1.2 Kubernetes Object</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#121-name"><span class="nav-text"> 1.2.1 Name</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1211-nmaes"><span class="nav-text"> 1.2.1.1 Nmaes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1212-uids"><span class="nav-text"> 1.2.1.2 UIDs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#122-namespaces"><span class="nav-text"> 1.2.2 Namespaces</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1221-when-to-use-multiple-namespaces"><span class="nav-text"> 1.2.2.1 When to use Multiple Namespaces</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1222-working-with-namespaces"><span class="nav-text"> 1.2.2.2 Working with Namespaces</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1223-namespaces-and-dns%E6%9C%AA%E5%AE%8C%E6%88%90"><span class="nav-text"> 1.2.2.3 Namespaces and DNS（未完成）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1224-not-all-objects-are-in-a-namespace"><span class="nav-text"> 1.2.2.4 Not All Objects are in a Namespace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#123-labels-and-selectors"><span class="nav-text"> 1.2.3 Labels and Selectors</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1231-motivation"><span class="nav-text"> 1.2.3.1 Motivation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1232-label-selectors"><span class="nav-text"> 1.2.3.2 Label selectors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1233-api"><span class="nav-text"> 1.2.3.3 API</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#124-annotations"><span class="nav-text"> 1.2.4 Annotations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#125-field-selectors"><span class="nav-text"> 1.2.5 Field Selectors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#126-recommended-labels"><span class="nav-text"> 1.2.6 Recommended Labels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#127-%E5%8F%82%E8%80%83"><span class="nav-text"> 1.2.7 参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-architecture"><span class="nav-text"> 2 Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-node"><span class="nav-text"> 2.1 Node</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#211-node-status"><span class="nav-text"> 2.1.1 Node Status</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2111-addresses"><span class="nav-text"> 2.1.1.1 Addresses</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2112-condition"><span class="nav-text"> 2.1.1.2 Condition</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2113-capacity"><span class="nav-text"> 2.1.1.3 Capacity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2114-info"><span class="nav-text"> 2.1.1.4 Info</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#212-management"><span class="nav-text"> 2.1.2 Management</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2121-node-controller"><span class="nav-text"> 2.1.2.1 Node Controller</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#213-node-capacity"><span class="nav-text"> 2.1.3 Node capacity</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-master-node-communication"><span class="nav-text"> 2.2 Master-Node communication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#221-cluster-to-master"><span class="nav-text"> 2.2.1 Cluster to Master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#222-master-to-cluster"><span class="nav-text"> 2.2.2 Master to Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2221-api-server-to-kubelet"><span class="nav-text"> 2.2.2.1 Api server to kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2222-api-server-to-nodes-pods-and-services"><span class="nav-text"> 2.2.2.2 Api server to nodes, pods, and services</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-concepts-underlying-the-cloud-controller-manager"><span class="nav-text"> 2.3 Concepts Underlying the Cloud Controller Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#231-design"><span class="nav-text"> 2.3.1 Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#232-components-of-the-ccm"><span class="nav-text"> 2.3.2 Components of the CCM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#233-functions-of-the-ccm"><span class="nav-text"> 2.3.3 Functions of the CCM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2331-kubernetes-controller-manager"><span class="nav-text"> 2.3.3.1 Kubernetes Controller Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#23311-node-controller"><span class="nav-text"> 2.3.3.1.1 Node Controller</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#23312-route-controller"><span class="nav-text"> 2.3.3.1.2 Route Controller</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#23313-service-controller"><span class="nav-text"> 2.3.3.1.3 Service Controller</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#23314-persistentvolumelabels-controller"><span class="nav-text"> 2.3.3.1.4 PersistentVolumeLabels Controller</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2332-kubelet"><span class="nav-text"> 2.3.3.2 Kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2333-kubernetes-api-server"><span class="nav-text"> 2.3.3.3 Kubernetes API server</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#234-plugin-mechanism"><span class="nav-text"> 2.3.4 Plugin mechanism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#235-authorization"><span class="nav-text"> 2.3.5 Authorization</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2351-node-controller"><span class="nav-text"> 2.3.5.1 Node Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2352-route-controller"><span class="nav-text"> 2.3.5.2 Route Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2353-service-controller"><span class="nav-text"> 2.3.5.3 Service Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2354-persistentvolumelabels-controller"><span class="nav-text"> 2.3.5.4 PersistentVolumeLabels Controller</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-%E5%8F%82%E8%80%83"><span class="nav-text"> 2.4 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-workloads"><span class="nav-text"> 3 Workloads</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#31-pods"><span class="nav-text"> 3.1 Pods</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#311-pod-overview"><span class="nav-text"> 3.1.1 Pod Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3111-understanding-pods"><span class="nav-text"> 3.1.1.1 Understanding Pods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3112-working-with-pods"><span class="nav-text"> 3.1.1.2 Working with Pods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3113-pod-templates"><span class="nav-text"> 3.1.1.3 Pod Templates</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#312-pods"><span class="nav-text"> 3.1.2 Pods</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3121-what-is-a-pod"><span class="nav-text"> 3.1.2.1 What is a Pod?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3122-motivation-for-pods"><span class="nav-text"> 3.1.2.2 Motivation for pods</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3123-durability-of-pods-or-lack-thereof"><span class="nav-text"> 3.1.2.3 Durability of pods (or lack thereof)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3124-termination-of-pods"><span class="nav-text"> 3.1.2.4 Termination of Pods</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#313-pod-lifecycle"><span class="nav-text"> 3.1.3 Pod Lifecycle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3131-pod-phase"><span class="nav-text"> 3.1.3.1 Pod phase</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3132-pod-conditions"><span class="nav-text"> 3.1.3.2 Pod conditions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3133-container-probes"><span class="nav-text"> 3.1.3.3 Container probes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3134-pod-readiness-gate"><span class="nav-text"> 3.1.3.4 Pod readiness gate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3135-restart-policy"><span class="nav-text"> 3.1.3.5 Restart policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3136-pod-lifetime"><span class="nav-text"> 3.1.3.6 Pod lifetime</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#314-init-containers"><span class="nav-text"> 3.1.4 Init Containers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3141-understanding-init-containers"><span class="nav-text"> 3.1.4.1 Understanding Init Containers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3142-detailed-behavior"><span class="nav-text"> 3.1.4.2 Detailed behavior</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#315-pod-preset"><span class="nav-text"> 3.1.5 Pod Preset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#316-disruptions"><span class="nav-text"> 3.1.6 Disruptions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3161-voluntary-and-involuntary-disruptions"><span class="nav-text"> 3.1.6.1 Voluntary and Involuntary Disruptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3162-dealing-with-disruptions"><span class="nav-text"> 3.1.6.2 Dealing with Disruptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3163-how-disruption-budgets-work"><span class="nav-text"> 3.1.6.3 How Disruption Budgets Work</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#317-%E5%8F%82%E8%80%83"><span class="nav-text"> 3.1.7 参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-controller"><span class="nav-text"> 3.2 Controller</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#321-replicaset"><span class="nav-text"> 3.2.1 ReplicaSet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3211-how-to-use-a-replicaset"><span class="nav-text"> 3.2.1.1 How to use a ReplicaSet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3212-when-to-use-a-replicaset"><span class="nav-text"> 3.2.1.2 When to use a ReplicaSet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3213-writing-a-replicaset-manifest"><span class="nav-text"> 3.2.1.3 Writing a ReplicaSet manifest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3214-working-with-replicasets"><span class="nav-text"> 3.2.1.4 Working with ReplicaSets</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#32141-deleting-a-replicaset-and-its-pods"><span class="nav-text"> 3.2.1.4.1 Deleting a ReplicaSet and its Pods</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32142-deleting-just-a-replicaset"><span class="nav-text"> 3.2.1.4.2 Deleting just a ReplicaSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32143-isolating-pods-from-a-replicaset"><span class="nav-text"> 3.2.1.4.3 Isolating Pods from a ReplicaSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32144-scaling-a-replicaset"><span class="nav-text"> 3.2.1.4.4 Scaling a ReplicaSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32145-replicaset-as-a-horizontal-pod-autoscaler-target"><span class="nav-text"> 3.2.1.4.5 ReplicaSet as a Horizontal Pod Autoscaler Target</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3215-alternatives-to-replicaset"><span class="nav-text"> 3.2.1.5 Alternatives to ReplicaSet</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#32151-deploymentrecommended"><span class="nav-text"> 3.2.1.5.1 Deployment(recommended)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32152-bare-pods"><span class="nav-text"> 3.2.1.5.2 Bare Pods</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32153-job"><span class="nav-text"> 3.2.1.5.3 Job</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32154-daemonset"><span class="nav-text"> 3.2.1.5.4 DaemonSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32155-replicationcontroller"><span class="nav-text"> 3.2.1.5.5 ReplicationController</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#322-replicationcontroller"><span class="nav-text"> 3.2.2 ReplicationController</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3221-how-a-replicationcontroller-works"><span class="nav-text"> 3.2.2.1 How a ReplicationController Works</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3222-writing-a-replicationcontroller-spec"><span class="nav-text"> 3.2.2.2 Writing a ReplicationController Spec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3223-working-with-replicationcontrollers"><span class="nav-text"> 3.2.2.3 Working with ReplicationControllers</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#32231-deleting-a-replicationcontroller-and-its-pods"><span class="nav-text"> 3.2.2.3.1 Deleting a ReplicationController and its Pods</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32232-deleting-just-a-replicationcontroller"><span class="nav-text"> 3.2.2.3.2 Deleting just a ReplicationController</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32233-isolating-pods-from-a-replicationcontroller"><span class="nav-text"> 3.2.2.3.3 Isolating pods from a ReplicationController</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3224-common-usage-patterns"><span class="nav-text"> 3.2.2.4 Common usage patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#32241-rescheduling"><span class="nav-text"> 3.2.2.4.1 Rescheduling</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32242-scaling"><span class="nav-text"> 3.2.2.4.2 Scaling</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32243-rolling-updates"><span class="nav-text"> 3.2.2.4.3 Rolling updates</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32244-multiple-release-tracks"><span class="nav-text"> 3.2.2.4.4 Multiple release tracks</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32245-using-replicationcontrollers-with-services"><span class="nav-text"> 3.2.2.4.5 Using ReplicationControllers with Services</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3225-writing-programs-for-replication"><span class="nav-text"> 3.2.2.5 Writing programs for Replication</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3226-responsibilities-of-the-replicationcontroller"><span class="nav-text"> 3.2.2.6 Responsibilities of the ReplicationController</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3227-api-object"><span class="nav-text"> 3.2.2.7 API Object</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3228-alternatives-to-replicationcontroller"><span class="nav-text"> 3.2.2.8 Alternatives to ReplicationController</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#32281-replicaset"><span class="nav-text"> 3.2.2.8.1 ReplicaSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32282-deploymentrecommended"><span class="nav-text"> 3.2.2.8.2 Deployment(Recommended)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32283-bare-pods"><span class="nav-text"> 3.2.2.8.3 Bare Pods</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32284-job"><span class="nav-text"> 3.2.2.8.4 Job</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#32285-daemonset"><span class="nav-text"> 3.2.2.8.5 DaemonSet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#323-deployments"><span class="nav-text"> 3.2.3 Deployments</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3231-creating-a-deployment"><span class="nav-text"> 3.2.3.1 Creating a Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3232-updating-a-deployment"><span class="nav-text"> 3.2.3.2 Updating a Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3233-rolling-back-a-deployment"><span class="nav-text"> 3.2.3.3 Rolling Back a Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3234-scaling-a-deployment"><span class="nav-text"> 3.2.3.4 Scaling a Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3235-pausing-and-resuming-a-deployment"><span class="nav-text"> 3.2.3.5 Pausing and Resuming a Deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3236-deployment-status"><span class="nav-text"> 3.2.3.6 Deployment Status</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3237-clean-up-policy"><span class="nav-text"> 3.2.3.7 Clean up Policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3238-writing-a-deployment-spec"><span class="nav-text"> 3.2.3.8 Writing a Deployment Spec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3239-alternative-to-deployments"><span class="nav-text"> 3.2.3.9 Alternative to Deployments</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#324-statefulsets"><span class="nav-text"> 3.2.4 StatefulSets</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3241-using-statefulsets"><span class="nav-text"> 3.2.4.1 Using StatefulSets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3242-limitations"><span class="nav-text"> 3.2.4.2 Limitations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3243-components"><span class="nav-text"> 3.2.4.3 Components</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3244-pod-selector"><span class="nav-text"> 3.2.4.4 Pod Selector</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3245-pod-indentity"><span class="nav-text"> 3.2.4.5 Pod Indentity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3246-deployment-and-scaling-guarantees"><span class="nav-text"> 3.2.4.6 Deployment and Scaling Guarantees</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3247-update-strategies"><span class="nav-text"> 3.2.4.7 Update Strategies</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#325-daemonset"><span class="nav-text"> 3.2.5 DaemonSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#326-garbage-collection"><span class="nav-text"> 3.2.6 Garbage Collection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#327-ttl-controller-for-finished-resources"><span class="nav-text"> 3.2.7 TTL Controller for Finished Resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#328-jobs-run-to-completion"><span class="nav-text"> 3.2.8 Jobs - Run to Completion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#329-cronjob"><span class="nav-text"> 3.2.9 CronJob</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-services-load-balancing-and-networking"><span class="nav-text"> 4 Services, Load Balancing and Networking</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-services"><span class="nav-text"> 4.1 Services</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#411-defining-a-service"><span class="nav-text"> 4.1.1 Defining a service</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4111-services-without-selectors"><span class="nav-text"> 4.1.1.1 Services without selectors</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#412-virtual-ips-and-service-proxies"><span class="nav-text"> 4.1.2 Virtual IPs and service proxies</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4121-proxy-mode-userspace"><span class="nav-text"> 4.1.2.1 Proxy-mode: userspace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4122-proxy-mode-iptables"><span class="nav-text"> 4.1.2.2 Proxy-mode: iptables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4123-proxy-mode-ipvs"><span class="nav-text"> 4.1.2.3 Proxy-mode: ipvs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#413-multi-port-services"><span class="nav-text"> 4.1.3 Multi-Port Services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#414-choosing-your-own-ip-address"><span class="nav-text"> 4.1.4 Choosing your own IP address</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#415-discovering-services"><span class="nav-text"> 4.1.5 Discovering services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4151-environment-variables"><span class="nav-text"> 4.1.5.1 Environment Variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4152-dns"><span class="nav-text"> 4.1.5.2 DNS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#416-headless-services"><span class="nav-text"> 4.1.6 Headless services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#417-publishing-services-service-types"><span class="nav-text"> 4.1.7 Publishing services - service types</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4171-type-nodeport"><span class="nav-text"> 4.1.7.1 Type NodePort</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4172-type-loadbalancer"><span class="nav-text"> 4.1.7.2 Type LoadBalancer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#418-the-gory-details-of-virtual-ips"><span class="nav-text"> 4.1.8 The gory details of virtual IPs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4181-avoiding-collisions"><span class="nav-text"> 4.1.8.1 Avoiding collisions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4182-ips-and-vips"><span class="nav-text"> 4.1.8.2 IPs and VIPs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#42-dns-for-services-and-pods"><span class="nav-text"> 4.2 DNS for Services and Pods</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#421-introduction"><span class="nav-text"> 4.2.1 Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#422-services"><span class="nav-text"> 4.2.2 Services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4221-a-records"><span class="nav-text"> 4.2.2.1 A Records</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#423-pods"><span class="nav-text"> 4.2.3 Pods</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4231-pods-hostname-and-subdomain-fields"><span class="nav-text"> 4.2.3.1 Pod’s hostname and subdomain fields</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4232-pods-dns-policy"><span class="nav-text"> 4.2.3.2 Pod’s DNS Policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4233-pods-dns-config"><span class="nav-text"> 4.2.3.3 Pod’s DNS Config</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#43-connecting-applications-with-services"><span class="nav-text"> 4.3 Connecting Applications with Services</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#431-exposing-pods-to-the-cluster"><span class="nav-text"> 4.3.1 Exposing pods to the cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#432-create-a-service"><span class="nav-text"> 4.3.2 Create a Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#433-accessing-the-service"><span class="nav-text"> 4.3.3 Accessing the Service</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4331-environment-variables"><span class="nav-text"> 4.3.3.1 Environment Variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4332-dns"><span class="nav-text"> 4.3.3.2 DNS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#434-securing-the-service"><span class="nav-text"> 4.3.4 Securing the Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#435-exposing-the-service%E6%9C%AA%E5%AE%8C%E6%88%90"><span class="nav-text"> 4.3.5 Exposing the Service（未完成）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#44-ingress"><span class="nav-text"> 4.4 Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#441-terminology"><span class="nav-text"> 4.4.1 Terminology</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#442-what-is-ingress"><span class="nav-text"> 4.4.2 What is Ingress?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#443-ingress-controllers"><span class="nav-text"> 4.4.3 Ingress controllers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#444-the-ingress-resource"><span class="nav-text"> 4.4.4 The Ingress Resource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#445-types-of-ingress"><span class="nav-text"> 4.4.5 Types of Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4451-single-service-ingress"><span class="nav-text"> 4.4.5.1 Single Service Ingress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4452-simple-fanout"><span class="nav-text"> 4.4.5.2 Simple fanout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4453-name-based-virtual-hosting"><span class="nav-text"> 4.4.5.3 Name based virtual hosting</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4454-tls"><span class="nav-text"> 4.4.5.4 TLS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4455-loadbalancing"><span class="nav-text"> 4.4.5.5 Loadbalancing</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#446-updating-an-ingress"><span class="nav-text"> 4.4.6 Updating an Ingress</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#45-ingress-controller"><span class="nav-text"> 4.5 Ingress Controller</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#451-additional-controllers"><span class="nav-text"> 4.5.1 Additional controllers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#46-network-policies"><span class="nav-text"> 4.6 Network Policies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#461-isolated-and-non-isolated-pods"><span class="nav-text"> 4.6.1 Isolated and Non-isolated Pods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#462-the-networkpolicy-resource"><span class="nav-text"> 4.6.2 The NetworkPolicy Resource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#463-behavior-of-to-and-from-selectors"><span class="nav-text"> 4.6.3 Behavior of to and from selectors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#464-default-policies"><span class="nav-text"> 4.6.4 Default policies</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4641-default-deny-all-ingress-traffic"><span class="nav-text"> 4.6.4.1 Default deny all ingress traffic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4642-default-allow-all-ingress-traffic"><span class="nav-text"> 4.6.4.2 Default allow all ingress traffic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4643-default-deny-all-egress-traffic"><span class="nav-text"> 4.6.4.3 Default deny all egress traffic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4644-default-allow-all-egress-traffic"><span class="nav-text"> 4.6.4.4 Default allow all egress traffic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4645-default-deny-all-ingress-and-all-egress-traffic"><span class="nav-text"> 4.6.4.5 Default deny all ingress and all egress traffic</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#47-adding-entries-to-pod-etchosts-with-hostaliases"><span class="nav-text"> 4.7 Adding entries to Pod &#x2F;etc&#x2F;hosts with HostAliases</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#471-default-hosts-file-content"><span class="nav-text"> 4.7.1 Default Hosts File Content</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#472-adding-additional-entries-with-hostaliases"><span class="nav-text"> 4.7.2 Adding Additional Entries with HostAliases</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#473-why-does-kubelet-manage-the-hosts-file"><span class="nav-text"> 4.7.3 Why Does Kubelet Manage the Hosts File?</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-storage"><span class="nav-text"> 5 Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#51-volumes"><span class="nav-text"> 5.1 Volumes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#511-backgroud"><span class="nav-text"> 5.1.1 Backgroud</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#512-types-of-volumes"><span class="nav-text"> 5.1.2 Types of Volumes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-persistent-volumes"><span class="nav-text"> 5.2 Persistent Volumes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-storage-classes"><span class="nav-text"> 5.3 Storage Classes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-volume-snapshot-classes"><span class="nav-text"> 5.4 Volume Snapshot Classes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#55-dynamic-volume-provisioning"><span class="nav-text"> 5.5 Dynamic Volume Provisioning</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#56-node-specific-volume-limits"><span class="nav-text"> 5.6 Node-specific Volume Limits</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-network"><span class="nav-text"> 6 Network</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#61-overview"><span class="nav-text"> 6.1 Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#62-docker-model"><span class="nav-text"> 6.2 Docker Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#63-kubernetes-model"><span class="nav-text"> 6.3 Kubernetes model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#64-kubernetes-networking-model-implements"><span class="nav-text"> 6.4 Kubernetes networking model implements</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#65-%E5%8F%82%E8%80%83"><span class="nav-text"> 6.5 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-question"><span class="nav-text"> 7 Question</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E5%8F%82%E8%80%83"><span class="nav-text"> 8 参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liuyehcf"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Liuyehcf</p>
  <div class="site-description" itemprop="description">大音希声，大象无形</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">285</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuyehcf</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qhEhLuMeMOy1zgcBhkqUS6P8-gzGzoHsz',
      appKey     : 'uhkruDLNLNdL5rQjRBY2X9Ke',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
