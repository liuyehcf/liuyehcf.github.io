<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="阅读更多">
<meta property="og:type" content="article">
<meta property="og:title" content="Protocol-SSL">
<meta property="og:url" content="http://example.com/2018/12/02/Protocol-SSL/index.html">
<meta property="og:site_name" content="Liuye Notebook">
<meta property="og:description" content="阅读更多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Protocol-SSL/fig1.jpg">
<meta property="article:published_time" content="2018-12-02T10:41:43.000Z">
<meta property="article:modified_time" content="2024-03-18T13:37:51.000Z">
<meta property="article:author" content="Liuyehcf">
<meta property="article:tag" content="摘录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Protocol-SSL/fig1.jpg">

<link rel="canonical" href="http://example.com/2018/12/02/Protocol-SSL/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Protocol-SSL | Liuye Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liuye Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-explore">

    <a href="/explore/" rel="section"><i class="fa fa-sitemap fa-fw"></i>发现</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/12/02/Protocol-SSL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Liuyehcf">
      <meta itemprop="description" content="大音希声，大象无形">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuye Notebook">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Protocol-SSL
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-02 18:41:43" itemprop="dateCreated datePublished" datetime="2018-12-02T18:41:43+08:00">2018-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-18 21:37:51" itemprop="dateModified" datetime="2024-03-18T21:37:51+08:00">2024-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/HTTP/" itemprop="url" rel="index"><span itemprop="name">HTTP</span></a>
                </span>
            </span>

          
            <span id="/2018/12/02/Protocol-SSL/" class="post-meta-item leancloud_visitors" data-flag-title="Protocol-SSL" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/02/Protocol-SSL/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/02/Protocol-SSL/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>阅读更多</strong></p>
<span id="more"></span>
<h1 id="1-ssl协议特性"><a class="markdownIt-Anchor" href="#1-ssl协议特性"></a> 1 SSL协议特性</h1>
<h2 id="11-sni"><a class="markdownIt-Anchor" href="#11-sni"></a> 1.1 SNI</h2>
<p>本小节内容转载自<a target="_blank" rel="noopener" href="https://blog.51cto.com/zengestudy/2170245">HTTPS之SNI介绍</a></p>
<p>早期的<code>SSLv2</code>根据经典的公钥基础设施<code>PKI(Public Key Infrastructure)</code>设计，它默认认为：一台服务器（或者说一个IP）只会提供一个服务，所以在SSL握手时，服务器端可以确信客户端申请的是哪张证书</p>
<p>但是让人万万没有想到的是，虚拟主机大力发展起来了，这就造成了一个IP会对应多个域名的情况。解决办法有一些，例如申请泛域名证书，对所有<code>*.yourdomain.com</code>的域名都可以认证，但如果你还有一个<code>yourdomain.net</code>的域名，那就不行了。</p>
<p>在HTTP协议中，请求的域名作为主机头（Host）放在<code>HTTP Header</code>中，所以服务器端知道应该把请求引向哪个域名，但是早期的SSL做不到这一点，因为在SSL握手的过程中，根本不会有Host的信息，所以服务器端通常返回的是配置中的第一个可用证书。因而一些较老的环境，可能会产生多域名分别配好了证书，但返回的始终是同一个</p>
<p>既然问题的原因是在SSL握手时缺少主机头信息，那么补上就是了。</p>
<p><strong><code>SNI（Server Name Indication）</code>定义在RFC 4366，是一项用于改善<code>SSL/TLS</code>的技术，在<code>SSLv3/TLSv1</code>中被启用。它允许客户端在发起SSL握手请求时（具体说来，是客户端发出SSL请求中的ClientHello阶段），就提交请求的Host信息，使得服务器能够切换到正确的域并返回相应的证书</strong></p>
<p>要使用SNI，需要客户端和服务器端同时满足条件，幸好对于现代浏览器来说，大部分都支持<code>SSLv3/TLSv1</code>，所以都可以享受SNI带来的便利</p>
<h1 id="2-证书"><a class="markdownIt-Anchor" href="#2-证书"></a> 2 证书</h1>
<h2 id="21-证书格式"><a class="markdownIt-Anchor" href="#21-证书格式"></a> 2.1 证书格式</h2>
<p>| 格式名称 | 格式后缀 | 文件格式 | 描述 |<br />
|:–|:–|:–|:–|:–|<br />
| <code>DER(Distinguished Encoding Rules)</code> | <code>.der/.cer</code> | 二进制格式 | 只保存证书，不保存私钥</br>Java和Windows服务器偏向于使用这种编码格式 |<br />
| <code>PEM(Privacy-Enhanced Mail)</code> | <code>.pem</code> | 文本格式 | 可保存证书，也可保存私钥</br>以<code>-----BEGIN...</code>开头，以<code>-----END...</code>结尾。中间的内容是<code>BASE64</code>编码</br>有时我们也把PEM格式的私钥的后缀改为<code>.key</code>以区别证书与私钥 |<br />
| <code>CRT(Certificate)</code> | <code>.crt</code> | 二进制格式/文本格式 | 可保存证书，也可保存私钥</br>有可能是PEM编码格式，也可能是DER编码格式 |<br />
| <code>PFX(Predecessor of PKCS#12)</code> | <code>.pfx/.P12</code> | 二进制格式 | 同时包含证书和私钥，一般有密码保护</br>证书和私钥存在一个PFX文件中</br>一般用于Windows上的IIS服务器 |<br />
| <code>JPS(Java Key Storage)</code> | <code>.jks</code> | 二进制格式 | 同时包含证书和私钥，一般有密码保护</br>Java的专属格式，可以用keytool进行格式转换</br>一般用于Tomcat服务器 |</p>
<h3 id="211-x509"><a class="markdownIt-Anchor" href="#211-x509"></a> 2.1.1 X.509</h3>
<p>X.509是公钥证书的标准格式，通常一个证书包含如下信息</p>
<ul>
<li><code>Certificate</code>
<ul>
<li><code>Version Number</code>: 版本号</li>
<li><code>Serial Number</code>: 序列号</li>
<li><code>Signature Algorithm</code>: 签名算法</li>
<li><strong><code>Issuer Name</code></strong>: 证书颁发机构名字，即CA</li>
<li><code>Validity period</code>: 证书有效期
<ul>
<li><code>Not Before</code>: 有效起始时间</li>
<li><code>Not After</code>: 有效的终止时间</li>
</ul>
</li>
<li><strong><code>Subject name</code></strong>: 证书持有者名字</li>
<li><code>Subject Public Key Info</code>: 证书公钥信息
<ul>
<li><code>Public Key Algorithm</code>: 公钥算法</li>
<li><code>Subject Public Key</code>: 公钥</li>
</ul>
</li>
<li><code>Issuer Unique Identifier (optional)</code></li>
<li><code>Subject Unique Identifier (optional)</code></li>
<li><code>Extensions (optional)</code></li>
</ul>
</li>
<li><code>Certificate Signature Algorithm</code>: 证书签名算法</li>
<li><code>Certificate Signature</code>: 证书签名</li>
</ul>
<p><code>Issuer Name</code>/<code>Subject name</code>（又称为<code>DN</code>，<code>Distinguished Name</code>）的格式如下</p>
<ol>
<li><code>C</code>: Country</li>
<li><code>ST</code>:</li>
<li><code>L</code>: Locality</li>
<li><code>O</code>: Organization</li>
<li><code>CN</code>: Common Name</li>
</ol>
<p><strong>若<code>Issuer Name</code>与<code>Subject name</code>相同，则表示自签名，根证书都是自签名的</strong></p>
<h2 id="22-证书类型"><a class="markdownIt-Anchor" href="#22-证书类型"></a> 2.2 证书类型</h2>
<table>
<thead>
<tr>
<th style="text-align:left">证书类型</th>
<th style="text-align:left">类型解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">单域名证书</td>
<td style="text-align:left">证书匹配一个<code>单域名</code></td>
</tr>
<tr>
<td style="text-align:left">单SAN证书</td>
<td style="text-align:left">证书匹配多个后缀不同的<code>单域名</code></td>
</tr>
<tr>
<td style="text-align:left">泛域名证书</td>
<td style="text-align:left">证书匹配单个<code>泛域名</code></br>（例如，<code>*.test.com</code>可以匹配<code>www.test.com</code>和<code>ftp.test.com</code>）</td>
</tr>
<tr>
<td style="text-align:left">泛SAN证书</td>
<td style="text-align:left">证书匹配多个后缀不同的<code>泛域名</code></td>
</tr>
</tbody>
</table>
<p><code>SAN</code>: <code>Subject Alternative Name</code></p>
<h2 id="23-根证书和中间证书以及证书链"><a class="markdownIt-Anchor" href="#23-根证书和中间证书以及证书链"></a> 2.3 根证书和中间证书以及证书链</h2>
<p>大多数人都知道SSL(TLS)，但是对其工作原理知之甚少，更不用说中间证书<code>Intermediate Certificate</code>、根证书<code>Root Certificate</code>以及证书链<code>Certificate Chain</code>了</p>
<h3 id="231-根证书"><a class="markdownIt-Anchor" href="#231-根证书"></a> 2.3.1 根证书</h3>
<p>根证书，又称为信任链的起点，是信任体系（SSL/TLS）的核心基础。每个浏览器或者设备都包含一个根仓库（<code>root store</code>），<code>root store</code>包含了一组预置的根证书，根证书价值是非常高的，任何由它的私钥签发的证书都会被浏览器信任</p>
<p>根证书属于证书颁发机构，它是校验以及颁发SSL证书的机构</p>
<h3 id="232-证书链"><a class="markdownIt-Anchor" href="#232-证书链"></a> 2.3.2 证书链</h3>
<p>在进一步探讨证书之前，我们需要引入一个概念，叫做证书链。我们先从一个问题入手：浏览器如何判断一个证书是否合法？当你访问一个站点时，浏览器会快速地校验这个证书的合法性</p>
<p>浏览器会沿着证书的<strong>证书链</strong>进行校验，那么什么是证书链呢？我们在申请证书时，需要创建一个<code>Certificate Signing Request</code>以及<code>Private Key</code>，<code>Certificate Signing Request</code>会发送给证书颁发机构，该机构会用根证书的私钥来对证书进行签名，然后再发还给请求者</p>
<p>当浏览器校验这个站点证书时，发现这个证书由根证书签名（准确地说，用根证书的私钥签名），且浏览器信任这个根证书，因此浏览器信任由这个根证书签名的站点证书。在这个例子中，站点证书直链根证书</p>
<h3 id="233-中间证书"><a class="markdownIt-Anchor" href="#233-中间证书"></a> 2.3.3 中间证书</h3>
<p>通常情况下，证书颁发机构不会用根证书来为站点证书签名，因为这非常危险，如果发生了误发证书或者其他错误而不得不撤回根证书，那么所有由该根证书签名的证书都会立即失效</p>
<p>为了提供更好的隔离性，证书颁发机构通常只为中间证书签名（用根证书的私钥来为这些<code>Intermediate Certificate</code>签名），然后再用这些中间证书来为站点证书签名（用中间证书的私钥来进行签名）。通常，站点证书与根证书之间存在多级的中间证书</p>
<p>证书链的示意图如下，简洁起见，只保留了一级中间证书</p>
<p><img src="/images/Protocol-SSL/fig1.jpg" alt="fig1" /></p>
<p><strong>要获得中间证书，一般有两种方式</strong></p>
<ol>
<li>由客户端自动下载中间证书</li>
<li>由服务器推送中间证书</li>
</ol>
<h4 id="2331-客户端自动下载中间证书"><a class="markdownIt-Anchor" href="#2331-客户端自动下载中间证书"></a> 2.3.3.1 客户端自动下载中间证书</h4>
<p><strong>一张标准的证书，都会包含自己的颁发者名称，以及颁发者机构访问信息：Authority Info Access，其中就会有颁发者CA证书的下载地址</strong>，可以通过<code>openssl x509 -in &lt;cert&gt; -noout -text</code>查看证书信息。通过这个CA证书下载地址，我们就能够获得CA证书，<strong>但有些平台不支持这种方式，例如Android，在这种平台上，仅通过站点证书就无法建立安全连接</strong></p>
<p>除了操作系统支持外，还有一个很重要的因素，就是客户端可以正常访问公网。如果客户端本身在一个封闭的网络环境内，无法访问公网下载中间证书，就会造成失败，无法建立可信连接</p>
<p>此外，有些CA的中间证书下载地址因为种种原因被“墙”掉了，也会造成我们无法获得中间证书，进而无法建立可信链接</p>
<p>虽然自动下载中间证书的机制如此不靠谱，但在有些应用中，这却是唯一有效的机制，譬如邮件签名证书，由于我们发送邮件时，无法携带颁发邮件证书的中间证书，往往只能依靠客户端自己去下载中间证书，一旦这个中间证书的URL无法访问（被“墙”掉）就会造成验证失败</p>
<h4 id="2332-服务器推送中间证书"><a class="markdownIt-Anchor" href="#2332-服务器推送中间证书"></a> 2.3.3.2 服务器推送中间证书</h4>
<p><strong>服务器推送中间证书，就是将中间证书，预先部署在服务器上，服务器在发送证书的同时，将中间证书一起发给客户端</strong></p>
<p>如果我们在服务器上不主动推送中间证书，可能会造成下列问题：</p>
<ol>
<li>Android手机无法自动下载中间证书，造成验证出错，提示证书不可信，无法建立可信连接</li>
<li>Java客户端无法自动下载中间证书，验证出错，可信连接失败</li>
<li>内网电脑，在禁止公网的情况下，无法自动下载中间证书，验证出错，可信连接失败</li>
<li>虽然我们不部署中间证书，在大多数情况，我们依然可以建立可信的HTTPS连接，但为了避免以上这些情况，我们必须在服务器上部署中间证书</li>
</ol>
<p>所以，为了确保我们在各种环境下都能建立可信的HTTPS连接，我们应该尽量做到以下几点：</p>
<ol>
<li>必须在服务器上部署正确的中间证书，以确保各类浏览器都能获得完整的证书链，完成验证</li>
<li>选择可靠的SSL服务商，有些小的CA机构，因为各种原因，造成他们的中间证书下载URL被禁止访问，即使我们在服务器上部署了中间证书，但也可能存在某种不可测的风险，这是我们应该尽力避免的</li>
<li>中间证书往往定期会更新，所以在证书续费或者重新签发后，需要检查是否更换过中间证书</li>
</ol>
<h3 id="234-数字签名"><a class="markdownIt-Anchor" href="#234-数字签名"></a> 2.3.4 数字签名</h3>
<p>数字签名是一种数字形式的公证。当根证书为中间证书签名时，本质上是将信任度传递到了中间证书，由于签名用的是根证书的私钥，因此中间证书也同时获得了信任</p>
<p>每当浏览器或设备收到SSL证书时，都会收到证书本身以及与证书关联的公钥。使用公钥解密数字签名并查看由谁签署的证书。当浏览器验证站点SSL证书时，它使用证书提供的公钥来解密签名并沿着证书链向上移动。不断重复这个过程–解密签名并跟随证书链到签署它的证书–直到最终到达浏览器信任库中的一个根证书。如果最后的根证书不在信任库中，那么浏览器就不信任该证书</p>
<p><strong>证书包含以下内容</strong></p>
<ol>
<li>证书包含了颁发证书的机构的名字–CA（CA可能是<code>Root CA</code>也可能是<code>Intermediate CA</code>）</li>
<li>证书内容本身的数字签名(用<strong>CA的私钥</strong>对摘要加密后的结果)</li>
<li>证书持有者的公钥</li>
<li>证书签名用到的hash算法</li>
</ol>
<h3 id="235-root-ca与intermediate-ca"><a class="markdownIt-Anchor" href="#235-root-ca与intermediate-ca"></a> 2.3.5 <code>Root CA</code>与<code>Intermediate CA</code></h3>
<p>到这里就比较清晰明了了，<code>Root CA</code>是拥有一个或多个根证书的证书颁发机构，<code>Intermediate CA</code>/<code>Sub CA</code>是拥有中间证书的证书颁发机构，中间证书需要连接到上层的证书（可能是中间证书或者根证书），这个就叫做交叉验签，或多级验签</p>
<p>一般来说，不会用根证书来为站点证书做签名，而是通过中间证书来增加安全层级，这有助于减少以及分解由误签或者其他错误造成的危害，因为我们只需要撤销中间证书而不需要撤销根证书，因此只会让部分证书失效而不会使全部证书失效</p>
<h3 id="236-chained-root与single-root"><a class="markdownIt-Anchor" href="#236-chained-root与single-root"></a> 2.3.6 <code>Chained Root</code>与<code>Single Root</code></h3>
<p><code>Root CA</code>用<code>Single Root</code>来直接颁发证书，使得部署证书和安装证书变得更加简单。<code>Sub CA</code>用<code>Chained Root</code>来颁发证书。它是一个中间证书，因为<code>Sub CA</code>没有自己的受信任的根，所以必须链接到一个具有根证书的<code>Third-party CA</code></p>
<p>下面是两者的差异</p>
<ol>
<li><code>Chained Root</code>安装起来更麻烦，<strong>因为持有站点证书的应用最好能够同时提供中间证书（以免中间证书无法正常下载，导致验证失败）</strong>，这就是为什么在制作证书时，需要将站点证书和中间证书一并打入证书中</li>
<li><code>Chained Root</code>受它们所链接的<code>Third-party CA</code>支配，它们无法控制根证书，如果<code>Root CA</code>停业，那么<code>Chained Root</code>也会失效</li>
<li>根证书和中间证书都会过期，虽然时间较长，但是中间证书的失效时间必须早于根证书，这增加了复杂度</li>
</ol>
<h2 id="24-认证过程"><a class="markdownIt-Anchor" href="#24-认证过程"></a> 2.4 认证过程</h2>
<p><strong>以一个深度为3的证书链的为例进行介绍</strong></p>
<img src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzOTdweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg1NHB4O2hlaWdodDozOTdweDtiYWNrZ3JvdW5kOiNFRUVCREM7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4NTQgMzk3IiB3aWR0aD0iODU0cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBmaWxsPSIjRUVFQkRDIiBoZWlnaHQ9IjM5NyIgc3R5bGU9InN0cm9rZTpub25lO3N0cm9rZS13aWR0aDoxLjA7IiB3aWR0aD0iODU0IiB4PSIwIiB5PSIwIi8+PHBhdGggZD0iTTM1LDM5Ljc4OTEgTDM1LjI4MDIsMzkuNzg5MSBMMzQuNDQ3Niw0OS43NjM5IEwzNS4yNTc3LDU5LjczODggTDM1LjUzMjksNjkuNzEzNiBMMzQuMDQ4OCw3OS42ODg1IEwzNC44OTY0LDg5LjY2MzMgTDM0LjQzMTMsOTkuNjM4MiBMMzQuNDg4NywxMDkuNjEzIEwzNC45MDkxLDExOS41ODc5IEwzNC4wNzgyLDEyOS41NjI3IEwzNS43MzgyLDEzOS41Mzc2IEwzNC4xNTk2LDE0OS41MTI1IEwzNC43MzYzLDE1OS40ODczIEwzNS41NzU5LDE2OS40NjIyIEwzNC44ODU2LDE3OS40MzcgTDM1LjA5MSwxODkuNDExOSBMMzQuOTU3NCwxOTkuMzg2NyBMMzUuMjM4LDIwOS4zNjE2IEwzNS4zMTg4LDIxOS4zMzY0IEwzNS43ODA5LDIyOS4zMTEzIEwzNS44OTQ3LDIzOS4yODYxIEwzNS45MDU3LDI0OS4yNjEgTDM1LjMzOTUsMjU5LjIzNTggTDM1LjYxODEsMjY5LjIxMDcgTDM1LjkzNjMsMjc5LjE4NTUgTDM0LjAzODQsMjg5LjE2MDQgTDM1LjkwNDcsMjk5LjEzNTMgTDM0LjYwNDcsMzA5LjExMDEgTDM1LjcxMTcsMzE5LjA4NSBMMzQuMzQsMzI5LjA1OTggTDM0LjkwODcsMzM5LjAzNDcgTDM1Ljk4ODgsMzQ5LjAwOTUgTDM1LDM1OC45ODQ0ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDAwMEZGO3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LjAsNS4wOyIvPjxwYXRoIGQ9Ik04MTUsMzkuNzg5MSBMODE1LjI4MDIsMzkuNzg5MSBMODE0LjQ0NzYsNDkuNzYzOSBMODE1LjI1NzcsNTkuNzM4OCBMODE1LjUzMjksNjkuNzEzNiBMODE0LjA0ODgsNzkuNjg4NSBMODE0Ljg5NjQsODkuNjYzMyBMODE0LjQzMTMsOTkuNjM4MiBMODE0LjQ4ODcsMTA5LjYxMyBMODE0LjkwOTEsMTE5LjU4NzkgTDgxNC4wNzgyLDEyOS41NjI3IEw4MTUuNzM4MiwxMzkuNTM3NiBMODE0LjE1OTYsMTQ5LjUxMjUgTDgxNC43MzYzLDE1OS40ODczIEw4MTUuNTc1OSwxNjkuNDYyMiBMODE0Ljg4NTYsMTc5LjQzNyBMODE1LjA5MSwxODkuNDExOSBMODE0Ljk1NzQsMTk5LjM4NjcgTDgxNS4yMzgsMjA5LjM2MTYgTDgxNS4zMTg4LDIxOS4zMzY0IEw4MTUuNzgwOSwyMjkuMzExMyBMODE1Ljg5NDcsMjM5LjI4NjEgTDgxNS45MDU3LDI0OS4yNjEgTDgxNS4zMzk1LDI1OS4yMzU4IEw4MTUuNjE4MSwyNjkuMjEwNyBMODE1LjkzNjMsMjc5LjE4NTUgTDgxNC4wMzg0LDI4OS4xNjA0IEw4MTUuOTA0NywyOTkuMTM1MyBMODE0LjYwNDcsMzA5LjExMDEgTDgxNS43MTE3LDMxOS4wODUgTDgxNC4zNCwzMjkuMDU5OCBMODE0LjkwODcsMzM5LjAzNDcgTDgxNS45ODg4LDM0OS4wMDk1IEw4MTUsMzU4Ljk4NDQgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMDAwRkY7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7Ii8+PHBvbHlnb24gZmlsbD0iIzFFOTBGRiIgcG9pbnRzPSI3LjUsNSw3LjUsNS4yMTAyLDE2LjY2NjcsNC41ODU3LDI1LjgzMzMsNS4xOTMzLDM1LDUuMzk5Nyw0NC4xNjY3LDQuMjg2Niw1My4zMzMzLDQuOTIyMyw2Mi41LDUsNjIuNDQ1Niw0Ljg2ODcsNjIuODA0Niw1LjAyODMsNjMuMTk4NCw1LjI3MTksNjMuNDcyNSw1LjIyNjQsNjMuOTg0OCw1Ljc1NjMsNjQuMjY3OCw1LjczMjIsNjQuMDczNyw1LjY1MTgsNjQuMzUzMyw2LjA2MDYsNjQuNjkzNyw2LjQ5NDQsNjQuNjgwNyw2Ljc4Miw2NC44NzQ2LDcuMTU1Miw2NSw3LjUsNjQuOTg5NCw3LjUsNjUuMDU5NSwxMy4yNTc4LDY1LjA3OTcsMTkuMDE1Niw2NS4xOTUyLDI0Ljc3MzQsNjUuMjIzNywzMC41MzEzLDY1LDM2LjI4OTEsNjUuMjA5MiwzNi4zNzU3LDY0LjkzMiwzNi42NzUxLDY0Ljg0OTksMzcuMDU1Myw2NC43NzY5LDM3LjQzOTMsNjQuMTkyMSwzNy42MTEzLDY0LjI2NzgsMzguMDU2OCw2NC4zNTQzLDM4LjI2NTgsNjMuODc2NCwzOC4xMTIsNjMuNjI4OCwzOC41MTQxLDYzLjE0NCwzOC4zNDM3LDYyLjg0NDgsMzguNjIxNSw2Mi41LDM4Ljc4OTEsNjIuNSwzOS41MzA3LDUzLjMzMzMsMzguNzQwMyw0NC4xNjY3LDM4Ljg5NDQsMzUsMzkuMTI3NywyNS44MzMzLDM5LjIwNTMsMTYuNjY2NywzOC43ODUyLDcuNSwzOC43ODkxLDcuNTM2NiwzOC44Nzc1LDcuMDczNCwzOC40NjYzLDYuODI5MiwzOC41ODM3LDYuNTA5MywzOC41MTg1LDYuMTQyNSwzOC4zNDAyLDUuNzMyMiwzOC4wNTY4LDUuOTIxLDM4LjEzNSw1LjQzNywzNy42NDE3LDUuMjM4NSwzNy4yNjY1LDUuMTAxNSwzNi45MTY5LDUuMTI4MywzNi42MzUxLDUsMzYuMjg5MSw0LjkzNDUsMzYuMjg5MSw1LjIyNzEsMzAuNTMxMyw0Ljk0MTgsMjQuNzczNCw0Ljg4NTYsMTkuMDE1Niw1LjA3NjEsMTMuMjU3OCw1LDcuNSw0Ljc5NDYsNy40MTQ5LDQuOTg2Niw3LjA4MDIsNS40OTI3LDYuODc1Nyw1LjU3MzUsNi40OTQ5LDUuODEyLDYuMTc5NSw1LjczMjIsNS43MzIyLDUuNjkxMiw1LjYzMzEsNi4xMjY1LDUuNjg0MSw2LjUxNDcsNS42MjEyLDYuNzMyNiw1LjE0NzQsNy4xMzQyLDUuMTE2OSw3LjUsNSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iI0E5RENERiIgZm9udC1mYW1pbHk9IkltcGFjdCIgZm9udC1zaXplPSIxNyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NiIgeD0iMTIiIHk9IjI3Ljc3OTgiPmNsaWVudDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9IjcuNSwzNTcuOTg0NCw3LjUsMzU4LjE5NDYsMTYuNjY2NywzNTcuNTcwMSwyNS44MzMzLDM1OC4xNzc3LDM1LDM1OC4zODQxLDQ0LjE2NjcsMzU3LjI3MSw1My4zMzMzLDM1Ny45MDY3LDYyLjUsMzU3Ljk4NDQsNjIuNDQ1NiwzNTcuODUzLDYyLjgwNDYsMzU4LjAxMjcsNjMuMTk4NCwzNTguMjU2Myw2My40NzI1LDM1OC4yMTA4LDYzLjk4NDgsMzU4Ljc0MDcsNjQuMjY3OCwzNTguNzE2Niw2NC4wNzM3LDM1OC42MzYyLDY0LjM1MzMsMzU5LjA0NDksNjQuNjkzNywzNTkuNDc4OCw2NC42ODA3LDM1OS43NjYzLDY0Ljg3NDYsMzYwLjEzOTUsNjUsMzYwLjQ4NDQsNjQuOTg5NCwzNjAuNDg0NCw2NS4wNTk1LDM2Ni4yNDIyLDY1LjA3OTcsMzcyLDY1LjE5NTIsMzc3Ljc1NzgsNjUuMjIzNywzODMuNTE1Niw2NSwzODkuMjczNCw2NS4yMDkyLDM4OS4zNjAxLDY0LjkzMiwzODkuNjU5NSw2NC44NDk5LDM5MC4wMzk3LDY0Ljc3NjksMzkwLjQyMzcsNjQuMTkyMSwzOTAuNTk1Nyw2NC4yNjc4LDM5MS4wNDEyLDY0LjM1NDMsMzkxLjI1MDIsNjMuODc2NCwzOTEuMDk2Myw2My42Mjg4LDM5MS40OTg1LDYzLjE0NCwzOTEuMzI4MSw2Mi44NDQ4LDM5MS42MDU5LDYyLjUsMzkxLjc3MzQsNjIuNSwzOTIuNTE1LDUzLjMzMzMsMzkxLjcyNDcsNDQuMTY2NywzOTEuODc4NywzNSwzOTIuMTEyMSwyNS44MzMzLDM5Mi4xODk3LDE2LjY2NjcsMzkxLjc2OTUsNy41LDM5MS43NzM0LDcuNTM2NiwzOTEuODYxOSw3LjA3MzQsMzkxLjQ1MDcsNi44MjkyLDM5MS41NjgxLDYuNTA5MywzOTEuNTAyOSw2LjE0MjUsMzkxLjMyNDUsNS43MzIyLDM5MS4wNDEyLDUuOTIxLDM5MS4xMTk0LDUuNDM3LDM5MC42MjYsNS4yMzg1LDM5MC4yNTA5LDUuMTAxNSwzODkuOTAxMyw1LjEyODMsMzg5LjYxOTUsNSwzODkuMjczNCw0LjkzNDUsMzg5LjI3MzQsNS4yMjcxLDM4My41MTU2LDQuOTQxOCwzNzcuNzU3OCw0Ljg4NTYsMzcyLDUuMDc2MSwzNjYuMjQyMiw1LDM2MC40ODQ0LDQuNzk0NiwzNjAuMzk5Myw0Ljk4NjYsMzYwLjA2NDYsNS40OTI3LDM1OS44Niw1LjU3MzUsMzU5LjQ3OTMsNS44MTIsMzU5LjE2MzksNS43MzIyLDM1OC43MTY2LDUuNjkxMiwzNTguNjE3NSw2LjEyNjUsMzU4LjY2ODUsNi41MTQ3LDM1OC42MDU1LDYuNzMyNiwzNTguMTMxOCw3LjEzNDIsMzU4LjEwMTMsNy41LDM1Ny45ODQ0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ2IiB4PSIxMiIgeT0iMzgwLjc2NDIiPmNsaWVudDwvdGV4dD48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9Ijc4NC41LDUsNzg0LjUsNS4yMTAyLDc5NC42NjY3LDQuNTg1Nyw4MDQuODMzMyw1LjE5MzMsODE1LDUuMzk5Nyw4MjUuMTY2Nyw0LjI4NjYsODM1LjMzMzMsNC45MjIzLDg0NS41LDUsODQ1LjQ0NTYsNC44Njg3LDg0NS44MDQ2LDUuMDI4Myw4NDYuMTk4NCw1LjI3MTksODQ2LjQ3MjUsNS4yMjY0LDg0Ni45ODQ4LDUuNzU2Myw4NDcuMjY3OCw1LjczMjIsODQ3LjA3MzcsNS42NTE4LDg0Ny4zNTMzLDYuMDYwNiw4NDcuNjkzNyw2LjQ5NDQsODQ3LjY4MDcsNi43ODIsODQ3Ljg3NDYsNy4xNTUyLDg0OCw3LjUsODQ3Ljk4OTQsNy41LDg0OC4wNTk1LDEzLjI1NzgsODQ4LjA3OTcsMTkuMDE1Niw4NDguMTk1MiwyNC43NzM0LDg0OC4yMjM3LDMwLjUzMTMsODQ4LDM2LjI4OTEsODQ4LjIwOTIsMzYuMzc1Nyw4NDcuOTMyLDM2LjY3NTEsODQ3Ljg0OTksMzcuMDU1Myw4NDcuNzc2OSwzNy40MzkzLDg0Ny4xOTIxLDM3LjYxMTMsODQ3LjI2NzgsMzguMDU2OCw4NDcuMzU0MywzOC4yNjU4LDg0Ni44NzY0LDM4LjExMiw4NDYuNjI4OCwzOC41MTQxLDg0Ni4xNDQsMzguMzQzNyw4NDUuODQ0OCwzOC42MjE1LDg0NS41LDM4Ljc4OTEsODQ1LjUsMzkuNTMwNyw4MzUuMzMzMywzOC43NDAzLDgyNS4xNjY3LDM4Ljg5NDQsODE1LDM5LjEyNzcsODA0LjgzMzMsMzkuMjA1Myw3OTQuNjY2NywzOC43ODUyLDc4NC41LDM4Ljc4OTEsNzg0LjUzNjYsMzguODc3NSw3ODQuMDczNCwzOC40NjYzLDc4My44MjkyLDM4LjU4MzcsNzgzLjUwOTMsMzguNTE4NSw3ODMuMTQyNSwzOC4zNDAyLDc4Mi43MzIyLDM4LjA1NjgsNzgyLjkyMSwzOC4xMzUsNzgyLjQzNywzNy42NDE3LDc4Mi4yMzg1LDM3LjI2NjUsNzgyLjEwMTUsMzYuOTE2OSw3ODIuMTI4MywzNi42MzUxLDc4MiwzNi4yODkxLDc4MS45MzQ1LDM2LjI4OTEsNzgyLjIyNzEsMzAuNTMxMyw3ODEuOTQxOCwyNC43NzM0LDc4MS44ODU2LDE5LjAxNTYsNzgyLjA3NjEsMTMuMjU3OCw3ODIsNy41LDc4MS43OTQ2LDcuNDE0OSw3ODEuOTg2Niw3LjA4MDIsNzgyLjQ5MjcsNi44NzU3LDc4Mi41NzM1LDYuNDk0OSw3ODIuODEyLDYuMTc5NSw3ODIuNzMyMiw1LjczMjIsNzgyLjY5MTIsNS42MzMxLDc4My4xMjY1LDUuNjg0MSw3ODMuNTE0Nyw1LjYyMTIsNzgzLjczMjYsNS4xNDc0LDc4NC4xMzQyLDUuMTE2OSw3ODQuNSw1IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyIiB4PSI3ODkiIHk9IjI3Ljc3OTgiPnNlcnZlcjwvdGV4dD48cG9seWdvbiBmaWxsPSIjMUU5MEZGIiBwb2ludHM9Ijc4NC41LDM1Ny45ODQ0LDc4NC41LDM1OC4xOTQ2LDc5NC42NjY3LDM1Ny41NzAxLDgwNC44MzMzLDM1OC4xNzc3LDgxNSwzNTguMzg0MSw4MjUuMTY2NywzNTcuMjcxLDgzNS4zMzMzLDM1Ny45MDY3LDg0NS41LDM1Ny45ODQ0LDg0NS40NDU2LDM1Ny44NTMsODQ1LjgwNDYsMzU4LjAxMjcsODQ2LjE5ODQsMzU4LjI1NjMsODQ2LjQ3MjUsMzU4LjIxMDgsODQ2Ljk4NDgsMzU4Ljc0MDcsODQ3LjI2NzgsMzU4LjcxNjYsODQ3LjA3MzcsMzU4LjYzNjIsODQ3LjM1MzMsMzU5LjA0NDksODQ3LjY5MzcsMzU5LjQ3ODgsODQ3LjY4MDcsMzU5Ljc2NjMsODQ3Ljg3NDYsMzYwLjEzOTUsODQ4LDM2MC40ODQ0LDg0Ny45ODk0LDM2MC40ODQ0LDg0OC4wNTk1LDM2Ni4yNDIyLDg0OC4wNzk3LDM3Miw4NDguMTk1MiwzNzcuNzU3OCw4NDguMjIzNywzODMuNTE1Niw4NDgsMzg5LjI3MzQsODQ4LjIwOTIsMzg5LjM2MDEsODQ3LjkzMiwzODkuNjU5NSw4NDcuODQ5OSwzOTAuMDM5Nyw4NDcuNzc2OSwzOTAuNDIzNyw4NDcuMTkyMSwzOTAuNTk1Nyw4NDcuMjY3OCwzOTEuMDQxMiw4NDcuMzU0MywzOTEuMjUwMiw4NDYuODc2NCwzOTEuMDk2Myw4NDYuNjI4OCwzOTEuNDk4NSw4NDYuMTQ0LDM5MS4zMjgxLDg0NS44NDQ4LDM5MS42MDU5LDg0NS41LDM5MS43NzM0LDg0NS41LDM5Mi41MTUsODM1LjMzMzMsMzkxLjcyNDcsODI1LjE2NjcsMzkxLjg3ODcsODE1LDM5Mi4xMTIxLDgwNC44MzMzLDM5Mi4xODk3LDc5NC42NjY3LDM5MS43Njk1LDc4NC41LDM5MS43NzM0LDc4NC41MzY2LDM5MS44NjE5LDc4NC4wNzM0LDM5MS40NTA3LDc4My44MjkyLDM5MS41NjgxLDc4My41MDkzLDM5MS41MDI5LDc4My4xNDI1LDM5MS4zMjQ1LDc4Mi43MzIyLDM5MS4wNDEyLDc4Mi45MjEsMzkxLjExOTQsNzgyLjQzNywzOTAuNjI2LDc4Mi4yMzg1LDM5MC4yNTA5LDc4Mi4xMDE1LDM4OS45MDEzLDc4Mi4xMjgzLDM4OS42MTk1LDc4MiwzODkuMjczNCw3ODEuOTM0NSwzODkuMjczNCw3ODIuMjI3MSwzODMuNTE1Niw3ODEuOTQxOCwzNzcuNzU3OCw3ODEuODg1NiwzNzIsNzgyLjA3NjEsMzY2LjI0MjIsNzgyLDM2MC40ODQ0LDc4MS43OTQ2LDM2MC4zOTkzLDc4MS45ODY2LDM2MC4wNjQ2LDc4Mi40OTI3LDM1OS44Niw3ODIuNTczNSwzNTkuNDc5Myw3ODIuODEyLDM1OS4xNjM5LDc4Mi43MzIyLDM1OC43MTY2LDc4Mi42OTEyLDM1OC42MTc1LDc4My4xMjY1LDM1OC42Njg1LDc4My41MTQ3LDM1OC42MDU1LDc4My43MzI2LDM1OC4xMzE4LDc4NC4xMzQyLDM1OC4xMDEzLDc4NC41LDM1Ny45ODQ0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjQTlEQ0RGIiBmb250LWZhbWlseT0iSW1wYWN0IiBmb250LXNpemU9IjE3IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyIiB4PSI3ODkiIHk9IjM4MC43NjQyIj5zZXJ2ZXI8L3RleHQ+PHBvbHlnb24gZmlsbD0iIzAwQkZGRiIgcG9pbnRzPSI4MDMsNjYuOTIxOSw4MDMuMDI2LDY2Ljk4NjksODA0Ljk0ODcsNjcuNTkzNiw4MDcuMDIzOSw2OC41ODE3LDgwOS4wNDk1LDY5LjQ0NTYsODEwLjkxMTcsNjkuOTAxMSw4MTMsNzAuOTIxOSw4MTIuOTkwNCw3MC44OTc4LDgxMC45NDcyLDcxLjU4OTksODA4Ljk1MjUsNzIuNDAzMiw4MDYuOTkxNiw3My4zMDA4LDgwNC45MTQ0LDczLjkwNzksODAzLDc0LjkyMTksODAzLjEzMDUsNzUuMDUyNCw4MDMuNjUxNCw3My45NzMzLDgwNC41NTM0LDczLjI3NTMsODA1LjUwMTgsNzIuNjIzNyw4MDYuMTc5OCw3MS43MDE3LDgwNyw3MC45MjE5LDgwNy4wMTYxLDcwLjkzOCw4MDYuMTkyNSw3MC4xMTQzLDgwNS40NDIxLDY5LjM2NCw4MDQuNjU2NCw2OC41NzgyLDgwMy45MzgsNjcuODU5OSw4MDMsNjYuOTIxOSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBhdGggZD0iTTM1LDcwLjkyMTkgTDM1LDcxLjIwMjEgTDQ1LjA1MTksNzAuMzY5NCBMNTUuMTAzOSw3MS4xNzk2IEw2NS4xNTU4LDcxLjQ1NDggTDc1LjIwNzgsNjkuOTcwNyBMODUuMjU5Nyw3MC44MTgzIEw5NS4zMTE3LDcwLjM1MzIgTDEwNS4zNjM2LDcwLjQxMDUgTDExNS40MTU2LDcwLjgzMSBMMTI1LjQ2NzUsNzAgTDEzNS41MTk1LDcxLjY2MDEgTDE0NS41NzE0LDcwLjA4MTUgTDE1NS42MjM0LDcwLjY1ODIgTDE2NS42NzUzLDcxLjQ5NzggTDE3NS43MjczLDcwLjgwNzUgTDE4NS43NzkyLDcxLjAxMjkgTDE5NS44MzEyLDcwLjg3OTMgTDIwNS44ODMxLDcxLjE1OTkgTDIxNS45MzUxLDcxLjI0MDcgTDIyNS45ODcsNzEuNzAyOCBMMjM2LjAzOSw3MS44MTY2IEwyNDYuMDkwOSw3MS44Mjc2IEwyNTYuMTQyOSw3MS4yNjE0IEwyNjYuMTk0OCw3MS41NCBMMjc2LjI0NjgsNzEuODU4MiBMMjg2LjI5ODcsNjkuOTYwMyBMMjk2LjM1MDYsNzEuODI2NiBMMzA2LjQwMjYsNzAuNTI2NSBMMzE2LjQ1NDUsNzEuNjMzNiBMMzI2LjUwNjUsNzAuMjYxOCBMMzM2LjU1ODQsNzAuODMwNSBMMzQ2LjYxMDQsNzEuOTEwNyBMMzU2LjY2MjMsNzAuODU2OSBMMzY2LjcxNDMsNzEuMDYyMyBMMzc2Ljc2NjIsNzEuMzczNCBMMzg2LjgxODIsNzEuNDc2OSBMMzk2Ljg3MDEsNzAuOTE2NyBMNDA2LjkyMjEsNzEuMzA0OCBMNDE2Ljk3NCw3MC4xNTg3IEw0MjcuMDI2LDcxLjMwMTEgTDQzNy4wNzc5LDcxLjY1MjggTDQ0Ny4xMjk5LDcxLjUxNDYgTDQ1Ny4xODE4LDcxLjczOTIgTDQ2Ny4yMzM4LDcwLjI3NzggTDQ3Ny4yODU3LDcwLjA1MjMgTDQ4Ny4zMzc3LDcwLjA5MzMgTDQ5Ny4zODk2LDcwLjg0MzQgTDUwNy40NDE2LDcwLjY1OTggTDUxNy40OTM1LDcxLjgzMDQgTDUyNy41NDU1LDcwLjY4OSBMNTM3LjU5NzQsNzAuNDY0NSBMNTQ3LjY0OTQsNzEuMjI2MiBMNTU3LjcwMTMsNzAuMDMyOCBMNTY3Ljc1MzIsNzAuMjI5NyBMNTc3LjgwNTIsNzEuNzg3MSBMNTg3Ljg1NzEsNzEuNTAyOCBMNTk3LjkwOTEsNzEuOTAxMiBMNjA3Ljk2MSw3MC40OTI4IEw2MTguMDEzLDcxLjM0NzUgTDYyOC4wNjQ5LDcxLjcwOTEgTDYzOC4xMTY5LDcwLjI5MiBMNjQ4LjE2ODgsNzAuNzk0MSBMNjU4LjIyMDgsNzEuMDg5OSBMNjY4LjI3MjcsNzEuNzkwOSBMNjc4LjMyNDcsNzAuOTE2MyBMNjg4LjM3NjYsNzEuNTM4NiBMNjk4LjQyODYsNzAuMTgzNSBMNzA4LjQ4MDUsNzAuMDE4OSBMNzE4LjUzMjUsNzEuNTkzNCBMNzI4LjU4NDQsNjkuOTY2IEw3MzguNjM2NCw3MS42MDA1IEw3NDguNjg4Myw3MS4xOTc0IEw3NTguNzQwMyw3MC41NjQ3IEw3NjguNzkyMiw3MC40NTAyIEw3NzguODQ0Miw3MS41MzM2IEw3ODguODk2MSw3MC41MjI4IEw3OTguOTQ4MSw3MS43MTEgTDgwOSw3MC45MjE5ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTYiIHg9IjQyIiB5PSI2NS44NTYiPnNheSBoZWxsbzwvdGV4dD48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9IjQ2LDk2LjA1NDcsNDYuMDI2LDk2LjExOTcsNDMuOTQ4Nyw5Ni43MjY1LDQyLjAyMzksOTcuNzE0NSw0MC4wNDk1LDk4LjU3ODQsMzcuOTExNyw5OS4wMzM5LDM2LDEwMC4wNTQ3LDM1Ljk5MDQsMTAwLjAzMDYsMzcuOTQ3MiwxMDAuNzIyNywzOS45NTI1LDEwMS41MzYsNDEuOTkxNiwxMDIuNDMzNiw0My45MTQ0LDEwMy4wNDA3LDQ2LDEwNC4wNTQ3LDQ2LjEzMDUsMTA0LjE4NTIsNDUuMDUxNCwxMDMuMTA2MSw0NC4zNTM0LDEwMi40MDgxLDQzLjcwMTgsMTAxLjc1NjUsNDIuNzc5OCwxMDAuODM0NSw0MiwxMDAuMDU0Nyw0Mi4wMTYxLDEwMC4wNzA4LDQyLjc5MjUsOTkuMjQ3Miw0My42NDIxLDk4LjQ5NjgsNDQuNDU2NCw5Ny43MTExLDQ1LjMzOCw5Ni45OTI3LDQ2LDk2LjA1NDciIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik00MCwxMDAuMDU0NyBMNDAsMTAwLjMzNDkgTDUwLjA1MTksOTkuNTAyMyBMNjAuMTAzOSwxMDAuMzEyNCBMNzAuMTU1OCwxMDAuNTg3NiBMODAuMjA3OCw5OS4xMDM1IEw5MC4yNTk3LDk5Ljk1MTEgTDEwMC4zMTE3LDk5LjQ4NiBMMTEwLjM2MzYsOTkuNTQzNCBMMTIwLjQxNTYsOTkuOTYzOCBMMTMwLjQ2NzUsOTkuMTMyOSBMMTQwLjUxOTUsMTAwLjc5MjkgTDE1MC41NzE0LDk5LjIxNDMgTDE2MC42MjM0LDk5Ljc5MSBMMTcwLjY3NTMsMTAwLjYzMDYgTDE4MC43MjczLDk5Ljk0MDMgTDE5MC43NzkyLDEwMC4xNDU3IEwyMDAuODMxMiwxMDAuMDEyMSBMMjEwLjg4MzEsMTAwLjI5MjcgTDIyMC45MzUxLDEwMC4zNzM1IEwyMzAuOTg3LDEwMC44MzU2IEwyNDEuMDM5LDEwMC45NDk0IEwyNTEuMDkwOSwxMDAuOTYwNCBMMjYxLjE0MjksMTAwLjM5NDIgTDI3MS4xOTQ4LDEwMC42NzI4IEwyODEuMjQ2OCwxMDAuOTkxIEwyOTEuMjk4Nyw5OS4wOTMxIEwzMDEuMzUwNiwxMDAuOTU5NCBMMzExLjQwMjYsOTkuNjU5MyBMMzIxLjQ1NDUsMTAwLjc2NjQgTDMzMS41MDY1LDk5LjM5NDcgTDM0MS41NTg0LDk5Ljk2MzQgTDM1MS42MTA0LDEwMS4wNDM1IEwzNjEuNjYyMyw5OS45ODk3IEwzNzEuNzE0MywxMDAuMTk1MSBMMzgxLjc2NjIsMTAwLjUwNjIgTDM5MS44MTgyLDEwMC42MDk3IEw0MDEuODcwMSwxMDAuMDQ5NSBMNDExLjkyMjEsMTAwLjQzNzYgTDQyMS45NzQsOTkuMjkxNSBMNDMyLjAyNiwxMDAuNDMzOSBMNDQyLjA3NzksMTAwLjc4NTYgTDQ1Mi4xMjk5LDEwMC42NDc0IEw0NjIuMTgxOCwxMDAuODcyMSBMNDcyLjIzMzgsOTkuNDEwNiBMNDgyLjI4NTcsOTkuMTg1MSBMNDkyLjMzNzcsOTkuMjI2MiBMNTAyLjM4OTYsOTkuOTc2MiBMNTEyLjQ0MTYsOTkuNzkyNiBMNTIyLjQ5MzUsMTAwLjk2MzIgTDUzMi41NDU1LDk5LjgyMTggTDU0Mi41OTc0LDk5LjU5NzMgTDU1Mi42NDk0LDEwMC4zNTkgTDU2Mi43MDEzLDk5LjE2NTYgTDU3Mi43NTMyLDk5LjM2MjUgTDU4Mi44MDUyLDEwMC45MiBMNTkyLjg1NzEsMTAwLjYzNTYgTDYwMi45MDkxLDEwMS4wMzQgTDYxMi45NjEsOTkuNjI1NiBMNjIzLjAxMywxMDAuNDgwMyBMNjMzLjA2NDksMTAwLjg0MTkgTDY0My4xMTY5LDk5LjQyNDggTDY1My4xNjg4LDk5LjkyNjkgTDY2My4yMjA4LDEwMC4yMjI3IEw2NzMuMjcyNywxMDAuOTIzNyBMNjgzLjMyNDcsMTAwLjA0OTEgTDY5My4zNzY2LDEwMC42NzE0IEw3MDMuNDI4Niw5OS4zMTYzIEw3MTMuNDgwNSw5OS4xNTE3IEw3MjMuNTMyNSwxMDAuNzI2MiBMNzMzLjU4NDQsOTkuMDk4OCBMNzQzLjYzNjQsMTAwLjczMzMgTDc1My42ODgzLDEwMC4zMzAyIEw3NjMuNzQwMyw5OS42OTc1IEw3NzMuNzkyMiw5OS41ODMgTDc4My44NDQyLDEwMC42NjY0IEw3OTMuODk2MSw5OS42NTU2IEw4MDMuOTQ4MSwxMDAuODQzOCBMODE0LDEwMC4wNTQ3ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0IiB4PSI1MiIgeT0iOTQuOTg4OCI+JiMyMTQ1NzsmIzM2ODY1OyYjMTIzMDA7JiMzMTQ0OTsmIzI4ODU3OyYjMzU3Nzc7JiMyMDA3MDsmIzEyMzAxOzwvdGV4dD48cGF0aCBkPSJNMzUsMTI5LjE4NzUgTDM1LDEyOS4yODA5IEw0My40LDEyOS4wMDM0IEw1MS44LDEyOS4yNzM0IEw2MC4yLDEyOS4zNjUxIEw2OC42LDEyOC44NzA0IEw3NywxMjkuMTg3NSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik03NywxMjkuMTg3NSBMNzcuMDkzNCwxMjkuMTg3NSBMNzYuODE1OSwxMzEuNzg3NSBMNzcuMDg1OSwxMzQuMzg3NSBMNzcuMTc3NiwxMzYuOTg3NSBMNzYuNjgyOSwxMzkuNTg3NSBMNzcsMTQyLjE4NzUgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cGF0aCBkPSJNMzYsMTQyLjE4NzUgTDM2LDE0Mi4yODA5IEw0NC4yLDE0Mi4wMDM0IEw1Mi40LDE0Mi4yNzM0IEw2MC42LDE0Mi4zNjUxIEw2OC44LDE0MS44NzA0IEw3NywxNDIuMTg3NSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMwMEJGRkYiIHBvaW50cz0iNDYsMTM4LjE4NzUsNDYuMDI2LDEzOC4yNTI1LDQzLjk0ODcsMTM4Ljg1OTMsNDIuMDIzOSwxMzkuODQ3Myw0MC4wNDk1LDE0MC43MTEyLDM3LjkxMTcsMTQxLjE2NjcsMzYsMTQyLjE4NzUsMzUuOTkwNCwxNDIuMTYzNCwzNy45NDcyLDE0Mi44NTU1LDM5Ljk1MjUsMTQzLjY2ODgsNDEuOTkxNiwxNDQuNTY2NCw0My45MTQ0LDE0NS4xNzM1LDQ2LDE0Ni4xODc1LDQ2LjEzMDUsMTQ2LjMxOCw0NS4wNTE0LDE0NS4yMzg5LDQ0LjM1MzQsMTQ0LjU0MDksNDMuNzAxOCwxNDMuODg5Myw0Mi43Nzk4LDE0Mi45NjczLDQyLDE0Mi4xODc1LDQyLjAxNjEsMTQyLjIwMzYsNDIuNzkyNSwxNDEuMzgsNDMuNjQyMSwxNDAuNjI5Niw0NC40NTY0LDEzOS44NDM5LDQ1LjMzOCwxMzkuMTI1NSw0NiwxMzguMTg3NSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzUxIiB4PSI0MiIgeT0iMTI0LjEyMTYiPiYjMjY2ODE7JiMyNTQ1NDsmIzEyMzAwOyYjMzE0NDk7JiMyODg1NzsmIzM1Nzc3OyYjMjAwNzA7JiMxMjMwMTsmIzIwMDEzOyYjMzAzNDA7JiMxOTk3OTsmIzM2NzMzOyYjMzgxNDI7JiMyNTUwOTsmIzY1MjkyOyYjMTk5Nzk7JiMzNjczMzsmIzEyMzAwO0ludGVybWVkaWF0ZSBDQSYjMTIzMDE7PC90ZXh0PjxwYXRoIGQ9Ik0zNSwxODYuNDUzMSBMMzUsMTg2LjU0NjUgTDQzLjQsMTg2LjI2OSBMNTEuOCwxODYuNTM5IEw2MC4yLDE4Ni42MzA4IEw2OC42LDE4Ni4xMzYxIEw3NywxODYuNDUzMSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik03NywxODYuNDUzMSBMNzcuMDkzNCwxODYuNDUzMSBMNzYuODE1OSwxODkuMDUzMSBMNzcuMDg1OSwxOTEuNjUzMSBMNzcuMTc3NiwxOTQuMjUzMSBMNzYuNjgyOSwxOTYuODUzMSBMNzcsMTk5LjQ1MzEgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cGF0aCBkPSJNMzYsMTk5LjQ1MzEgTDM2LDE5OS41NDY1IEw0NC4yLDE5OS4yNjkgTDUyLjQsMTk5LjUzOSBMNjAuNiwxOTkuNjMwOCBMNjguOCwxOTkuMTM2MSBMNzcsMTk5LjQ1MzEgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9IjQ2LDE5NS40NTMxLDQ2LjAyNiwxOTUuNTE4Miw0My45NDg3LDE5Ni4xMjQ5LDQyLjAyMzksMTk3LjExMjksNDAuMDQ5NSwxOTcuOTc2OCwzNy45MTE3LDE5OC40MzIzLDM2LDE5OS40NTMxLDM1Ljk5MDQsMTk5LjQyOTEsMzcuOTQ3MiwyMDAuMTIxMSwzOS45NTI1LDIwMC45MzQ0LDQxLjk5MTYsMjAxLjgzMiw0My45MTQ0LDIwMi40MzkyLDQ2LDIwMy40NTMxLDQ2LjEzMDUsMjAzLjU4MzYsNDUuMDUxNCwyMDIuNTA0Niw0NC4zNTM0LDIwMS44MDY1LDQzLjcwMTgsMjAxLjE1NDksNDIuNzc5OCwyMDAuMjMyOSw0MiwxOTkuNDUzMSw0Mi4wMTYxLDE5OS40NjkyLDQyLjc5MjUsMTk4LjY0NTYsNDMuNjQyMSwxOTcuODk1Miw0NC40NTY0LDE5Ny4xMDk1LDQ1LjMzOCwxOTYuMzkxMiw0NiwxOTUuNDUzMSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjk5IiB4PSI0MiIgeT0iMTY2LjI1NDQiPiYjMjk5OTI7JiMxMjMwMDtJbnRlcm1lZGlhdGUgQ0EmIzEyMzAxOyYjMjY2NTc7JiMzOTU2NDsmIzEyMzAwOyYjMzE0NDk7JiMyODg1NzsmIzM1Nzc3OyYjMjAwNzA7JiMxMjMwMTsmIzMwMzQwOyYjMjE1MTI7JiMyNzg2MTsmIzI0NjE1OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3MTUiIHg9IjQyIiB5PSIxODEuMzg3MiI+JiMzNTc0NTsmIzMxNjM5OyYjMTIzMDA7JiMzMTQ0OTsmIzI4ODU3OyYjMzU3Nzc7JiMyMDA3MDsmIzEyMzAxOyYjMzAzNDA7JiMyNTY4ODsmIzM1MjAxOyYjNjUyOTI7JiMyOTk5MjsmIzEyMzAwO0ludGVybWVkaWF0ZSBDQSYjMTIzMDE7JiMzMDM0MDsmIzIwODQ0OyYjMzgwNTM7JiMzNTI5OTsmIzMwNzIxOyYjMTIzMDA7JiMzMTQ0OTsmIzI4ODU3OyYjMzU3Nzc7JiMyMDA3MDsmIzEyMzAxOyYjMjAwMTM7JiMzMDM0MDsmIzI1OTY4OyYjMjMzODM7JiMzMTYxNDsmIzIxNTE3OyYjMjQ0NzE7JiMyMTA0MDsmIzI1Njg4OyYjMzUyMDE7JiM2NTI5MjsmIzIzNTQ1OyYjMjc2MDQ7JiMyMDAwNDsmIzIwMDEwOyYjMjU2ODg7JiMzNTIwMTsmIzI2MTU5OyYjMjE1NDI7JiMzMDQ1NjsmIzIxNTE2OzwvdGV4dD48cGF0aCBkPSJNMzUsMjI4LjU4NTkgTDM1LDIyOC42Nzk0IEw0My40LDIyOC40MDE4IEw1MS44LDIyOC42NzE4IEw2MC4yLDIyOC43NjM2IEw2OC42LDIyOC4yNjg5IEw3NywyMjguNTg1OSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik03NywyMjguNTg1OSBMNzcuMDkzNCwyMjguNTg1OSBMNzYuODE1OSwyMzEuMTg1OSBMNzcuMDg1OSwyMzMuNzg1OSBMNzcuMTc3NiwyMzYuMzg1OSBMNzYuNjgyOSwyMzguOTg1OSBMNzcsMjQxLjU4NTkgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cGF0aCBkPSJNMzYsMjQxLjU4NTkgTDM2LDI0MS42Nzk0IEw0NC4yLDI0MS40MDE4IEw1Mi40LDI0MS42NzE4IEw2MC42LDI0MS43NjM2IEw2OC44LDI0MS4yNjg5IEw3NywyNDEuNTg1OSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMwMEJGRkYiIHBvaW50cz0iNDYsMjM3LjU4NTksNDYuMDI2LDIzNy42NTEsNDMuOTQ4NywyMzguMjU3Nyw0Mi4wMjM5LDIzOS4yNDU4LDQwLjA0OTUsMjQwLjEwOTYsMzcuOTExNywyNDAuNTY1MSwzNiwyNDEuNTg1OSwzNS45OTA0LDI0MS41NjE5LDM3Ljk0NzIsMjQyLjI1MzksMzkuOTUyNSwyNDMuMDY3Miw0MS45OTE2LDI0My45NjQ4LDQzLjkxNDQsMjQ0LjU3Miw0NiwyNDUuNTg1OSw0Ni4xMzA1LDI0NS43MTY0LDQ1LjA1MTQsMjQ0LjYzNzQsNDQuMzUzNCwyNDMuOTM5Myw0My43MDE4LDI0My4yODc3LDQyLjc3OTgsMjQyLjM2NTcsNDIsMjQxLjU4NTksNDIuMDE2MSwyNDEuNjAyLDQyLjc5MjUsMjQwLjc3ODQsNDMuNjQyMSwyNDAuMDI4LDQ0LjQ1NjQsMjM5LjI0MjMsNDUuMzM4LDIzOC41MjQsNDYsMjM3LjU4NTkiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM1MCIgeD0iNDIiIHk9IjIyMy41MiI+JiMyNjY4MTsmIzI1NDU0OyYjMTIzMDA7SW50ZXJtZWRpYXRlIENBJiMxMjMwMTsmIzIwMDEzOyYjMzAzNDA7JiMxOTk3OTsmIzM2NzMzOyYjMzgxNDI7JiMyNTUwOTsmIzY1MjkyOyYjMTk5Nzk7JiMzNjczMzsmIzEyMzAwO1Jvb3QgQ0EmIzEyMzAxOzwvdGV4dD48cGF0aCBkPSJNMzUsMjg1Ljg1MTYgTDM1LDI4NS45NDUgTDQzLjQsMjg1LjY2NzQgTDUxLjgsMjg1LjkzNzUgTDYwLjIsMjg2LjAyOTIgTDY4LjYsMjg1LjUzNDUgTDc3LDI4NS44NTE2ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBhdGggZD0iTTc3LDI4NS44NTE2IEw3Ny4wOTM0LDI4NS44NTE2IEw3Ni44MTU5LDI4OC40NTE2IEw3Ny4wODU5LDI5MS4wNTE2IEw3Ny4xNzc2LDI5My42NTE2IEw3Ni42ODI5LDI5Ni4yNTE2IEw3NywyOTguODUxNiAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik0zNiwyOTguODUxNiBMMzYsMjk4Ljk0NSBMNDQuMiwyOTguNjY3NCBMNTIuNCwyOTguOTM3NSBMNjAuNiwyOTkuMDI5MiBMNjguOCwyOTguNTM0NSBMNzcsMjk4Ljg1MTYgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMDBCRkZGIiBwb2ludHM9IjQ2LDI5NC44NTE2LDQ2LjAyNiwyOTQuOTE2Niw0My45NDg3LDI5NS41MjMzLDQyLjAyMzksMjk2LjUxMTQsNDAuMDQ5NSwyOTcuMzc1MywzNy45MTE3LDI5Ny44MzA4LDM2LDI5OC44NTE2LDM1Ljk5MDQsMjk4LjgyNzUsMzcuOTQ3MiwyOTkuNTE5NiwzOS45NTI1LDMwMC4zMzI5LDQxLjk5MTYsMzAxLjIzMDUsNDMuOTE0NCwzMDEuODM3Niw0NiwzMDIuODUxNiw0Ni4xMzA1LDMwMi45ODIxLDQ1LjA1MTQsMzAxLjkwMyw0NC4zNTM0LDMwMS4yMDQ5LDQzLjcwMTgsMzAwLjU1MzQsNDIuNzc5OCwyOTkuNjMxMyw0MiwyOTguODUxNiw0Mi4wMTYxLDI5OC44Njc2LDQyLjc5MjUsMjk4LjA0NCw0My42NDIxLDI5Ny4yOTM2LDQ0LjQ1NjQsMjk2LjUwNzksNDUuMzM4LDI5NS43ODk2LDQ2LDI5NC44NTE2IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOTgiIHg9IjQyIiB5PSIyNjUuNjUyOCI+JiMyOTk5MjsmIzEyMzAwO1Jvb3QgQ0EmIzEyMzAxOyYjMjY2NTc7JiMzOTU2NDsmIzEyMzAwO0ludGVybWVkaWF0ZSBDQSYjMTIzMDE7JiMzMDM0MDsmIzIxNTEyOyYjMjc4NjE7JiMyNDYxNTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzY2IiB4PSI0MiIgeT0iMjgwLjc4NTYiPiYjMzU3NDU7JiMzMTYzOTsmIzEyMzAwO0ludGVybWVkaWF0ZSBDQSYjMTIzMDE7JiMzMDM0MDsmIzI1Njg4OyYjMzUyMDE7JiM2NTI5MjsmIzI5OTkyOyYjMTIzMDA7Um9vdCBDQSYjMTIzMDE7JiMzMDM0MDsmIzIwODQ0OyYjMzgwNTM7JiMzNTI5OTsmIzMwNzIxOyYjMTIzMDA7SW50ZXJtZWRpYXRlIENBJiMxMjMwMTsmIzIwMDEzOyYjMzAzNDA7JiMyNTk2ODsmIzIzMzgzOyYjMzE2MTQ7JiMyMTUxNzsmIzI0NDcxOyYjMjEwNDA7JiMyNTY4ODsmIzM1MjAxOyYjNjUyOTI7JiMyMzU0NTsmIzI3NjA0OyYjMjAwMDQ7JiMyMDAxMDsmIzI1Njg4OyYjMzUyMDE7JiMyNjE1OTsmIzIxNTQyOyYjMzA0NTY7JiMyMTUxNjs8L3RleHQ+PHBhdGggZD0iTTM1LDMyNy45ODQ0IEwzNSwzMjguMDc3OCBMNDMuNCwzMjcuODAwMiBMNTEuOCwzMjguMDcwMyBMNjAuMiwzMjguMTYyIEw2OC42LDMyNy42NjczIEw3NywzMjcuOTg0NCAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwQkZGRjtzdHJva2Utd2lkdGg6MS4wOyIvPjxwYXRoIGQ9Ik03NywzMjcuOTg0NCBMNzcuMDkzNCwzMjcuOTg0NCBMNzYuODE1OSwzMzAuNTg0NCBMNzcuMDg1OSwzMzMuMTg0NCBMNzcuMTc3NiwzMzUuNzg0NCBMNzYuNjgyOSwzMzguMzg0NCBMNzcsMzQwLjk4NDQgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cGF0aCBkPSJNMzYsMzQwLjk4NDQgTDM2LDM0MS4wNzc4IEw0NC4yLDM0MC44MDAyIEw1Mi40LDM0MS4wNzAzIEw2MC42LDM0MS4xNjIgTDY4LjgsMzQwLjY2NzMgTDc3LDM0MC45ODQ0ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDBCRkZGO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzAwQkZGRiIgcG9pbnRzPSI0NiwzMzYuOTg0NCw0Ni4wMjYsMzM3LjA0OTQsNDMuOTQ4NywzMzcuNjU2MSw0Mi4wMjM5LDMzOC42NDQyLDQwLjA0OTUsMzM5LjUwODEsMzcuOTExNywzMzkuOTYzNiwzNiwzNDAuOTg0NCwzNS45OTA0LDM0MC45NjAzLDM3Ljk0NzIsMzQxLjY1MjQsMzkuOTUyNSwzNDIuNDY1Nyw0MS45OTE2LDM0My4zNjMzLDQzLjkxNDQsMzQzLjk3MDQsNDYsMzQ0Ljk4NDQsNDYuMTMwNSwzNDUuMTE0OSw0NS4wNTE0LDM0NC4wMzU4LDQ0LjM1MzQsMzQzLjMzNzgsNDMuNzAxOCwzNDIuNjg2Miw0Mi43Nzk4LDM0MS43NjQyLDQyLDM0MC45ODQ0LDQyLjAxNjEsMzQxLjAwMDUsNDIuNzkyNSwzNDAuMTc2OCw0My42NDIxLDMzOS40MjY1LDQ0LjQ1NjQsMzM4LjY0MDcsNDUuMzM4LDMzNy45MjI0LDQ2LDMzNi45ODQ0IiBzdHlsZT0ic3Ryb2tlOiMwMEJGRkY7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyODUiIHg9IjQyIiB5PSIzMjIuOTE4NSI+JiMyNjY1NzsmIzM5NTY0OyYjMTIzMDA7Um9vdCBDQSYjMTIzMDE7JiMyNjE1OTsmIzIxNTQyOyYjMjIzMTI7JiMyNjQxMjsmIzI2NDI2OyYjMzAzNDA7JiMyMTQ4NzsmIzIwNDQ5OyYjMjY2ODE7JiMzNTc3NzsmIzIwMDcwOyYjMjEwMTU7JiMzNDkyMDsmIzIwMDEzOzwvdGV4dD48IS0tU1JDPVtoUDcxUmpEMDU0Tk55TFVDbjllNUFxR05JNHdTSWZLZ1hFWU1wVEgtajVRUzZOU29lSEk0YjIyRzhmN0c1NWdiRzFROWU2YktjaFdJY21KSHkzN3JaOXFMbHUxSmJ5SURkUjlYd1ZVRXh4bHRKWTVkNFhpcGQ0VmhNQ3pqQzVlYUhlUFFiQTVSc01tc2hNTUttZkpPbkNKT1BZUmRHMTFkSEwwWWttOWk1TzdlVzV1ZUFQS25rWHNBUTAzc01jdWRSR0xxSWpLdlBNZEEzNjA5c3JOcDJRb1ExQUIwLWxORGw0RnJkZlJIYmZNS2FkZzg2SlRycXlRNEJwbUdQVVFLRDZmaTA4alhvdkptMXBXRlEyTGxPdnQ3VGNsY1NxMXR4aVJjQ05qWHloY1pVQWs4aHJRcGQtQTVOSmlxZExwUUtoNERwdklOWWc5UjlYMkVSanlGdGU0ejFSUTQyZFc3Uk85YktJTVNKN09Yak9KNHhqd3VMQnVlTFJybDd4ck5Henlma3lGRUhRYU1hVmNCb2pQR3JsZm5yMXRxbDQtbHRTNVJfX255XzY0YXRudHpfYmFERm1EdVhOMVdVSjFDcDA1YnI2SGZSeC1SWUNmTVV0bklaUHlDeGVid0hOdV9hQU5abnlKbGp4ci04djZJVXVULWZucHVNTkhYZWxKY1RGcC1vM18tdWhOQVl6QjlXcEZIUXRZemFRWk5uQVdYQWNUSlBVNENmUkZsM2h3d1d2RG1BMHlUS1V6dWRtVVlOaHNmbnhZUmN3anlIMmRfSHVLcFA1ZlRTa1E0elhCMWtHOWQtbDdZNWlOdmx6clRmT2U0bFZuM0RCa29VSWdSRm9RLVRYdHRMcGtlRU5uNEtNZHV4TXhXdkd5MF0tLT48L2c+PC9zdmc+'>
<h1 id="3-openssl"><a class="markdownIt-Anchor" href="#3-openssl"></a> 3 openssl</h1>
<h2 id="31-openssl-req"><a class="markdownIt-Anchor" href="#31-openssl-req"></a> 3.1 openssl req</h2>
<p>req指令既可以直接生成一个新的自签名证书，也可以根据现有的证书请求和其相应私钥生成自签名根证书</p>
<ul>
<li>如果是根据现有证书请求生成自签名根证书，那么一定要-key选项指定相应的私钥指令才能执行成功</li>
</ul>
<p>req指令也可以生成密钥对，但在使用req同时生成密钥对是对密钥对保存和格式有限制（只能是PEM编码，DES3-CBC模式加密）。如果需要更灵活的处理，可以使用genrsa或者gendsa先生成密钥然后使用-key选项指定</p>
<p><strong>参数选项</strong></p>
<ul>
<li><strong><code>-new</code>: 指定执行生成新的证书请求，此时会忽略<code>-in</code>指定的内容</strong></li>
<li><strong><code>-x509</code>: 根据现有的证书请求生成自签名根证书（要求使用-key指定证书请求里面的公钥相应的私钥，以便对自签名根证书进行签名）</strong></li>
<li><strong><code>-key</code>: 指定输入的密钥，如果不指定此选项会根据<code>-newkey</code>选项的参数生成密钥对</strong></li>
<li><strong><code>-newkey</code>: 指定生成一个新的密钥对，只有在没有<code>-key</code>选项的时候才生效，参数形式为<code>rsa:numbits</code>或者<code>dsa:file</code></strong></li>
<li><strong><code>-subj</code>: 直接从指令行指定证书请求的主体名称，格式为/分割的键值对字符串，如果没有此选项，那么会弹出交互提示</strong></li>
<li><strong><code>-days</code>: 设定了生成的自签名根证书的有效期，单位为天；该选项只有在使用了<code>-x509</code>选项生成自签名证书的时候才生效，默认为30天</strong></li>
<li><strong><code>-config</code>: 指定req指令在生成证书请求的时候使用的OpenSSL配置文件，一般默认为<code>/etc/pki/tls/openssl.cnf</code></strong></li>
<li><strong><code>-extensions</code>: 选项指定了生成自签名根证书的时候使用的扩展字段，其参数为OpenSSL配置文件中的某个字段名</strong></li>
<li><strong><code>-reqexts</code>: 选项指定了生成证书请求是使用的扩展字段，该字段参数也是配置文件中的某个字段名</strong></li>
<li><code>-text</code>: 让指令输出证书请求或者自签名根证书内容的明文解析，默认情况下，它将输出所有可能输出的内容，如果使用了reqopt选项，则输出内容取决于reqopt选项</li>
<li><code>-reqopt</code>: 指定text选项输出的内容可以为多个，每个之间使用<code>,</code>分隔</li>
<li><code>set_serial</code>: 指定生成的自签名根证书的序列号，默认情况下生成的自签名根证书序列号是0；该选项也只有在生成自签名根证书的时候有效</li>
<li><code>-keyout</code>: 置顶新生成的私钥的输出（仅在使用了<code>-newKey</code>或<code>-new</code>选项导致生成新密钥对的时候才有效，如果使用了<code>-key</code>则此选项被忽略）</li>
<li><code>-keyform</code>: 指定输入密钥的编码格式（比如PEM，DER，PKCS#12，Netscape，IIS SGC，Engine等）</li>
<li><strong><code>-in</code>: 指定输入证书请求文件，如果使用了<code>-new</code>或者<code>-newkey</code>选项，此选项被忽略</strong></li>
<li><code>-inform</code>: 指定输入证书请求文件的编码格式（比如PEM，DER）</li>
<li><strong><code>-out</code>: 指定输出证书请求文件或自签名证书文件</strong></li>
<li><code>-noout</code>: 使用此选项后，指令将不会输出编码的证书请求或者自签名根证书到-out选项指定的文件中，一般用来测试指令或者查看证书请求的信息</li>
<li><code>-outform</code>: 指定输出证书请求文件或自签名证书的编码格式（比如PEM，DER）</li>
<li><code>-pubkey</code>: 使用此选项的话，指令将输出PEM编码的公钥到<code>-out</code>指定的文件中，默认情况下只输出私钥到<code>-keyout</code>指定的文件，并不输出公钥</li>
<li><code>-passin</code>: 指定读取<code>-key</code>选项指定的私钥所需要的解密口令，如果没有指定，私钥又有密钥的话，会弹出交互提示</li>
<li><code>-passout</code>: 指定<code>-keyout</code>选项输出私钥时使用的加密口令</li>
<li><code>-nodes</code>: 表示不对私钥进行加密，如果指定此选项，则忽略-passout指定的口令；如果没有此选项，却指定了-passout则会有交互提示</li>
<li><code>-digest</code>: 指定生成证书请求或者自签名根证书是使用的信息摘要算法，一般在生成数字签名的时候使用</li>
<li><code>-verify</code>: 使用此选项对证书请求中的数字签名进行验证操作，并给出失败或者成功的提示信息，其验证的过程是从证书请求里面提取公钥，然后使用该公钥对证书请求的数字签名进行验证</li>
<li>如果没有<code>-key</code>选项也没有<code>-newkey</code>选项，则会根据<code>openssl.cnf</code>中<code>req</code>字段的<code>default_bits</code>选项的参数，生成一个RSA密钥</li>
<li>如果没有使用<code>-nodes</code>选项，并且生成了新的私钥，私钥会被输出到<code>-keyout</code>指定的文件中时将被以DES3的CBC模式加密</li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个新的证书请求，使用新的 rsa2048 位密钥</span></span><br><span class="line"><span class="comment"># 输出证书请求到request.pem</span></span><br><span class="line"><span class="comment"># 输出密钥到private.pem，密钥口令为12345678</span></span><br><span class="line"></span><br><span class="line">openssl req -new \</span><br><span class="line">    -newkey rsa:2048 -keyout private.pem -passout pass:12345678 \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=www.liuyehcf.test&quot;</span> \</span><br><span class="line">    -out request.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对证书请求签名进行验证</span></span><br><span class="line">openssl req -<span class="keyword">in</span> request.pem -verify -noout</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----分割线-----</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个自签名的根证书</span></span><br><span class="line">openssl req \</span><br><span class="line">    -newkey rsa:2048 -keyout private.pem -passout pass:12345678 \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=selfca&quot;</span> \</span><br><span class="line">    -x509 \</span><br><span class="line">    -out selfsign.crt</span><br></pre></td></tr></table></figure>
<h2 id="32-openssl-ca"><a class="markdownIt-Anchor" href="#32-openssl-ca"></a> 3.2 openssl ca</h2>
<p>ca指令模拟一个完整的CA服务器，它包括签发用户证书，吊销证书，产生CRL及更新证书库等管理操作</p>
<p><strong>参数选项</strong></p>
<ul>
<li><strong><code>-config</code>: 指定要使用的配置文件，如果没有此选项，则会先查找OPENSSL_CONF或者SSLEAY_CONF定义的文件名，如果这两个环境变量都没有定义，就使用OpenSSL安装的默认路径，一般是<code>/usr/local/openssl/openssl.cnf</code>，具体看安装配置</strong></li>
<li><code>-startdate</code>: 设置证书的生效时间 格式为<code>YYMMDDHHMMSSZ</code>指定年月日时分秒，如果没有则使用主配置文件中的default_startdate</li>
<li><code>-enddate</code>: 格式跟<code>-startdate</code>一样</li>
<li><strong><code>-days</code>: 设置证书的有效天数，生效时间到到期时间之间的天数，如果使用了<code>-enddate</code>，此选项被忽略</strong></li>
<li><code>-name</code>: 指定配置文件中CA选项的名称</li>
<li><code>-notext</code>: 不输出明文信息到证书文件</li>
<li><strong><code>-subj</code>: 直接从指令行指定证书请求的主体名称，格式为/分割的键值对字符串，如果没有此选项，那么会弹出交互提示</strong></li>
<li><strong><code>-cert</code>: 参数是一个可以包含路径的文件名，该文件是一个PEM编码的X.509证书文件</strong></li>
<li><strong><code>-keyfile</code>: 参数是一个包含路径的文件名，文件格式可以为PEM，DER，PKCS#12，Netscape，IIS SGC，Engine，但需要通过<code>-keyform</code>指定到底是哪种格式</strong></li>
<li><code>-policy</code>: 指定CA的匹配策略</li>
<li><strong><code>-extensions</code> 指定<code>x509 v3</code>扩展字段的字段名，如果没有这个选项，就由<code>-extfile</code>选项指定</strong></li>
<li><code>-extfile</code>: 指定<code>x509 v3</code>扩展的配置文件，如果没有<code>-extensions</code>字段，则由CA主配置文件中的<code>x509_extensions</code>选项指定</li>
<li><strong><code>-in</code>: 指定一个可以包含路径的证书请求文件名，应该是PEM变得PKCS#10格式的证书请求</strong></li>
<li><code>-infiles</code>: 指定一系列包含PEM编码证书请求的文件，包含多个，只能作为指令的最后一个选项，其后的参数都被认为是证书请求文件</li>
<li><strong><code>-out</code>: 选项指定了输出签发好的证书或者新生成的CRL的文件，如果没有使用<code>-notext</code>选项，那么证书的明文信息也会输出到<code>-out</code>选项指定的文件中</strong></li>
<li><code>-outdir</code>: 选项指定了新生成的证书的输出目录，默认输出到<code>newecerts</code>目录，并使用<code>.pem</code>作为后缀，都是PEM编码。</li>
</ul>
<h2 id="33-证书转换"><a class="markdownIt-Anchor" href="#33-证书转换"></a> 3.3 证书转换</h2>
<h3 id="331-crt与pkcs12"><a class="markdownIt-Anchor" href="#331-crt与pkcs12"></a> 3.3.1 crt与pkcs12</h3>
<p><strong>将<code>crt</code>格式的站点私钥与站点证书，转存为<code>pkcs12</code>格式的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> &lt;cert&gt; -inkey &lt;private key&gt; -name &lt;aliasName&gt; -out &lt;pkcs12 file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行过程中，会创建pkcs12证书的密码</span></span><br><span class="line"><span class="comment"># 1. &lt;cert&gt; 指证书文件路径</span></span><br><span class="line"><span class="comment"># 2. &lt;private key&gt; 指私钥文件路径</span></span><br><span class="line"><span class="comment"># 3. &lt;aliasName&gt; 指该证书的别名</span></span><br><span class="line"><span class="comment"># 4. &lt;pkcs12 file&gt; 指待创建的pkcs12证书</span></span><br></pre></td></tr></table></figure>
<p><strong>将<code>crt</code>格式的站点私钥与站点证书、中间证书、CA证书，转存为<code>pkcs12</code>格式的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> &lt;server cert&gt; -inkey &lt;server private key&gt;  -certfile &lt;intermediate cert&gt; -CAfile &lt;ca cert&gt; -name &lt;aliasName&gt; -out &lt;pkcs12 file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行过程中，会创建pkcs12证书的密码</span></span><br><span class="line"><span class="comment"># 1. &lt;server cert&gt; 指站点证书</span></span><br><span class="line"><span class="comment"># 2. &lt;server private key&gt; 指站点证书的私钥</span></span><br><span class="line"><span class="comment"># 3. &lt;intermediate cert&gt; 中间证书</span></span><br><span class="line"><span class="comment"># 4. &lt;ca cert&gt; 根证书</span></span><br><span class="line"><span class="comment"># 5. &lt;aliasName&gt; 指该证书的别名</span></span><br><span class="line"><span class="comment"># 6. &lt;pkcs12 file&gt; 指待创建的pkcs12证书</span></span><br></pre></td></tr></table></figure>
<p><strong>将<code>crt</code>格式的根证书添加到<code>pkcs12</code>的信任证书链中</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -<span class="built_in">alias</span> &lt;aliasName&gt; -file &lt;ca cert&gt; -keystore &lt;pkcs12 file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;aliasName&gt; 该证书在keystore中的别名，随意取，保证唯一性即可</span></span><br><span class="line"><span class="comment"># &lt;ca cert&gt; 待导入的根证书</span></span><br><span class="line"><span class="comment"># &lt;pkcs12 file&gt; pkcs12证书</span></span><br></pre></td></tr></table></figure>
<p><strong>从<code>pkcs12</code>格式的证书中导出<code>der</code>格式的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -<span class="built_in">alias</span> &lt;aliasName&gt; -keystore &lt;pkcs12 file&gt; -file &lt;der file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;aliasName&gt; 证书在keystore中的别名</span></span><br><span class="line"><span class="comment"># &lt;pkcs12 file&gt; pkcs12证书</span></span><br><span class="line"><span class="comment"># &lt;der file&gt; der证书</span></span><br></pre></td></tr></table></figure>
<h3 id="332-crt与der"><a class="markdownIt-Anchor" href="#332-crt与der"></a> 3.3.2 crt与der</h3>
<p><strong>将<code>der</code>格式的证书转换为<code>crt</code>格式的证书</strong></p>
<ul>
<li><code>der</code>格式的证书，其后缀为<code>.cer</code>或<code>.der</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -inform DER -<span class="keyword">in</span> &lt;der file&gt; -out &lt;crt file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;der file&gt; der格式的证书</span></span><br><span class="line"><span class="comment"># &lt;crt file&gt; crt格式的证书</span></span><br></pre></td></tr></table></figure>
<h3 id="333-crt与pem"><a class="markdownIt-Anchor" href="#333-crt与pem"></a> 3.3.3 crt与pem</h3>
<p><strong>将<code>pem</code>格式的证书转换为<code>crt</code>格式的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -inform PEM -<span class="keyword">in</span> &lt;pem file&gt; -out &lt;crt file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;pem file&gt; pem格式的证书</span></span><br><span class="line"><span class="comment"># &lt;crt file&gt; crt格式的证书</span></span><br></pre></td></tr></table></figure>
<h2 id="34-从私钥导出公钥"><a class="markdownIt-Anchor" href="#34-从私钥导出公钥"></a> 3.4 从私钥导出公钥</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> &lt;private key&gt; -pubout -out &lt;public key&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. &lt;private key&gt; 私钥的路径</span></span><br><span class="line"><span class="comment"># 2. &lt;public key&gt; 公钥的路径</span></span><br></pre></td></tr></table></figure>
<h2 id="35-查看证书信息"><a class="markdownIt-Anchor" href="#35-查看证书信息"></a> 3.5 查看证书信息</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> &lt;cert file&gt; -noout -text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. &lt;cert file&gt; 证书的路径</span></span><br></pre></td></tr></table></figure>
<h1 id="4-keytool"><a class="markdownIt-Anchor" href="#4-keytool"></a> 4 keytool</h1>
<h2 id="41-cmd"><a class="markdownIt-Anchor" href="#41-cmd"></a> 4.1 cmd</h2>
<p><code>keytool command [command options]</code></p>
<ul>
<li><code>-certreq</code>：生成证书请求</li>
<li><code>-changealias</code>：更改条目的别名</li>
<li><code>-delete</code>：删除条目</li>
<li><code>-exportcert</code>：导出证书</li>
<li><code>-genkeypair</code>：生成密钥对</li>
<li><code>-genseckey</code>：生成密钥</li>
<li><code>-gencert</code>：根据证书请求生成证书</li>
<li><code>-importcert</code>：导入证书或证书链</li>
<li><code>-importpass</code>：导入口令</li>
<li><code>-importkeystore</code>：从其他密钥库导入一个或所有条目</li>
<li><code>-keypasswd</code>：更改条目的密钥口令</li>
<li><code>-list</code>：列出密钥库中的条目</li>
<li><code>-printcert</code>：打印证书内容</li>
<li><code>-printcertreq</code>：打印证书请求的内容</li>
<li><code>-printcrl</code>：打印 CRL 文件的内容</li>
<li><code>-storepasswd</code>：更改密钥库的存储口令</li>
</ul>
<p><code>keytool -genkeypair [options]</code></p>
<ul>
<li><code>-alias &lt;alias&gt;</code>：要处理的条目的别名</li>
<li><code>-keyalg &lt;keyalg&gt;</code>：密钥算法名称</li>
<li><code>-keysize &lt;keysize&gt;</code>：密钥位大小</li>
<li><code>-sigalg &lt;sigalg&gt;</code>：签名算法名称</li>
<li><code>-destalias &lt;destalias&gt;</code>：目标别名</li>
<li><code>-dname &lt;dname&gt;</code>：唯一判别名</li>
<li><code>-startdate &lt;startdate&gt;</code>：证书有效期开始日期/时间</li>
<li><code>-ext &lt;value&gt;</code>：X.509 扩展</li>
<li><code>-validity &lt;valDays&gt;</code>：有效天数</li>
<li><code>-keypass &lt;arg&gt;</code>：密钥口令</li>
<li><code>-keystore &lt;keystore&gt;</code>：密钥库名称</li>
<li><code>-storepass &lt;arg&gt;</code>：密钥库口令</li>
<li><code>-storetype &lt;storetype&gt;</code>：密钥库类型</li>
<li><code>-providername &lt;providername&gt;</code>：提供方名称</li>
<li><code>-providerclass &lt;providerclass&gt;</code>：提供方类名</li>
<li><code>-providerarg &lt;arg&gt;</code>：提供方参数</li>
<li><code>-providerpath &lt;pathlist&gt;</code>：提供方类路径</li>
<li><code>-v</code>：详细输出</li>
<li><code>-protected</code>：通过受保护的机制的口令</li>
</ul>
<h3 id="411-查看证书信息"><a class="markdownIt-Anchor" href="#411-查看证书信息"></a> 4.1.1 查看证书信息</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看keystore之外的证书的信息</span></span><br><span class="line">keytool -printcert -file &lt;cert file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看keystore之中的证书的信息</span></span><br><span class="line">keytool -list -keystore &lt;key store path&gt; -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;key store path&gt; 指本地的jks路径</span></span><br></pre></td></tr></table></figure>
<h3 id="412-从jks中导出证书"><a class="markdownIt-Anchor" href="#412-从jks中导出证书"></a> 4.1.2 从JKS中导出证书</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -keystore &lt;key store path&gt; -<span class="built_in">alias</span> &lt;aliasName&gt; -file &lt;cert file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;key store path&gt; 指本地的jks路径</span></span><br><span class="line"><span class="comment"># &lt;aliasName&gt; 指证书别名</span></span><br><span class="line"><span class="comment"># &lt;cert file&gt; 指待输出的证书文件</span></span><br></pre></td></tr></table></figure>
<h3 id="413-将根证书导入jks"><a class="markdownIt-Anchor" href="#413-将根证书导入jks"></a> 4.1.3 将根证书导入JKS</h3>
<p>我们如何使用Java连接到颁发了合法证书的服务端？当然，不校验服务端的合法性是可以的，但是此时客户端会存在安全风险</p>
<p>如果Java客户端需要校验服务端的合法性，那么我们需要将站点证书对应的<strong>根证书</strong>导入本地的JKS中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -<span class="built_in">alias</span> &lt;aliasName&gt; -file &lt;root cert file&gt; -keystore &lt;key store path&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. &lt;aliasName&gt; 指证书别名</span></span><br><span class="line"><span class="comment"># 2. &lt;root cert file&gt; 指待导入的根证书的别名</span></span><br><span class="line"><span class="comment"># 3. &lt;key store path&gt; 指本地的jks路径</span></span><br></pre></td></tr></table></figure>
<p>于是，我们的Java客户端使用上述导入了根证书的JKS就能连接到服务端。因为该服务端的根证书位于信任池中，因此也会信任该服务端的站点证书。具体使用JKS的实例代码参见下方的Demo</p>
<h3 id="414-将服务端证书导入jks"><a class="markdownIt-Anchor" href="#414-将服务端证书导入jks"></a> 4.1.4 将服务端证书导入JKS</h3>
<p><strong>将<code>pkcs12</code>格式的证书导入JKS，并转为<code>jks</code>格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore &lt;pkcs12 file&gt; -destkeystore &lt;jks file&gt; -srcstoretype PKCS12 -deststoretype JKS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行过程中，会创建jks证书的密码，以及源pkcs12证书的密码</span></span><br><span class="line"><span class="comment"># 1. &lt;pkcs12 file&gt; 指源pkcs12证书的路径</span></span><br><span class="line"><span class="comment"># 2. &lt;jks file&gt; 指待创建的jks证书的路径</span></span><br></pre></td></tr></table></figure>
<p><strong>将<code>pkcs12</code>格式的证书直接导入JKS，保持其<code>pkcs12</code>格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore &lt;pkcs12 file&gt; -destkeystore &lt;jks file&gt; -srcstoretype PKCS12 -deststoretype PKCS12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行过程中，会创建jks证书的密码，以及源pkcs12证书的密码</span></span><br><span class="line"><span class="comment"># 1. &lt;pkcs12 file&gt; 指源pkcs12证书的路径</span></span><br><span class="line"><span class="comment"># 2. &lt;jks file&gt; 指待创建的jks证书的路径</span></span><br></pre></td></tr></table></figure>
<h2 id="42-java-api"><a class="markdownIt-Anchor" href="#42-java-api"></a> 4.2 Java-Api</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.security.tools.keytool.CertAndKeyGen;</span><br><span class="line"><span class="keyword">import</span> sun.security.x509.X500Name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.Key;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.Certificate;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/12/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeyStoreExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> <span class="string">&quot;/tmp/keyStore.ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;PKCS12&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;654321&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALIAS_PRIVATE</span> <span class="operator">=</span> <span class="string">&quot;alias_private&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALIAS_CERT</span> <span class="operator">=</span> <span class="string">&quot;alias_cert&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        createKeyStore();</span><br><span class="line"></span><br><span class="line">        storePrivateEntryAndCertChain();</span><br><span class="line">        loadPrivateEntryAndCertChain();</span><br><span class="line"></span><br><span class="line">        storeCert();</span><br><span class="line">        loadCert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createKeyStore</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(KEY_STORE_TYPE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init the key store</span></span><br><span class="line">        keyStore.load(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        keyStore.store(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">storePrivateEntryAndCertChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(KEY_STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">CertAndKeyGen</span> <span class="variable">gen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CertAndKeyGen</span>(<span class="string">&quot;RSA&quot;</span>, <span class="string">&quot;SHA1WithRSA&quot;</span>);</span><br><span class="line">        gen.generate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> gen.getPrivateKey();</span><br><span class="line">        <span class="type">X509Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> gen.getSelfCertificate(<span class="keyword">new</span> <span class="title class_">X500Name</span>(<span class="string">&quot;CN=ROOT&quot;</span>), (<span class="type">long</span>) <span class="number">365</span> * <span class="number">24</span> * <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">        X509Certificate[] chain = <span class="keyword">new</span> <span class="title class_">X509Certificate</span>[<span class="number">1</span>];</span><br><span class="line">        chain[<span class="number">0</span>] = cert;</span><br><span class="line"></span><br><span class="line">        keyStore.setKeyEntry(ALIAS_PRIVATE, key, KEY_PASSWORD.toCharArray(), chain);</span><br><span class="line"></span><br><span class="line">        keyStore.store(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadPrivateEntryAndCertChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(KEY_STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">Key</span> <span class="variable">pvtKey</span> <span class="operator">=</span> keyStore.getKey(ALIAS_PRIVATE, KEY_PASSWORD.toCharArray());</span><br><span class="line">        assertNotNull(pvtKey);</span><br><span class="line">        System.out.println(pvtKey.toString());</span><br><span class="line"></span><br><span class="line">        Certificate[] chain = keyStore.getCertificateChain(ALIAS_PRIVATE);</span><br><span class="line">        assertNotNull(chain);</span><br><span class="line">        <span class="keyword">for</span> (Certificate cert : chain) &#123;</span><br><span class="line">            System.out.println(cert.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//or you can get cert by same alias</span></span><br><span class="line">        <span class="type">Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> keyStore.getCertificate(ALIAS_PRIVATE);</span><br><span class="line">        assertNotNull(cert);</span><br><span class="line">        System.out.println(cert);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">storeCert</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(KEY_STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">CertAndKeyGen</span> <span class="variable">gen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CertAndKeyGen</span>(<span class="string">&quot;RSA&quot;</span>, <span class="string">&quot;SHA1WithRSA&quot;</span>);</span><br><span class="line">        gen.generate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">X509Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> gen.getSelfCertificate(<span class="keyword">new</span> <span class="title class_">X500Name</span>(<span class="string">&quot;CN=ROOT&quot;</span>), (<span class="type">long</span>) <span class="number">365</span> * <span class="number">24</span> * <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">        keyStore.setCertificateEntry(ALIAS_CERT, cert);</span><br><span class="line"></span><br><span class="line">        keyStore.store(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadCert</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(KEY_STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="type">Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> keyStore.getCertificate(ALIAS_CERT);</span><br><span class="line">        assertNotNull(cert);</span><br><span class="line">        System.out.println(cert);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">assertNotNull</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-jks"><a class="markdownIt-Anchor" href="#5-jks"></a> 5 JKS</h1>
<h2 id="51-服务端"><a class="markdownIt-Anchor" href="#51-服务端"></a> 5.1 服务端</h2>
<p>Java环境下，数字证书是用<code>keytool</code>生成的，这些证书被存储在<code>store</code>中，就是证书仓库。我们来调用keytool命令为服务端生成数字证书和保存它使用的证书仓库：</p>
<p><strong>生成数字证书和证书仓库</strong></p>
<ul>
<li>证书名称：<code>liuyehcf_server_key</code></li>
<li>证书仓库路径：<code>~/liuyehcf_server_ks</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -v -<span class="built_in">alias</span> liuyehcf_server_key -keyalg RSA -keystore ~/liuyehcf_server_ks -dname <span class="string">&quot;CN=localhost,OU=cn,O=cn,L=cn,ST=cn,C=cn&quot;</span> -storepass 123456 -keypass 234567</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">在为以下对象生成 2,048 位RSA密钥对和自签名证书 (SHA256withRSA) (有效期为 90 天):</span><br><span class="line">     CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">[正在存储/Users/HCF/liuyehcf_server_ks]</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_server_ks -destkeystore /Users/HCF/liuyehcf_server_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<h2 id="52-客户端"><a class="markdownIt-Anchor" href="#52-客户端"></a> 5.2 客户端</h2>
<p>有了服务端，我们原来的客户端就不能使用了，必须要走SSL协议。由于服务端的证书是我们自己生成的，没有任何受信任机构的签名，所以客户端是无法验证服务端证书的有效性的，通信必然会失败。所以我们需要为客户端创建一个保存所有信任证书的仓库，然后把服务端证书导进这个仓库。这样，当客户端连接服务端时，会发现服务端的证书在自己的信任列表中，就可以正常通信了</p>
<p>因此现在我们要做的是生成一个客户端的证书仓库，<strong>因为keytool不能仅生成一个空白仓库，所以和服务端一样，我们还是生成一个证书加一个仓库（客户端证书加仓库）</strong></p>
<p><strong>生成数字证书和证书仓库</strong></p>
<ul>
<li>证书名称：<code>liuyehcf_client_key</code></li>
<li>证书仓库路径：<code>~/liuyehcf_client_ks</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -v -<span class="built_in">alias</span> liuyehcf_client_key -keyalg RSA -keystore ~/liuyehcf_client_ks -dname <span class="string">&quot;CN=localhost,OU=cn,O=cn,L=cn,ST=cn,C=cn&quot;</span> -storepass 345678 -keypass 456789</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">正在为以下对象生成 2,048 位RSA密钥对和自签名证书 (SHA256withRSA) (有效期为 90 天):</span><br><span class="line">     CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">[正在存储/Users/HCF/liuyehcf_client_ks]</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_client_ks -destkeystore /Users/HCF/liuyehcf_client_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<p><strong>接下来，我们要把服务端的证书导出来，并导入到客户端的仓库。第一步是导出服务端的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -<span class="built_in">alias</span> liuyehcf_server_key -keystore ~/liuyehcf_server_ks -file ~/server_key.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">存储在文件 &lt;/Users/HCF/server_key.cer&gt; 中的证书</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_server_ks -destkeystore /Users/HCF/liuyehcf_server_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<p><strong>然后是把导出的证书导入到客户端证书仓库</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -<span class="built_in">alias</span> liuyehcf_server_key -file ~/server_key.cer -keystore ~/liuyehcf_client_ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">所有者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">发布者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">序列号: bd78a56</span><br><span class="line">有效期为 Fri Dec 07 21:59:02 CST 2018 至 Thu Mar 07 21:59:02 CST 2019</span><br><span class="line">证书指纹:</span><br><span class="line">     MD5:  75:9E:FF:BB:D7:A2:70:59:CB:17:DB:4F:5E:0F:BD:67</span><br><span class="line">     SHA1: AC:89:15:A2:A2:4B:90:6E:A3:FD:24:38:27:DF:F6:32:BA:1C:7B:89</span><br><span class="line">     SHA256: 10:FF:A0:C6:B5:B4:CC:DF:6E:9E:61:27:3B:F1:59:01:49:55:E8:75:33:EE:0B:13:55:56:6C:38:16:08:19:F8</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"></span><br><span class="line"><span class="comment">#1: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: 29 B6 53 D0 FB A0 DD A6   4A C7 A1 D7 51 C5 E2 07  ).S.....J...Q...</span><br><span class="line">0010: 6D D6 2A 4D                                        m.*M</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">是否信任此证书? [否]:  y</span><br><span class="line">证书已添加到密钥库中</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_client_ks -destkeystore /Users/HCF/liuyehcf_client_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<h2 id="53-sslserver"><a class="markdownIt-Anchor" href="#53-sslserver"></a> 5.3 SSLServer</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLServerSocket;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/12/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLServer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.home&quot;</span>) + File.separator + <span class="string">&quot;liuyehcf_server_ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;JKS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROTOCOL</span> <span class="operator">=</span> <span class="string">&quot;TLS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;234567&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SSLServer</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// keyStore</span></span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyManagerFactory</span></span><br><span class="line">        <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        keyManagerFactory.init(keyStore, KEY_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trustManagerFactory</span></span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        trustManagerFactory.init(keyStore);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sslContext</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(PROTOCOL);</span><br><span class="line">        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serverSocketFactory</span></span><br><span class="line">        <span class="type">ServerSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> sslContext.getServerSocketFactory();</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> factory.createServerSocket(<span class="number">8443</span>);</span><br><span class="line">        ((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SSLServer</span>(socket.accept()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(socket.getOutputStream());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            writer.println(data);</span><br><span class="line">            writer.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="54-sslclient"><a class="markdownIt-Anchor" href="#54-sslclient"></a> 5.4 SSLClient</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/12/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.home&quot;</span>) + File.separator + <span class="string">&quot;liuyehcf_client_ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;JKS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROTOCOL</span> <span class="operator">=</span> <span class="string">&quot;TLS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;345678&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;456789&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Set the key store to use for validating the server cert.</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;javax.net.debug&quot;</span>, <span class="string">&quot;ssl,handshake&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLClient</span>();</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> client.createSslSocket();</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(s.getOutputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">        writer.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        System.out.println(reader.readLine());</span><br><span class="line">        s.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Socket <span class="title function_">createSslSocket</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// keyStore</span></span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyManagerFactory</span></span><br><span class="line">        <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        keyManagerFactory.init(keyStore, KEY_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trustManagerFactory</span></span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        trustManagerFactory.init(keyStore);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sslContext</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(PROTOCOL);</span><br><span class="line">        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// socketFactory</span></span><br><span class="line">        <span class="type">SSLSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> sslContext.getSocketFactory();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory.createSocket(<span class="string">&quot;localhost&quot;</span>, <span class="number">8443</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="55-双向认证"><a class="markdownIt-Anchor" href="#55-双向认证"></a> 5.5 双向认证</h2>
<p>上述示例中，仅仅客户端对服务端做了单向认证，如果要进行双向认证，需要将客户端的证书添加到服务端的keyStore中</p>
<p><strong>接下来，我们要把客户端的证书导出来，并导入到服务端的仓库。第一步是导出客户端的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -<span class="built_in">alias</span> liuyehcf_client_key -keystore ~/liuyehcf_client_ks -file ~/client_key.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">存储在文件 &lt;/Users/HCF/client_key.cer&gt; 中的证书</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_client_ks -destkeystore /Users/HCF/liuyehcf_client_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<p><strong>然后是把导出的证书导入到服务端证书仓库</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -<span class="built_in">alias</span> liuyehcf_client_key -file ~/client_key.cer -keystore ~/liuyehcf_server_ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">所有者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">发布者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">序列号: 54f5ef02</span><br><span class="line">有效期为 Fri Dec 07 21:59:51 CST 2018 至 Thu Mar 07 21:59:51 CST 2019</span><br><span class="line">证书指纹:</span><br><span class="line">     MD5:  F2:E4:16:62:DE:1C:D1:DC:F3:E3:95:35:6E:5E:5C:3E</span><br><span class="line">     SHA1: B1:7F:B5:38:AD:73:C8:D4:AF:C9:FB:F2:C4:9D:A5:8A:37:3C:E3:6D</span><br><span class="line">     SHA256: 54:E8:31:2F:CF:B0:10:3B:B1:85:96:A9:0B:92:54:08:30:8E:49:BB:F5:EF:47:6F:B8:47:68:28:AA:CF:81:B5</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"></span><br><span class="line"><span class="comment">#1: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: B5 BF 75 DD B6 07 5A 4A   BC 7D AF F0 46 76 FE E3  ..u...ZJ....Fv..</span><br><span class="line">0010: 2B AC 01 B8                                        +...</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">是否信任此证书? [否]:  y</span><br><span class="line">证书已添加到密钥库中</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">&quot;keytool -importkeystore -srckeystore /Users/HCF/liuyehcf_server_ks -destkeystore /Users/HCF/liuyehcf_server_ks -deststoretype pkcs12&quot;</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<p><strong>改造服务端的代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改为</span></span><br><span class="line"></span><br><span class="line">((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h1 id="6-pkcs12"><a class="markdownIt-Anchor" href="#6-pkcs12"></a> 6 PKCS12</h1>
<h2 id="61-服务端"><a class="markdownIt-Anchor" href="#61-服务端"></a> 6.1 服务端</h2>
<p>Java环境下，数字证书是用<code>keytool</code>生成的，这些证书被存储在<code>store</code>中，就是证书仓库。我们来调用keytool命令为服务端生成数字证书和保存它使用的证书仓库：</p>
<p><strong>生成数字证书和证书仓库</strong></p>
<ul>
<li>证书名称：<code>liuyehcf_server_key</code></li>
<li>证书仓库路径：<code>~/liuyehcf_server_ks</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意，在指定-storetype PKCS12时，-keypass参数是无效的</span></span><br><span class="line">keytool -genkey -v -<span class="built_in">alias</span> liuyehcf_server_key -keyalg RSA -keystore ~/liuyehcf_server_ks -storetype PKCS12 -dname <span class="string">&quot;CN=localhost,OU=cn,O=cn,L=cn,ST=cn,C=cn&quot;</span> -storepass 123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">正在为以下对象生成 2,048 位RSA密钥对和自签名证书 (SHA256withRSA) (有效期为 90 天):</span><br><span class="line">     CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">[正在存储/Users/HCF/liuyehcf_server_ks]</span><br></pre></td></tr></table></figure>
<h2 id="62-客户端"><a class="markdownIt-Anchor" href="#62-客户端"></a> 6.2 客户端</h2>
<p>有了服务端，我们原来的客户端就不能使用了，必须要走SSL协议。由于服务端的证书是我们自己生成的，没有任何受信任机构的签名，所以客户端是无法验证服务端证书的有效性的，通信必然会失败。所以我们需要为客户端创建一个保存所有信任证书的仓库，然后把服务端证书导进这个仓库。这样，当客户端连接服务端时，会发现服务端的证书在自己的信任列表中，就可以正常通信了</p>
<p>因此现在我们要做的是生成一个客户端的证书仓库，<strong>因为keytool不能仅生成一个空白仓库，所以和服务端一样，我们还是生成一个证书加一个仓库（客户端证书加仓库）</strong></p>
<p><strong>生成数字证书和证书仓库</strong></p>
<ul>
<li>证书名称：<code>liuyehcf_client_key</code></li>
<li>证书仓库路径：<code>~/liuyehcf_client_ks</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意，在指定-storetype PKCS12时，-keypass参数是无效的</span></span><br><span class="line">keytool -genkey -v -<span class="built_in">alias</span> liuyehcf_client_key -keyalg RSA -keystore ~/liuyehcf_client_ks -storetype PKCS12 -dname <span class="string">&quot;CN=localhost,OU=cn,O=cn,L=cn,ST=cn,C=cn&quot;</span> -storepass 345678</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">正在为以下对象生成 2,048 位RSA密钥对和自签名证书 (SHA256withRSA) (有效期为 90 天):</span><br><span class="line">     CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">[正在存储/Users/HCF/liuyehcf_client_ks]</span><br></pre></td></tr></table></figure>
<p><strong>接下来，我们要把服务端的证书导出来，并导入到客户端的仓库。第一步是导出服务端的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -<span class="built_in">alias</span> liuyehcf_server_key -keystore ~/liuyehcf_server_ks -file ~/server_key.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">存储在文件 &lt;/Users/HCF/server_key.cer&gt; 中的证书</span><br></pre></td></tr></table></figure>
<p><strong>然后是把导出的证书导入到客户端证书仓库</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -<span class="built_in">alias</span> liuyehcf_server_key -file ~/server_key.cer -keystore ~/liuyehcf_client_ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">所有者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">发布者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">序列号: 3f428b5f</span><br><span class="line">有效期为 Fri Dec 07 22:09:42 CST 2018 至 Thu Mar 07 22:09:42 CST 2019</span><br><span class="line">证书指纹:</span><br><span class="line">     MD5:  49:55:0E:90:8C:29:87:09:41:AA:D0:D0:8D:BE:51:9D</span><br><span class="line">     SHA1: 96:12:9E:FF:AD:D8:CD:32:72:D0:01:50:01:83:06:FF:09:E2:A4:B6</span><br><span class="line">     SHA256: 79:B9:DF:FD:45:98:53:8F:90:66:9B:31:4C:A1:8F:84:AF:E3:8A:CC:89:D7:F6:BC:BE:BB:52:50:D9:77:15:5E</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"></span><br><span class="line"><span class="comment">#1: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: 4F FC 25 2B 3C DA CB 66   ED 54 E5 90 F8 31 B6 58  O.%+&lt;..f.T...1.X</span><br><span class="line">0010: A5 D5 22 A6                                        ..<span class="string">&quot;.</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">是否信任此证书? [否]:  y</span></span><br><span class="line"><span class="string">证书已添加到密钥库中</span></span><br></pre></td></tr></table></figure>
<h2 id="63-sslserver"><a class="markdownIt-Anchor" href="#63-sslserver"></a> 6.3 SSLServer</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLServerSocket;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/12/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLServer</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.home&quot;</span>) + File.separator + <span class="string">&quot;liuyehcf_server_ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;PKCS12&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROTOCOL</span> <span class="operator">=</span> <span class="string">&quot;TLS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> KEY_STORE_PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SSLServer</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// keyStore</span></span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyManagerFactory</span></span><br><span class="line">        <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        keyManagerFactory.init(keyStore, KEY_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trustManagerFactory</span></span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        trustManagerFactory.init(keyStore);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sslContext</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(PROTOCOL);</span><br><span class="line">        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// serverSocketFactory</span></span><br><span class="line">        <span class="type">ServerSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> sslContext.getServerSocketFactory();</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">socket</span> <span class="operator">=</span> factory.createServerSocket(<span class="number">8443</span>);</span><br><span class="line">        ((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SSLServer</span>(socket.accept()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(socket.getOutputStream());</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            writer.println(data);</span><br><span class="line">            writer.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="64-sslclient"><a class="markdownIt-Anchor" href="#64-sslclient"></a> 6.4 SSLClient</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/12/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.home&quot;</span>) + File.separator + <span class="string">&quot;liuyehcf_client_ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;PKCS12&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROTOCOL</span> <span class="operator">=</span> <span class="string">&quot;TLS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;345678&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> KEY_STORE_PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Set the key store to use for validating the server cert.</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;javax.net.debug&quot;</span>, <span class="string">&quot;ssl,handshake&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLClient</span>();</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> client.createSslSocket();</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(s.getOutputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">        writer.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        System.out.println(reader.readLine());</span><br><span class="line">        s.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Socket <span class="title function_">createSslSocket</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// keyStore</span></span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyManagerFactory</span></span><br><span class="line">        <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        keyManagerFactory.init(keyStore, KEY_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trustManagerFactory</span></span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        trustManagerFactory.init(keyStore);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sslContext</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(PROTOCOL);</span><br><span class="line">        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// socketFactory</span></span><br><span class="line">        <span class="type">SSLSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> sslContext.getSocketFactory();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory.createSocket(<span class="string">&quot;localhost&quot;</span>, <span class="number">8443</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="65-双向认证"><a class="markdownIt-Anchor" href="#65-双向认证"></a> 6.5 双向认证</h2>
<p>上述示例中，仅仅客户端对服务端做了单向认证，如果要进行双向认证，需要将客户端的证书添加到服务端的keyStore中</p>
<p><strong>接下来，我们要把客户端的证书导出来，并导入到服务端的仓库。第一步是导出客户端的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -<span class="built_in">export</span> -<span class="built_in">alias</span> liuyehcf_client_key -keystore ~/liuyehcf_client_ks -file ~/client_key.cer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">存储在文件 &lt;/Users/HCF/client_key.cer&gt; 中的证书</span><br></pre></td></tr></table></figure>
<p><strong>然后是把导出的证书导入到服务端证书仓库</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">keytool -import -trustcacerts -<span class="built_in">alias</span> liuyehcf_client_key -file ~/client_key.cer -keystore ~/liuyehcf_server_ks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为输出内容</span></span><br><span class="line">输入密钥库口令:</span><br><span class="line">所有者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">发布者: CN=localhost, OU=cn, O=cn, L=cn, ST=cn, C=cn</span><br><span class="line">序列号: 7e402030</span><br><span class="line">有效期为 Sat Dec 08 09:45:48 CST 2018 至 Fri Mar 08 09:45:48 CST 2019</span><br><span class="line">证书指纹:</span><br><span class="line">     MD5:  5C:54:D1:FC:B5:3C:D4:F7:F4:44:0B:9D:43:83:05:06</span><br><span class="line">     SHA1: 1D:A6:E8:E7:83:3B:CC:A9:CC:BF:0D:93:20:77:9F:25:9F:FC:CE:EB</span><br><span class="line">     SHA256: B5:92:A3:C8:82:6F:D6:1E:FB:53:DF:D7:89:17:75:B3:F5:00:24:9E:9D:23:5B:FD:B8:D5:0F:5F:EB:3D:E5:22</span><br><span class="line">签名算法名称: SHA256withRSA</span><br><span class="line">主体公共密钥算法: 2048 位 RSA 密钥</span><br><span class="line">版本: 3</span><br><span class="line"></span><br><span class="line">扩展:</span><br><span class="line"></span><br><span class="line"><span class="comment">#1: ObjectId: 2.5.29.14 Criticality=false</span></span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: 9E 34 C8 DB A2 C5 77 6E   14 67 97 6E 77 F6 81 5F  .4....wn.g.nw.._</span><br><span class="line">0010: 72 F1 3B DD                                        r.;.</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">是否信任此证书? [否]:  y</span><br><span class="line">证书已添加到密钥库中</span><br></pre></td></tr></table></figure>
<p><strong>改造服务端的代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改为</span></span><br><span class="line"></span><br><span class="line">((SSLServerSocket) socket).setNeedClientAuth(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<h1 id="7-最佳实践"><a class="markdownIt-Anchor" href="#7-最佳实践"></a> 7 最佳实践</h1>
<h2 id="71-证书生成及签名"><a class="markdownIt-Anchor" href="#71-证书生成及签名"></a> 7.1 证书生成及签名</h2>
<h3 id="711-创建自签名的单域名证书"><a class="markdownIt-Anchor" href="#711-创建自签名的单域名证书"></a> 7.1.1 创建自签名的单域名证书</h3>
<p><strong>第一步：创建自签名ca</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ca私钥</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ca自签名证书</span></span><br><span class="line">openssl req -new \</span><br><span class="line">    -sha256 \</span><br><span class="line">    -key ca.key \</span><br><span class="line">    -x509 \</span><br><span class="line">    -days 365 \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=selfca&quot;</span> \</span><br><span class="line">    -out ca.crt</span><br></pre></td></tr></table></figure>
<p><strong>第二步：创建服务端私钥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建服务端私钥</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看私钥</span></span><br><span class="line">file server.key</span><br><span class="line"><span class="built_in">cat</span> server.key</span><br><span class="line">openssl rsa -<span class="keyword">in</span> server.key -noout -text</span><br></pre></td></tr></table></figure>
<p><strong>第三步：根据私钥生成证书签名请求</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建证书签名请求</span></span><br><span class="line">openssl req -new \</span><br><span class="line">     -sha256 \</span><br><span class="line">     -key server.key \</span><br><span class="line">     -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=www.liuyehcf.test&quot;</span> \</span><br><span class="line">     -out server.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面这几个字段的含义</span></span><br><span class="line"><span class="comment"># C  =&gt; Country</span></span><br><span class="line"><span class="comment"># ST =&gt; State</span></span><br><span class="line"><span class="comment"># L  =&gt; City</span></span><br><span class="line"><span class="comment"># O  =&gt; Organization</span></span><br><span class="line"><span class="comment"># OU =&gt; Organization Unit</span></span><br><span class="line"><span class="comment"># CN =&gt; Common Name (证书所请求的域名)</span></span><br><span class="line"><span class="comment"># emailAddress =&gt; main administrative point of contact for the certificate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书签名请求</span></span><br><span class="line">file server.csr</span><br><span class="line"><span class="built_in">cat</span> server.csr</span><br><span class="line">openssl req -noout -text -<span class="keyword">in</span> server.csr</span><br></pre></td></tr></table></figure>
<p><strong>第四步：用自签名ca进行证书签名</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用CA的私钥和证书对用户证书签名，下面有两种方式，效果一样</span></span><br><span class="line"><span class="comment"># 1. 使用 openssl ca 进行签名</span></span><br><span class="line"><span class="comment"># 2. 使用 openssl x509 进行签名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式1: openssl ca</span></span><br><span class="line"><span class="comment"># 创建一些必要的文件，否则签名时会有问题</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/pki/CA/newcerts</span><br><span class="line"><span class="built_in">touch</span> /etc/pki/CA/index.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;01&quot;</span> &gt; /etc/pki/CA/serial</span><br><span class="line">openssl ca -<span class="keyword">in</span> server.csr \</span><br><span class="line">    -md sha256 \</span><br><span class="line">    -days 3650 \</span><br><span class="line">    -keyfile ca.key \</span><br><span class="line">    -cert ca.crt \</span><br><span class="line">    -config &lt;(<span class="built_in">cat</span> /etc/pki/tls/openssl.cnf) \</span><br><span class="line">    -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2: openssl x509</span></span><br><span class="line">openssl x509 -req \</span><br><span class="line">    -<span class="keyword">in</span> server.csr \</span><br><span class="line">    -sha256 \</span><br><span class="line">    -days 3650 \</span><br><span class="line">    -CAkey ca.key \</span><br><span class="line">    -CA ca.crt \</span><br><span class="line">    -CAcreateserial \</span><br><span class="line">    -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">file server.crt</span><br><span class="line"><span class="built_in">cat</span> server.crt</span><br><span class="line">openssl x509 -<span class="keyword">in</span> server.crt -noout -text</span><br></pre></td></tr></table></figure>
<p><strong>验证</strong></p>
<p>启动Http服务（参考<code>[Java验证]</code>小节），并配置host</p>
<ul>
<li><code>127.0.0.1 www.liuyehcf.test</code></li>
</ul>
<p>浏览器访问</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.liuyehcf.test:8866/">https://www.liuyehcf.test:8866/</a></li>
</ul>
<p>此时浏览器会提示该证书非法。将<code>ca.crt</code>添加到系统根证书中后，可正常访问</p>
<h3 id="712-创建自签名的san证书"><a class="markdownIt-Anchor" href="#712-创建自签名的san证书"></a> 7.1.2 创建自签名的SAN证书</h3>
<p><strong>第一步：创建自签名ca</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ca私钥</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ca自签名证书</span></span><br><span class="line">openssl req -new \</span><br><span class="line">    -sha256 \</span><br><span class="line">    -key ca.key \</span><br><span class="line">    -x509 \</span><br><span class="line">    -days 365 \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=selfca&quot;</span> \</span><br><span class="line">    -out ca.crt</span><br></pre></td></tr></table></figure>
<p><strong>第二步：创建服务端私钥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建服务端私钥</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br></pre></td></tr></table></figure>
<p><strong>第三步：根据私钥生成证书签名请求</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建证书签名请求</span></span><br><span class="line">openssl req -new \</span><br><span class="line">    -sha256 \</span><br><span class="line">    -key server.key \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=ZJ/L=HZ/O=LiuYe/OU=Study/CN=liuyeSAN&quot;</span> \</span><br><span class="line">    -out server.csr</span><br></pre></td></tr></table></figure>
<p><strong>第四步：用自签名ca进行证书签名</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用CA的私钥和证书对用户证书签名，下面有两种方式，效果一样</span></span><br><span class="line"><span class="comment"># 1. 使用 openssl ca 进行签名</span></span><br><span class="line"><span class="comment"># 2. 使用 openssl x509 进行签名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式1: openssl ca</span></span><br><span class="line"><span class="comment"># 创建一些必要的文件，否则签名时会有问题</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/pki/CA/newcerts</span><br><span class="line"><span class="built_in">touch</span> /etc/pki/CA/index.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;01&quot;</span> &gt; /etc/pki/CA/serial</span><br><span class="line">openssl ca -<span class="keyword">in</span> server.csr \</span><br><span class="line">    -md sha256 \</span><br><span class="line">    -keyfile ca.key \</span><br><span class="line">    -cert ca.crt \</span><br><span class="line">    -extensions SAN \</span><br><span class="line">    -config &lt;(<span class="built_in">cat</span> /etc/pki/tls/openssl.cnf \</span><br><span class="line">        &lt;(<span class="built_in">printf</span> <span class="string">&quot;[SAN]\nsubjectAltName=DNS:*.test1.liuyehcf.test,DNS:*.test2.liuyehcf.test,DNS:www.liuyehcf.test&quot;</span>)) \</span><br><span class="line">    -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2: openssl x509</span></span><br><span class="line"><span class="built_in">cat</span> &gt; server_ext &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">extendedKeyUsage=serverAuth,OCSPSigning</span></span><br><span class="line"><span class="string">subjectAltName=@alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1=*.test1.liuyehcf.test</span></span><br><span class="line"><span class="string">DNS.2=*.test2.liuyehcf.test</span></span><br><span class="line"><span class="string">DNS.3=www.liuyehcf.test</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">openssl x509 -req \</span><br><span class="line">    -<span class="keyword">in</span> server.csr \</span><br><span class="line">    -sha256 \</span><br><span class="line">    -days 3650 \</span><br><span class="line">    -CAkey ca.key \</span><br><span class="line">    -CA ca.crt \</span><br><span class="line">    -CAcreateserial \</span><br><span class="line">    -extfile server_ext \</span><br><span class="line">    -out server.crt</span><br></pre></td></tr></table></figure>
<p><strong>验证</strong></p>
<p>启动Http服务（参考<code>[Java验证]</code>小节），并配置三个host</p>
<ul>
<li><code>127.0.0.1 www.liuyehcf.test</code></li>
<li><code>127.0.0.1 www.test1.liuyehcf.test</code></li>
<li><code>127.0.0.1 www.test2.liuyehcf.test</code></li>
<li><code>127.0.0.1 www.liuyehcf.test2</code>（非证书保护的域名）</li>
</ul>
<p>浏览器访问如下地址</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.liuyehcf.test:8866/">https://www.liuyehcf.test:8866/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.test1.liuyehcf.test:8866/">https://www.test1.liuyehcf.test:8866/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.test2.liuyehcf.test:8866/">https://www.test2.liuyehcf.test:8866/</a></li>
</ul>
<p>此时浏览器会提示该证书非法。将<code>ca.crt</code>添加到系统根证书中后，可正常访问，可用<code>curl</code>来验证</p>
<ul>
<li><code>curl https://www.liuyehcf.test:8866/</code>
<ul>
<li><code>hello world. origin host='www.liuyehcf.test:8866'</code></li>
</ul>
</li>
<li><code>curl https://www.test1.liuyehcf.test:8866/</code>
<ul>
<li><code>hello world. origin host='www.test1.liuyehcf.test:8866'</code></li>
</ul>
</li>
<li><code>curl https://www.test2.liuyehcf.test:8866/</code>
<ul>
<li><code>hello world. origin host='www.test2.liuyehcf.test:8866'</code></li>
</ul>
</li>
<li><code>curl https://www.liuyehcf.test2:8866/</code>
<ul>
<li><code>curl: (51) SSL: no alternative certificate subject name matches target host name 'www.liuyehcf.test2'</code></li>
</ul>
</li>
</ul>
<p><strong>问题</strong></p>
<ol>
<li><strong>在用<code>openssl ca</code>进行签名时，要确保<code>.csr</code>文件包含的CN必须是唯一的，否则在签名时会出现<code>TXT_DB error number 2</code>的问题</strong></li>
</ol>
<h3 id="713-java验证"><a class="markdownIt-Anchor" href="#713-java验证"></a> 7.1.3 Java验证</h3>
<p><strong>将证书导入JavaKeyStore</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 转成pkcs12格式的证书，会要求创建密码，我创建的是 123456</span></span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> server.crt -inkey server.key -name liuyehcf -out server.p12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将pkcs12格式的证书导入keystore，会要求输入keystore的密码，以及pkcs12的密码，我填的都是 123456</span></span><br><span class="line">keytool -importkeystore -srckeystore server.p12 -destkeystore liuyehcf_server_ks -srcstoretype PKCS12 -deststoretype PKCS12</span><br></pre></td></tr></table></figure>
<p><strong>Java验证代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.liuyehcf.netty.https;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslContextBuilder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.KeyManagerFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hechenfeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8866</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PATH</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.home&quot;</span>) + File.separator + <span class="string">&quot;liuyehcf_server_ks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STORE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;PKCS12&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_STORE_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PASSWORD</span> <span class="operator">=</span> KEY_STORE_PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EventLoopGroup</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EventLoopGroup</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        bootstrap.group(boss, worker)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line">                        pipeline.addLast(createSslHandlerUsingNetty(pipeline));</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ServerHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                .childOption(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(PORT).sync();</span><br><span class="line">        System.out.println(<span class="string">&quot;server start ...... &quot;</span>);</span><br><span class="line"></span><br><span class="line">        future.channel().closeFuture().sync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ChannelHandler <span class="title function_">createSslHandlerUsingNetty</span><span class="params">(ChannelPipeline pipeline)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// keyStore</span></span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(STORE_TYPE);</span><br><span class="line">        keyStore.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(KEY_STORE_PATH), KEY_STORE_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyManagerFactory</span></span><br><span class="line">        <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        keyManagerFactory.init(keyStore, KEY_PASSWORD.toCharArray());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SslContextBuilder.forServer(keyManagerFactory).build()</span><br><span class="line">                .newHandler(pipeline.channel().alloc(), HOST, PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest msg)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(</span><br><span class="line">                    HttpVersion.HTTP_1_1,</span><br><span class="line">                    HttpResponseStatus.BAD_REQUEST,</span><br><span class="line">                    Unpooled.copiedBuffer(<span class="string">&quot;hello world&quot;</span>, Charset.defaultCharset()));</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            ctx.channel().writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="72-centos安装ca根证书"><a class="markdownIt-Anchor" href="#72-centos安装ca根证书"></a> 7.2 CentOS安装CA根证书</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ca-certificates</span><br></pre></td></tr></table></figure>
<h1 id="8-在netty中使用ssl"><a class="markdownIt-Anchor" href="#8-在netty中使用ssl"></a> 8 在Netty中使用SSL</h1>
<p>详见<a href="/2018/10/21/Netty-Demo/" title="Netty-Demo">Netty-Demo</a></p>
<h1 id="9-查看证书信息"><a class="markdownIt-Anchor" href="#9-查看证书信息"></a> 9 查看证书信息</h1>
<p>可以通过网站<code>https://myssl.com/</code>来查看证书信息</p>
<p>比如查看aliyun的证书信息，可以访问<code>https://myssl.com/www.aliyun.com</code></p>
<p>此外，可以通过openssl来查看证书详情以及过期时间等等信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看证书详情</span></span><br><span class="line"><span class="built_in">echo</span> | openssl s_client -servername www.aliyun.com -connect www.aliyun.com:443 2&gt;/dev/null | openssl x509 -text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书过期时间</span></span><br><span class="line"><span class="built_in">echo</span> | openssl s_client -servername www.aliyun.com -connect www.aliyun.com:443 2&gt;/dev/null | openssl x509 -noout -dates</span><br></pre></td></tr></table></figure>
<h1 id="10-参考"><a class="markdownIt-Anchor" href="#10-参考"></a> 10 参考</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/everyok/article/details/82882156">Java SSL</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/crazyacking/p/5648520.html">SSL介绍与Java实例</a></li>
<li><a target="_blank" rel="noopener" href="https://www.csdn.net/article/2015-01-06/2823434">Java不同类型密钥库之PKCS12和JCEKS</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kmyhy/article/details/6431609">PKCS12 证书的生成及验证</a></li>
<li><a target="_blank" rel="noopener" href="https://www.programcreek.com/java-api-examples/?api=javax.net.ssl.SSLContext">Java Code Examples for javax.net.ssl.SSLContext</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/bolg_hero/article/details/71170606">java PKCS12双向认证</a></li>
<li><a target="_blank" rel="noopener" href="https://www.aliyun.com/jiaocheng/1738033.html?spm=5176.100033.2.5.490a4571JCeVLU">Okhttp3配置Https访问(使用PKCS12)证书</a></li>
<li><a target="_blank" rel="noopener" href="https://coderwall.com/p/3t4xka/import-private-key-and-certificate-into-java-keystore">Import private key and certificate into java keystore</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wowza.com/docs/how-to-import-an-existing-ssl-certificate-and-private-key">Convert the certificate and private key to PKCS 12</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.freessl.cn/ssl-cert-format-introduce/">SSL 证书格式普及，PEM、CER、JKS、PKCS12</a></li>
<li><a target="_blank" rel="noopener" href="https://www.thesslstore.com/blog/root-certificates-intermediate/">The Difference Between Root Certificates and Intermediate Certificates</a></li>
<li><a target="_blank" rel="noopener" href="https://www.58ssl.com/ssl_wenti/4156.html">中间证书的使用（组图）</a></li>
<li><a target="_blank" rel="noopener" href="http://liaoph.com/openssl-san/">使用 OpenSSL 制作一个包含 SAN（Subject Alternative Name）的证书</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7d940d7a07d9">如何使用openssl生成证书及签名</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/NewTWG/article/details/85330895">keytool使用大全：p12(PKCS12)和jks互相转换等</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/24ed15c973ec">HTTPS SAN自签名证书</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/dotalee/article/details/78041691">OpenSSL创建带SAN扩展的证书并进行CA自签</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26646377">使用OpenSSL生成多域名自签名证书进行HTTPS开发调试</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/littleatp/p/5878763.html">使用 openssl 生成证书</a></li>
<li><a target="_blank" rel="noopener" href="https://support.apple.com/en-us/HT210176">Requirements for trusted certificates in iOS 13 and macOS 10.15</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/zengestudy/2170245">HTTPS之SNI介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/coder9999/article/details/79664282">centos 添加CA 证书</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html">阮一峰-数字签名是什么？</a></li>
<li><a target="_blank" rel="noopener" href="https://www.chinassl.net/ssltools/decoder-ssl.html">SSL证书文件校验工具</a></li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%91%98%E5%BD%95/" rel="tag"># 摘录</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/12/02/Linux-DNS/" rel="prev" title="Linux-DNS">
      <i class="fa fa-chevron-left"></i> Linux-DNS
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/12/24/Spring-Boot-Starter-Demo/" rel="next" title="Spring-Boot-Starter-Demo">
      Spring-Boot-Starter-Demo <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY0My8xMDE5OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-ssl%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7"><span class="nav-text"> 1 SSL协议特性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-sni"><span class="nav-text"> 1.1 SNI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E8%AF%81%E4%B9%A6"><span class="nav-text"> 2 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-%E8%AF%81%E4%B9%A6%E6%A0%BC%E5%BC%8F"><span class="nav-text"> 2.1 证书格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#211-x509"><span class="nav-text"> 2.1.1 X.509</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-%E8%AF%81%E4%B9%A6%E7%B1%BB%E5%9E%8B"><span class="nav-text"> 2.2 证书类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-%E6%A0%B9%E8%AF%81%E4%B9%A6%E5%92%8C%E4%B8%AD%E9%97%B4%E8%AF%81%E4%B9%A6%E4%BB%A5%E5%8F%8A%E8%AF%81%E4%B9%A6%E9%93%BE"><span class="nav-text"> 2.3 根证书和中间证书以及证书链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#231-%E6%A0%B9%E8%AF%81%E4%B9%A6"><span class="nav-text"> 2.3.1 根证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#232-%E8%AF%81%E4%B9%A6%E9%93%BE"><span class="nav-text"> 2.3.2 证书链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#233-%E4%B8%AD%E9%97%B4%E8%AF%81%E4%B9%A6"><span class="nav-text"> 2.3.3 中间证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2331-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%87%AA%E5%8A%A8%E4%B8%8B%E8%BD%BD%E4%B8%AD%E9%97%B4%E8%AF%81%E4%B9%A6"><span class="nav-text"> 2.3.3.1 客户端自动下载中间证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2332-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%E4%B8%AD%E9%97%B4%E8%AF%81%E4%B9%A6"><span class="nav-text"> 2.3.3.2 服务器推送中间证书</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#234-%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D"><span class="nav-text"> 2.3.4 数字签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#235-root-ca%E4%B8%8Eintermediate-ca"><span class="nav-text"> 2.3.5 Root CA与Intermediate CA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#236-chained-root%E4%B8%8Esingle-root"><span class="nav-text"> 2.3.6 Chained Root与Single Root</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B"><span class="nav-text"> 2.4 认证过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-openssl"><span class="nav-text"> 3 openssl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#31-openssl-req"><span class="nav-text"> 3.1 openssl req</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-openssl-ca"><span class="nav-text"> 3.2 openssl ca</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#33-%E8%AF%81%E4%B9%A6%E8%BD%AC%E6%8D%A2"><span class="nav-text"> 3.3 证书转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#331-crt%E4%B8%8Epkcs12"><span class="nav-text"> 3.3.1 crt与pkcs12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#332-crt%E4%B8%8Eder"><span class="nav-text"> 3.3.2 crt与der</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#333-crt%E4%B8%8Epem"><span class="nav-text"> 3.3.3 crt与pem</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#34-%E4%BB%8E%E7%A7%81%E9%92%A5%E5%AF%BC%E5%87%BA%E5%85%AC%E9%92%A5"><span class="nav-text"> 3.4 从私钥导出公钥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#35-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF"><span class="nav-text"> 3.5 查看证书信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-keytool"><span class="nav-text"> 4 keytool</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-cmd"><span class="nav-text"> 4.1 cmd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#411-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF"><span class="nav-text"> 4.1.1 查看证书信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#412-%E4%BB%8Ejks%E4%B8%AD%E5%AF%BC%E5%87%BA%E8%AF%81%E4%B9%A6"><span class="nav-text"> 4.1.2 从JKS中导出证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#413-%E5%B0%86%E6%A0%B9%E8%AF%81%E4%B9%A6%E5%AF%BC%E5%85%A5jks"><span class="nav-text"> 4.1.3 将根证书导入JKS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#414-%E5%B0%86%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%81%E4%B9%A6%E5%AF%BC%E5%85%A5jks"><span class="nav-text"> 4.1.4 将服务端证书导入JKS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#42-java-api"><span class="nav-text"> 4.2 Java-Api</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-jks"><span class="nav-text"> 5 JKS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#51-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text"> 5.1 服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text"> 5.2 客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-sslserver"><span class="nav-text"> 5.3 SSLServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-sslclient"><span class="nav-text"> 5.4 SSLClient</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#55-%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81"><span class="nav-text"> 5.5 双向认证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-pkcs12"><span class="nav-text"> 6 PKCS12</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#61-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text"> 6.1 服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#62-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text"> 6.2 客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#63-sslserver"><span class="nav-text"> 6.3 SSLServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#64-sslclient"><span class="nav-text"> 6.4 SSLClient</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#65-%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81"><span class="nav-text"> 6.5 双向认证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text"> 7 最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#71-%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90%E5%8F%8A%E7%AD%BE%E5%90%8D"><span class="nav-text"> 7.1 证书生成及签名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#711-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8D%E7%9A%84%E5%8D%95%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="nav-text"> 7.1.1 创建自签名的单域名证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#712-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8D%E7%9A%84san%E8%AF%81%E4%B9%A6"><span class="nav-text"> 7.1.2 创建自签名的SAN证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#713-java%E9%AA%8C%E8%AF%81"><span class="nav-text"> 7.1.3 Java验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#72-centos%E5%AE%89%E8%A3%85ca%E6%A0%B9%E8%AF%81%E4%B9%A6"><span class="nav-text"> 7.2 CentOS安装CA根证书</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E5%9C%A8netty%E4%B8%AD%E4%BD%BF%E7%94%A8ssl"><span class="nav-text"> 8 在Netty中使用SSL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF"><span class="nav-text"> 9 查看证书信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E5%8F%82%E8%80%83"><span class="nav-text"> 10 参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liuyehcf"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Liuyehcf</p>
  <div class="site-description" itemprop="description">大音希声，大象无形</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">288</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">98</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuyehcf</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qhEhLuMeMOy1zgcBhkqUS6P8-gzGzoHsz',
      appKey     : 'uhkruDLNLNdL5rQjRBY2X9Ke',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
