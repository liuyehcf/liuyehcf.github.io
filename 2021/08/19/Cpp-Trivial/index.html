<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="阅读更多">
<meta property="og:type" content="article">
<meta property="og:title" content="Cpp-Trivial">
<meta property="og:url" content="http://example.com/2021/08/19/Cpp-Trivial/index.html">
<meta property="og:site_name" content="Liuye Notebook">
<meta property="og:description" content="阅读更多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Cpp-Trivial/abi.png">
<meta property="og:image" content="http://example.com/images/Cpp-Trivial/tcmalloc.png">
<meta property="og:image" content="http://example.com/images/Cpp-Trivial/jemalloc.png">
<meta property="og:image" content="http://example.com/images/Cpp-Trivial/analysis-tools.png">
<meta property="article:published_time" content="2021-08-19T01:38:42.000Z">
<meta property="article:modified_time" content="2024-03-24T12:30:53.000Z">
<meta property="article:author" content="Liuyehcf">
<meta property="article:tag" content="原创">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Cpp-Trivial/abi.png">

<link rel="canonical" href="http://example.com/2021/08/19/Cpp-Trivial/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cpp-Trivial | Liuye Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liuye Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-explore">

    <a href="/explore/" rel="section"><i class="fa fa-sitemap fa-fw"></i>发现</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/19/Cpp-Trivial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Liuyehcf">
      <meta itemprop="description" content="大音希声，大象无形">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuye Notebook">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cpp-Trivial
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-19 09:38:42" itemprop="dateCreated datePublished" datetime="2021-08-19T09:38:42+08:00">2021-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-24 20:30:53" itemprop="dateModified" datetime="2024-03-24T20:30:53+08:00">2024-03-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cpp/" itemprop="url" rel="index"><span itemprop="name">Cpp</span></a>
                </span>
            </span>

          
            <span id="/2021/08/19/Cpp-Trivial/" class="post-meta-item leancloud_visitors" data-flag-title="Cpp-Trivial" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/08/19/Cpp-Trivial/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/19/Cpp-Trivial/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>阅读更多</strong></p>
<span id="more"></span>
<h1 id="1-compile-process"><a class="markdownIt-Anchor" href="#1-compile-process"></a> 1 Compile Process</h1>
<pre class="mermaid">flowchart TD
    other_target(["其他目标代码"])
    linker[["链接器"]]
    source(["源代码"])
    compiler[["编译器"]]
    assembly(["汇编代码"])
    assembler[["汇编器"]]
    target(["目标代码"])
    lib(["库文件"])
    result_target(["目标代码"])
    exec(["可执行程序"])
    result_lib(["库文件"])

    other_target --> linker

    subgraph 编译过程
        source --> compiler
        compiler --> assembly
        assembly --> assembler
        assembler --> target
        end
        target --> linker
        lib --> linker

    linker --> result_target
    linker --> exec
    linker --> result_lib</pre>
<h1 id="2-library"><a class="markdownIt-Anchor" href="#2-library"></a> 2 Library</h1>
<h2 id="21-static-library"><a class="markdownIt-Anchor" href="#21-static-library"></a> 2.1 Static Library</h2>
<p><strong>后缀：<code>*.a</code></strong></p>
<p><strong>编译时如何链接静态链接库：</strong></p>
<ul>
<li><code>-L</code>：指定静态链接库的搜索路径</li>
<li><code>-l &lt;static_lib_name&gt;</code>：
<ul>
<li>假设静态链接库的名称是<code>libgflags.a</code>，那么<code>&lt;static_lib_name&gt;</code>既不需要<code>lib</code>前缀，也不需要<code>.a</code>后缀，即<code>gflags</code></li>
</ul>
</li>
</ul>
<p><strong>如何查看二进制的静态链接库：由于链接器在链接时，就会丢弃静态库的名字信息，因此，一般是看不到的</strong></p>
<ul>
<li><code>-Xlinker -Map=a.map</code>：将链接时的信息记录到<code>a.map</code>中</li>
<li><code>nm/objdump/readelf/strings</code>或许可以找到一些静态库相关的<code>hint</code></li>
</ul>
<h3 id="211-search-order"><a class="markdownIt-Anchor" href="#211-search-order"></a> 2.1.1 Search Order</h3>
<p><strong>搜索顺序如下：详见<code>ld --verbose | grep SEARCH_DIR</code></strong></p>
<ul>
<li>首先在链接器命令行中指定的库目录中搜索，如果找到与指定的库名匹配的库文件，则使用该库文件</li>
<li>如果在指定的库目录中没有找到匹配的库文件，则在系统默认的库目录中搜索，如<code>/lib</code>、<code>/usr/lib</code>、<code>/usr/local/lib</code>等
<ul>
<li><code>/usr/lib/x86_64-linux-gnu</code></li>
</ul>
</li>
<li>如果在系统默认的库目录中也没有找到匹配的库文件，则按照编译器的默认顺序搜索一些特定的库目录，如<code>/lib64</code>、<code>/usr/lib64</code>、<code>/usr/local/lib64</code>等</li>
<li>如果在所有指定的库目录中都没有找到匹配的库文件，则链接器会报错，指出无法找到指定的库文件</li>
</ul>
<h2 id="22-dynamic-library"><a class="markdownIt-Anchor" href="#22-dynamic-library"></a> 2.2 Dynamic Library</h2>
<p><strong>后缀：<code>*.so</code></strong></p>
<p><strong>如何查看二进制的动态链接库：<code>ldd</code> (list dynamic dependencies)</strong></p>
<p><strong>查看动态链接库绑定信息：<code>ldconfig -v</code>、<code>ldconfig -p</code></strong></p>
<h3 id="221-search-order"><a class="markdownIt-Anchor" href="#221-search-order"></a> 2.2.1 Search Order</h3>
<p><strong>搜索顺序如下：详见<code>man ld.so</code></strong></p>
<ol>
<li>在环境变量<code>LD_LIBRARY_PATH</code>指定的目录下搜索，以<code>:</code>分隔</li>
<li>在<code>/etc/ld.so.cache</code>指定的目录中搜索</li>
<li>在<code>/lib</code>、<code>/lib64</code>中搜索（系统发行版安装的）</li>
<li>在<code>/usr/lib</code>、<code>/usr/lib64</code>中搜索（其他软件安装的）</li>
</ol>
<h3 id="222-linuxs-so-version-mechanism"><a class="markdownIt-Anchor" href="#222-linuxs-so-version-mechanism"></a> 2.2.2 Linux’s so version mechanism</h3>
<p><strong>本小节转载摘录自<a target="_blank" rel="noopener" href="https://blog.ideawand.com/2020/02/15/how-does-linux-shared-library-versioning-works/">一文读懂Linux下动态链接库版本管理及查找加载方式</a></strong></p>
<p>在<code>/lib64</code>、<code>/usr/lib64</code>、<code>/usr/local/lib64</code>目录下，会看到很多具有下列特征的软连接，其中<code>x</code>、<code>y</code>、<code>z</code>为数字, 那么这些软连接和他们后面的数字有什么用途呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libfoo.so    -&gt;  libfoo.so.x</span><br><span class="line">libfoo.so.x  -&gt;  libfoo.so.x.y.z</span><br><span class="line">libbar.so.x  -&gt;  libbar.so.x.y</span><br></pre></td></tr></table></figure>
<p>这里的<code>x</code>、<code>y</code>、<code>z</code>分别代表的是这个<code>so</code>的主版本号（<code>MAJOR</code>），次版本号（<code>MINOR</code>），以及发行版本号（<code>RELEASE</code>），对于这三个数字各自的含义，以及什么时候会进行增长，不同的文献上有不同的解释，不同的组织遵循的规定可能也有细微的差别，但有一个可以肯定的事情是：主版本号（<code>MAJOR</code>）不同的两个<code>so</code>库，所暴露出的<code>API</code>接口是不兼容的。而对于次版本号，和发行版本号，则有着不同定义，其中一种定义是：次要版本号表示<code>API</code>接口的定义发生了改变（比如参数的含义发生了变化），但是保持向前兼容；而发行版本号则是函数内部的一些功能调整、优化、BUG修复，不涉及<code>API</code>接口定义的修改</p>
<h4 id="2221-so-related-names"><a class="markdownIt-Anchor" href="#2221-so-related-names"></a> 2.2.2.1 so Related Names</h4>
<p><strong>介绍一下在<code>so</code>查找过程中的几个名字</strong></p>
<ul>
<li><strong><code>SONAME</code>：一组具有兼容<code>API</code>的<code>so</code>库所共有的名字，其命名特征是<code>lib&lt;库名&gt;.so.&lt;数字&gt;</code>这种形式的</strong></li>
<li><strong><code>real name</code>：是真实具有<code>so</code>库可执行代码的那个文件，之所以叫<code>real</code>是相对于<code>SONAME</code>和<code>linker name</code>而言的，因为另外两种名字一般都是一个软连接，这些软连接最终指向的文件都是具有<code>real name</code>命名形式的文件。<code>real name</code>的命名格式中，可能有<code>2</code>个数字尾缀，也可能有<code>3</code>个数字尾缀，但这不重要。你只要记住，真实的那个，不是以软连接形式存在的，就是一个<code>real name</code></strong></li>
<li><strong><code>linker name</code>：这个名字只是给编译工具链中的连接器使用的名字，和程序运行并没有什么关系，仅仅在链接得到可执行文件的过程中才会用到。它的命名特征是以<code>lib</code>开头，以<code>.so</code>结尾，不带任何数字后缀的格式</strong></li>
</ul>
<h4 id="2222-soname"><a class="markdownIt-Anchor" href="#2222-soname"></a> 2.2.2.2 SONAME</h4>
<p>假设在你的Linux系统中有3个不同版本的<code>bar</code>共享库，他们在磁盘上保存的文件名如下：</p>
<ul>
<li><code>/usr/lib64/libbar.so.1.3</code></li>
<li><code>/usr/lib64/libbar.so.1.5</code></li>
<li><code>/usr/lib64/libbar.so.2.1</code></li>
</ul>
<p>假设以上三个文件，都是真实的<code>so</code>库文件，而不是软连接，也就是说，上面列出的名字都是<code>real name</code></p>
<p>根据我们之前对版本号的定义，我们可以知道：</p>
<ul>
<li><code>libbar.so.1.3</code>和<code>libbar.so.1.5</code>之间是互相兼容的</li>
<li><code>libbar.so.2.1</code>和上述两个库之间互相不兼容</li>
</ul>
<p><strong>引入软连接的好处是什么呢？假设有一天，<code>libbar.so.2.1</code>库进行了升级，但<code>API</code>接口仍然保持兼容，升级后的库文件为<code>libbar.so.2.2</code>，这时候，我们只要将之前的软连接重新指向升级后的文件，然后重新启动B程序，B程序就可以使用全新版本的<code>so</code>库了，我们并不需要去重新编译链接来更新B程序</strong></p>
<p><strong>总结一下上面的逻辑：</strong></p>
<ul>
<li>通常<code>SONAME</code>是一个指向<code>real name</code>的软连接</li>
<li>应用程序中存储自己所依赖的<code>so</code>库的<code>SONAME</code>，也就是仅保证主版本号能匹配就行</li>
<li>通过修改软连接的指向，可以让应用程序在互相兼容的<code>so</code>库中方便切换使用哪一个</li>
<li>通常情况下，大家使用最新版本即可，除非是为了在特定版本下做一些调试、开发工作</li>
</ul>
<h4 id="2223-linker-name"><a class="markdownIt-Anchor" href="#2223-linker-name"></a> 2.2.2.3 linker name</h4>
<p>上一节中我们提到，可执行文件里会存储精确到主版本号的<code>SONAME</code>，但是在编译生成可执行文件的过程中，编译器怎么知道应该用哪个主版本号呢？为了回答这个问题，我们从编译链接的过程来梳理一下</p>
<p>假设我们使用<code>gcc</code>编译生成一个依赖<code>foo</code>库的可执行文件<code>A</code>：<code>gcc A.c -lfoo -o A</code></p>
<p>熟悉<code>gcc</code>编译的读者们肯定知道，上述的<code>-l</code>标记后跟随了<code>foo</code>参数，表示我们告诉<code>gcc</code>在编译的过程中需要用到一个外部的名为<code>foo</code>的库，但这里有一个问题，我们并没有说使用哪一个主版本，我们只给出了一个名字。为了解决这个问题，软链接再次发挥作用，具体流程如下：</p>
<p><strong>根据linux下动态链接库的命名规范，<code>gcc</code>会根据<code>-lfoo</code>这个标识拼接出<code>libfoo.so</code>这个文件名，这个文件名就是<code>linker name</code>，然后去尝试读取这个文件，并将这个库链接到生成的可执行文件<code>A</code>中。在执行编译前，我们可以通过软链接的形式，将<code>libfoo.so</code>指向一个具体<code>so</code>库，也就是指向一个<code>real name</code>，在编译过程中，<code>gcc</code>会从这个真实的库中读取出<code>SONAME</code>并将它写入到生成的可执行文件<code>A</code>中。例如，若<code>libfoo.so</code>指向<code>libfoo.so.1.5</code>,则生成的可执行文件A使用主版本号为<code>1</code>的<code>SONAME</code>，即<code>libfoo.so.1</code></strong></p>
<p>在上述编译过程完成之后，<code>SONAME</code>已经被写入可执行文件<code>A</code>中了，因此可以看到<code>linker name</code>仅仅在编译的过程中，可以起到指定连接那个库版本的作用，除此之外，再无其他作用</p>
<p><strong>总结一下上面的逻辑：</strong></p>
<ul>
<li>通常<code>linker name</code>是一个指向<code>real name</code>的软连接</li>
<li>通过修改软连接的指向，可以指定编译生成的可执行文件使用那个主版本号<code>so</code>库</li>
<li>编译器从软链接指向的文件里找到其<code>SONAME</code>，并将<code>SONAME</code>写入到生成的可执行文件中</li>
<li>通过改变<code>linker name</code>软连接的指向，可以将不同主版本号的<code>SONAME</code>写入到生成的可执行文件中</li>
</ul>
<h2 id="23-link-order"><a class="markdownIt-Anchor" href="#23-link-order"></a> 2.3 Link Order</h2>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45135/why-does-the-order-in-which-libraries-are-linked-sometimes-cause-errors-in-gcc">Why does the order in which libraries are linked sometimes cause errors in GCC?</a></p>
<p><strong>示例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; a.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">extern int a;</span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; b.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">extern int b;</span><br><span class="line">int a = b;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; d.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">int b;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">g++ -c b.cpp -o b.o</span><br><span class="line">ar cr libb.a b.o</span><br><span class="line">g++ -c d.cpp -o d.o</span><br><span class="line">ar cr libd.a d.o</span><br><span class="line"></span><br><span class="line">g++ -L. -ld -lb a.cpp <span class="comment"># wrong order</span></span><br><span class="line">g++ -L. -lb -ld a.cpp <span class="comment"># wrong order</span></span><br><span class="line">g++ a.cpp -L. -ld -lb <span class="comment"># wrong order</span></span><br><span class="line">g++ a.cpp -L. -lb -ld <span class="comment"># right order</span></span><br></pre></td></tr></table></figure>
<p><strong>链接器解析过程如下：从左到右扫描目标文件、库文件</strong></p>
<ul>
<li>记录未解析的符号</li>
<li>若发现某个库文件可以解决「未解析符号表」中的某个符号，则将该符号从「未解析符号表」中删除</li>
</ul>
<p><strong>因此，假设<code>libA</code>依赖<code>libB</code>，那么需要将<code>libA</code>写前面，<code>libB</code>写后面</strong></p>
<h2 id="24-environment-variables"><a class="markdownIt-Anchor" href="#24-environment-variables"></a> 2.4 Environment Variables</h2>
<p>Please refer to <code>man ld.so</code> for details:</p>
<h3 id="241-ld_preload"><a class="markdownIt-Anchor" href="#241-ld_preload"></a> 2.4.1 LD_PRELOAD</h3>
<p>Lists shared libraries that are loaded (preloaded) before any other shared libraries. This can be used to override functions in other shared objects.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; sample.c &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">int main(void) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Calling the fopen() function...\n&quot;</span>);</span><br><span class="line">    FILE *fd = fopen(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fd) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fopen() returned NULL\n&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fopen() succeeded\n&quot;</span>);</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">gcc -o sample sample.c</span><br><span class="line"></span><br><span class="line">./sample </span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Calling the fopen() <span class="keyword">function</span>...</span><br><span class="line">fopen() returned NULL</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">touch</span> test.txt</span><br><span class="line">./sample</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Calling the fopen() <span class="keyword">function</span>...</span><br><span class="line">fopen() succeeded</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; myfopen.c &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">FILE *fopen(const char *path, const char *mode) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is my fopen!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">gcc -o myfopen.so myfopen.c -Wall -fPIC -shared</span><br><span class="line"></span><br><span class="line">LD_PRELOAD=./myfopen.so ./sample</span><br><span class="line"><span class="comment">#-------------------------↓↓↓↓↓↓-------------------------</span></span><br><span class="line">Calling the fopen() <span class="keyword">function</span>...</span><br><span class="line">This is my fopen!</span><br><span class="line">fopen() returned NULL</span><br><span class="line"><span class="comment">#-------------------------↑↑↑↑↑↑-------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="242-ld_debug"><a class="markdownIt-Anchor" href="#242-ld_debug"></a> 2.4.2 LD_DEBUG</h3>
<p>Usage: <code>LD_DEBUG=&lt;type&gt; &lt;binary&gt;</code>, here are all available types.</p>
<ol>
<li><code>all</code>: Print all debugging information (except statistics and unused; see below).</li>
<li><code>bindings</code>: Display information about which definition each symbol is bound to.</li>
<li><code>files</code>: Display progress for input file.</li>
<li><code>libs</code>: Display library search paths.</li>
<li><code>reloc</code>: Display relocation processing.</li>
<li><code>scopes</code>: Display scope information.</li>
<li><code>statistics</code>: Display relocation statistics.</li>
<li><code>symbols</code>: Display search paths for each symbol look-up.</li>
<li><code>unused</code>: Determine unused DSOs.</li>
<li><code>versions</code>: Display version dependencies.</li>
</ol>
<h2 id="25-how-to-make-library"><a class="markdownIt-Anchor" href="#25-how-to-make-library"></a> 2.5 How to make library</h2>
<h3 id="251-how-to-make-static-library"><a class="markdownIt-Anchor" href="#251-how-to-make-static-library"></a> 2.5.1 How to make static library</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; foo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">foo</span></span>() &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;hello, this is foo&quot;</span> &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cat &gt; main.cpp &lt;&lt; &#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">void foo();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    foo();</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gcc -o foo.o -c foo.cpp -O3 -Wall -fPIC</span></span><br><span class="line"><span class="string">ar rcs libfoo.a foo.o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gcc -o main main.cpp -O3 -L . -lfoo -lstdc++</span></span><br><span class="line"><span class="string">./main</span></span><br></pre></td></tr></table></figure>
<h3 id="252-how-to-make-dynamic-library"><a class="markdownIt-Anchor" href="#252-how-to-make-dynamic-library"></a> 2.5.2 How to make dynamic library</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; foo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">foo</span></span>() &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;hello, this is foo&quot;</span> &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cat &gt; main.cpp &lt;&lt; &#x27;EOF&#x27;</span></span><br><span class="line"><span class="string">void foo();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    foo();</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gcc -o foo.o -c foo.cpp -O3 -Wall -fPIC</span></span><br><span class="line"><span class="string">gcc -shared -o libfoo.so foo.o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gcc -o main main.cpp -O3 -L . -lfoo -lstdc++</span></span><br><span class="line"><span class="string">./main # ./main: error while loading shared libraries: libfoo.so: cannot open shared object file: No such file or directory</span></span><br><span class="line"><span class="string">gcc -o main main.cpp -O3 -L . -Wl,-rpath=`pwd` -lfoo -lstdc++</span></span><br><span class="line"><span class="string">./main</span></span><br></pre></td></tr></table></figure>
<h2 id="26-abi"><a class="markdownIt-Anchor" href="#26-abi"></a> 2.6 ABI</h2>
<p><code>ABI</code>全称是<code>Application Binary Interface</code>，它是两个二进制模块间的接口，二进制模块可以是<code>lib</code>，可以是操作系统的基础设施，或者一个正在运行的用户程序</p>
<blockquote>
<p>An ABI defines how data structures or computational routines are accessed in machine code, which is a low-level, hardware-dependent format</p>
</blockquote>
<p><img src="/images/Cpp-Trivial/abi.png" alt="abi" /></p>
<p>具体来说，<code>ABI</code>定义了如下内容：</p>
<ol>
<li>指令集、寄存器、栈组织结构，内存访问类型等等</li>
<li>基本数据类型的<code>size</code>、<code>layout</code>、<code>alignment</code></li>
<li>调用约定，比如参数如何传递、结果如何传递
<ul>
<li>参数传递到栈中，还是传递到寄存器中</li>
<li>如果传递到寄存器中的话，哪个入参对应哪个寄存器</li>
<li>如果传递到栈中的话，第一个入参是先压栈还是后压栈</li>
<li>返回值使用哪个寄存器</li>
</ul>
</li>
<li>如何发起系统调用</li>
<li><code>lib</code>、<code>object file</code>等的文件格式</li>
</ol>
<h3 id="261-language-specific-abi"><a class="markdownIt-Anchor" href="#261-language-specific-abi"></a> 2.6.1 Language-Specific ABI</h3>
<p>摘自<a target="_blank" rel="noopener" href="https://www.quora.com/What-is-C-ABI">What is C++ ABI?</a></p>
<blockquote>
<p>Often, a platform will specify a “base ABI” that specifies how to use that platform’s basic services and that is often done in terms of C language capabilities. However, other programming languages like C++ may require support for additional mechanisms. That’s how you get to language-specific ABIs, including a variety of C++ ABIs. Among the concerns of a C++ ABI are the following:</p>
<ul>
<li>How are classes with virtual functions represented? A C++ ABI will just about always extend the C layout rules for this, and specify implicit pointers in the objects that point to static tables (“vtables”) that themselves point to virtual functions.</li>
<li>How are base classes (including virtual base classes) laid out in class objects? Again, this usually starts with the C struct layout rules.</li>
<li>How are closure classes (for lambdas) organized?</li>
<li>How is RTTI information stored?</li>
<li>How are exceptions implemented?</li>
<li>How are overloaded functions and operators “named” in object files? This is where “name mangling” usually comes in: The type of the various functions is encoded in their object file names. That also handles the “overloading” that results from template instantiations.</li>
<li>How are spilled inline functions and template instantiations handled? After all, different object files might use/spill the same instances, which could lead to collisions.</li>
</ul>
</blockquote>
<h3 id="262-dual-abi"><a class="markdownIt-Anchor" href="#262-dual-abi"></a> 2.6.2 Dual ABI</h3>
<p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html">Dual ABI</a></p>
<blockquote>
<p>In the GCC 5.1 release libstdc++ introduced a new library ABI that includes new implementations of std::string and std::list. These changes were necessary to conform to the 2011 C++ standard which forbids Copy-On-Write strings and requires lists to keep track of their size.</p>
</blockquote>
<p>宏<code>_GLIBCXX_USE_CXX11_ABI</code>用于控制使用新版本还是老版本</p>
<ul>
<li><code>_GLIBCXX_USE_CXX11_ABI = 0</code>：老版本</li>
<li><code>_GLIBCXX_USE_CXX11_ABI = 1</code>：新版本</li>
</ul>
<p>其他参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/abi.html">ABI Policy and Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/556726543">C/C++ ABI兼容那些事儿</a></li>
</ul>
<h3 id="263-abi-mismatch-issue"><a class="markdownIt-Anchor" href="#263-abi-mismatch-issue"></a> 2.6.3 ABI Mismatch Issue</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># compile works fine</span><br><span class="line">gcc -o main main.cpp -O0 -lstdc++</span><br><span class="line"></span><br><span class="line"># Errors occur at runtime</span><br><span class="line">./main</span><br><span class="line"></span><br><span class="line"># ./main: /lib64/libstdc++.so.6: version `GLIBCXX_3.4.29&#x27; not found (required by ./main)</span><br><span class="line"># ./main: /lib64/libstdc++.so.6: version `GLIBCXX_3.4.30&#x27; not found (required by ./main)</span><br><span class="line"># ./main: /lib64/libstdc++.so.6: version `CXXABI_1.3.13&#x27; not found (required by ./main)</span><br></pre></td></tr></table></figure>
<p>The errors you’re encountering at runtime indicate that your application (<code>main</code>) is linked against newer versions of the C++ standard library (<code>libstdc++</code>) and C++ ABI (<code>CXXABI</code>) than are available on your system. This typically happens when your application is compiled with a newer version of GCC than the one installed on the runtime system.</p>
<ul>
<li><code>gcc -o main main.cpp -O0 -lstdc++ -fuse-ld=gold -Wl,--verbose</code>: Check the dynamic lib path that used at link time.</li>
<li><code>ldd main</code>: Check the dynamic lib path that used at runtime.</li>
</ul>
<h2 id="27-commonly-used-librarys"><a class="markdownIt-Anchor" href="#27-commonly-used-librarys"></a> 2.7 Commonly-used Librarys</h2>
<p><strong><code>libc/glibc/glib</code>（<code>man libc/glibc</code>）</strong></p>
<ul>
<li><code>libc</code>实现了C的标准库函数，例如<code>strcpy()</code>，以及<code>POSIX</code>函数，例如系统调用<code>getpid()</code>。此外，不是所有的C标准库函数都包含在<code>libc</code>中，比如大多数<code>math</code>相关的库函数都封装在<code>libm</code>中，大多数压缩相关的库函数都封装在<code>libz</code>中
<ul>
<li>系统调用有别于普通函数，它无法被链接器解析。实现系统调用必须引入平台相关的汇编指令。我们可以通过手动实现这些汇编指令来完成系统调用，或者直接使用<code>libc</code>（它已经为我们封装好了）</li>
</ul>
</li>
<li><strong><code>glibc, GNU C Library</code>可以看做是<code>libc</code>的另一种实现，它不仅包含<code>libc</code>的所有功能还包含<code>libm</code>以及其他核心库，比如<code>libpthread</code></strong>
<ul>
<li><strong><code>glibc</code>对应的动态库的名字是<code>libc.so</code></strong></li>
<li><strong>Linux主流的发行版用的都是这个</strong></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/sources.html">The GNU C Library (glibc)</a></li>
</ul>
</li>
<li><code>glib</code>是Linux下C的一些工具库，和<code>glibc</code>没有关系</li>
</ul>
<p><strong>查看<code>glibc</code>的版本</strong></p>
<ul>
<li><code>ldd --version</code>：<code>ldd</code>隶属于<code>glibc</code>，因此<code>ldd</code>的版本就是<code>glibc</code>的版本</li>
<li><code>getconf GNU_LIBC_VERSION</code></li>
<li><code>gcc -print-file-name=libc.so</code></li>
<li><code>strings /lib64/libc.so.6 | grep GLIBC</code>：查看<code>glibc</code>的API的版本</li>
</ul>
<p><strong>其他常用动态库可以参考<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E86824_01/html/E54772/makehtml-id-7.html#scrolltoc">Library Interfaces and Headers</a>中的介绍</strong></p>
<ol>
<li><code>libdl</code>：dynamic linking library
<ul>
<li><strong><code>libdl</code>主要作用是将那些早已存在于<code>libc</code>中的<code>private dl functions</code>对外露出，便于用户实现一些特殊的需求。<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31155824/dlopen-in-libc-and-libdl">dlopen in libc and libdl</a></strong></li>
<li>可以通过<code>readelf -s /lib64/ld-linux-x86-64.so.2 | grep PRIVATE</code>查看露出的这些方法</li>
</ul>
</li>
<li><code>libm</code>：c math library</li>
<li><code>libz</code>：compression/decompression library</li>
<li><code>libpthread</code>：POSIX threads library</li>
</ol>
<h2 id="28-reference"><a class="markdownIt-Anchor" href="#28-reference"></a> 2.8 Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html">Program Library HOWTO</a></li>
<li><a target="_blank" rel="noopener" href="https://amir.rachum.com/blog/2016/09/17/shared-libraries/">Shared Libraries: Understanding Dynamic Loading</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Rpath">wiki-Rpath</a></li>
<li><a target="_blank" rel="noopener" href="https://gitlab.kitware.com/cmake/community/-/wikis/doc/cmake/RPATH-handling">RPATH handling</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/reuodut/articles/13723437.html">Linux hook：Ring3下动态链接库.so函数劫持</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/14715175/what-is-the-difference-between-ld-preload-path-and-ld-library-path">What is the difference between LD_PRELOAD_PATH and LD_LIBRARY_PATH?</a></li>
<li><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/557919/what-is-libstdc-so-6-and-glibcxx-3-4-20">What is libstdc++.so.6 and GLIBCXX_3.4.20?</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mo4776/article/details/119837501">多个gcc/glibc版本的共存及指定gcc版本的编译</a></li>
</ul>
<h1 id="3-memory-management"><a class="markdownIt-Anchor" href="#3-memory-management"></a> 3 Memory Management</h1>
<p>Virtual memory is allocated through system call <code>brk</code> and <code>mmap</code>, please refer to <a href="/2020/04/11/Linux-Memory-Management/" title="Linux-Memory-Management">Linux-Memory-Management</a> for details.</p>
<p>memory management libraries run in user mode and typically use low-level system calls for virtual memory allocation. Different libraries may employ different memory allocation algorithms to effectively manage allocated and deallocated memory blocks in the heap.</p>
<h2 id="31-tcmalloc"><a class="markdownIt-Anchor" href="#31-tcmalloc"></a> 3.1 tcmalloc</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/google/tcmalloc">tcmalloc</a></p>
<p><img src="/images/Cpp-Trivial/tcmalloc.png" alt="tcmalloc" /></p>
<p><strong>特点：</strong></p>
<ul>
<li><code>Small object allocation</code>
<ul>
<li>每个线程都会有个<code>ThreadCache</code>，用于为当前线程分配小对象</li>
<li>当其容量不足时，会从<code>CentralCache</code>获取额外的存储空间</li>
</ul>
</li>
<li><code>CentralCache allocation management</code>
<ul>
<li>用于分配大对象，大对象通常指<code>&gt;32K</code></li>
<li>当内存空间用完后，用<code>sbrk/mmap</code>从操作系统中分配内存</li>
<li>在多线程高并发的场景中，<code>CentralCache</code>中的锁竞争很容易成为瓶颈</li>
</ul>
</li>
<li><code>Recycle</code></li>
</ul>
<p><strong>如何安装：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gperftools gperftools-devel</span><br></pre></td></tr></table></figure>
<h3 id="311-heap-profile"><a class="markdownIt-Anchor" href="#311-heap-profile"></a> 3.1.1 Heap-profile</h3>
<p><strong><code>main.cpp</code>：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">create</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">malloc</span>(size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">create_destory</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* p = <span class="built_in">create</span>(size);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> loop = <span class="number">4</span>;</span><br><span class="line">    <span class="type">char</span>* a[loop];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> mega = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; loop; i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> create_size = <span class="number">1024</span> * mega;</span><br><span class="line">        <span class="built_in">create</span>(create_size);</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> malloc_size = <span class="number">1024</span> * mega;</span><br><span class="line">        a[i] = (<span class="type">char</span>*)<span class="built_in">malloc</span>(malloc_size);</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> create_destory_size = mega;</span><br><span class="line">        <span class="built_in">create_destory</span>(create_destory_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; loop; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(a[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -Wall -O3 -lstdc++ -ltcmalloc -std=gnu++17</span><br></pre></td></tr></table></figure>
<p><strong>运行：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启 heap profile 功能</span></span><br><span class="line"><span class="built_in">export</span> HEAPPROFILE=/tmp/test-profile</span><br><span class="line"></span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p><strong>输出如下：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Starting tracking the heap</span><br><span class="line">tcmalloc: large alloc 1073741824 bytes == 0x2c46000 @  0x7f6a8fd244ef 0x7f6a8fd43e76 0x400571 0x7f6a8f962555 0x4005bf</span><br><span class="line">Dumping heap profile to /tmp/test-profile.0001.heap (1024 MB allocated cumulatively, 1024 MB currently in use)</span><br><span class="line">Dumping heap profile to /tmp/test-profile.0002.heap (2048 MB allocated cumulatively, 2048 MB currently in use)</span><br><span class="line">Dumping heap profile to /tmp/test-profile.0003.heap (3072 MB allocated cumulatively, 3072 MB currently in use)</span><br><span class="line">Dumping heap profile to /tmp/test-profile.0004.heap (4096 MB allocated cumulatively, 4096 MB currently in use)</span><br><span class="line">Dumping heap profile to /tmp/test-profile.0005.heap (Exiting, 0 bytes in use)</span><br></pre></td></tr></table></figure>
<p><strong>使用<code>pprof</code>分析内存：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文本格式</span></span><br><span class="line">pprof --text ./main /tmp/test-profile.0001.heap | <span class="built_in">head</span> -30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片格式</span></span><br><span class="line">pprof --svg ./main /tmp/test-profile.0001.heap &gt; heap.svg </span><br></pre></td></tr></table></figure>
<h2 id="32-jemalloc"><a class="markdownIt-Anchor" href="#32-jemalloc"></a> 3.2 jemalloc</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc">jemalloc</a></p>
<p><img src="/images/Cpp-Trivial/jemalloc.png" alt="jemalloc" /></p>
<p><strong>特点：</strong></p>
<ul>
<li>在多核、多线程场景下，跨线程分配/释放的性能比较好</li>
<li>大量分配小对象时，所占空间会比<code>tcmalloc</code>稍多一些</li>
<li>对于大对象分配，所造成的的内存碎片会比<code>tcmalloc</code>少一些</li>
<li>内存分类粒度更细，锁比<code>tcmalloc</code>更少</li>
</ul>
<h3 id="321-install"><a class="markdownIt-Anchor" href="#321-install"></a> 3.2.1 Install</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc/blob/dev/INSTALL.md">jemalloc/INSTALL.md</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:jemalloc/jemalloc.git</span><br><span class="line"><span class="built_in">cd</span> jemalloc</span><br><span class="line">git checkout 5.3.0</span><br><span class="line"></span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr/local --enable-prof</span><br><span class="line">make -j 16</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h3 id="322-heap-profile"><a class="markdownIt-Anchor" href="#322-heap-profile"></a> 3.2.2 Heap-profile</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc/wiki/Getting-Started">Getting Started</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">alloc_1M</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">uint8_t</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">alloc_1M</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译执行：</strong></p>
<ul>
<li>
<p>方式1：隐式链接，用<code>LD_PRELOAD</code></p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -O0 -lstdc++ -std=gnu++17</span><br><span class="line">MALLOC_CONF=prof_leak:<span class="literal">true</span>,lg_prof_sample:0,prof_final:<span class="literal">true</span> LD_PRELOAD=/usr/local/lib/libjemalloc.so.2 ./main</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>方式2：显示链接</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -O0 -lstdc++ -std=gnu++17 -L`jemalloc-config --libdir` -Wl,-rpath,`jemalloc-config --libdir` -ljemalloc `jemalloc-config --libs`</span><br><span class="line">MALLOC_CONF=prof_leak:true,lg_prof_sample:0,prof_final:true ./main</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>查看：<code>jeprof --text main jeprof.145931.0.f.heap</code></strong></p>
<ul>
<li>第一列：函数直接申请的内存大小，单位MB</li>
<li>第二列：第一列占总内存的百分比</li>
<li>第三列：第二列的累积值</li>
<li>第四列：函数以及函数所有调用的函数申请的内存大小，单位MB</li>
<li>第五列：第四列占总内存的百分比</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Using local file main.</span><br><span class="line">Using local file jeprof.145931.0.f.heap.</span><br><span class="line">Total: 100.1 MB</span><br><span class="line">100.1 100.0% 100.0%    100.1 100.0% prof_backtrace_impl</span><br><span class="line">    0.0   0.0% 100.0%      0.1   0.1% _GLOBAL__sub_I_eh_alloc.cc</span><br><span class="line">    0.0   0.0% 100.0%    100.0  99.9% __libc_start_main</span><br><span class="line">    0.0   0.0% 100.0%      0.1   0.1% __static_initialization_and_destruction_0 (inline)</span><br><span class="line">    0.0   0.0% 100.0%      0.1   0.1% _dl_init_internal</span><br><span class="line">    0.0   0.0% 100.0%      0.1   0.1% _dl_start_user</span><br><span class="line">    0.0   0.0% 100.0%    100.0  99.9% _start</span><br><span class="line">    0.0   0.0% 100.0%    100.0  99.9% alloc_1M</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% imalloc (inline)</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% imalloc_body (inline)</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% je_malloc_default</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% je_prof_backtrace</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% je_prof_tctx_create</span><br><span class="line">    0.0   0.0% 100.0%    100.0  99.9% main</span><br><span class="line">    0.0   0.0% 100.0%      0.1   0.1% pool (inline)</span><br><span class="line">    0.0   0.0% 100.0%    100.1 100.0% prof_alloc_prep (inline)</span><br><span class="line">    0.0   0.0% 100.0%    100.0  99.9% void* fallback_impl</span><br></pre></td></tr></table></figure>
<h3 id="323-work-with-http"><a class="markdownIt-Anchor" href="#323-work-with-http"></a> 3.2.3 Work with http</h3>
<p>源码如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/yhirose/cpp-httplib">yhirose/cpp-httplib</a></li>
<li><code>path</code>是固定，即<code>/pprof/heap</code>以及<code>/pprof/profile</code>
<ul>
<li><code>/pprof/profile</code>的实现估计有问题，拿不到预期的结果</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libgoogle-perftools-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"></span><br><span class="line">sudo yum install gperftools-devel</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gperftools/profiler.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;httplib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint8_t</span>* <span class="title">alloc_1M</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">uint8_t</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    httplib::Server svr;</span><br><span class="line"></span><br><span class="line">    svr.<span class="built_in">Get</span>(<span class="string">&quot;/pprof/heap&quot;</span>, [](<span class="type">const</span> httplib::Request&amp;, httplib::Response&amp; res) &#123;</span><br><span class="line">        std::stringstream fname;</span><br><span class="line">        fname &lt;&lt; <span class="string">&quot;./heap.&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; <span class="built_in">rand</span>();</span><br><span class="line">        <span class="keyword">auto</span> fname_str = fname.<span class="built_in">str</span>();</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* fname_cstr = fname_str.<span class="built_in">c_str</span>();</span><br><span class="line"></span><br><span class="line">        std::string content;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">mallctl</span>(<span class="string">&quot;prof.dump&quot;</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;fname_cstr, <span class="built_in">sizeof</span>(<span class="type">const</span> <span class="type">char</span>*)) == <span class="number">0</span>) &#123;</span><br><span class="line">            std::ifstream <span class="built_in">f</span>(fname_cstr);</span><br><span class="line">            content = std::<span class="built_in">string</span>(std::<span class="built_in">istreambuf_iterator</span>&lt;<span class="type">char</span>&gt;(f), std::<span class="built_in">istreambuf_iterator</span>&lt;<span class="type">char</span>&gt;());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            content = <span class="string">&quot;dump jemalloc prof file failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.<span class="built_in">set_content</span>(content, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    svr.<span class="built_in">Get</span>(<span class="string">&quot;/pprof/profile&quot;</span>, [](<span class="type">const</span> httplib::Request&amp; req, httplib::Response&amp; res) &#123;</span><br><span class="line">        <span class="type">int</span> seconds = <span class="number">30</span>;</span><br><span class="line">        <span class="type">const</span> std::string&amp; seconds_str = req.<span class="built_in">get_param_value</span>(<span class="string">&quot;seconds&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!seconds_str.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            seconds = std::<span class="built_in">atoi</span>(seconds_str.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::ostringstream fname;</span><br><span class="line">        fname &lt;&lt; <span class="string">&quot;./profile.&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; <span class="built_in">rand</span>();</span><br><span class="line">        <span class="keyword">auto</span> fname_str = fname.<span class="built_in">str</span>();</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* fname_cstr = fname_str.<span class="built_in">c_str</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ProfilerStart</span>(fname_cstr);</span><br><span class="line">        <span class="built_in">sleep</span>(seconds);</span><br><span class="line">        <span class="built_in">ProfilerStop</span>();</span><br><span class="line"></span><br><span class="line">        std::ifstream <span class="built_in">f</span>(fname_cstr, std::ios::in);</span><br><span class="line">        std::string content;</span><br><span class="line">        <span class="keyword">if</span> (f.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            content = std::<span class="built_in">string</span>(std::<span class="built_in">istreambuf_iterator</span>&lt;<span class="type">char</span>&gt;(f), std::<span class="built_in">istreambuf_iterator</span>&lt;<span class="type">char</span>&gt;());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            content = <span class="string">&quot;dump jemalloc prof file failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.<span class="built_in">set_content</span>(content, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">t_alloc</span><span class="params">([]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            alloc_1M();</span></span></span><br><span class="line"><span class="params"><span class="function">            sleep(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    svr.<span class="built_in">listen</span>(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">16691</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Compile and run:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -O0 -lstdc++ -std=gnu++17 -L`jemalloc-config --libdir` -Wl,-rpath,`jemalloc-config --libdir` -ljemalloc `jemalloc-config --libs` -lprofiler</span><br><span class="line">MALLOC_CONF=prof_leak:<span class="literal">true</span>,lg_prof_sample:0,prof_final:<span class="literal">true</span> ./main</span><br><span class="line"></span><br><span class="line"><span class="comment"># In another terminal</span></span><br><span class="line">jeprof main localhost:16691/pprof/heap <span class="comment"># interactive mode</span></span><br><span class="line">jeprof main localhost:16691/pprof/heap --text <span class="comment"># text</span></span><br><span class="line">jeprof main localhost:16691/pprof/heap --svg &gt; main.svg <span class="comment"># graph</span></span><br><span class="line"></span><br><span class="line">jeprof main localhost:16691/pprof/profile --text --seconds=15</span><br></pre></td></tr></table></figure>
<p><strong>How to create a graph:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:16691/pprof/heap &gt; begin.heap</span><br><span class="line"><span class="built_in">sleep</span> 10</span><br><span class="line">curl http://127.0.0.1:16691/pprof/heap &gt; end.heap</span><br><span class="line">jeprof --dot --base=begin.heap ./main end.heap &gt; heap-profile.dot</span><br><span class="line">dot -Tsvg heap-profile.dot -o heap-profile.svg</span><br><span class="line">dot -Tpdf heap-profile.dot -o heap-profile.pdf</span><br></pre></td></tr></table></figure>
<h3 id="324-reference"><a class="markdownIt-Anchor" href="#324-reference"></a> 3.2.4 Reference</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg3Mjg2NjU4NA==&amp;mid=2247484507&amp;idx=1&amp;sn=0befa2bec46c3fe64807f5b79b2940d5">Jemalloc内存分配与优化实践</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/StarRocks/starrocks/pull/35322">[Feature] support heap profile using script</a></li>
</ul>
<h2 id="33-mimalloc"><a class="markdownIt-Anchor" href="#33-mimalloc"></a> 3.3 <a target="_blank" rel="noopener" href="https://github.com/microsoft/mimalloc">mimalloc</a></h2>
<h2 id="34-comparison"><a class="markdownIt-Anchor" href="#34-comparison"></a> 3.4 Comparison</h2>
<p><code>tcmalloc</code> and <code>jemalloc</code> are both memory allocators, and they are commonly used in software development to manage dynamic memory allocation in programs. However, they have different characteristics and were designed to address different issues. Here’s a comparison of the two:</p>
<ol>
<li><strong>Design Philosophy:</strong>
<ul>
<li><strong>jemalloc</strong>: Designed by Jason Evans, originally to enhance the performance of FreeBSD. jemalloc focuses on reducing memory fragmentation and improving memory allocation efficiency, especially in concurrent environments. It employs an advanced memory allocation strategy that reduces lock contention, thus improving performance in multithreaded applications.</li>
<li><strong>tcmalloc</strong>: Developed by Google, standing for “Thread-Caching Malloc”. The key feature of tcmalloc is that it provides individual memory caches for each thread. This design reduces the reliance on a global memory allocation lock, thus offering better performance in multithreaded applications.</li>
</ul>
</li>
<li><strong>Memory Allocation Strategy</strong>:
<ul>
<li><strong>jemalloc</strong>: Uses size classes to manage memory allocations, which helps in reducing memory fragmentation. It also employs a delayed recycling strategy to further optimize memory usage.</li>
<li><strong>tcmalloc</strong>: Manages memory allocations for each thread through Thread Local Storage (TLS), meaning each thread has its own small memory pool for quick allocation and deallocation.</li>
</ul>
</li>
<li><strong>Memory Fragmentation Management</strong>:
<ul>
<li><strong>jemalloc</strong>: Effectively reduces memory fragmentation through its sophisticated memory allocation strategy.</li>
<li><strong>tcmalloc</strong>: While its thread caching mechanism can boost performance, it might lead to more memory fragmentation in some scenarios.</li>
</ul>
</li>
<li><strong>Suitable Use Cases</strong>:
<ul>
<li><strong>jemalloc</strong>: Widely used in applications requiring high-performance memory management, such as databases and large multithreaded applications.</li>
<li><strong>tcmalloc</strong>: Particularly suitable for applications that frequently allocate and deallocate memory due to its high-performance thread caching feature.</li>
</ul>
</li>
</ol>
<h2 id="35-hook"><a class="markdownIt-Anchor" href="#35-hook"></a> 3.5 Hook</h2>
<h3 id="351-override-the-operator-new"><a class="markdownIt-Anchor" href="#351-override-the-operator-new"></a> 3.5.1 Override the operator new</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;new&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(std::<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Custom new called with size: &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">malloc</span>(size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* ptr)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Custom delete called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="type">void</span>* __real_malloc(<span class="type">size_t</span> c);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __wrap_malloc(<span class="type">size_t</span> c) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc called with %zu\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> __real_malloc(c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* num1 = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="type">int</span>* num2 = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">return</span> *num1 * *num2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -Wl,-wrap=malloc -lstdc++ -std=gnu++17</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<h3 id="352-wrap-operator-new-by-its-mangled-name"><a class="markdownIt-Anchor" href="#352-wrap-operator-new-by-its-mangled-name"></a> 3.5.2 Wrap operator new by its mangled name</h3>
<p>The mangled name for <code>operator new</code> with a <code>size_t</code> argument is <code>_Znwm</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="type">void</span>* __real_malloc(<span class="type">size_t</span> c);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __wrap_malloc(<span class="type">size_t</span> c) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc called with %zu\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> __real_malloc(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __real__Znwm(<span class="type">size_t</span> c); <span class="comment">// operator new</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __wrap__Znwm(<span class="type">size_t</span> c) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;operator new called with %zu\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> __real__Znwm(c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* num1 = (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    <span class="type">int</span>* num2 = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">return</span> *num1 * *num2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -Wl,-wrap=malloc -Wl,-wrap=_Znwm -lstdc++ -std=gnu++17</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<h3 id="353-work-with-library"><a class="markdownIt-Anchor" href="#353-work-with-library"></a> 3.5.3 Work With Library</h3>
<p><code>foo.cpp</code> is like this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span>* <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;hello, this is foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>main.cpp</code> is like this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span>* <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="type">void</span>* __real_malloc(<span class="type">size_t</span> c);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __wrap_malloc(<span class="type">size_t</span> c) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc called with %zu\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> __real_malloc(c);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span>* res = <span class="built_in">foo</span>();</span><br><span class="line">    res[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3531-static-linking-libraryworking"><a class="markdownIt-Anchor" href="#3531-static-linking-libraryworking"></a> 3.5.3.1 Static Linking Library(Working)</h4>
<p>And here are how to build the program.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc -o foo.o -c foo.cpp -O3 -Wall -fPIC</span><br><span class="line">ar rcs libfoo.a foo.o</span><br><span class="line">gcc -o main main.cpp -O3 -L . -Wl,-wrap=malloc -lfoo -lstdc++</span><br><span class="line"></span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p>And it prints:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello, this is foo</span><br><span class="line">malloc called with 100</span><br></pre></td></tr></table></figure>
<p>The reason why static linking works fine with the <code>-Wl,-wrap=malloc</code> hook, is because of how static linking works:</p>
<ul>
<li>In static linking, the object code (or binary code) for the functions used from the static library is embedded directly into the final executable at link-time.</li>
<li>So, when you use the <code>-Wl,-wrap=malloc</code> linker option, it can intercept and replace all calls to <code>malloc</code> in both the <code>main</code> program and any static libraries, as they are all being linked together into a single executable at the same time.</li>
<li>Essentially, the linker sees the entire code (from the main program and the static library) as one unit and can replace all calls to <code>malloc</code> with calls to <code>__wrap_malloc</code>.</li>
</ul>
<h4 id="3532-dynamic-linking-librarynot-working"><a class="markdownIt-Anchor" href="#3532-dynamic-linking-librarynot-working"></a> 3.5.3.2 Dynamic Linking library(Not Working)</h4>
<p>And here are how to build the program.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc -o foo.o -c foo.cpp -O3 -Wall -fPIC</span><br><span class="line">gcc -shared -o libfoo.so foo.o</span><br><span class="line">gcc -o main main.cpp -O3 -L . -Wl,-rpath=`<span class="built_in">pwd</span>` -Wl,-wrap=malloc  -lfoo -lstdc++</span><br><span class="line"></span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p>And it prints:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello, this is foo</span><br></pre></td></tr></table></figure>
<p>Here’s a step-by-step breakdown:</p>
<ol>
<li>When you compile <code>foo.cpp</code> into <code>foo.o</code>, there’s a call to <code>malloc</code> in the machine code, but it’s not yet resolved to an actual memory address. It’s just a placeholder that says “I want to call <code>malloc</code>”.</li>
<li>When you link <code>foo.o</code> into <code>libfoo.so</code>, the call to <code>malloc</code> inside <code>foo</code> is linked. It’s resolved to the <code>malloc</code> function provided by the C library.</li>
<li>Later, when you link <code>main.cpp</code> into an executable, you’re using the <code>-Wl,-wrap=malloc</code> option, but that only affects calls to <code>malloc</code> that are being linked at that time. The call to <code>malloc</code> inside <code>foo</code> was already linked in step 2, so it’s unaffected.</li>
</ol>
<h2 id="36-reference"><a class="markdownIt-Anchor" href="#36-reference"></a> 3.6 Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://gperftools.github.io/gperftools/heapprofile.html">heapprofile.html</a></li>
<li><a target="_blank" rel="noopener" href="https://doris.apache.org/developer-guide/debug-tool.html">Apache Doris-调试工具</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/stdpain/doris-vectorized/blob/master/docs/zh-CN/developer-guide/debug-tool.md">调试工具</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yuanguohuo.com/2019/01/02/jemalloc-heap-profiling/">jemalloc的heap profiling</a></li>
</ul>
<h1 id="4-name-mangling"><a class="markdownIt-Anchor" href="#4-name-mangling"></a> 4 Name mangling</h1>
<p>Name mangling, also known as name decoration or name encoding, is a technique used by compilers to encode the names of functions, variables, and other symbols in a program in a way that includes additional information about their types, namespaces, and sometimes other attributes. Name mangling is primarily used in languages like C++ to support features such as function overloading, function templates, and namespaces.</p>
<p>Here are some key points about name mangling:</p>
<ul>
<li><strong>Function Overloading</strong>: In C++, you can define multiple functions with the same name but different parameter lists. Name mangling ensures that these functions have distinct mangled names so the compiler can differentiate between them during the linking process.</li>
<li><strong>Template Specialization</strong>: In C++, templates allow you to write generic code that works with different types. Name mangling encodes the template arguments and specializations so that the compiler can generate the correct code for each specialization.</li>
<li><strong>Namespace Resolution</strong>: When you use namespaces to organize your code, name mangling includes the namespace information in the mangled name to avoid naming conflicts.</li>
<li><strong>Type Information</strong>: Name mangling can encode information about the types of function parameters and return values, which can be used for type checking and to resolve overloaded function calls.</li>
<li><strong>Demangling</strong>: While the mangled names generated by the compiler are not meant to be human-readable, tools and libraries exist to “demangle” these names, converting them back into their original, human-readable form for debugging and error messages.</li>
<li><strong>Compiler-Specific</strong>: The specific rules for name mangling are compiler-dependent. Different C++ compilers, such as GCC, Clang, and MSVC, may use different name mangling schemes. These schemes are not standardized by the C++ language standard.</li>
</ul>
<h2 id="41-encoding-elements"><a class="markdownIt-Anchor" href="#41-encoding-elements"></a> 4.1 Encoding Elements</h2>
<p>Name mangling (also known as name decoration) is a compiler-specific technique to encode C++ symbols into unique names. The exact format and rules for name mangling are dependent on the compiler and its version. Therefore, there isn’t a single standard for it. However, many C++ compilers follow (at least loosely) the Itanium C++ ABI for mangling names, especially on Unix-like systems.</p>
<p>Below are some common elements of name mangling based on the Itanium C++ ABI:</p>
<ol>
<li><strong>Function Names</strong>:
<ul>
<li><code>_Z</code>: Prefix for encoded names.</li>
<li><code>N</code>: Begins a nested name.</li>
<li><code>E</code>: Ends a nested name.</li>
</ul>
</li>
<li><strong>Namespace and Class Names</strong>:
<ul>
<li>Length of the name followed by the actual name. E.g., <code>5Outer</code> for <code>Outer</code>.</li>
</ul>
</li>
<li><strong>Types</strong>:
<ul>
<li><code>i</code>: int</li>
<li><code>l</code>: long</li>
<li><code>s</code>: short</li>
<li><code>d</code>: double</li>
<li><code>f</code>: float</li>
<li><code>c</code>: char</li>
<li><code>b</code>: bool</li>
<li><code>v</code>: void</li>
<li><code>P</code>: Pointer to a type (e.g., <code>Pi</code> is pointer to int)</li>
<li><code>R</code>: Reference</li>
<li><code>O</code>: rvalue reference</li>
<li><code>C1</code>, <code>C2</code>: Constructor</li>
<li><code>D1</code>, <code>D2</code>: Destructor</li>
</ul>
</li>
<li><strong>Template Classes</strong>:
<ul>
<li><code>I</code>: Marks the beginning of template arguments.</li>
<li><code>E</code>: Marks the end of template arguments.</li>
</ul>
</li>
<li><strong>Const/Volatile qualifiers</strong>:
<ul>
<li><code>K</code>: const</li>
<li><code>V</code>: volatile</li>
<li><code>r</code>: restrict (from C99)</li>
</ul>
</li>
<li><strong>Function Arguments</strong>:
<ul>
<li>Encoded in order, using their type encodings.</li>
</ul>
</li>
<li><strong>Arrays</strong>:
<ul>
<li>The size followed by the type, e.g., <code>A10_i</code> for <code>int[10]</code>.</li>
</ul>
</li>
<li><strong>Modifiers</strong>:
<ul>
<li><code>U</code>: Vendor-specific type qualifier.</li>
</ul>
</li>
<li><strong>Special Names</strong>:
<ul>
<li><code>_vt</code>: Virtual table</li>
<li><code>_qt</code>: Virtual table for a qualified name</li>
</ul>
</li>
<li><strong>Operators</strong>:
<ul>
<li>Most operators get their own special mangled name, e.g., <code>_pl</code> for <code>operator+</code>.</li>
</ul>
</li>
<li><strong>CV Qualifiers</strong>:
<ul>
<li><code>K</code>: <code>const</code></li>
<li><code>V</code>: <code>volatile</code></li>
</ul>
</li>
<li><strong>Calling Convention</strong>:
<ul>
<li>While the Itanium ABI doesn’t specify mangling for calling conventions (because it’s designed for architectures with a single calling convention), some other mangling schemes might have special symbols for this.</li>
</ul>
</li>
<li><strong>Other Features</strong>:
<ul>
<li><code>S</code>: String literal</li>
<li>And various encodings for other built-in types, custom types, etc.</li>
</ul>
</li>
</ol>
<h2 id="42-example"><a class="markdownIt-Anchor" href="#42-example"></a> 4.2 Example</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Outer::Inner &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Foo</span>(T value) : <span class="built_in">data</span>(value) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">()</span> <span class="type">const</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func_no_arg</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func_void</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func_one_arg</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func_one_arg</span><span class="params">(<span class="type">double</span> x)</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func_one_arg</span><span class="params">(<span class="type">long</span>&amp; x)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace Outer::Inner</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Outer::<span class="function">Inner::Foo&lt;<span class="type">int</span>&gt; <span class="title">foo</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line">    foo.<span class="built_in">bar</span>();</span><br><span class="line">    <span class="type">const</span> Outer::<span class="function">Inner::Foo&lt;<span class="type">int</span>&gt; <span class="title">cfoo</span><span class="params">(<span class="number">6</span>)</span></span>;</span><br><span class="line">    cfoo.<span class="built_in">bar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gcc-12.3.0</span></span><br><span class="line">$ gcc -o main main.cpp -lstdc++ -std=gnu++17 -g -ggdb -O0 &amp;&amp; nm main | grep <span class="string">&#x27;_Z&#x27;</span></span><br><span class="line"></span><br><span class="line">0000000000001149 T _ZN5Outer5Inner11func_no_argEv</span><br><span class="line">000000000000116d T _ZN5Outer5Inner12func_one_argEd</span><br><span class="line">000000000000115f T _ZN5Outer5Inner12func_one_argEi</span><br><span class="line">000000000000117d T _ZN5Outer5Inner12func_one_argERl</span><br><span class="line">000000000000123e W _ZN5Outer5Inner3FooIiE3barEv</span><br><span class="line">0000000000001222 W _ZN5Outer5Inner3FooIiEC1Ei</span><br><span class="line">0000000000001222 W _ZN5Outer5Inner3FooIiEC2Ei</span><br><span class="line">000000000000119d T _ZN5Outer5Inner5func2Edd</span><br><span class="line">000000000000118c T _ZN5Outer5Inner5func2Eii</span><br><span class="line">0000000000001154 T _ZN5Outer5Inner9func_voidEv</span><br><span class="line">000000000000124e W _ZNK5Outer5Inner3FooIiE3barEv</span><br></pre></td></tr></table></figure>
<h1 id="5-address-sanitizer"><a class="markdownIt-Anchor" href="#5-address-sanitizer"></a> 5 Address Sanitizer</h1>
<p>Address Sanitizer (ASan) has its origins in Google. The project was started as a way to improve the detection of memory-related bugs, which have historically been some of the most elusive and difficult-to-diagnose issues in software development.</p>
<p>Here’s a brief history of Address Sanitizer:</p>
<ol>
<li><strong>Early 2010s Origin</strong>: Address Sanitizer was developed by Konstantin Serebryany, Dmitry Vyukov, and other contributors at Google. The initial focus was on detecting memory issues in C++ programs, but the tool’s capabilities expanded over time.</li>
<li><strong>Release and Integration with Major Compilers</strong>: After its development, Address Sanitizer was integrated into major compilers. Clang was one of the first compilers to support ASan, and later, it was incorporated into GCC (GNU Compiler Collection). The ease of use—simply adding a compiler flag—made it very attractive for developers to adopt.</li>
<li><strong>Chromium Adoption</strong>: One of the early and significant adoptions of ASan was in the Chromium project (the open-source foundation of the Chrome browser). Given the scale and complexity of this project, and the potential security implications of memory bugs in a web browser, ASan proved to be an invaluable tool for ensuring the robustness and safety of the code.</li>
<li><strong>Expanding Beyond Address Sanitizer</strong>: The success of ASan led to the development of other “sanitizers” such as Thread Sanitizer (TSan) for detecting data races, Memory Sanitizer (MSan) for uninitialized memory reads, and Undefined Behavior Sanitizer (UBSan) for undefined behavior checks.</li>
<li><strong>Integration in Development Ecosystems</strong>: As ASan’s popularity grew, it found its way into various development ecosystems. Debugging tools, continuous integration systems, and even some integrated development environments (IDEs) began offering first-class support for ASan and related tools.</li>
<li><strong>Widening Support</strong>: Beyond just C++ and C, ASan also found applicability in other languages and platforms where the underlying memory model had similarities, further broadening its reach and impact.</li>
</ol>
<p>It is a tool that can help developers find memory-related issues in their programs, such as:</p>
<ol>
<li><strong>Use-after-free</strong>: Detects when a program uses memory after it has been freed.</li>
<li><strong>Heap buffer overflow</strong>: Detects when a program writes past the end of an allocated object on the heap.</li>
<li><strong>Stack buffer overflow</strong>: Detects when a program writes past the end of an allocated object on the stack.</li>
<li><strong>Global buffer overflow</strong>: Similar to the above but for global variables.</li>
<li><strong>Memory leaks</strong>: Identifies instances where memory is allocated but not freed, resulting in memory being lost until the program ends.</li>
<li><strong>Use-after-scope</strong>: Detects the usage of local variables outside of their scope.</li>
<li><strong>Initialization errors</strong>: Finds reads from uninitialized memory locations.</li>
</ol>
<p>Address Sanitizer achieves this by instrumenting the binary code. When compiling code with Address Sanitizer enabled, the compiler (e.g., Clang or GCC) will insert additional checks around memory operations. Additionally, Address Sanitizer uses a shadow memory mechanism to keep track of the status (e.g., allocated, deallocated) of each byte in the application’s memory.</p>
<p>Because of this instrumentation, programs compiled with Address Sanitizer tend to run slower and use more memory than their non-instrumented counterparts. However, the benefits in terms of finding and fixing memory-related bugs can be substantial.</p>
<p>To use Address Sanitizer, developers typically pass the <code>-fsanitize=address</code> flag (and sometimes additional flags) when compiling and linking their code.</p>
<p>Remember, Address Sanitizer is not a substitute for other types of testing or for manual code review. However, when combined with other testing methodologies, it can be a powerful tool in a developer’s arsenal for ensuring software reliability and security.</p>
<h2 id="51-how-it-works"><a class="markdownIt-Anchor" href="#51-how-it-works"></a> 5.1 How it works</h2>
<p>Here’s an in-depth breakdown of how it works:</p>
<ol>
<li><strong>Compile-time Instrumentation</strong>:
<ul>
<li>When a program is compiled with ASan enabled (e.g., using the -fsanitize=address flag), the compiler inserts extra instructions around memory operations. These instructions help in checking for memory-related issues.</li>
<li>This instrumentation helps the runtime component of ASan understand memory accesses and allocations/deallocations.</li>
</ul>
</li>
<li><strong>Shadow Memory</strong>:
<ul>
<li>ASan uses a concept called “shadow memory” to keep track of each byte of the application’s memory.</li>
<li>For every 8 bytes of application memory, there’s a corresponding byte in the shadow memory. This shadow byte holds metadata about the status of those 8 bytes (whether they are allocated, deallocated, part of a redzone, etc.).</li>
<li>Using shadow memory, ASan can quickly check the status of a memory location whenever the program accesses it. For example, if a program accesses memory that corresponds to a shadow byte indicating it’s deallocated, ASan can immediately flag a use-after-free error.</li>
</ul>
</li>
<li><strong>Redzones</strong>:
<ul>
<li>ASan places “redzones” (extra bytes) around allocated memory. These redzones are used to detect out-of-bounds accesses.</li>
<li>If the program accesses memory inside a redzone, it indicates a buffer overflow or underflow.</li>
</ul>
</li>
<li>**Allocation and Deallocation:
<ul>
<li>ASan replaces the standard memory allocation and deallocation functions (like malloc and free in C).</li>
<li>When memory is allocated, ASan also sets up the corresponding shadow memory and redzones. When memory is deallocated, it is poisoned (marked in a way that any access will be flagged by ASan), helping detect use-after-free bugs.</li>
</ul>
</li>
<li><strong>Memory Leak Detection</strong>:
<ul>
<li>ASan can also track allocations that were never deallocated. At the end of the program’s execution, it can report these as memory leaks.</li>
</ul>
</li>
<li><strong>Reporting</strong>:
<ul>
<li>When ASan detects an error, it immediately halts the program and provides a detailed report. This report typically includes the type of error (e.g., buffer overflow), the memory address where the error occurred, and a stack trace, helping developers pinpoint and understand the cause.</li>
</ul>
</li>
<li><strong>Performance Impact</strong>:
<ul>
<li>ASan’s checks and shadow memory mechanism introduce overhead. Programs compiled with ASan typically run slower (often around 2x) and consume more memory than their non-instrumented counterparts.</li>
<li>It’s important to understand that while ASan can detect a variety of memory errors, it’s not foolproof. For example, it might not detect all memory leaks, especially if they involve complex data structures. However, its ability to catch many common and critical memory errors makes it a valuable tool for developers.</li>
</ul>
</li>
</ol>
<p>When you compile your program with Address Sanitizer (ASan) enabled, the standard memory allocation and deallocation functions like <code>malloc</code>, <code>free</code>, <code>new</code>, and <code>delete</code> get intercepted or “wrapped” by ASan. This means that when your program calls <code>malloc</code>, it’s actually calling ASan’s version of <code>malloc</code>.</p>
<p>This interception is crucial for how ASan functions. Here’s why:</p>
<ol>
<li><strong>Setting up Redzones</strong>: When memory is allocated, ASan’s version of <code>malloc</code> (or <code>new</code> for C++) can add “redzones” around the allocated memory. These redzones help in detecting out-of-bounds accesses.</li>
<li><strong>Shadow Memory Management</strong>: ASan maintains a shadow memory that maps to your program’s memory to track the state of each byte (e.g., allocated, deallocated). When memory is allocated or deallocated, ASan’s version of the memory functions update the shadow memory accordingly.</li>
<li><strong>Poisoning Memory</strong>: When memory is deallocated using ASan’s <code>free</code> or <code>delete</code>, the memory isn’t immediately returned to the system. Instead, it is “poisoned”. This means that any subsequent access to this memory will raise an error, helping in detecting use-after-free bugs.</li>
<li><strong>Memory Leak Detection</strong>: By intercepting these calls, ASan can also maintain a list of all current allocations. When the program exits, it checks this list to report any memory that hasn’t been deallocated, indicating a memory leak.</li>
</ol>
<p>Here’s an example to illustrate the mechanism:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello AddressSanitizer!\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dynamic link</span></span><br><span class="line">gcc -o main main.cpp -lstdc++ -std=gnu++17 -fsanitize=address</span><br><span class="line"></span><br><span class="line">objdump -p main | grep NEEDED</span><br><span class="line">  NEEDED               libasan.so.8</span><br><span class="line">  NEEDED               libstdc++.so.6</span><br><span class="line">  NEEDED               libc.so.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># It shows that the call malloc was redirect to libasan.so.8</span></span><br><span class="line">LD_DEBUG=<span class="string">&quot;bindings&quot;</span> ./main 2&gt; bind.txt &amp;&amp; <span class="built_in">cat</span> bind.txt | grep malloc</span><br><span class="line">Hello AddressSanitizer!</span><br><span class="line">   2623584:	binding file /lib/x86_64-linux-gnu/libc.so.6 [0] to /lib/x86_64-linux-gnu/libasan.so.8 [0]: normal symbol `malloc<span class="string">&#x27; [GLIBC_2.2.5]</span></span><br><span class="line"><span class="string">   2623584:	binding file ./main [0] to /lib/x86_64-linux-gnu/libasan.so.8 [0]: normal symbol `malloc&#x27;</span> [GLIBC_2.2.5]</span><br><span class="line">   2623584:	binding file /lib/x86_64-linux-gnu/libstdc++.so.6 [0] to /lib/x86_64-linux-gnu/libasan.so.8 [0]: normal symbol `malloc<span class="string">&#x27; [GLIBC_2.2.5]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># static link</span></span><br><span class="line">gcc -o main main.cpp -lstdc++ -std=gnu++17 -fsanitize=address -static-libasan</span><br><span class="line"></span><br><span class="line">objdump -p main | grep NEEDED</span><br><span class="line">  NEEDED               libstdc++.so.6</span><br><span class="line">  NEEDED               libm.so.6</span><br><span class="line">  NEEDED               libgcc_s.so.1</span><br><span class="line">  NEEDED               libc.so.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># It shows that the call malloc was redirect to main itself</span></span><br><span class="line">LD_DEBUG=<span class="string">&quot;bindings&quot;</span> ./main 2&gt; bind.txt &amp;&amp; <span class="built_in">cat</span> bind.txt | grep malloc</span><br><span class="line">Hello AddressSanitizer!</span><br><span class="line">   2624551:	binding file /lib/x86_64-linux-gnu/libc.so.6 [0] to ./main [0]: normal symbol `malloc<span class="string">&#x27; [GLIBC_2.2.5]</span></span><br><span class="line"><span class="string">   2624551:	binding file ./main [0] to ./main [0]: normal symbol `malloc&#x27;</span> [GLIBC_2.2.5]</span><br><span class="line">   2624551:	binding file /lib/x86_64-linux-gnu/libstdc++.so.6 [0] to ./main [0]: normal symbol `malloc<span class="string">&#x27; [GLIBC_2.2.5]</span></span><br></pre></td></tr></table></figure>
<h2 id="52-memory-leak"><a class="markdownIt-Anchor" href="#52-memory-leak"></a> 5.2 memory leak</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; test_memory_leak.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    int *p = new int(5);</span><br><span class="line">    std::cout &lt;&lt; *p &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">gcc test_memory_leak.cpp -o test_memory_leak -g -lstdc++ -fsanitize=address -static-libasan</span></span><br><span class="line"><span class="string">./test_memory_leak</span></span><br></pre></td></tr></table></figure>
<h2 id="53-stack-buffer-underflow"><a class="markdownIt-Anchor" href="#53-stack-buffer-underflow"></a> 5.3 stack buffer underflow</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; test_stack_buffer_underflow.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    char buffer[5] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    uint8_t num = 5;</span><br><span class="line"></span><br><span class="line">    buffer[-1] = 7;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; (void*)buffer &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">    std</span>::cout &lt;&lt; (void*)&amp;buffer[-1] &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">    std</span>::cout &lt;&lt; (void*)&amp;num &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">    std</span>::cout &lt;&lt; (uint32_t)num &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 非asan模式</span></span><br><span class="line"><span class="string">gcc test_stack_buffer_underflow.cpp -o test_stack_buffer_underflow -g -lstdc++ </span></span><br><span class="line"><span class="string">./test_stack_buffer_underflow</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># asan模式</span></span><br><span class="line"><span class="string">gcc test_stack_buffer_underflow.cpp -o test_stack_buffer_underflow -g -lstdc++ -fsanitize=address -static-libasan</span></span><br><span class="line"><span class="string">./test_stack_buffer_underflow</span></span><br></pre></td></tr></table></figure>
<h2 id="54-reference"><a class="markdownIt-Anchor" href="#54-reference"></a> 5.4 Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41644391/article/details/103450401">c++ Asan(address-sanitize)的配置和使用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.osc.edu/resources/getting_started/howto/howto_use_address_sanitizer">HOWTO: Use Address Sanitizer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/sanitizers">google/sanitizers</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg3Mjg2NjU4NA==&amp;mid=2247483868&amp;idx=1&amp;sn=a85112e88cd187e27f418ff044247956&amp;chksm=cee9f7abf99e7ebdac55e36077b4f915bccbe33a8a6ee9920136a1dc9598e2ae62bb95d3a25f&amp;scene=21#wechat_redirect">深入浅出 Sanitizer Interceptor 机制</a></li>
</ul>
<h1 id="6-user-defined-thread"><a class="markdownIt-Anchor" href="#6-user-defined-thread"></a> 6 User-defined Thread</h1>
<p><code>jump_fcontext</code> and <code>make_fcontext</code> is copy from <a target="_blank" rel="noopener" href="https://github.com/apache/brpc/blob/master/src/bthread/context.h">context.h</a> and <a target="_blank" rel="noopener" href="https://github.com/apache/brpc/blob/master/src/bthread/context.cpp">context.cpp</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>* <span class="type">fcontext_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="function"><span class="type">intptr_t</span> <span class="title">jump_fcontext</span><span class="params">(<span class="type">fcontext_t</span>* ofc, <span class="type">fcontext_t</span> nfc, <span class="type">intptr_t</span> vp, <span class="type">bool</span> preserve_fpu = <span class="literal">false</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">fcontext_t</span> <span class="title">make_fcontext</span><span class="params">(<span class="type">void</span>* sp, <span class="type">size_t</span> size, <span class="type">void</span> (*fn)(<span class="type">intptr_t</span>))</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__asm(<span class="string">&quot;.text\n&quot;</span>                         <span class="comment">// Section for code</span></span><br><span class="line">      <span class="string">&quot;.globl jump_fcontext\n&quot;</span>          <span class="comment">// Globally visible symbol</span></span><br><span class="line">      <span class="string">&quot;.type jump_fcontext,@function\n&quot;</span> <span class="comment">// Specifies the symbol type</span></span><br><span class="line">      <span class="string">&quot;.align 16\n&quot;</span>                     <span class="comment">// Aligns the code at 16-byte boundaries</span></span><br><span class="line">      <span class="string">&quot;jump_fcontext:\n&quot;</span>                <span class="comment">// Start of function named &#x27;jump_fcontext&#x27;</span></span><br><span class="line">      <span class="string">&quot;    pushq  %rbp  \n&quot;</span>             <span class="comment">// Pushes base pointer onto the stack</span></span><br><span class="line">      <span class="string">&quot;    pushq  %rbx  \n&quot;</span>             <span class="comment">// Pushes bx register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    pushq  %r15  \n&quot;</span>             <span class="comment">// Pushes r15 register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    pushq  %r14  \n&quot;</span>             <span class="comment">// Pushes r14 register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    pushq  %r13  \n&quot;</span>             <span class="comment">// Pushes r13 register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    pushq  %r12  \n&quot;</span>             <span class="comment">// Pushes r12 register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    leaq  -0x8(%rsp), %rsp\n&quot;</span>    <span class="comment">// Decrement the stack pointer by 8 bytes (allocate stack memory)</span></span><br><span class="line">      <span class="string">&quot;    cmp  $0, %rcx\n&quot;</span>             <span class="comment">// Compare rcx register with 0</span></span><br><span class="line">      <span class="string">&quot;    je  1f\n&quot;</span>                    <span class="comment">// If rcx == 0, jump to label 1</span></span><br><span class="line">      <span class="string">&quot;    stmxcsr  (%rsp)\n&quot;</span>           <span class="comment">// Store the contents of the MXCSR register onto the stack</span></span><br><span class="line">      <span class="string">&quot;    fnstcw   0x4(%rsp)\n&quot;</span>        <span class="comment">// Store the control word of FPU onto the stack</span></span><br><span class="line">      <span class="string">&quot;1:\n&quot;</span></span><br><span class="line">      <span class="string">&quot;    movq  %rsp, (%rdi)\n&quot;</span> <span class="comment">// Save current stack pointer to location pointed by rdi</span></span><br><span class="line">      <span class="string">&quot;    movq  %rsi, %rsp\n&quot;</span>   <span class="comment">// Set stack pointer to value in rsi</span></span><br><span class="line">      <span class="string">&quot;    cmp  $0, %rcx\n&quot;</span>      <span class="comment">// Compare rcx register with 0</span></span><br><span class="line">      <span class="string">&quot;    je  2f\n&quot;</span>             <span class="comment">// If rcx == 0, jump to label 2</span></span><br><span class="line">      <span class="string">&quot;    ldmxcsr  (%rsp)\n&quot;</span>    <span class="comment">// Load value from the stack into the MXCSR register</span></span><br><span class="line">      <span class="string">&quot;    fldcw  0x4(%rsp)\n&quot;</span>   <span class="comment">// Load control word into FPU</span></span><br><span class="line">      <span class="string">&quot;2:\n&quot;</span></span><br><span class="line">      <span class="string">&quot;    leaq  0x8(%rsp), %rsp\n&quot;</span>               <span class="comment">// Increment the stack pointer by 8 bytes (deallocate stack memory)</span></span><br><span class="line">      <span class="string">&quot;    popq  %r12  \n&quot;</span>                        <span class="comment">// Restore r12 register from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %r13  \n&quot;</span>                        <span class="comment">// Restore r13 register from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %r14  \n&quot;</span>                        <span class="comment">// Restore r14 register from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %r15  \n&quot;</span>                        <span class="comment">// Restore r15 register from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %rbx  \n&quot;</span>                        <span class="comment">// Restore bx register from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %rbp  \n&quot;</span>                        <span class="comment">// Restore base pointer from the stack</span></span><br><span class="line">      <span class="string">&quot;    popq  %r8\n&quot;</span>                           <span class="comment">// Restore r8 register from the stack</span></span><br><span class="line">      <span class="string">&quot;    movq  %rdx, %rax\n&quot;</span>                    <span class="comment">// Copy value from rdx to rax</span></span><br><span class="line">      <span class="string">&quot;    movq  %rdx, %rdi\n&quot;</span>                    <span class="comment">// Copy value from rdx to rdi</span></span><br><span class="line">      <span class="string">&quot;    jmp  *%r8\n&quot;</span>                           <span class="comment">// Jump to the address in r8</span></span><br><span class="line">      <span class="string">&quot;.size jump_fcontext,.-jump_fcontext\n&quot;</span>     <span class="comment">// Specifies the size of jump_fcontext function</span></span><br><span class="line">      <span class="string">&quot;.section .note.GNU-stack,\&quot;\&quot;,%progbits\n&quot;</span> <span class="comment">// Stack properties note for linkers</span></span><br><span class="line">      <span class="string">&quot;.previous\n&quot;</span>);                             <span class="comment">// Return to previous section</span></span><br><span class="line"></span><br><span class="line">__asm(<span class="string">&quot;.text\n&quot;</span>                         <span class="comment">// Section for code</span></span><br><span class="line">      <span class="string">&quot;.globl make_fcontext\n&quot;</span>          <span class="comment">// Globally visible symbol</span></span><br><span class="line">      <span class="string">&quot;.type make_fcontext,@function\n&quot;</span> <span class="comment">// Specifies the symbol type</span></span><br><span class="line">      <span class="string">&quot;.align 16\n&quot;</span>                     <span class="comment">// Aligns the code at 16-byte boundaries</span></span><br><span class="line">      <span class="string">&quot;make_fcontext:\n&quot;</span>                <span class="comment">// Start of function named &#x27;make_fcontext&#x27;</span></span><br><span class="line">      <span class="string">&quot;    movq  %rdi, %rax\n&quot;</span>          <span class="comment">// Copy the value of rdi into rax</span></span><br><span class="line">      <span class="string">&quot;    andq  $-16, %rax\n&quot;</span>          <span class="comment">// Align rax to the nearest lower 16-byte boundary</span></span><br><span class="line">      <span class="string">&quot;    leaq  -0x48(%rax), %rax\n&quot;</span>   <span class="comment">// Decrement rax by 72 bytes (0x48) (allocate stack memory)</span></span><br><span class="line">      <span class="string">&quot;    movq  %rdx, 0x38(%rax)\n&quot;</span>    <span class="comment">// Store the value of rdx at memory address rax + 56 bytes (0x38)</span></span><br><span class="line">      <span class="string">&quot;    stmxcsr  (%rax)\n&quot;</span>           <span class="comment">// Store the contents of the MXCSR register at the address in rax</span></span><br><span class="line">      <span class="string">&quot;    fnstcw   0x4(%rax)\n&quot;</span>        <span class="comment">// Store the control word of FPU at memory address rax + 4 bytes</span></span><br><span class="line">      <span class="string">&quot;    leaq  finish(%rip), %rcx\n&quot;</span>  <span class="comment">// Load the address of the `finish` label into rcx</span></span><br><span class="line">      <span class="string">&quot;    movq  %rcx, 0x40(%rax)\n&quot;</span>    <span class="comment">// Store the address from rcx at memory address rax + 64 bytes (0x40)</span></span><br><span class="line">      <span class="string">&quot;    ret \n&quot;</span>                      <span class="comment">// Return from the function</span></span><br><span class="line">      <span class="string">&quot;finish:\n&quot;</span>                       <span class="comment">// Label &#x27;finish&#x27;</span></span><br><span class="line">      <span class="string">&quot;    xorq  %rdi, %rdi\n&quot;</span>          <span class="comment">// Zero out the rdi register</span></span><br><span class="line">      <span class="string">&quot;    call  _exit@PLT\n&quot;</span>           <span class="comment">// Call the exit function to terminate</span></span><br><span class="line">      <span class="string">&quot;    hlt\n&quot;</span>                       <span class="comment">// Halt the processor (This should never be reached due to the above _exit call)</span></span><br><span class="line">      <span class="string">&quot;.size make_fcontext,.-make_fcontext\n&quot;</span>     <span class="comment">// Specifies the size of make_fcontext function</span></span><br><span class="line">      <span class="string">&quot;.section .note.GNU-stack,\&quot;\&quot;,%progbits\n&quot;</span> <span class="comment">// Stack properties note for linkers</span></span><br><span class="line">      <span class="string">&quot;.previous\n&quot;</span>);                             <span class="comment">// Return to previous section</span></span><br><span class="line"></span><br><span class="line"><span class="type">fcontext_t</span> ctx_main;</span><br><span class="line"><span class="type">fcontext_t</span> ctx1;</span><br><span class="line"><span class="type">fcontext_t</span> ctx2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">(<span class="type">intptr_t</span>)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func1 step1, jump to func2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx1, ctx2, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func1 step2, jump to func2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx1, ctx2, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func1 step3, jump to func2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx1, ctx2, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func1 step4, jump to func2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx1, ctx2, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func1 step5, jump to func2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx1, ctx2, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">(<span class="type">intptr_t</span>)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func2 step1, jump to func1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx2, ctx1, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func2 step2, jump to func1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx2, ctx1, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func2 step3, jump to func1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx2, ctx1, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func2 step4, jump to func1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx2, ctx1, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;func2 step5, jump to main&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx2, ctx_main, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> sp1[<span class="number">4096</span>];</span><br><span class="line">    <span class="type">char</span> sp2[<span class="number">4096</span>];</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;create ctx1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    ctx1 = <span class="built_in">make_fcontext</span>(sp1 + <span class="built_in">sizeof</span>(sp1), <span class="built_in">sizeof</span>(sp1), &amp;func1);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;create ctx2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    ctx2 = <span class="built_in">make_fcontext</span>(sp2 + <span class="built_in">sizeof</span>(sp2), <span class="built_in">sizeof</span>(sp2), &amp;func2);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;start, jump to func1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">jump_fcontext</span>(&amp;ctx_main, ctx1, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;end, back to main&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create ctx1</span><br><span class="line">create ctx2</span><br><span class="line">start, jump to func1</span><br><span class="line">func1 step1, jump to func2</span><br><span class="line">func2 step1, jump to func1</span><br><span class="line">func1 step2, jump to func2</span><br><span class="line">func2 step2, jump to func1</span><br><span class="line">func1 step3, jump to func2</span><br><span class="line">func2 step3, jump to func1</span><br><span class="line">func1 step4, jump to func2</span><br><span class="line">func2 step4, jump to func1</span><br><span class="line">func1 step5, jump to func2</span><br><span class="line">func2 step5, jump to main</span><br><span class="line">end, back to main</span><br></pre></td></tr></table></figure>
<h1 id="7-gnu-tools"><a class="markdownIt-Anchor" href="#7-gnu-tools"></a> 7 GNU Tools</h1>
<ol>
<li><code>ld</code>：the GNU linker</li>
<li><code>as</code>：the GNU assembler</li>
<li><code>gold</code>：a new, faster, ELF only linker</li>
<li><code>addr2line</code>：Converts addresses into filenames and line numbers</li>
<li><code>ar</code>：A utility for creating, modifying and extracting from archives</li>
<li><code>c++filt</code> - Filter to demangle encoded C++ symbols.</li>
<li><code>dlltool</code> - Creates files for building and using DLLs.</li>
<li><code>elfedit</code> - Allows alteration of ELF format files.</li>
<li><code>gprof</code> - Displays profiling information.</li>
<li><code>nlmconv</code> - Converts object code into an NLM.</li>
<li><code>nm</code> - Lists symbols from object files.</li>
<li><code>objcopy</code> - Copies and translates object files.</li>
<li><code>objdump</code> - Displays information from object files.</li>
<li><code>ranlib</code> - Generates an index to the contents of an archive.</li>
<li><code>readelf</code> - Displays information from any ELF format object file.</li>
<li><code>size</code> - Lists the section sizes of an object or archive file.</li>
<li><code>strings</code> - Lists printable strings from files.</li>
<li><code>strip</code> - Discards symbols.</li>
<li><code>windmc</code> - A Windows compatible message compiler.</li>
<li><code>windres</code> - A compiler for Windows resource files.</li>
</ol>
<h2 id="71-gcc"><a class="markdownIt-Anchor" href="#71-gcc"></a> 7.1 gcc</h2>
<p><strong>常用参数说明：</strong></p>
<ol>
<li><strong>文件类型</strong>
<ul>
<li><code>-E</code>：生成预处理文件（<code>.i</code>）</li>
<li><code>-S</code>：生成汇编文件（<code>.s</code>）
<ul>
<li><code>-fverbose-asm</code>：带上一些注释信息</li>
</ul>
</li>
<li><code>-c</code>：生成目标文件（<code>.o</code>）</li>
<li>默认生成可执行文件</li>
</ul>
</li>
<li><strong>优化级别</strong>
<ol>
<li><code>-O0</code>（默认）：不做任何优化</li>
<li><code>-O/-O1</code>：在不影响编译速度的前提下，尽量采用一些优化算法降低代码大小和可执行代码的运行速度</li>
<li><code>-O2</code>：该优化选项会牺牲部分编译速度，除了执行<code>-O1</code>所执行的所有优化之外，还会采用几乎所有的目标配置支持的优化算法，用以提高目标代码的运行速度</li>
<li><code>-O3</code>：该选项除了执行<code>-O2</code>所有的优化选项之外，一般都是采取很多向量化算法，提高代码的并行执行程度，利用现代CPU中的流水线，<code>Cache</code>等</li>
</ol>
<ul>
<li>不同优化等级对应开启的优化参数参考<code>man page</code></li>
</ul>
</li>
<li><strong>调试</strong>
<ul>
<li><code>-gz[=type]</code>：对于<code>DWARF</code>格式的文件中的调试部分按照指定的压缩方式进行压缩</li>
<li><code>-g</code>：生成调试信息</li>
<li><code>-ggdb</code>：生成<code>gdb</code>专用的调试信息</li>
<li><code>-gdwarf</code>/<code>-gdwarf-version</code>：生成<code>DWARF</code>格式的调试信息，<code>version</code>的可选值有<code>2/3/4/5</code>，默认是4</li>
</ul>
</li>
<li><strong><code>-print-search-dirs</code>：打印搜索路径</strong></li>
<li><strong><code>-I &lt;path&gt;</code>：增加头文件搜索路径</strong>
<ul>
<li>可以并列使用多个<code>-I</code>参数，例如<code>-I path1 -I path2</code></li>
</ul>
</li>
<li><strong><code>-L &lt;path&gt;</code>：增加库文件搜索路径</strong></li>
<li><strong><code>-l&lt;lib_name&gt;</code>：增加库文件</strong>
<ul>
<li>搜索指定名称的静态或者动态库，如果同时存在，默认选择动态库</li>
<li>例如<code>-lstdc++</code>、<code>-lpthread</code></li>
</ul>
</li>
<li><strong><code>-std=&lt;std_version&gt;</code>：指定标注库类型以及版本信息</strong>
<ul>
<li>例如<code>-std=gnu++17</code></li>
</ul>
</li>
<li><strong><code>-W&lt;xxx&gt;</code>：warning提示</strong>
<ul>
<li><code>-Wall</code>：启用大部分warning提示（部分warning无法通过该参数默认启用）</li>
<li><code>-Wno&lt;xxx&gt;</code>：关闭指定种类的warning提示</li>
<li><code>-Werror</code>：所有warning变为error（会导致编译失败）</li>
<li><code>-Werror=&lt;xxx&gt;</code>：指定某个warning变为error（会导致编译失败）</li>
</ul>
</li>
<li><strong><code>-D &lt;macro_name&gt;[=&lt;macro_definition&gt;]</code>：定义宏</strong>
<ul>
<li>例如<code>-D MY_DEMO_MACRO</code>、<code>-D MY_DEMO_MACRO=2</code>、<code>-D 'MY_DEMO_MACRO=&quot;hello&quot;'</code>、<code>-D 'ECHO(a)=(a)'</code></li>
</ul>
</li>
<li><strong><code>-U &lt;macro_name&gt;</code>：取消宏定义</strong></li>
<li><strong><code>--coverage</code>：覆盖率测试</strong></li>
<li><strong><code>-fno-access-control</code>：关闭访问控制，例如在类外可以直接访问某类的私有字段和方法，一般用于单元测试</strong></li>
<li><strong>向量化相关参数</strong>
<ul>
<li><code>-fopt-info-vec</code>/<code>-fopt-info-vec-optimized</code>：当循环进行向量化优化时，输出详细信息</li>
<li><code>-fopt-info-vec-missed</code>：当循环无法向量化时，输出详细信息</li>
<li><code>-fopt-info-vec-note</code>：输出循环向量化优化的所有详细信息</li>
<li><code>-fopt-info-vec-all</code>：开启所有输出向量化详细信息的参数</li>
<li><code>-fno-tree-vectorize</code>：关闭向量化</li>
<li><strong>一般来说，需要指定参数后才能使用更大宽度的向量化寄存器</strong>
<ul>
<li><code>-mmmx</code></li>
<li><code>-msse</code>、<code>-msse2</code>、<code>-msse3</code>、<code>-mssse3</code>、<code>-msse4</code>、<code>-msse4a</code>、<code>-msse4.1</code>、<code>-msse4.2</code></li>
<li><code>-mavx</code>、<code>-mavx2</code>、<code>-mavx512f</code>、<code>-mavx512pf</code>、<code>-mavx512er</code>、<code>-mavx512cd</code>、<code>-mavx512vl</code>、<code>-mavx512bw</code>、<code>-mavx512dq</code>、<code>-mavx512ifma</code>、<code>-mavx512vbmi</code></li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>-fPIC</code>：如果目标机器支持，则生成与位置无关的代码，适用于动态链接并避免对全局偏移表大小的任何限制</strong></li>
<li><strong><code>-fomit-frame-pointer</code>：必要的话，允许部分函数没有栈指针</strong>
<ul>
<li><code>-fno-omit-frame-pointer</code>：所有函数必须包含栈指针</li>
</ul>
</li>
<li><code>-faligned-new</code></li>
<li><code>-fsized-deallocation</code>：启用接收<code>size</code>参数的<code>delete</code>运算符。<a target="_blank" rel="noopener" href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2013/n3778.html">C++ Sized Deallocation</a>。现代内存分配器在给对象分配内存时，需要指定大小，出于空间利用率的考虑，不会在对象内存周围存储对象的大小信息。因此在释放对象时，需要查找对象占用的内存大小，查找的开销很大，因为通常不在缓存中。因此，编译器允许提供接受一个<code>size</code>参数的<code>global delete operator</code>，并用这个版本来对对象进行析构</li>
<li><code>-mcmodel=small/medium/large</code>: is an option used in compilers like GCC (GNU Compiler Collection) to specify the memory model for code generation. This option is particularly relevant in systems with large address spaces, such as 64-bit architectures, where how the program accesses memory can significantly impact performance and compatibility.
<ul>
<li><code>small</code>
<ul>
<li>This is the default memory model.</li>
<li>Assumes that all symbols are within 2GB of each other.</li>
<li>Code and data are assumed to be close, which allows the compiler to use shorter and more efficient instructions for calls and references.</li>
<li>Suitable for most applications where the total memory usage (including code, data, and stack) does not exceed 2GB.</li>
</ul>
</li>
<li><code>medium</code>
<ul>
<li>Used for applications larger than 2GB but less than a certain threshold (often around tens of GBs).</li>
<li>Code is generated under the assumption that it will be within 2GB, but data may be farther away.</li>
<li>This model uses absolute addresses for data and thus can handle larger data sizes, but still has limitations on the size of the code.</li>
</ul>
</li>
<li><code>large</code>
<ul>
<li>Designed for applications where both the code and data are larger than the limits of the medium model.</li>
<li>Uses absolute addresses for both data and code, allowing for very large applications.</li>
<li>However, this comes at the cost of efficiency, as the generated code is less optimized compared to the small and medium models.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="711-how-to-link-libc-statically"><a class="markdownIt-Anchor" href="#711-how-to-link-libc-statically"></a> 7.1.1 How to link libc++ statically</h3>
<p>Use <code>g++</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o main main.cpp -static-libstdc++</span><br></pre></td></tr></table></figure>
<p>Use <code>gcc</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.cpp -o main -std=gnu++17 -Wl,-Bstatic -lstdc++ -Wl,-Bdynamic</span><br></pre></td></tr></table></figure>
<h2 id="72-ld"><a class="markdownIt-Anchor" href="#72-ld"></a> 7.2 ld</h2>
<p><strong>种类</strong></p>
<ul>
<li><code>GNU ld</code></li>
<li><code>GNU gold</code></li>
<li><code>LLVM lld</code></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rui314/mold">mold</a></li>
</ul>
<p><strong><code>gcc</code>如何指定<code>linker</code></strong></p>
<ul>
<li><code>-B/usr/bin</code>: For GNU ld, setup searching directory</li>
<li><code>-fuse-ld=gold</code>: For GNU gold</li>
<li><code>-fuse-ld=lld</code>: For LLVM lld</li>
<li><code>-B/usr/local/bin/gcc-mold</code>: For mold, setup searching directory</li>
</ul>
<p><strong>常用参数说明：</strong></p>
<ul>
<li><code>--verbose</code>：打印链接时的详细信息，包括链接了哪些动态库</li>
<li><code>-l &lt;name&gt;</code>：增加库文件，查找<code>lib&lt;name&gt;.a</code>或者<code>lib&lt;name&gt;.so</code>，如果都存在，默认使用<code>so</code>版本</li>
<li><code>-L &lt;dir&gt;</code>：增加库文件搜索路径，其优先级会高于默认的搜索路径。允许指定多个，搜索顺序与其指定的顺序相同</li>
<li><code>-rpath=&lt;dir&gt;</code>：增加运行时库文件搜索路径（务必用绝路径，否则二进制一旦换目录就无法运行了）。<code>-L</code>参数只在编译、链接期间生效，运行时仍然会找不到动态库文件，需要通过该参数指定。因此，对于位于非默认搜索路径下的动态库文件，<code>-L</code>与<code>-Wl,-rpath=</code>这两个参数通常是一起使用的
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49138195/whats-the-difference-between-rpath-link-and-l">What’s the difference between <code>-rpath-link</code> and <code>-L</code>?</a></li>
</ul>
</li>
<li><code>-Bstatic</code>：修改默认行为，强制使用静态链接库，只对该参数之后出现的库有效。如果找不到对应的静态库会报错（即便有动态库）</li>
<li><code>-Bdynamic</code>：修改默认行为，强制使用动态链接库，只对该参数之后出现的库有效。如果找不到对应的动态库会报错（即便有静态库）</li>
<li><code>--wrap=&lt;symbol&gt;</code>
<ul>
<li>任何指向<code>&lt;symbol&gt;</code>的未定义的符号都会被解析为<code>__wrap_&lt;symbol&gt;</code></li>
<li>任何指向<code>__real_&lt;symbol&gt;</code>的未定义的符号都会被解析为<code>&lt;symbol&gt;</code></li>
<li>于是，我们就可以在<code>__wrap_&lt;symbol&gt;</code>增加额外的逻辑，并最终调用<code>__real_&lt;symbol&gt;</code>来实现代理</li>
</ul>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; proxy_malloc.c &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;stddef.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line">void* __real_malloc(size_t c);</span><br><span class="line"></span><br><span class="line">void* __wrap_malloc(size_t c) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc called with %zu\n&quot;</span>, c);</span><br><span class="line">    <span class="built_in">return</span> __real_malloc(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    int* num = (int*)malloc(sizeof(int));</span><br><span class="line">    <span class="built_in">return</span> *num;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">gcc -o proxy_malloc proxy_malloc.c -Wl,-wrap=malloc</span><br><span class="line"></span><br><span class="line">./proxy_malloc</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="721-how-to-check-default-linker"><a class="markdownIt-Anchor" href="#721-how-to-check-default-linker"></a> 7.2.1 How to check default linker</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l $(<span class="built_in">which</span> ld)</span><br><span class="line"></span><br><span class="line">update-alternatives --display ld</span><br></pre></td></tr></table></figure>
<h3 id="722-how-to-print-dynamic-lib-path-when-linking-program"><a class="markdownIt-Anchor" href="#722-how-to-print-dynamic-lib-path-when-linking-program"></a> 7.2.2 How to print dynamic lib path when linking program</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default GNU ld</span></span><br><span class="line">gcc -o your_program your_program.c -Wl,--verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># gold</span></span><br><span class="line">gcc -o your_program your_program.c -fuse-ld=gold -Wl,--verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># lld</span></span><br><span class="line">gcc -o your_program your_program.c -fuse-ld=lld -Wl,--verbose</span><br></pre></td></tr></table></figure>
<h3 id="723-how-to-determine-which-linker-was-used-to-link-a-binary-file"><a class="markdownIt-Anchor" href="#723-how-to-determine-which-linker-was-used-to-link-a-binary-file"></a> 7.2.3 How to determine which linker was used to link a binary file</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method 1</span></span><br><span class="line">readelf -p .comment &lt;binary_file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># method 2</span></span><br><span class="line">strings &lt;binary_file&gt; | grep &lt;linker_name&gt;</span><br></pre></td></tr></table></figure>
<h2 id="73-dwarf-problems"><a class="markdownIt-Anchor" href="#73-dwarf-problems"></a> 7.3 DWARF Problems</h2>
<p>Try use different linker.</p>
<h2 id="74-reference"><a class="markdownIt-Anchor" href="#74-reference"></a> 7.4 Reference</h2>
<h1 id="8-llvm-tools"><a class="markdownIt-Anchor" href="#8-llvm-tools"></a> 8 LLVM Tools</h1>
<h2 id="81-clang"><a class="markdownIt-Anchor" href="#81-clang"></a> 8.1 clang</h2>
<p><strong>Doc:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/">Clang documentation</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/DiagnosticsReference.html">Diagnostic flags in Clang</a></li>
</ul>
</li>
</ul>
<h2 id="82-clang-format"><a class="markdownIt-Anchor" href="#82-clang-format"></a> 8.2 clang-format</h2>
<p><strong>如何安装<code>clang-format</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g clang-format</span><br></pre></td></tr></table></figure>
<p><strong>如何使用：在<code>用户目录</code>或者<code>项目根目录</code>中创建<code>.clang-format</code>文件用于指定格式化的方式，下面给一个示例</strong></p>
<ul>
<li><strong>优先使用项目根目录中的<code>.clang-format</code>；如果不存在，则使用用户目录中的<code>~/.clang-format</code></strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">Language: Cpp</span><br><span class="line">BasedOnStyle: Google</span><br><span class="line">AccessModifierOffset: -4</span><br><span class="line">AllowShortFunctionsOnASingleLine: Inline</span><br><span class="line">ColumnLimit: 120</span><br><span class="line">ConstructorInitializerIndentWidth: 8 # double of IndentWidth</span><br><span class="line">ContinuationIndentWidth: 8 # double of IndentWidth</span><br><span class="line">DerivePointerAlignment: false # always use PointerAlignment</span><br><span class="line">IndentCaseLabels: false</span><br><span class="line">IndentWidth: 4</span><br><span class="line">PointerAlignment: Left</span><br><span class="line">ReflowComments: false</span><br><span class="line">SortUsingDeclarations: false</span><br><span class="line">SpacesBeforeTrailingComments: 1</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ul>
<li>即便<code>.clang-format</code>相同，不同版本的<code>clang-format</code>格式化的结果也有差异</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/StarRocks/starrocks/blob/main/.clang-format">StarRocks-format</a></li>
</ul>
<h1 id="9-assorted"><a class="markdownIt-Anchor" href="#9-assorted"></a> 9 Assorted</h1>
<h2 id="91-dynamic-analysis"><a class="markdownIt-Anchor" href="#91-dynamic-analysis"></a> 9.1 Dynamic Analysis</h2>
<p><img src="/images/Cpp-Trivial/analysis-tools.png" alt="analysis-tools" /></p>
<h2 id="92-header-file-search-order"><a class="markdownIt-Anchor" href="#92-header-file-search-order"></a> 9.2 Header File Search Order</h2>
<p><strong>头文件<code>#include &quot;xxx.h&quot;</code>的搜索顺序</strong></p>
<ol>
<li>先搜索当前目录</li>
<li>然后搜索<code>-I</code>参数指定的目录</li>
<li>再搜索gcc的环境变量<code>CPLUS_INCLUDE_PATH</code>（C程序使用的是<code>C_INCLUDE_PATH</code>）</li>
<li>最后搜索gcc的内定目录，包括：
<ul>
<li><code>/usr/include</code></li>
<li><code>/usr/local/include</code></li>
<li><code>/usr/lib/gcc/x86_64-redhat-linux/&lt;gcc version&gt;/include</code>（C头文件）或者<code>/usr/include/c++/&lt;gcc version&gt;</code>（C++头文件）</li>
</ul>
</li>
</ol>
<p><strong>头文件<code>#include &lt;xxx.h&gt;</code>的搜索顺序</strong></p>
<ol>
<li>先搜索<code>-I</code>参数指定的目录</li>
<li>再搜索gcc的环境变量<code>CPLUS_INCLUDE_PATH</code>（C程序使用的是<code>C_INCLUDE_PATH</code>）</li>
<li>最后搜索gcc的内定目录，包括：
<ul>
<li><code>/usr/include</code></li>
<li><code>/usr/local/include</code></li>
<li><code>/usr/lib/gcc/x86_64-redhat-linux/&lt;gcc version&gt;/include</code>（C头文件）或者<code>/usr/include/c++/&lt;gcc version&gt;</code>（C++头文件）</li>
</ul>
</li>
</ol>
<h2 id="93-how-to-check-the-compile-error-message"><a class="markdownIt-Anchor" href="#93-how-to-check-the-compile-error-message"></a> 9.3 How to check the compile error message</h2>
<p>Example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In file included from /starrocks/be/src/exprs/agg/approx_top_k.h:20:</span><br><span class="line">/starrocks/be/src/column/column_hash.h: In instantiation of ‘std::size_t starrocks::StdHashWithSeed&lt;T, seed&gt;::operator()(T) const [with T = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;; starrocks::PhmapSeed seed = starrocks::PhmapSeed1; std::size_t = long unsigned int]’:</span><br><span class="line">/starrocks/be/src/util/phmap/phmap.h:1723:49:   required from ‘size_t phmap::priv::raw_hash_set&lt;Policy, Hash, Eq, Alloc&gt;::HashElement::operator()(const K&amp;, Args&amp;&amp; ...) const [with K = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;; Args = &#123;&#125;; Policy = phmap::priv::FlatHashMapPolicy&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt;; Hash = starrocks::StdHashWithSeed&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::PhmapSeed1&gt;; Eq = phmap::EqualTo&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt; &gt;; Alloc = std::allocator&lt;std::pair&lt;const std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt; &gt;; size_t = long unsigned int]’</span><br><span class="line">/starrocks/be/src/util/phmap/phmap.h:1689:39:   required from ‘size_t phmap::priv::raw_hash_set&lt;Policy, Hash, Eq, Alloc&gt;::hash(const K&amp;) const [with K = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;; Policy = phmap::priv::FlatHashMapPolicy&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt;; Hash = starrocks::StdHashWithSeed&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::PhmapSeed1&gt;; Eq = phmap::EqualTo&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt; &gt;; Alloc = std::allocator&lt;std::pair&lt;const std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt; &gt;; size_t = long unsigned int]’</span><br><span class="line">/starrocks/be/src/util/phmap/phmap.h:1625:36:   required from ‘phmap::priv::raw_hash_set&lt;Policy, Hash, Eq, Alloc&gt;::iterator phmap::priv::raw_hash_set&lt;Policy, Hash, Eq, Alloc&gt;::find(key_arg&lt;K&gt;&amp;) [with K = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;; Policy = phmap::priv::FlatHashMapPolicy&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt;; Hash = starrocks::StdHashWithSeed&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::PhmapSeed1&gt;; Eq = phmap::EqualTo&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt; &gt;; Alloc = std::allocator&lt;std::pair&lt;const std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, starrocks::ApproxTopKState&lt;starrocks::TYPE_VARCHAR&gt;::Counter*&gt; &gt;; key_arg&lt;K&gt; = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;]’</span><br><span class="line">/starrocks/be/src/exprs/agg/approx_top_k.h:80:23:   required from ‘void starrocks::ApproxTopKState&lt;LT&gt;::process(const CppType&amp;, int64_t, bool) [with starrocks::LogicalType LT = starrocks::TYPE_VARCHAR; CppType = std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;; int64_t = long int]’</span><br><span class="line">/starrocks/be/src/exprs/agg/approx_top_k.h:75:13:   required from ‘void starrocks::ApproxTopKState&lt;LT&gt;::merge(std::vector&lt;Counter&gt;) [with starrocks::LogicalType LT = starrocks::TYPE_VARCHAR]’</span><br><span class="line">/starrocks/be/src/exprs/agg/approx_top_k.h:239:32:   required from ‘void starrocks::ApproxTopKAggregateFunction&lt;LT, T&gt;::merge(starrocks::FunctionContext*, const starrocks::Column*, starrocks::AggDataPtr, size_t) const [with starrocks::LogicalType LT = starrocks::TYPE_VARCHAR; T = starrocks::Slice; starrocks::AggDataPtr = unsigned char*; size_t = long unsigned int]’</span><br><span class="line">/starrocks/be/src/exprs/agg/approx_top_k.h:215:10:   required from here</span><br><span class="line">/starrocks/be/src/column/column_hash.h:282:101: error: use of deleted function ‘std::hash&lt;std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt; &gt;::hash()’</span><br><span class="line">  282 |     std::size_t operator()(T value) const &#123; return phmap_mix_with_seed&lt;sizeof(size_t), seed&gt;()(std::hash&lt;T&gt;()(value)); &#125;</span><br></pre></td></tr></table></figure>
<p>When interpreting compiler error messages, especially those involving template instantiation (which can be particularly verbose and intricate), there’s a general approach that you can take. Here’s how to approach such error messages:</p>
<ol>
<li><strong>Start At The End:</strong>
<ul>
<li>Often, the actual error (like a type mismatch, use of an undefined variable, etc.) is reported at the end of the message.</li>
<li>In your provided message, the core error was at the end, stating the use of a deleted function.</li>
</ul>
</li>
<li><strong>Work Your Way Up:</strong>
<ul>
<li>Once you have the core error in mind, start moving upwards to see where in your code this problem originates. Often, the actual line of your code that triggers the error is one of the last things mentioned before the core error.</li>
<li>In your case, the direct line of code causing the error was provided in <code>column_hash.h</code>.</li>
</ul>
</li>
<li><strong>Template Call Stack:</strong>
<ul>
<li>Template errors tend to provide a “call stack” of sorts which traces the sequence of template instantiations that led to the error. This can be useful to understand the flow of logic and how you arrived at the error.</li>
<li>In your message, this was the sequence starting from <code>phmap.h:1723:49</code> and moving through various template functions/classes.</li>
</ul>
</li>
<li><strong>Context:</strong>
<ul>
<li>The initial part of the message usually provides the broader context: where the error started, what file it originated from, and so on.</li>
<li>In your output, the initial message pointed to <code>column_hash.h</code> being included from <code>approx_top_k.h</code>, providing a starting point for the cascade of template instantiation.</li>
</ul>
</li>
</ol>
<p>In Summary: While the bottom-up approach is useful for quickly identifying the core error and the immediate lines of code causing it, you sometimes need to go top-down to fully understand the context and sequence of events leading to the error. With experience, you’ll develop an intuition for quickly scanning and pinpointing the most relevant parts of such error messages.</p>
<h2 id="94-how-to-get-coverage-of-code"><a class="markdownIt-Anchor" href="#94-how-to-get-coverage-of-code"></a> 9.4 How to get coverage of code</h2>
<p><strong>Here’s how it works: <code>gcov</code> determines which files to analyze for coverage information based on the profile data files (<code>*.gcda</code> and <code>*.gcno</code>) that are generated when you compile and run your program with the appropriate GCC flags (<code>-fprofile-arcs</code> and <code>-ftest-coverage</code>). Here’s a breakdown of how <code>gcov</code> knows which files to load:</strong></p>
<ol>
<li><strong>Compilation and Execution:</strong>
<ul>
<li>When you compile your C/C++ program with GCC using <code>-fprofile-arcs</code> and <code>-ftest-coverage</code>, it produces two types of files for each source file:</li>
<li><code>*.gcno</code>: These are generated during the compilation. They contain information about the source code’s structure (like basic blocks, branches, etc.).</li>
<li><code>*.gcda</code>: These are generated when the compiled program is run. They contain the actual coverage data, such as how many times each line of code was executed.</li>
</ul>
</li>
<li><strong>Locating Files:</strong>
<ul>
<li>When you invoke <code>gcov</code>, it looks for <code>.gcno</code> and <code>.gcda</code> files in the current directory by default. These files are named after the source files but with different extensions.</li>
<li>For example, if your source file is <code>example.c</code>, <code>gcov</code> will look for <code>example.gcno</code> and <code>example.gcda</code> in the current directory.</li>
</ul>
</li>
<li><strong>Matching Source Files:</strong>
<ul>
<li><code>gcov</code> uses the information in these files to match with the corresponding source file. It relies on the path and filename information stored in the <code>.gcno</code> and <code>.gcda</code> files to find the correct source file.</li>
<li>If your source files are in a different directory, you may need to specify the path when running <code>gcov</code>, or run <code>gcov</code> from the directory containing the <code>.gcda</code> and <code>.gcno</code> files.</li>
</ul>
</li>
<li><strong>Generating the Report:</strong>
<ul>
<li>Once <code>gcov</code> has matched the <code>.gcno</code> and <code>.gcda</code> files with their corresponding source files, it processes these files to generate a coverage report. This report shows how many times each line in the source file was executed.</li>
</ul>
</li>
<li><strong>Manual Specification:</strong>
<ul>
<li>You can also manually specify which source files to generate reports for by passing their names as arguments to <code>gcov</code>.</li>
</ul>
</li>
</ol>
<p><strong>Here’s an example:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello, World!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unusedFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;This function is never called.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printMessage</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g++ --coverage -o example example.cpp</span><br><span class="line">./example</span><br><span class="line">gcov example.cpp</span><br><span class="line"><span class="built_in">cat</span> example.cpp.gcov</span><br></pre></td></tr></table></figure>
<h2 id="95-document"><a class="markdownIt-Anchor" href="#95-document"></a> 9.5 Document</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/">cpp reference</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aitjcize/cppman/">cppman</a>
<ul>
<li>安装：<code>pip install cppman</code></li>
<li>示例：<code>cppman vector::begin</code></li>
<li>重建索引：<code>cppman -r</code></li>
</ul>
</li>
</ol>
<h2 id="96-reference"><a class="markdownIt-Anchor" href="#96-reference"></a> 9.6 Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/crylearner/article/details/17013187">C/C++ 头文件以及库的搜索路径</a></li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag"># 原创</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/16/DataStructure-LSM-Tree/" rel="prev" title="DataStructure-LSM-Tree">
      <i class="fa fa-chevron-left"></i> DataStructure-LSM-Tree
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/25/DataStructure-WinnerLoser-Tree/" rel="next" title="DataStructure-WinnerLoser-Tree">
      DataStructure-WinnerLoser-Tree <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY0My8xMDE5OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-compile-process"><span class="nav-text"> 1 Compile Process</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-library"><span class="nav-text"> 2 Library</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-static-library"><span class="nav-text"> 2.1 Static Library</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#211-search-order"><span class="nav-text"> 2.1.1 Search Order</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-dynamic-library"><span class="nav-text"> 2.2 Dynamic Library</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#221-search-order"><span class="nav-text"> 2.2.1 Search Order</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#222-linuxs-so-version-mechanism"><span class="nav-text"> 2.2.2 Linux’s so version mechanism</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2221-so-related-names"><span class="nav-text"> 2.2.2.1 so Related Names</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2222-soname"><span class="nav-text"> 2.2.2.2 SONAME</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2223-linker-name"><span class="nav-text"> 2.2.2.3 linker name</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-link-order"><span class="nav-text"> 2.3 Link Order</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-environment-variables"><span class="nav-text"> 2.4 Environment Variables</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#241-ld_preload"><span class="nav-text"> 2.4.1 LD_PRELOAD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#242-ld_debug"><span class="nav-text"> 2.4.2 LD_DEBUG</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#25-how-to-make-library"><span class="nav-text"> 2.5 How to make library</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#251-how-to-make-static-library"><span class="nav-text"> 2.5.1 How to make static library</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#252-how-to-make-dynamic-library"><span class="nav-text"> 2.5.2 How to make dynamic library</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#26-abi"><span class="nav-text"> 2.6 ABI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#261-language-specific-abi"><span class="nav-text"> 2.6.1 Language-Specific ABI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#262-dual-abi"><span class="nav-text"> 2.6.2 Dual ABI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#263-abi-mismatch-issue"><span class="nav-text"> 2.6.3 ABI Mismatch Issue</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#27-commonly-used-librarys"><span class="nav-text"> 2.7 Commonly-used Librarys</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#28-reference"><span class="nav-text"> 2.8 Reference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-memory-management"><span class="nav-text"> 3 Memory Management</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#31-tcmalloc"><span class="nav-text"> 3.1 tcmalloc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#311-heap-profile"><span class="nav-text"> 3.1.1 Heap-profile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-jemalloc"><span class="nav-text"> 3.2 jemalloc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#321-install"><span class="nav-text"> 3.2.1 Install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#322-heap-profile"><span class="nav-text"> 3.2.2 Heap-profile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#323-work-with-http"><span class="nav-text"> 3.2.3 Work with http</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#324-reference"><span class="nav-text"> 3.2.4 Reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#33-mimalloc"><span class="nav-text"> 3.3 mimalloc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#34-comparison"><span class="nav-text"> 3.4 Comparison</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#35-hook"><span class="nav-text"> 3.5 Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#351-override-the-operator-new"><span class="nav-text"> 3.5.1 Override the operator new</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#352-wrap-operator-new-by-its-mangled-name"><span class="nav-text"> 3.5.2 Wrap operator new by its mangled name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#353-work-with-library"><span class="nav-text"> 3.5.3 Work With Library</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3531-static-linking-libraryworking"><span class="nav-text"> 3.5.3.1 Static Linking Library(Working)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3532-dynamic-linking-librarynot-working"><span class="nav-text"> 3.5.3.2 Dynamic Linking library(Not Working)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#36-reference"><span class="nav-text"> 3.6 Reference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-name-mangling"><span class="nav-text"> 4 Name mangling</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-encoding-elements"><span class="nav-text"> 4.1 Encoding Elements</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#42-example"><span class="nav-text"> 4.2 Example</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-address-sanitizer"><span class="nav-text"> 5 Address Sanitizer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#51-how-it-works"><span class="nav-text"> 5.1 How it works</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-memory-leak"><span class="nav-text"> 5.2 memory leak</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-stack-buffer-underflow"><span class="nav-text"> 5.3 stack buffer underflow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-reference"><span class="nav-text"> 5.4 Reference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-user-defined-thread"><span class="nav-text"> 6 User-defined Thread</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-gnu-tools"><span class="nav-text"> 7 GNU Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#71-gcc"><span class="nav-text"> 7.1 gcc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#711-how-to-link-libc-statically"><span class="nav-text"> 7.1.1 How to link libc++ statically</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#72-ld"><span class="nav-text"> 7.2 ld</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#721-how-to-check-default-linker"><span class="nav-text"> 7.2.1 How to check default linker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#722-how-to-print-dynamic-lib-path-when-linking-program"><span class="nav-text"> 7.2.2 How to print dynamic lib path when linking program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#723-how-to-determine-which-linker-was-used-to-link-a-binary-file"><span class="nav-text"> 7.2.3 How to determine which linker was used to link a binary file</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#73-dwarf-problems"><span class="nav-text"> 7.3 DWARF Problems</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#74-reference"><span class="nav-text"> 7.4 Reference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-llvm-tools"><span class="nav-text"> 8 LLVM Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#81-clang"><span class="nav-text"> 8.1 clang</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#82-clang-format"><span class="nav-text"> 8.2 clang-format</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-assorted"><span class="nav-text"> 9 Assorted</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#91-dynamic-analysis"><span class="nav-text"> 9.1 Dynamic Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#92-header-file-search-order"><span class="nav-text"> 9.2 Header File Search Order</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#93-how-to-check-the-compile-error-message"><span class="nav-text"> 9.3 How to check the compile error message</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#94-how-to-get-coverage-of-code"><span class="nav-text"> 9.4 How to get coverage of code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#95-document"><span class="nav-text"> 9.5 Document</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#96-reference"><span class="nav-text"> 9.6 Reference</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liuyehcf"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Liuyehcf</p>
  <div class="site-description" itemprop="description">大音希声，大象无形</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">287</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">98</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuyehcf</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qhEhLuMeMOy1zgcBhkqUS6P8-gzGzoHsz',
      appKey     : 'uhkruDLNLNdL5rQjRBY2X9Ke',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
