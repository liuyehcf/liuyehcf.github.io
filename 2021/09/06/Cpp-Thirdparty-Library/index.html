<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="阅读更多">
<meta property="og:type" content="article">
<meta property="og:title" content="Cpp-Thirdparty-Library">
<meta property="og:url" content="http://example.com/2021/09/06/Cpp-Thirdparty-Library/index.html">
<meta property="og:site_name" content="Liuye Notebook">
<meta property="og:description" content="阅读更多">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-06T02:55:52.000Z">
<meta property="article:modified_time" content="2024-11-17T13:53:37.000Z">
<meta property="article:author" content="Liuyehcf">
<meta property="article:tag" content="原创">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2021/09/06/Cpp-Thirdparty-Library/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cpp-Thirdparty-Library | Liuye Notebook</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Liuye Notebook</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-explore">

    <a href="/explore/" rel="section"><i class="fa fa-sitemap fa-fw"></i>发现</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/06/Cpp-Thirdparty-Library/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Liuyehcf">
      <meta itemprop="description" content="大音希声，大象无形">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuye Notebook">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cpp-Thirdparty-Library
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-06 10:55:52" itemprop="dateCreated datePublished" datetime="2021-09-06T10:55:52+08:00">2021-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-17 21:53:37" itemprop="dateModified" datetime="2024-11-17T21:53:37+08:00">2024-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cpp/" itemprop="url" rel="index"><span itemprop="name">Cpp</span></a>
                </span>
            </span>

          
            <span id="/2021/09/06/Cpp-Thirdparty-Library/" class="post-meta-item leancloud_visitors" data-flag-title="Cpp-Thirdparty-Library" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/09/06/Cpp-Thirdparty-Library/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/09/06/Cpp-Thirdparty-Library/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>阅读更多</strong></p>
<span id="more"></span>
<h1 id="1-gnu"><a class="markdownIt-Anchor" href="#1-gnu"></a> 1 GNU</h1>
<h2 id="11-libbacktrace"><a class="markdownIt-Anchor" href="#11-libbacktrace"></a> 1.1 libbacktrace</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ianlancetaylor/libbacktrace.git</span><br><span class="line"><span class="built_in">cd</span> libbacktrace</span><br><span class="line"></span><br><span class="line">./configure CFLAGS=<span class="string">&quot;-fPIC&quot;</span></span><br><span class="line">make -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;backtrace-supported.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;backtrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cxxabi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback for backtrace_full</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">callback</span><span class="params">(<span class="type">void</span>* data, <span class="type">uintptr_t</span> pc, <span class="type">const</span> <span class="type">char</span>* filename, <span class="type">int</span> lineno, <span class="type">const</span> <span class="type">char</span>* function)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>* demangled = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">int</span> status = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (function) &#123;</span><br><span class="line">        demangled = abi::__cxa_demangle(function, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;status);</span><br><span class="line">        <span class="keyword">if</span> (demangled) &#123;</span><br><span class="line">            function = demangled;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; filename &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; lineno &lt;&lt; <span class="string">&quot;: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; pc &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; function &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">free</span>(demangled);</span><br><span class="line">    <span class="comment">// Returning 0 continues the backtrace</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Error callback</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">error_callback</span><span class="params">(<span class="type">void</span>* data, <span class="type">const</span> <span class="type">char</span>* msg, <span class="type">int</span> errnum)</span> </span>&#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;ERROR: &quot;</span> &lt;&lt; msg &lt;&lt; <span class="string">&quot; (&quot;</span> &lt;&lt; errnum &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function to print the current stack trace</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_stack_trace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">backtrace_state</span>* state = <span class="built_in">backtrace_create_state</span>(<span class="literal">NULL</span>, BACKTRACE_SUPPORTS_THREADS, error_callback, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">backtrace_full</span>(state, <span class="number">0</span>, callback, error_callback, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sample function that calls another function to generate a stack trace</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">print_stack_trace</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">my_function</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -lstdc++ -std=gnu++17 -lbacktrace -g</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/root/main.cpp:31: 0x4014d3 print_stack_trace()</span><br><span class="line">/root/main.cpp:24: 0x4014df my_function()</span><br><span class="line">/root/main.cpp:28: 0x4014eb main</span><br><span class="line">../csu/libc-start.c:123: 0x7fd890a7c2e0 __libc_start_main</span><br></pre></td></tr></table></figure>
<h2 id="12-libunwind"><a class="markdownIt-Anchor" href="#12-libunwind"></a> 1.2 libunwind</h2>
<p><a target="_blank" rel="noopener" href="https://www.nongnu.org/libunwind/index.html">The libunwind project</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/libunwind/libunwind">github-libunwind</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/libunwind/libunwind.git</span><br><span class="line"><span class="built_in">cd</span> libunwind</span><br><span class="line">git checkout v1.6.2</span><br><span class="line"></span><br><span class="line">autoreconf -i</span><br><span class="line">./configure</span><br><span class="line">make -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cxxabi.h&gt;</span> <span class="comment">// Include for __cxa_demangle</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libunwind.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span> <span class="comment">// For free</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_stack_trace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unw_cursor_t</span> cursor;</span><br><span class="line">    <span class="type">unw_context_t</span> context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize context to the current machine state.</span></span><br><span class="line">    <span class="built_in">unw_getcontext</span>(&amp;context);</span><br><span class="line">    <span class="built_in">unw_init_local</span>(&amp;cursor, &amp;context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Walk the stack up, one frame at a time.</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">unw_step</span>(&amp;cursor) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">unw_word_t</span> offset, pc;</span><br><span class="line">        <span class="type">char</span> sym[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">unw_get_reg</span>(&amp;cursor, UNW_REG_IP, &amp;pc)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Error: cannot read program counter&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">unw_get_proc_name</span>(&amp;cursor, sym, <span class="built_in">sizeof</span>(sym), &amp;offset) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> status;</span><br><span class="line">            <span class="comment">// Attempt to demangle the symbol</span></span><br><span class="line">            <span class="type">char</span>* demangled_name = abi::__cxa_demangle(sym, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;status);</span><br><span class="line"></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;0x&quot;</span> &lt;&lt; std::hex &lt;&lt; pc &lt;&lt; <span class="string">&quot;: &quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status == <span class="number">0</span> &amp;&amp; demangled_name) &#123;</span><br><span class="line">                std::cout &lt;&lt; demangled_name &lt;&lt; <span class="string">&quot; (+0x&quot;</span> &lt;&lt; std::hex &lt;&lt; offset &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="built_in">free</span>(demangled_name); <span class="comment">// Free the demangled name</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// If demangling failed, print the mangled name</span></span><br><span class="line">                std::cout &lt;&lt; sym &lt;&lt; <span class="string">&quot; (+0x&quot;</span> &lt;&lt; std::hex &lt;&lt; offset &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot; -- error: unable to obtain symbol name for this frame&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recursive</span><span class="params">(<span class="type">uint16_t</span> cnt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">print_stack_trace</span>();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">recursive</span>(cnt - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">recursive</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -DUNW_LOCAL_ONLY is mandatory, otherwise some link error may occur, like:</span></span><br><span class="line"><span class="comment">#    undefined reference to `_Ux86_64_init_local&#x27;</span></span><br><span class="line"><span class="comment">#    undefined reference to `_Ux86_64_get_reg&#x27;</span></span><br><span class="line"><span class="comment">#    undefined reference to `_Ux86_64_get_proc_name&#x27;</span></span><br><span class="line"><span class="comment">#    undefined reference to `_Ux86_64_step&#x27;</span></span><br><span class="line">gcc -o main main.cpp -lstdc++ -std=gnu++17 -lunwind -DUNW_LOCAL_ONLY</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x401437: recursive(unsigned short) (+0x1a)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x40144a: recursive(unsigned short) (+0x2d)</span><br><span class="line">0x401465: main (+0x19)</span><br><span class="line">0x7f19ef09f2e1: __libc_start_main (+0xf1)</span><br><span class="line">0x40114a: _start (+0x2a)</span><br></pre></td></tr></table></figure>
<h3 id="121-how-to-automatically-generate-a-stacktrace-when-my-program-crashes"><a class="markdownIt-Anchor" href="#121-how-to-automatically-generate-a-stacktrace-when-my-program-crashes"></a> 1.2.1 How to automatically generate a stacktrace when my program crashes</h3>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/77005/how-to-automatically-generate-a-stacktrace-when-my-program-crashes">How to automatically generate a stacktrace when my program crashes</a></p>
<h2 id="13-bison"><a class="markdownIt-Anchor" href="#13-bison"></a> 1.3 bison</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/bison/manual/bison.html">Bison 3.8.1</a></li>
</ul>
<p>Bison is a general-purpose parser generator that converts an annotated context-free grammar into a deterministic LR or generalized LR (GLR) parser employing LALR(1) parser tables. As an experimental feature, Bison can also generate IELR(1) or canonical LR(1) parser tables. Once you are proficient with Bison, you can use it to develop a wide range of language parsers, from those used in simple desk calculators to complex programming languages.</p>
<p><strong>Install:</strong></p>
<ul>
<li><code>apt install -y bison flex</code></li>
</ul>
<p><strong>Example:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; calculator.l &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">%&#123;</span><br><span class="line"><span class="comment">#include &quot;calculator.tab.h&quot;</span></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">[0-9]+              &#123; yylval = atoi(yytext); <span class="built_in">return</span> NUMBER; &#125;</span><br><span class="line">[\t\n ]+            &#123; /* ignore whitespace */ &#125;</span><br><span class="line"><span class="string">&quot;+&quot;</span>                 &#123; <span class="built_in">return</span> PLUS; &#125;</span><br><span class="line"><span class="string">&quot;-&quot;</span>                 &#123; <span class="built_in">return</span> MINUS; &#125;</span><br><span class="line"><span class="string">&quot;*&quot;</span>                 &#123; <span class="built_in">return</span> MULTIPLY; &#125;</span><br><span class="line"><span class="string">&quot;/&quot;</span>                 &#123; <span class="built_in">return</span> DIVIDE; &#125;</span><br><span class="line">\(                  &#123; <span class="built_in">return</span> LPAREN; &#125;</span><br><span class="line">\)                  &#123; <span class="built_in">return</span> RPAREN; &#125;</span><br><span class="line">.                   &#123; <span class="built_in">return</span> yytext[0]; &#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">yywrap</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; calculator.y &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">%&#123;</span><br><span class="line"><span class="comment">#include &lt;cstdio&gt;</span></span><br><span class="line"><span class="comment">#include &lt;cstdlib&gt;</span></span><br><span class="line"></span><br><span class="line">void yyerror(const char *s);</span><br><span class="line">int yylex();</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token NUMBER</span><br><span class="line">%token PLUS MINUS MULTIPLY DIVIDE LPAREN RPAREN</span><br><span class="line"></span><br><span class="line">%left PLUS MINUS</span><br><span class="line">%left MULTIPLY DIVIDE</span><br><span class="line">%right UMINUS</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">calculation:</span><br><span class="line">    expression</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">expression:</span><br><span class="line">    expression PLUS expression     &#123; $$ = <span class="variable">$1</span> + <span class="variable">$3</span>; &#125;</span><br><span class="line">    | expression MINUS expression  &#123; $$ = <span class="variable">$1</span> - <span class="variable">$3</span>; &#125;</span><br><span class="line">    | expression MULTIPLY expression &#123; $$ = <span class="variable">$1</span> * <span class="variable">$3</span>; &#125;</span><br><span class="line">    | expression DIVIDE expression &#123; $$ = <span class="variable">$1</span> / <span class="variable">$3</span>; &#125;</span><br><span class="line">    | LPAREN expression RPAREN     &#123; $$ = <span class="variable">$2</span>; &#125;</span><br><span class="line">    | MINUS expression %prec UMINUS &#123; $$ = -<span class="variable">$2</span>; &#125;</span><br><span class="line">    | NUMBER                       &#123; $$ = <span class="variable">$1</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">void yyerror(const char *s) &#123;</span><br><span class="line">    fprintf(stderr, <span class="string">&quot;Error: %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter an expression: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (yyparse() == 0) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Result: %d\n&quot;</span>, yylval);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">flex calculator.l</span><br><span class="line">bison -d calculator.y</span><br><span class="line"></span><br><span class="line">g++ -o calculator lex.yy.c calculator.tab.c -O3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Press Ctrl + D to finish input</span></span><br><span class="line">./calculator</span><br></pre></td></tr></table></figure>
<h1 id="2-boost"><a class="markdownIt-Anchor" href="#2-boost"></a> 2 boost</h1>
<p><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/">Boost Library Documentation</a></p>
<h2 id="21-installation"><a class="markdownIt-Anchor" href="#21-installation"></a> 2.1 Installation</h2>
<h3 id="211-package-manager"><a class="markdownIt-Anchor" href="#211-package-manager"></a> 2.1.1 Package Manager</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y boost-devel</span><br></pre></td></tr></table></figure>
<h3 id="212-from-source"><a class="markdownIt-Anchor" href="#212-from-source"></a> 2.1.2 From Source</h3>
<p><a target="_blank" rel="noopener" href="https://www.boost.org/users/download/">Boost Downloads</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://boostorg.jfrog.io/artifactory/main/release/1.84.0/source/boost_1_84_0.tar.gz</span><br><span class="line">tar -zxf boost_1_84_0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> boost_1_84_0</span><br><span class="line"></span><br><span class="line">./bootstrap.sh</span><br><span class="line">./b2</span><br><span class="line">sudo ./b2 install</span><br></pre></td></tr></table></figure>
<h3 id="213-demo"><a class="markdownIt-Anchor" href="#213-demo"></a> 2.1.3 Demo</h3>
<p>All possible component names (<code>ls -1 /usr/local/lib | grep -E 'libboost_.*\.a' | sed -E 's|libboost_(.*)\.a|\1|g'</code>):</p>
<ul>
<li><code>atomic</code></li>
<li><code>chrono</code></li>
<li><code>container</code></li>
<li><code>context</code></li>
<li><code>contract</code></li>
<li><code>coroutine</code></li>
<li><code>date_time</code></li>
<li><code>exception</code></li>
<li><code>fiber</code></li>
<li><code>filesystem</code></li>
<li><code>graph</code></li>
<li><code>iostreams</code></li>
<li><code>json</code></li>
<li><code>locale</code></li>
<li><code>log</code></li>
<li><code>log_setup</code></li>
<li><code>math_c99</code></li>
<li><code>math_c99f</code></li>
<li><code>math_c99l</code></li>
<li><code>math_tr1</code></li>
<li><code>math_tr1f</code></li>
<li><code>math_tr1l</code></li>
<li><code>nowide</code></li>
<li><code>prg_exec_monitor</code></li>
<li><code>program_options</code></li>
<li><code>random</code></li>
<li><code>regex</code></li>
<li><code>serialization</code></li>
<li><code>stacktrace_addr2line</code></li>
<li><code>stacktrace_backtrace</code></li>
<li><code>stacktrace_basic</code></li>
<li><code>stacktrace_noop</code></li>
<li><code>system</code></li>
<li><code>test_exec_monitor</code></li>
<li><code>thread</code></li>
<li><code>timer</code></li>
<li><code>type_erasure</code></li>
<li><code>unit_test_framework</code></li>
<li><code>url</code></li>
<li><code>wave</code></li>
<li><code>wserialization</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p boost_demo</span><br><span class="line"><span class="built_in">cd</span> boost_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(boost_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(Boost_USE_STATIC_LIBS ON)</span><br><span class="line">find_package(Boost REQUIRED COMPONENTS atomic chrono container context contract coroutine date_time exception fiber filesystem graph iostreams json locale <span class="built_in">log</span> log_setup math_c99 math_c99f math_c99l math_tr1 math_tr1f math_tr1l nowide prg_exec_monitor program_options random regex serialization stacktrace_addr2line stacktrace_backtrace stacktrace_basic stacktrace_noop system test_exec_monitor thread timer type_erasure unit_test_framework url wave wserialization)</span><br><span class="line">message(STATUS <span class="string">&quot;All boost targets: <span class="variable">$&#123;Boost_LIBRARIES&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE Boost::filesystem Boost::system)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; boost_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;boost/filesystem.hpp&gt;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    std::string directory = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Iterate through the directory</span><br><span class="line">        <span class="keyword">for</span> (const auto&amp; entry : boost::filesystem::directory_iterator(directory)) &#123;</span><br><span class="line">            // Print the file name</span><br><span class="line">            std::cout &lt;&lt; <span class="string">entry.path().filename() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125; catch (const std::exception&amp; e) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; &quot;Error: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/boost_demo</span></span><br></pre></td></tr></table></figure>
<h2 id="22-algorithm"><a class="markdownIt-Anchor" href="#22-algorithm"></a> 2.2 Algorithm</h2>
<p><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_86_0/libs/algorithm/doc/html/index.html">The Boost Algorithm Library</a></p>
<h3 id="221-string"><a class="markdownIt-Anchor" href="#221-string"></a> 2.2.1 String</h3>
<p>Key Features of Boost.StringAlgo</p>
<ul>
<li><code>Case Conversion</code></li>
<li><code>Trimming</code></li>
<li><code>Splitting</code></li>
<li><code>Joining</code></li>
<li><code>Searching</code></li>
<li><code>Replacing</code></li>
<li><code>Case-Insensitive Operations</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/algorithm/string.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Case Conversion</span></span><br><span class="line">    std::string caseStr = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">    boost::<span class="built_in">to_upper</span>(caseStr);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Uppercase: &quot;</span> &lt;&lt; caseStr &lt;&lt; std::endl;</span><br><span class="line">    boost::<span class="built_in">to_lower</span>(caseStr);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Lowercase: &quot;</span> &lt;&lt; caseStr &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Trimming</span></span><br><span class="line">    std::string trimStr;</span><br><span class="line">    <span class="keyword">auto</span> reset = [&amp;trimStr]() &#123; trimStr = <span class="string">&quot;   Hello, Boost!   &quot;</span>; &#125;;</span><br><span class="line">    <span class="built_in">reset</span>();</span><br><span class="line">    boost::<span class="built_in">trim</span>(trimStr);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Trimmed: &#x27;&quot;</span> &lt;&lt; trimStr &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">reset</span>();</span><br><span class="line">    boost::<span class="built_in">trim_left</span>(trimStr);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Left Trimmed: &#x27;&quot;</span> &lt;&lt; trimStr &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">reset</span>();</span><br><span class="line">    boost::<span class="built_in">trim_right</span>(trimStr);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Right Trimmed: &#x27;&quot;</span> &lt;&lt; trimStr &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Splitting</span></span><br><span class="line">    std::string splitStr = <span class="string">&quot;a,b,c&quot;</span>;</span><br><span class="line">    std::vector&lt;std::string&gt; tokens;</span><br><span class="line">    boost::<span class="built_in">split</span>(tokens, splitStr, boost::<span class="built_in">is_any_of</span>(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Split Tokens: &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; token : tokens) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;&#x27;&quot;</span> &lt;&lt; token &lt;&lt; <span class="string">&quot;&#x27; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Joining</span></span><br><span class="line">    std::vector&lt;std::string&gt; joinTokens = &#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;;</span><br><span class="line">    std::string joined = boost::<span class="built_in">join</span>(joinTokens, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Joined: &quot;</span> &lt;&lt; joined &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Searching</span></span><br><span class="line">    std::string searchStr = <span class="string">&quot;Boost is awesome!&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> startsWithBoost = boost::<span class="built_in">starts_with</span>(searchStr, <span class="string">&quot;Boost&quot;</span>);</span><br><span class="line">    <span class="type">bool</span> endsWithAwesome = boost::<span class="built_in">ends_with</span>(searchStr, <span class="string">&quot;awesome!&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Starts with &#x27;Boost&#x27;: &quot;</span> &lt;&lt; std::boolalpha &lt;&lt; startsWithBoost &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Ends with &#x27;awesome!&#x27;: &quot;</span> &lt;&lt; std::boolalpha &lt;&lt; endsWithAwesome &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replacing</span></span><br><span class="line">    std::string replaceStr = <span class="string">&quot;Boost is great. Boost is powerful.&quot;</span>;</span><br><span class="line">    boost::<span class="built_in">replace_all</span>(replaceStr, <span class="string">&quot;Boost&quot;</span>, <span class="string">&quot;C++&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Replaced: &quot;</span> &lt;&lt; replaceStr &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Case-Insensitive Operations</span></span><br><span class="line">    std::string str1 = <span class="string">&quot;boost&quot;</span>;</span><br><span class="line">    std::string str2 = <span class="string">&quot;BOOST&quot;</span>;</span><br><span class="line">    <span class="type">bool</span> equalIgnoreCase = boost::<span class="built_in">iequals</span>(str1, str2);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Case-Insensitive Equals: &quot;</span> &lt;&lt; std::boolalpha &lt;&lt; equalIgnoreCase &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="23-hana"><a class="markdownIt-Anchor" href="#23-hana"></a> 2.3 Hana</h2>
<p><strong><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/release/libs/hana/doc/html/index.html">Boost.Hana</a></strong> is a library for metaprogramming in C++ that provides a modern, powerful, and easy-to-use set of tools for developers. It is part of the Boost libraries, which are known for their high-quality, peer-reviewed, and portable C++ libraries. Here are some key points about Boost.Hana:</p>
<ol>
<li><strong>Purpose</strong>: Boost.Hana aims to provide a comprehensive metaprogramming framework for C++, allowing developers to perform computations at compile-time with an expressive and efficient interface.</li>
<li><strong>Features</strong>:
<ul>
<li><strong>Compile-time Algorithms</strong>: Includes a wide range of algorithms for manipulating types and values at compile time.</li>
<li><strong>Heterogeneous Containers</strong>: Supports containers that can hold elements of different types, which is useful for various advanced C++ programming techniques.</li>
<li><strong>Integrations</strong>: Works seamlessly with other parts of the C++ standard library and other Boost libraries.</li>
</ul>
</li>
<li><strong>Usage</strong>: It is used for tasks such as type introspection, compile-time computations, and advanced type manipulations, making it a valuable tool for developers dealing with complex C++ codebases.</li>
<li><strong>Performance</strong>: Boost.Hana is designed with performance in mind, leveraging modern C++ features to minimize compile-time overhead and runtime inefficiencies.</li>
<li><strong>Modern C++</strong>: Embraces the latest standards of C++ (C++11 and beyond), making use of features such as constexpr, variadic templates, and template metaprogramming to provide a robust and future-proof library.</li>
</ol>
<p><strong>Here is an example:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/core/demangle.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/hana.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">std::string <span class="type">const</span>&amp; <span class="title">name_of</span><span class="params">(boost::hana::basic_type&lt;T&gt;)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> std::string name = boost::core::<span class="built_in">demangle</span>(<span class="built_in">typeid</span>(T).<span class="built_in">name</span>());</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123; RED, BLACK, WHITE &#125;;</span><br><span class="line"></span><br><span class="line">std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream&amp; os, Color color) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (color) &#123;</span><br><span class="line">    <span class="keyword">case</span> RED:</span><br><span class="line">        os &lt;&lt; <span class="string">&quot;RED&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> BLACK:</span><br><span class="line">        os &lt;&lt; <span class="string">&quot;BLACK&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> WHITE:</span><br><span class="line">        os &lt;&lt; <span class="string">&quot;WHITE&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream&amp; os, std::vector&lt;std::string&gt; <span class="type">const</span>&amp; vec) &#123;</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">    os &lt;&lt; std::<span class="built_in">accumulate</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(), std::<span class="built_in">string</span>(), [](std::string <span class="type">const</span>&amp; acc, std::string <span class="type">const</span>&amp; elem) &#123;</span><br><span class="line">        <span class="keyword">return</span> acc.<span class="built_in">empty</span>() ? elem : acc + <span class="string">&quot;,&quot;</span> + elem;</span><br><span class="line">    &#125;);</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tuple = boost::hana::<span class="built_in">make_tuple</span>(<span class="number">1</span>, <span class="number">2.5</span>, <span class="string">&quot;Hello, Hana!&quot;</span>, Color::RED, std::<span class="built_in">vector</span>&lt;std::string&gt;(&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> first = boost::hana::<span class="built_in">at_c</span>&lt;<span class="number">0</span>&gt;(tuple);</span><br><span class="line">    <span class="keyword">auto</span> second = boost::hana::<span class="built_in">at_c</span>&lt;<span class="number">1</span>&gt;(tuple);</span><br><span class="line">    <span class="keyword">auto</span> third = boost::hana::<span class="built_in">at_c</span>&lt;<span class="number">2</span>&gt;(tuple);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;First element: &quot;</span> &lt;&lt; first &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Second element: &quot;</span> &lt;&lt; second &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Third element: &quot;</span> &lt;&lt; third &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> size = boost::hana::<span class="built_in">size</span>(tuple);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Tuple size: &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    boost::hana::for_each(tuple, [](<span class="keyword">auto</span> <span class="type">const</span>&amp; elem) &#123; std::cout &lt;&lt; elem &lt;&lt; std::endl; &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> transformed_tuple =</span><br><span class="line">            boost::hana::<span class="built_in">transform</span>(tuple, [](<span class="keyword">auto</span> <span class="type">const</span>&amp; elem) &#123; <span class="keyword">return</span> boost::hana::type_c&lt;<span class="keyword">decltype</span>(elem)&gt;; &#125;);</span><br><span class="line">    boost::hana::for_each(transformed_tuple, [](<span class="keyword">auto</span> <span class="type">const</span>&amp; elem) &#123; std::cout &lt;&lt; <span class="built_in">name_of</span>(elem) &lt;&lt; std::endl; &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="24-stacktrace"><a class="markdownIt-Anchor" href="#24-stacktrace"></a> 2.4 Stacktrace</h2>
<p>Boost.Stacktrace provides several options for printing stack traces, depending on the underlying technology used to capture the stack information:</p>
<ul>
<li><code>BOOST_STACKTRACE_USE_BACKTRACE</code>: uses the <code>backtrace</code> function from the GNU C Library, which is available on most UNIX-like systems including Linux.</li>
<li><code>BOOST_STACKTRACE_USE_ADDR2LINE</code>: uses the <code>addr2line</code> utility from GNU binutils to convert addresses into file names and line numbers, providing more detailed information.</li>
<li><code>BOOST_STACKTRACE_USE_NOOP</code>: doesn’t capture the stack trace at all. This can be used when you want to disable stack tracing completely.</li>
<li><code>BOOST_STACKTRACE_USE_WINDBG</code>: utilizes the Windows Debug Help Library when compiling for Windows.</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/stacktrace.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/version.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> cnt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">foo</span>(cnt - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__GNUC__)</span></span><br><span class="line"><span class="comment">// wrap libc&#x27;s _cxa_throw to print stack trace of exceptions</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="type">void</span> __real___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* infov, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*));</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __wrap___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* infov, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// wrap libc&#x27;s _cxa_throw that must not throw exceptions again, otherwise causing crash.</span></span><br><span class="line"><span class="type">void</span> __wrap___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* info, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*)) &#123;</span><br><span class="line">    std::cout &lt;&lt; boost::stacktrace::<span class="built_in">stacktrace</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call the real __cxa_throw():</span></span><br><span class="line">    __real___cxa_throw(thrown_exception, info, dest);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Boost version: &quot;</span> &lt;&lt; BOOST_VERSION / <span class="number">100000</span> &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; BOOST_VERSION / <span class="number">100</span> % <span class="number">1000</span> &lt;&lt; <span class="string">&quot;.&quot;</span></span><br><span class="line">              &lt;&lt; BOOST_VERSION % <span class="number">100</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">foo</span>(<span class="number">5</span>);</span><br><span class="line">    &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="241-with-addr2line"><a class="markdownIt-Anchor" href="#241-with-addr2line"></a> 2.4.1 With addr2line</h3>
<p>This approach works fine with <code>gcc-10.3.0</code>, but can’t work with higher versions like <code>gcc-11.3.0</code>, <code>gcc-12.3.0</code>. Don’t know why so far.</p>
<p><strong>Compile:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -ldl: link libdl</span></span><br><span class="line"><span class="comment"># -g: generate debug information</span></span><br><span class="line">gcc -o main main.cpp -DBOOST_STACKTRACE_USE_ADDR2LINE -lstdc++ -std=gnu++17 -Wl,-wrap=__cxa_throw -ldl -g</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p><strong>Output:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Boost version: 1.84.0</span><br><span class="line"> 0# boost::stacktrace::basic_stacktrace&lt;std::allocator&lt;boost::stacktrace::frame&gt; &gt;::basic_stacktrace() at /usr/local/include/boost/stacktrace/stacktrace.hpp:129</span><br><span class="line"> 1# foo(int) at /root/main.cpp:9</span><br><span class="line"> 2# foo(int) at /root/main.cpp:10</span><br><span class="line"> 3# foo(int) at /root/main.cpp:10</span><br><span class="line"> 4# foo(int) at /root/main.cpp:10</span><br><span class="line"> 5# foo(int) at /root/main.cpp:10</span><br><span class="line"> 6# foo(int) at /root/main.cpp:10</span><br><span class="line"> 7# main at /root/main.cpp:36</span><br><span class="line"> 8# 0x00007F14FEF4E24A in /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line"> 9# __libc_start_main in /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">10# _start in ./main</span><br></pre></td></tr></table></figure>
<h3 id="242-with-libbacktrace"><a class="markdownIt-Anchor" href="#242-with-libbacktrace"></a> 2.4.2 With libbacktrace</h3>
<p><strong>Compile:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -ldl: link libdl</span></span><br><span class="line"><span class="comment"># -g: generate debug information</span></span><br><span class="line"><span class="comment"># -lbacktrace: link libbacktrace</span></span><br><span class="line">gcc -o main main.cpp -DBOOST_STACKTRACE_USE_BACKTRACE -lstdc++ -std=gnu++17 -Wl,-wrap=__cxa_throw -ldl -lbacktrace -g</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<p><strong>Output:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Boost version: 1.84.0</span><br><span class="line"> 0# __wrap___cxa_throw at /root/main.cpp:21</span><br><span class="line"> 1# foo(int) at /root/main.cpp:9</span><br><span class="line"> 2# foo(int) at /root/main.cpp:10</span><br><span class="line"> 3# foo(int) at /root/main.cpp:10</span><br><span class="line"> 4# foo(int) at /root/main.cpp:10</span><br><span class="line"> 5# foo(int) at /root/main.cpp:10</span><br><span class="line"> 6# foo(int) at /root/main.cpp:10</span><br><span class="line"> 7# main at /root/main.cpp:36</span><br><span class="line"> 8# __libc_start_call_main at ../sysdeps/nptl/libc_start_call_main.h:74</span><br><span class="line"> 9# __libc_start_main at ../csu/libc-start.c:347</span><br><span class="line">10# _start in ./main</span><br></pre></td></tr></table></figure>
<h2 id="25-reference"><a class="markdownIt-Anchor" href="#25-reference"></a> 2.5 Reference</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/master/doc/html/">The Boost C++ Libraries BoostBook Documentation Subset</a></li>
<li><a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/1_66_0/doc/html/stacktrace/getting_started.html">How to print current call stack</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/Questions/3899870/print-call-stack-in-c-or-c">print call stack in C or C++</a></li>
</ul>
<h1 id="3-fmt"><a class="markdownIt-Anchor" href="#3-fmt"></a> 3 fmt</h1>
<p><strong>Install <a target="_blank" rel="noopener" href="https://github.com/fmtlib/fmt">fmt</a>:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/fmtlib/fmt.git</span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">fmt</span></span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find_package(fmt)</span><br><span class="line"></span><br><span class="line">target_link_libraries(xxx fmt::fmt)</span><br></pre></td></tr></table></figure>
<p><strong>Example:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fmt/core.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fmt/ranges.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int32_t</span>&gt; nums&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Joined string: &#123;&#125;\n&quot;</span>, fmt::<span class="built_in">join</span>(nums, <span class="string">&quot;,&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>gcc -o main main.cpp -lstdc++ -std=gnu++17 -lfmt</code></li>
</ul>
<h1 id="4-facebook"><a class="markdownIt-Anchor" href="#4-facebook"></a> 4 Facebook</h1>
<h2 id="41-folly"><a class="markdownIt-Anchor" href="#41-folly"></a> 4.1 folly</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/folly">folly</a></p>
<p>Prerequisites (These dependencies won’t be automatically installed by cachelib’s script):</p>
<ul>
<li><code>boost</code></li>
<li><code>jemalloc</code></li>
</ul>
<p>For Ubuntu 18.04, you may need the following dependencies:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y libdouble-conversion-dev libevent-dev liblz4-dev libdwarf-dev libsnappy-dev liblzma-dev libbz2-dev libunwind-dev libsodium-dev libnuma-dev libzstd-dev</span><br></pre></td></tr></table></figure>
<h2 id="42-cachelib"><a class="markdownIt-Anchor" href="#42-cachelib"></a> 4.2 CacheLib</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/CacheLib">CacheLib</a></p>
<h1 id="5-google"><a class="markdownIt-Anchor" href="#5-google"></a> 5 Google</h1>
<h2 id="51-abseil"><a class="markdownIt-Anchor" href="#51-abseil"></a> 5.1 abseil</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/abseil/abseil-cpp">abseil-cpp</a></p>
<p><a target="_blank" rel="noopener" href="https://abseil.io/docs/cpp/guides/">abseil C++ Programming Guides</a></p>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add_subdirectory(abseil-cpp)</span><br><span class="line">target_link_libraries(&lt;target&gt; absl::base absl::synchronization absl::strings)</span><br></pre></td></tr></table></figure>
<p><strong>All available abseil cMake public targets are listed as follows:</strong></p>
<ul>
<li><code>absl::algorithm</code></li>
<li><code>absl::base</code></li>
<li><code>absl::debugging</code></li>
<li><code>absl::flat_hash_map</code></li>
<li><code>absl::flags</code></li>
<li><code>absl::log</code></li>
<li><code>absl::memory</code></li>
<li><code>absl::meta</code></li>
<li><code>absl::numeric</code></li>
<li><code>absl::random_random</code></li>
<li><code>absl::strings</code></li>
<li><code>absl::synchronization</code></li>
<li><code>absl::time</code></li>
<li><code>absl::utility</code></li>
<li>…</li>
</ul>
<p><strong>Example:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p absl_demo</span><br><span class="line"><span class="built_in">cd</span> absl_demo</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/abseil/abseil-cpp.git contrib/abseil-cpp</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(absl_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">add_subdirectory(contrib/abseil-cpp)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span></span><br><span class="line">    absl::<span class="built_in">log</span></span><br><span class="line">    absl::flags</span><br><span class="line">    absl::strings)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;absl/base/log_severity.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;absl/flags/flag.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;absl/log/globals.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;absl/log/log.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;absl/strings/str_join.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"><span class="comment">#include &lt;vector&gt;</span></span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line">    std::vector&lt;std::string&gt; v = &#123;<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>&#125;;</span><br><span class="line">    std::string s = absl::StrJoin(v, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Joined string: &quot;</span> &lt;&lt; <span class="string">s &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    absl::SetMinLogLevel(absl::LogSeverityAtLeast::kWarning);</span></span><br><span class="line"><span class="string">    LOG(INFO) &lt;&lt; &quot;This is a info log&quot;;</span></span><br><span class="line"><span class="string">    LOG(WARNING) &lt;&lt; &quot;This is a warning log&quot;;</span></span><br><span class="line"><span class="string">    LOG(ERROR) &lt;&lt; &quot;This is a error log&quot;;</span></span><br><span class="line"><span class="string">    LOG(FATAL) &lt;&lt; &quot;This is a fatal log&quot;;</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/absl_demo</span></span><br></pre></td></tr></table></figure>
<h2 id="52-gflag"><a class="markdownIt-Anchor" href="#52-gflag"></a> 5.2 gflag</h2>
<p><strong>Install <a target="_blank" rel="noopener" href="https://github.com/gflags/gflags">gflag</a>:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/gflags/gflags.git</span><br><span class="line"><span class="built_in">cd</span> gflags</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(gflags REQUIRED)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GFLAGS_INCLUDE_DIRS: $&#123;GFLAGS_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GFLAGS_BOTH_LIBRARIES: $&#123;GFLAGS_BOTH_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GFLAGS_LIBRARIES: $&#123;GFLAGS_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GFLAGS_MAIN_LIBRARIES: $&#123;GFLAGS_MAIN_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(xxx <span class="variable">$&#123;GFLAGS_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>Example:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gflags/gflags.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DEFINE_bool</span>(test_bool, <span class="literal">false</span>, <span class="string">&quot;test bool&quot;</span>);</span><br><span class="line"><span class="built_in">DEFINE_int32</span>(test_int32, <span class="number">5</span>, <span class="string">&quot;test int32&quot;</span>);</span><br><span class="line"><span class="built_in">DEFINE_double</span>(test_double, <span class="number">1.1</span>, <span class="string">&quot;test double&quot;</span>);</span><br><span class="line"><span class="built_in">DEFINE_string</span>(test_str, <span class="string">&quot;default str&quot;</span>, <span class="string">&quot;test str&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISPLAY(name) std::cout &lt;&lt; #name &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; name &lt;&lt; std::endl</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    gflags::<span class="built_in">SetUsageMessage</span>(<span class="string">&quot;some message&quot;</span>);</span><br><span class="line">    gflags::<span class="built_in">SetVersionString</span>(<span class="string">&quot;1.0.0&quot;</span>);</span><br><span class="line">    gflags::<span class="built_in">ParseCommandLineFlags</span>(&amp;argc, &amp;argv, <span class="literal">true</span>);</span><br><span class="line">    std::cout &lt;&lt; gflags::<span class="built_in">CommandlineFlagsIntoString</span>() &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">DISPLAY</span>(FLAGS_test_bool);</span><br><span class="line">    <span class="built_in">DISPLAY</span>(FLAGS_test_int32);</span><br><span class="line">    <span class="built_in">DISPLAY</span>(FLAGS_test_double);</span><br><span class="line">    <span class="built_in">DISPLAY</span>(FLAGS_test_str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>gcc -o main main.cpp -lstdc++ -std=gnu++17 -lgflags -lpthread</code></li>
<li><code>./main --test_bool true --test_int32 100 --test_double 6.666 --test_str hello</code></li>
</ul>
<h2 id="53-glog"><a class="markdownIt-Anchor" href="#53-glog"></a> 5.3 glog</h2>
<p><strong>Install <a target="_blank" rel="noopener" href="https://github.com/google/glog">glog</a>:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b v0.6.0 https://github.com/google/glog.git</span><br><span class="line"><span class="built_in">cd</span> glog</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(GLOG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(xxx glog::glog)</span><br></pre></td></tr></table></figure>
<p><strong>Example:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p glog_demo</span><br><span class="line"><span class="built_in">cd</span> glog_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(glog_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(GLOG)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> glog::glog)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;glog/logging.h&gt;</span></span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line">    google::InitGoogleLogging(argv[0]);</span><br><span class="line"></span><br><span class="line">    FLAGS_log_dir = <span class="string">&quot;./logs&quot;</span>;</span><br><span class="line">    google::EnableLogCleaner(7);</span><br><span class="line"></span><br><span class="line">    // Enables logs to both console and file</span><br><span class="line">    FLAGS_alsologtostderr = <span class="literal">true</span>;</span><br><span class="line">    // Set console <span class="built_in">log</span> level 0 = INFO, 1 = WARNING, 2 = ERROR, 3 = FATAL</span><br><span class="line">    FLAGS_stderrthreshold = 1;</span><br><span class="line"></span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">&quot;This is an info message.&quot;</span>;</span><br><span class="line">    LOG(WARNING) &lt;&lt; <span class="string">&quot;This is a warning message.&quot;</span>;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">&quot;This is an error message.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    // Conditional logging</span><br><span class="line">    int x = 10;</span><br><span class="line">    LOG_IF(INFO, x &gt; 5) &lt;&lt; <span class="string">&quot;x is greater than 5.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    // Every Nth logging</span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">        LOG_EVERY_N(INFO, 3) &lt;&lt; <span class="string">&quot;This message is logged every 3rd iteration.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    google::ShutdownGoogleLogging();</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line"><span class="built_in">mkdir</span> -p logs</span><br><span class="line">build/glog_demo</span><br></pre></td></tr></table></figure>
<h3 id="531-print-stack-not-recommend"><a class="markdownIt-Anchor" href="#531-print-stack-not-recommend"></a> 5.3.1 Print Stack (Not Recommend)</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/StarRocks/starrocks/pull/13410">[Enhancement] wrap libc’s __cxa_throw to print stack trace when throw exceptions</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GLOG_USE_GLOG_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;glog/logging.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> google &#123;</span><br><span class="line"><span class="keyword">namespace</span> glog_internal_namespace_ &#123;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DumpStackTraceToString</span><span class="params">(std::string* stacktrace)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="comment">// namespace google</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">get_stack_trace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string s;</span><br><span class="line">    google::glog_internal_namespace_::<span class="built_in">DumpStackTraceToString</span>(&amp;s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__GNUC__)</span></span><br><span class="line"><span class="comment">// wrap libc&#x27;s _cxa_throw to print stack trace of exceptions</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="type">void</span> __real___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* infov, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*));</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __wrap___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* infov, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// wrap libc&#x27;s _cxa_throw that must not throw exceptions again, otherwise causing crash.</span></span><br><span class="line"><span class="type">void</span> __wrap___cxa_throw(<span class="type">void</span>* thrown_exception, <span class="type">void</span>* info, <span class="built_in">void</span> (*dest)(<span class="type">void</span>*)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> stack = <span class="built_in">get_stack_trace</span>();</span><br><span class="line"></span><br><span class="line">    std::cerr &lt;&lt; stack &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call the real __cxa_throw():</span></span><br><span class="line">    __real___cxa_throw(thrown_exception, info, dest);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;catch exception&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译：</strong></p>
<ul>
<li><code>glog</code>需要使用静态库版本，因为动态库版本选择隐藏<code>DumpStackTraceToString</code>这个符号（<code>nm -D /usr/local/lib/libglog.so | grep 'DumpStackTraceToString'</code>），且该方法在<code>0.7.0</code>版本后被删除</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o main main.cpp -Wl,-wrap=__cxa_throw -lstdc++ -std=gnu++17 -Wl,-Bstatic -lglog -lgflags -Wl,-Bdynamic -lunwind -lpthread</span><br></pre></td></tr></table></figure>
<h2 id="54-gtest"><a class="markdownIt-Anchor" href="#54-gtest"></a> 5.4 gtest</h2>
<p><strong>Install <a target="_blank" rel="noopener" href="https://github.com/google/googletest">gtest</a>:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/googletest.git</span><br><span class="line"><span class="built_in">cd</span> googletest</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(GTest REQUIRED)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GTEST_INCLUDE_DIRS: $&#123;GTEST_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GTEST_BOTH_LIBRARIES: $&#123;GTEST_BOTH_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GTEST_LIBRARIES: $&#123;GTEST_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;GTEST_MAIN_LIBRARIES: $&#123;GTEST_MAIN_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(xxx <span class="variable">$&#123;GTEST_LIBRARIES&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(xxx <span class="variable">$&#123;GTEST_MAIN_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>Example:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p gtest_demo</span><br><span class="line"><span class="built_in">cd</span> gtest_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(gtest_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(EXEC_FILES ./test_main.cpp)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;EXEC_FILES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(GTest REQUIRED)</span><br><span class="line">message(STATUS <span class="string">&quot;GTEST_INCLUDE_DIRS: <span class="variable">$&#123;GTEST_INCLUDE_DIRS&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;GTEST_BOTH_LIBRARIES: <span class="variable">$&#123;GTEST_BOTH_LIBRARIES&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;GTEST_LIBRARIES: <span class="variable">$&#123;GTEST_LIBRARIES&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;GTEST_MAIN_LIBRARIES: <span class="variable">$&#123;GTEST_MAIN_LIBRARIES&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;GTEST_LIBRARIES&#125;</span>)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;GTEST_MAIN_LIBRARIES&#125;</span>)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; test_main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> </span><br><span class="line"><span class="comment">#include &lt;gtest/gtest.h&gt;</span></span><br><span class="line"></span><br><span class="line">TEST(TestDemo, case_right) &#123;</span><br><span class="line">    ASSERT_EQ(1, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(TestDemo, case_wrong) &#123;</span><br><span class="line">    ASSERT_EQ(1, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// <span class="variable">$&#123;GTEST_MAIN_LIBRARIES&#125;</span> will provide main method</span><br><span class="line">// int main(int argc, char **argv) &#123;</span><br><span class="line">//     ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">//     <span class="built_in">return</span> RUN_ALL_TESTS();</span><br><span class="line">// &#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">build/gtest_demo</span><br></pre></td></tr></table></figure>
<h3 id="541-macros"><a class="markdownIt-Anchor" href="#541-macros"></a> 5.4.1 Macros</h3>
<ol>
<li>
<p><code>TEST(test_case_name, test_name)</code>: Defines a test case.</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TEST</span>(TestCaseName, TestName) &#123;</span><br><span class="line">    <span class="comment">// Test logic here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>TEST_F(test_fixture, test_name)</code>: Defines a test case using a test fixture.</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyTestFixture</span> : <span class="keyword">public</span> ::testing::Test &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetUp</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Common setup logic for test cases</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">TearDown</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Common cleanup logic for test cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TEST_F</span>(MyTestFixture, TestName) &#123;</span><br><span class="line">    <span class="comment">// Test logic using the fixture environment</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>EXPECT_EQ(expected, actual)</code>: Expects that two values are equal.</p>
</li>
<li>
<p><code>ASSERT_EQ(expected, actual)</code>: Asserts that two values are equal.</p>
</li>
<li>
<p><code>EXPECT_NE(val1, val2)</code>: Expects that two values are not equal.</p>
</li>
<li>
<p><code>ASSERT_NE(val1, val2)</code>: Asserts that two values are not equal.</p>
</li>
<li>
<p><code>EXPECT_LT(val1, val2)</code>: Expects that val1 is less than val2.</p>
</li>
<li>
<p><code>ASSERT_LT(val1, val2)</code>: Asserts that val1 is less than val2.</p>
</li>
<li>
<p><code>EXPECT_LE(val1, val2)</code>: Expects that val1 is less than or equal to val2.</p>
</li>
<li>
<p><code>ASSERT_LE(val1, val2)</code>: Asserts that val1 is less than or equal to val2.</p>
</li>
<li>
<p><code>EXPECT_GT(val1, val2)</code>: Expects that val1 is greater than val2.</p>
</li>
<li>
<p><code>ASSERT_GT(val1, val2)</code>: Asserts that val1 is greater than val2.</p>
</li>
<li>
<p><code>EXPECT_GE(val1, val2)</code>: Expects that val1 is greater than or equal to val2.</p>
</li>
<li>
<p><code>ASSERT_GE(val1, val2)</code>: Asserts that val1 is greater than or equal to val2.</p>
</li>
<li>
<p><code>EXPECT_TRUE(condition)</code>: Expects that a condition is true.</p>
</li>
<li>
<p><code>ASSERT_TRUE(condition)</code>: Asserts that a condition is true.</p>
</li>
<li>
<p><code>EXPECT_FALSE(condition)</code>: Expects that a condition is false.</p>
</li>
<li>
<p><code>ASSERT_FALSE(condition)</code>: Asserts that a condition is false.</p>
</li>
<li>
<p><code>EXPECT_STREQ(expected_str, actual_str)</code>: Expects that two C-style strings are equal.</p>
</li>
<li>
<p><code>ASSERT_STREQ(expected_str, actual_str)</code>: Asserts that two C-style strings are equal.</p>
</li>
<li>
<p><code>EXPECT_STRNE(str1, str2)</code>: Expects that two C-style strings are not equal.</p>
</li>
<li>
<p><code>ASSERT_STRNE(str1, str2)</code>: Asserts that two C-style strings are not equal.</p>
</li>
<li>
<p><code>EXPECT_THROW(statement, exception_type)</code>: Expects that a specific statement throws a particular exception.</p>
</li>
<li>
<p><code>ASSERT_THROW(statement, exception_type)</code>: Asserts that a specific statement throws a particular exception.</p>
</li>
</ol>
<h3 id="542-tips"><a class="markdownIt-Anchor" href="#542-tips"></a> 5.4.2 Tips</h3>
<ol>
<li>假设编译得到的二进制是<code>test</code>，通过执行<code>./test --help</code>就可以看到所有gtest支持的参数，包括执行特定case等等</li>
</ol>
<h2 id="55-benchmark"><a class="markdownIt-Anchor" href="#55-benchmark"></a> 5.5 benchmark</h2>
<p><strong>Install <a target="_blank" rel="noopener" href="https://github.com/google/benchmark">benchmark</a>:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/benchmark.git</span><br><span class="line"><span class="built_in">cd</span> benchmark</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/google/googletest.git contrib/googletest</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DGOOGLETEST_PATH=contrib/googletest -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>Incorporating into a CMake project:</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(benchmark REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(xxx benchmark::benchmark)</span><br></pre></td></tr></table></figure>
<p><strong>Example:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p benchmark_demo</span><br><span class="line"><span class="built_in">cd</span> benchmark_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(benchmark_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall -fopt-info-vec)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(EXEC_FILES ./main.cpp)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;EXEC_FILES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(benchmark REQUIRED)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> benchmark::benchmark)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"><span class="comment">#include &lt;benchmark/benchmark.h&gt;</span></span><br><span class="line"></span><br><span class="line">static void BM_StringCreation(benchmark::State&amp; state) &#123;</span><br><span class="line">  <span class="keyword">for</span> (auto _ : state)</span><br><span class="line">    std::string empty_string;</span><br><span class="line">&#125;</span><br><span class="line">// Register the <span class="keyword">function</span> as a benchmark</span><br><span class="line">BENCHMARK(BM_StringCreation);</span><br><span class="line"></span><br><span class="line">// Define another benchmark</span><br><span class="line">static void BM_StringCopy(benchmark::State&amp; state) &#123;</span><br><span class="line">  std::string x = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (auto _ : state)</span><br><span class="line">    std::string copy(x);</span><br><span class="line">&#125;</span><br><span class="line">BENCHMARK(BM_StringCopy);</span><br><span class="line"></span><br><span class="line">BENCHMARK_MAIN();</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line"></span><br><span class="line">build/benchmark_demo</span><br></pre></td></tr></table></figure>
<p><strong>输出如下：</strong></p>
<ul>
<li><code>Time</code>：每次迭代消耗的总时间，包括cpu时间+等待时间</li>
<li><code>CPU</code>：每次迭代真正占用cpu的时间</li>
<li><code>Iterations</code>：迭代次数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------</span><br><span class="line">Benchmark                  Time             CPU   Iterations</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">BM_StringCreation       5.12 ns         5.12 ns    136772962</span><br><span class="line">BM_StringCopy           21.0 ns         21.0 ns     33441350</span><br></pre></td></tr></table></figure>
<h3 id="551-quick-benchmark"><a class="markdownIt-Anchor" href="#551-quick-benchmark"></a> 5.5.1 quick-benchmark</h3>
<p><a target="_blank" rel="noopener" href="https://quick-bench.com/">quick-bench（在线）</a></p>
<h3 id="552-tips"><a class="markdownIt-Anchor" href="#552-tips"></a> 5.5.2 Tips</h3>
<h4 id="5521-benchmarkdonotoptimize"><a class="markdownIt-Anchor" href="#5521-benchmarkdonotoptimize"></a> 5.5.2.1 benchmark::DoNotOptimize</h4>
<p>避免优化本不应该优化的代码，其源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> BENCHMARK_ALWAYS_INLINE <span class="type">void</span> <span class="title">DoNotOptimize</span><span class="params">(Tp&amp; value)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__clang__)</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;&quot;</span> : <span class="string">&quot;+r,m&quot;</span>(value) : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;&quot;</span> : <span class="string">&quot;+m,r&quot;</span>(value) : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5522-run-specific-case"><a class="markdownIt-Anchor" href="#5522-run-specific-case"></a> 5.5.2.2 Run Specific Case</h4>
<p>使用参数<code>--benchmark_filter=&lt;regexp&gt;</code>，此外可以使用<code>--help</code>查看所有参数</p>
<h3 id="553-reference"><a class="markdownIt-Anchor" href="#553-reference"></a> 5.5.3 Reference</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/benchmark/blob/main/docs/user_guide.md">benchmark/docs/user_guide.md</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/apocelipes/p/10348925.html">c++性能测试工具：google benchmark入门（一）</a></li>
</ul>
<h2 id="56-gperftoolsgperftools"><a class="markdownIt-Anchor" href="#56-gperftoolsgperftools"></a> 5.6 gperftools/gperftools</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/gperftools/gperftools">gperftools/gperftools</a></p>
<h2 id="57-snappy"><a class="markdownIt-Anchor" href="#57-snappy"></a> 5.7 snappy</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/google/snappy">snappy</a></p>
<p>Snappy is a compression/decompression library</p>
<h2 id="58-breakpad"><a class="markdownIt-Anchor" href="#58-breakpad"></a> 5.8 breakpad</h2>
<p>Breakpad is a library and tool suite that allows you to distribute an application to users with compiler-provided debugging information removed, record crashes in compact “minidump” files, send them back to your server, and produce C and C++ stack traces from these minidumps. Breakpad can also write minidumps on request for programs that have not crashed.</p>
<p>It includes following tools:</p>
<ul>
<li><code>minidump_stackwalk</code>: This tool processes minidump files to produce a human-readable stack trace. It uses symbol files to translate memory addresses into function names, file names, and line numbers
<ul>
<li><code>minidump_stackwalk &lt;minidump_file&gt; &lt;symbol_path&gt;</code></li>
</ul>
</li>
<li><code>microdump_stackwalk</code>: Similar to <code>minidump_stackwalk</code>, but specifically designed to process microdump files, which are smaller and contain less information than full minidumps
<ul>
<li><code>microdump_stackwalk &lt;microdump_file&gt; &lt;symbol_path&gt;</code></li>
</ul>
</li>
<li><code>dump_syms</code>: This tool extracts debugging symbols from a binary and outputs them in a format that can be uploaded to a symbol server
<ul>
<li><code>dump_syms &lt;binary_file&gt; &gt; &lt;output_symbol_file&gt;</code></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p breakpad_demo</span><br><span class="line"><span class="built_in">cd</span> breakpad_demo</span><br><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/breakpad/breakpad.git contrib/breakpad</span><br><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/linux-syscall-support.git contrib/breakpad/src/third_party/lss</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(breakpad_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(BREAKPAD_SOURCE_DIR <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/contrib/breakpad)</span><br><span class="line"><span class="built_in">set</span>(BREAKPAD_BINARY_DIR <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/breakpad_build)</span><br><span class="line"></span><br><span class="line">include(ExternalProject)</span><br><span class="line">ExternalProject_Add(</span><br><span class="line">    breakpad</span><br><span class="line">    SOURCE_DIR <span class="variable">$&#123;BREAKPAD_SOURCE_DIR&#125;</span></span><br><span class="line">    BINARY_DIR <span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span></span><br><span class="line">    CONFIGURE_COMMAND <span class="variable">$&#123;BREAKPAD_SOURCE_DIR&#125;</span>/configure --prefix=<span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span></span><br><span class="line">    <span class="comment"># --unset=MAKEFLAGS is mandatory to avoid nested make issues, error message like: make[3]: warning: jobserver unavailable: using -j1.  Add &#x27;+&#x27; to parent make rule.</span></span><br><span class="line">    BUILD_COMMAND <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E <span class="built_in">env</span> --<span class="built_in">unset</span>=MAKEFLAGS <span class="variable">$&#123;CMAKE_MAKE_PROGRAM&#125;</span> -C <span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span></span><br><span class="line">    INSTALL_COMMAND <span class="string">&quot;&quot;</span></span><br><span class="line">    BUILD_BYPRODUCTS <span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span>/src/client/linux/libbreakpad_client.a</span><br><span class="line">)</span><br><span class="line">add_custom_command(</span><br><span class="line">    TARGET breakpad</span><br><span class="line">    POST_BUILD</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E copy_directory</span><br><span class="line">    <span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span></span><br><span class="line">    <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/breakpad_product</span><br><span class="line">)</span><br><span class="line">add_dependencies(<span class="variable">$&#123;PROJECT_NAME&#125;</span> breakpad)</span><br><span class="line"></span><br><span class="line">target_include_directories(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE <span class="variable">$&#123;BREAKPAD_SOURCE_DIR&#125;</span>/src)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE <span class="variable">$&#123;BREAKPAD_BINARY_DIR&#125;</span>/src/client/linux/libbreakpad_client.a)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE pthread)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;client/linux/handler/exception_handler.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdexcept&gt;</span></span><br><span class="line"></span><br><span class="line">bool DumpCallback(const google_breakpad::MinidumpDescriptor&amp; descriptor, void* context, bool succeeded) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">descriptor.path() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    return succeeded;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main(int argc, char* argv[]) &#123;</span></span><br><span class="line"><span class="string">    google_breakpad::MinidumpDescriptor descriptor</span>(<span class="string">&quot;./minidumps&quot;</span>);</span><br><span class="line">    google_breakpad::ExceptionHandler handler(descriptor, nullptr, DumpCallback, nullptr, <span class="literal">true</span>, -1);</span><br><span class="line"></span><br><span class="line">    throw std::runtime_error(<span class="string">&quot;Test exception&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line"></span><br><span class="line">find build/breakpad_build -<span class="built_in">type</span> f -executable</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p minidumps</span><br><span class="line"><span class="comment"># step1: generate symbol file</span></span><br><span class="line">build/breakpad_build/src/tools/linux/dump_syms/dump_syms build/breakpad_demo &gt; build/breakpad_demo.sym</span><br><span class="line"><span class="comment"># step2: generate dump file</span></span><br><span class="line">dump_path=$(build/breakpad_demo | grep <span class="string">&#x27;minidumps&#x27;</span>)</span><br><span class="line"><span class="comment"># step3: analyze dump file</span></span><br><span class="line">build/breakpad_build/src/processor/minidump_stackwalk <span class="variable">$&#123;dump_path&#125;</span> build/breakpad_demo</span><br></pre></td></tr></table></figure>
<h2 id="59-protobuf"><a class="markdownIt-Anchor" href="#59-protobuf"></a> 5.9 protobuf</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/protocolbuffers/protobuf.git</span><br><span class="line"><span class="built_in">cd</span> protobuf</span><br><span class="line">git checkout v3.14.0</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -S cmake -DCMAKE_C_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span> -fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span></span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>CMakeLists.txt example:</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Protobuf REQUIRED)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;Protobuf_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>)</span><br><span class="line">protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS foo.proto)</span><br><span class="line">protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS EXPORT_MACRO DLL_EXPORT foo.proto)</span><br><span class="line">protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS DESCRIPTORS PROTO_DESCS foo.proto)</span><br><span class="line">protobuf_generate_python(PROTO_PY foo.proto)</span><br><span class="line"><span class="keyword">add_executable</span>(bar bar.cc <span class="variable">$&#123;PROTO_SRCS&#125;</span> <span class="variable">$&#123;PROTO_HDRS&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(bar <span class="variable">$&#123;Protobuf_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="510-leveldb"><a class="markdownIt-Anchor" href="#510-leveldb"></a> 5.10 leveldb</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/leveldb.git</span><br><span class="line"><span class="built_in">cd</span> leveldb</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=<span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -fPIC&quot;</span> -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<h1 id="6-apache"><a class="markdownIt-Anchor" href="#6-apache"></a> 6 Apache</h1>
<h2 id="61-arrow"><a class="markdownIt-Anchor" href="#61-arrow"></a> 6.1 arrow</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/arrow">apache-arrow</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/arrow/blob/main/docs/source/developers/cpp/building.rst">Building Arrow C++</a>: Find all building Optional Components here</li>
</ul>
<p>Requirement:</p>
<ol>
<li><code>protobuf</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b apache-arrow-16.1.0 https://github.com/apache/arrow.git</span><br><span class="line"><span class="built_in">cd</span> arrow/cpp</span><br><span class="line"></span><br><span class="line">cmake --list-presets</span><br><span class="line">cmake --preset -N ninja-release</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON --preset ninja-release -DPARQUET_REQUIRE_ENCRYPTION=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/usr/local/lib64&#x27;</span> | sudo <span class="built_in">tee</span> /etc/ld.so.conf.d/arrow.conf &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<p>Build with llvm’s libc++</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON --preset ninja-release -DPARQUET_REQUIRE_ENCRYPTION=ON \</span><br><span class="line">      -DCMAKE_C_COMPILER=clang \</span><br><span class="line">      -DCMAKE_CXX_COMPILER=clang++ \</span><br><span class="line">      -DCMAKE_CXX_FLAGS=<span class="string">&quot;-stdlib=libc++&quot;</span> \</span><br><span class="line">      -DCMAKE_EXE_LINKER_FLAGS=<span class="string">&quot;-stdlib=libc++&quot;</span> \</span><br><span class="line">      -DCMAKE_SHARED_LINKER_FLAGS=<span class="string">&quot;-stdlib=libc++&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="611-parquet-module"><a class="markdownIt-Anchor" href="#611-parquet-module"></a> 6.1.1 Parquet Module</h3>
<p><strong>Related Docs:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://arrow.apache.org/docs/cpp/parquet.html">Reading and writing Parquet files</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/parquet-format/blob/master/Encryption.md">Parquet Modular Encryption</a></li>
</ul>
<p><strong>Parquet demo without encryption:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/io/api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/pretty_print.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/result.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/type_fwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/arrow/reader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/arrow/writer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/exception.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">arrow::Status <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create a simple table</span></span><br><span class="line">    arrow::Int64Builder col_builder1;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder1.<span class="built_in">AppendValues</span>(&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;));</span><br><span class="line">    arrow::DoubleBuilder col_builder2;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder2.<span class="built_in">AppendValues</span>(&#123;<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>&#125;));</span><br><span class="line">    arrow::StringBuilder col_builder3;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder3.<span class="built_in">AppendValues</span>(&#123;<span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Jack&quot;</span>&#125;));</span><br><span class="line"></span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; col_array1;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder1.<span class="built_in">Finish</span>(&amp;col_array1));</span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; col_array2;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder2.<span class="built_in">Finish</span>(&amp;col_array2));</span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; col_array3;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(col_builder3.<span class="built_in">Finish</span>(&amp;col_array3));</span><br><span class="line">    std::shared_ptr&lt;arrow::Schema&gt; schema = arrow::<span class="built_in">schema</span>(&#123;arrow::<span class="built_in">field</span>(<span class="string">&quot;int_column&quot;</span>, arrow::<span class="built_in">int64</span>(), <span class="literal">false</span>),</span><br><span class="line">                                                           arrow::<span class="built_in">field</span>(<span class="string">&quot;double_column&quot;</span>, arrow::<span class="built_in">float64</span>(), <span class="literal">false</span>),</span><br><span class="line">                                                           arrow::<span class="built_in">field</span>(<span class="string">&quot;str_column&quot;</span>, arrow::<span class="built_in">utf8</span>(), <span class="literal">false</span>)&#125;);</span><br><span class="line">    <span class="keyword">auto</span> table = arrow::Table::<span class="built_in">Make</span>(schema, &#123;col_array1, col_array2, col_array3&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the table to a Parquet file</span></span><br><span class="line">    std::string file_path = <span class="string">&quot;data.parquet&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;arrow::io::FileOutputStream&gt; outfile;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::io::FileOutputStream::<span class="built_in">Open</span>(file_path).<span class="built_in">Value</span>(&amp;outfile));</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(parquet::arrow::<span class="built_in">WriteTable</span>(*table, arrow::<span class="built_in">default_memory_pool</span>(), outfile, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the Parquet file back into a table</span></span><br><span class="line">    std::shared_ptr&lt;arrow::io::ReadableFile&gt; infile;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::io::ReadableFile::<span class="built_in">Open</span>(file_path, arrow::<span class="built_in">default_memory_pool</span>()).<span class="built_in">Value</span>(&amp;infile));</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;parquet::arrow::FileReader&gt; reader;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(parquet::arrow::<span class="built_in">OpenFile</span>(infile, arrow::<span class="built_in">default_memory_pool</span>(), &amp;reader));</span><br><span class="line"></span><br><span class="line">    std::shared_ptr&lt;arrow::Table&gt; read_table;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(reader-&gt;<span class="built_in">ReadTable</span>(&amp;read_table));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Print the table to std::cout</span></span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::<span class="built_in">PrettyPrint</span>(*read_table.<span class="built_in">get</span>(), &#123;&#125;, &amp;ss));</span><br><span class="line">    std::cout &lt;&lt; ss.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> arrow::Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> status = <span class="built_in">execute</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o arrow_parquet_demo arrow_parquet_demo.cpp -lstdc++ -std=gnu++17 -larrow -lparquet</span><br><span class="line">./arrow_parquet_demo</span><br></pre></td></tr></table></figure>
<p><strong>Parquet demo with encryption:</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/io/api.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/pretty_print.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/result.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/status.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arrow/type_fwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/arrow/reader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/arrow/writer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;parquet/exception.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">arrow::Status <span class="title">execute</span><span class="params">(<span class="type">bool</span> footer_plaintext, <span class="type">bool</span> column_use_footer_key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create a simple table</span></span><br><span class="line">    arrow::Int64Builder int_col_builder;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(int_col_builder.<span class="built_in">AppendValues</span>(&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;));</span><br><span class="line">    arrow::DoubleBuilder double_col_builder;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(double_col_builder.<span class="built_in">AppendValues</span>(&#123;<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>&#125;));</span><br><span class="line">    arrow::StringBuilder str_col_builder;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(str_col_builder.<span class="built_in">AppendValues</span>(&#123;<span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Jack&quot;</span>&#125;));</span><br><span class="line"></span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; int_col_array;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(int_col_builder.<span class="built_in">Finish</span>(&amp;int_col_array));</span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; double_col_array;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(double_col_builder.<span class="built_in">Finish</span>(&amp;double_col_array));</span><br><span class="line">    std::shared_ptr&lt;arrow::Array&gt; str_col_array;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(str_col_builder.<span class="built_in">Finish</span>(&amp;str_col_array));</span><br><span class="line">    std::shared_ptr&lt;arrow::Schema&gt; schema = arrow::<span class="built_in">schema</span>(&#123;arrow::<span class="built_in">field</span>(<span class="string">&quot;int_column&quot;</span>, arrow::<span class="built_in">int64</span>(), <span class="literal">false</span>),</span><br><span class="line">                                                           arrow::<span class="built_in">field</span>(<span class="string">&quot;double_column&quot;</span>, arrow::<span class="built_in">float64</span>(), <span class="literal">false</span>),</span><br><span class="line">                                                           arrow::<span class="built_in">field</span>(<span class="string">&quot;str_column&quot;</span>, arrow::<span class="built_in">utf8</span>(), <span class="literal">false</span>)&#125;);</span><br><span class="line">    <span class="keyword">auto</span> table = arrow::Table::<span class="built_in">Make</span>(schema, &#123;int_col_array, double_col_array, str_col_array&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the table to a Parquet file</span></span><br><span class="line">    <span class="type">const</span> std::string file_path = <span class="string">&quot;data.parquet&quot;</span>;</span><br><span class="line">    std::shared_ptr&lt;arrow::io::FileOutputStream&gt; outfile;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::io::FileOutputStream::<span class="built_in">Open</span>(file_path).<span class="built_in">Value</span>(&amp;outfile));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lenght of key must be 16 or 24 or 32</span></span><br><span class="line">    <span class="type">const</span> std::string footer_key = <span class="string">&quot;footer_key______________&quot;</span>;</span><br><span class="line">    <span class="type">const</span> std::string int_column_key = <span class="string">&quot;int_column_key__________&quot;</span>;</span><br><span class="line">    <span class="type">const</span> std::string double_column_key = <span class="string">&quot;double_column_key_______&quot;</span>;</span><br><span class="line">    <span class="type">const</span> std::string str_column_key = <span class="string">&quot;str_column_key__________&quot;</span>;</span><br><span class="line"></span><br><span class="line">    parquet::<span class="function">FileEncryptionProperties::Builder <span class="title">file_encryption_props_builder</span><span class="params">(footer_key)</span></span>;</span><br><span class="line">    file_encryption_props_builder.<span class="built_in">algorithm</span>(parquet::ParquetCipher::AES_GCM_V1);</span><br><span class="line">    <span class="keyword">if</span> (footer_plaintext) &#123;</span><br><span class="line">        file_encryption_props_builder.<span class="built_in">set_plaintext_footer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!column_use_footer_key) &#123;</span><br><span class="line">        parquet::ColumnPathToEncryptionPropertiesMap encrypted_columns;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnEncryptionProperties::Builder <span class="title">column_encryption_props_builder</span><span class="params">(<span class="string">&quot;int_column&quot;</span>)</span></span>;</span><br><span class="line">            column_encryption_props_builder.<span class="built_in">key</span>(int_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnEncryptionProperties::Builder <span class="title">column_encryption_props_builder</span><span class="params">(<span class="string">&quot;double_column&quot;</span>)</span></span>;</span><br><span class="line">            column_encryption_props_builder.<span class="built_in">key</span>(double_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnEncryptionProperties::Builder <span class="title">column_encryption_props_builder</span><span class="params">(<span class="string">&quot;str_column&quot;</span>)</span></span>;</span><br><span class="line">            column_encryption_props_builder.<span class="built_in">key</span>(str_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        file_encryption_props_builder.<span class="built_in">encrypted_columns</span>(encrypted_columns);</span><br><span class="line">    &#125;</span><br><span class="line">    std::shared_ptr&lt;parquet::FileEncryptionProperties&gt; file_encryption_props = file_encryption_props_builder.<span class="built_in">build</span>();</span><br><span class="line">    std::shared_ptr&lt;parquet::WriterProperties&gt; write_props =</span><br><span class="line">            parquet::WriterProperties::<span class="built_in">Builder</span>().<span class="built_in">encryption</span>(file_encryption_props)-&gt;<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(parquet::arrow::<span class="built_in">WriteTable</span>(*table, arrow::<span class="built_in">default_memory_pool</span>(), outfile, <span class="number">3</span>, write_props));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the Parquet file back into a table</span></span><br><span class="line">    std::shared_ptr&lt;arrow::io::ReadableFile&gt; infile;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::io::ReadableFile::<span class="built_in">Open</span>(file_path, arrow::<span class="built_in">default_memory_pool</span>()).<span class="built_in">Value</span>(&amp;infile));</span><br><span class="line"></span><br><span class="line">    parquet::FileDecryptionProperties::Builder file_decryption_props_builder;</span><br><span class="line">    <span class="comment">// Why footer key required if set_plaintext_footer is called</span></span><br><span class="line">    file_decryption_props_builder.<span class="built_in">footer_key</span>(footer_key);</span><br><span class="line">    <span class="keyword">if</span> (!column_use_footer_key) &#123;</span><br><span class="line">        parquet::ColumnPathToDecryptionPropertiesMap decrypted_columns;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnDecryptionProperties::Builder <span class="title">column_decryption_props_builder</span><span class="params">(<span class="string">&quot;int_column&quot;</span>)</span></span>;</span><br><span class="line">            column_decryption_props_builder.<span class="built_in">key</span>(int_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnDecryptionProperties::Builder <span class="title">column_decryption_props_builder</span><span class="params">(<span class="string">&quot;double_column&quot;</span>)</span></span>;</span><br><span class="line">            column_decryption_props_builder.<span class="built_in">key</span>(double_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            parquet::<span class="function">ColumnDecryptionProperties::Builder <span class="title">column_decryption_props_builder</span><span class="params">(<span class="string">&quot;str_column&quot;</span>)</span></span>;</span><br><span class="line">            column_decryption_props_builder.<span class="built_in">key</span>(str_column_key);</span><br><span class="line">        &#125;</span><br><span class="line">        file_decryption_props_builder.<span class="built_in">column_keys</span>(decrypted_columns);</span><br><span class="line">    &#125;</span><br><span class="line">    std::shared_ptr&lt;parquet::FileDecryptionProperties&gt; file_decryption_props = file_decryption_props_builder.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">    parquet::ReaderProperties read_props;</span><br><span class="line">    read_props.<span class="built_in">file_decryption_properties</span>(file_decryption_props);</span><br><span class="line">    parquet::arrow::FileReaderBuilder file_reader_builder;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(file_reader_builder.<span class="built_in">Open</span>(infile, read_props));</span><br><span class="line">    std::unique_ptr&lt;parquet::arrow::FileReader&gt; reader;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(file_reader_builder.<span class="built_in">Build</span>(&amp;reader));</span><br><span class="line"></span><br><span class="line">    std::shared_ptr&lt;arrow::Table&gt; read_table;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(reader-&gt;<span class="built_in">ReadTable</span>(&amp;read_table));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Print the table to std::cout</span></span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    <span class="built_in">ARROW_RETURN_NOT_OK</span>(arrow::<span class="built_in">PrettyPrint</span>(*read_table.<span class="built_in">get</span>(), &#123;&#125;, &amp;ss));</span><br><span class="line">    std::cout &lt;&lt; ss.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> arrow::Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> status = <span class="built_in">execute</span>(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) std::cout &lt;&lt; status.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">execute</span>(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) std::cout &lt;&lt; status.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">execute</span>(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) std::cout &lt;&lt; status.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">execute</span>(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!status.<span class="built_in">ok</span>()) std::cout &lt;&lt; status.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o arrow_parquet_demo arrow_parquet_demo.cpp -lstdc++ -std=gnu++17 -larrow -lparquet</span><br><span class="line">./arrow_parquet_demo</span><br></pre></td></tr></table></figure>
<h2 id="62-thrift"><a class="markdownIt-Anchor" href="#62-thrift"></a> 6.2 thrift</h2>
<p>Requirement:</p>
<ol>
<li><code>libtool</code></li>
<li><code>bison</code></li>
<li><code>flex</code></li>
<li><code>openssl-devel</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b v0.16.0 https://github.com/apache/thrift.git</span><br><span class="line"><span class="built_in">cd</span> thrift</span><br><span class="line"></span><br><span class="line">./bootstrap.sh</span><br><span class="line"><span class="comment"># you can build specific lib by using --with-xxx or --without-xxx</span></span><br><span class="line">./configure --with-cpp=<span class="built_in">yes</span> --with-java=no --with-python=no --with-py3=no --with-nodejs=no</span><br><span class="line">make -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/usr/local/lib&#x27;</span> | sudo <span class="built_in">tee</span> /etc/ld.so.conf.d/thrift.conf &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; example.thrift &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">namespace cpp example</span><br><span class="line"></span><br><span class="line">struct Person &#123;</span><br><span class="line">  1: string name,</span><br><span class="line">  2: i32 age,</span><br><span class="line">  3: string email</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service PersonService &#123;</span><br><span class="line">  void addPerson(1: Person person)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">thrift --gen cpp example.thrift</span><br></pre></td></tr></table></figure>
<h2 id="63-brpc"><a class="markdownIt-Anchor" href="#63-brpc"></a> 6.3 brpc</h2>
<p>Requirement:</p>
<ul>
<li><code>gflag</code>: Built with <code>-fPIC</code> option</li>
<li><code>protobuf</code>: Built with <code>-fPIC</code> option, and requires specific version, here I choose <code>v3.14.0</code></li>
<li><code>leveldb</code>: Built with <code>-fPIC</code> option</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/incubator-brpc.git</span><br><span class="line"><span class="built_in">cd</span> incubator-brpc</span><br><span class="line">git checkout 1.9.0</span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install build &amp;&amp; sudo ldconfig</span><br></pre></td></tr></table></figure>
<h3 id="631-faq"><a class="markdownIt-Anchor" href="#631-faq"></a> 6.3.1 FAQ</h3>
<ol>
<li><code>brpc</code> uses coroutines, and using <code>std::mutex</code> within a coroutine might cause deadlock issues. Therefore, <code>bthread::Mutex</code> should be used.</li>
<li><code>bthread</code> cannot work with JNI, it may occur <code>java.lang.IllegalMonitorStateException</code></li>
</ol>
<h3 id="632-reference"><a class="markdownIt-Anchor" href="#632-reference"></a> 6.3.2 Reference</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/294129746">BRPC的精华全在bthread上啦（一）：Work Stealing以及任务的执行与切换</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/346081659">BRPC的精华全在bthread上啦（二）：ParkingLot 与Worker同步任务状态</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/347499412">BRPC的精华全在bthread上啦（三）：bthread上下文的创建</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/350582218">BRPC的精华都在bthread上啦（四）：尾声</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/incubator-brpc/blob/master/docs/cn/contention_profiler.md">contention_profiler.md</a></li>
</ul>
<h1 id="7-jni"><a class="markdownIt-Anchor" href="#7-jni"></a> 7 JNI</h1>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/functions.html">Chapter 4: JNI Functions</a></p>
<ul>
<li><code>PushLocalFrame</code>/<code>PopLocalFrame</code>: Manage local reference automatically</li>
<li><code>NewGlobalRef</code>/<code>DeleteGlobalRef</code>: Create/Delete global reference manually, this cannot be managed by <code>PushLocalFrame</code>/<code>PopLocalFrame</code></li>
<li><code>DeleteLocalRef</code>: Delete local reference manually created by java function or jni API</li>
</ul>
<h2 id="71-example"><a class="markdownIt-Anchor" href="#71-example"></a> 7.1 Example</h2>
<h3 id="711-hello-world"><a class="markdownIt-Anchor" href="#711-hello-world"></a> 7.1.1 Hello World</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p jni_demo/build</span><br><span class="line"><span class="built_in">cd</span> jni_demo</span><br><span class="line"><span class="built_in">cat</span> &gt; HelloWorld.java &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">public class HelloWorld &#123;</span><br><span class="line">    public void <span class="function"><span class="title">greet</span></span>() &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello from Java!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new HelloWorld().greet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; jni_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;jni.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    JavaVM* jvm;</span><br><span class="line">    JNIEnv* <span class="built_in">env</span>;</span><br><span class="line">    JavaVMInitArgs vm_args;</span><br><span class="line">    JavaVMOption options[1];</span><br><span class="line">    options[0].optionString = (char*)(<span class="string">&quot;-Djava.class.path=./&quot;</span>);</span><br><span class="line">    vm_args.version = JNI_VERSION_1_8;</span><br><span class="line">    vm_args.nOptions = 1;</span><br><span class="line">    vm_args.options = options;</span><br><span class="line">    vm_args.ignoreUnrecognized = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    // Load and initialize a Java VM, <span class="built_in">return</span> a JNI interface pointer <span class="keyword">in</span> <span class="built_in">env</span></span><br><span class="line">    jint res = JNI_CreateJavaVM(&amp;jvm, (void**)&amp;<span class="built_in">env</span>, &amp;vm_args);</span><br><span class="line">    <span class="keyword">if</span> (res != JNI_OK) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create JVM&quot;</span> &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Verify JVM version</span></span><br><span class="line"><span class="string">    jint ver = env-&gt;GetVersion();</span></span><br><span class="line"><span class="string">    std</span>::cout &lt;&lt; <span class="string">&quot;JVM version: &quot;</span> &lt;&lt; ((ver &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0</span>x0f) &lt;&lt; &quot;.&quot; &lt;&lt; (ver &amp; <span class="number">0</span>x0f) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    // Get Class</span><br><span class="line">    jclass cls = env-&gt;FindClass(&quot;HelloWorld&quot;);</span><br><span class="line">    if (cls == nullptr) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Failed to find class&quot; &lt;&lt; std::endl;</span><br><span class="line">        jvm-&gt;DestroyJavaVM();</span><br><span class="line">        return <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Get Method</span><br><span class="line">    jmethodID mid = env-&gt;GetMethodID(cls, &quot;greet&quot;, &quot;()V&quot;);</span><br><span class="line">    if (mid == nullptr) &#123;</span><br><span class="line">        std::cerr &lt;&lt; &quot;Failed to find method&quot; &lt;&lt; std::endl;</span><br><span class="line">        // Print the exception stack trace</span><br><span class="line">        if (env-&gt;ExceptionOccurred()) &#123;</span><br><span class="line">            <span class="built_in">env</span>-&gt;ExceptionDescribe();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jvm-&gt;DestroyJavaVM();</span><br><span class="line">        <span class="built_in">return</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create Instance</span><br><span class="line">    jobject obj = <span class="built_in">env</span>-&gt;AllocObject(cls);</span><br><span class="line">    <span class="keyword">if</span> (obj == nullptr) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create object&quot;</span> &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        jvm-&gt;DestroyJavaVM();</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Invoke</span></span><br><span class="line"><span class="string">    env-&gt;CallVoidMethod(obj, mid);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Destroy</span></span><br><span class="line"><span class="string">    jvm-&gt;DestroyJavaVM();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">javac HelloWorld.java</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># libjvm.so may be in ($&#123;JAVA_HOME&#125;/lib/server, $&#123;JAVA_HOME&#125;/jre/lib/amd64/server)</span></span><br><span class="line"><span class="string">JVM_SO_PATH=$(find $(readlink -f $&#123;JAVA_HOME&#125;) -name &quot;libjvm.so&quot;)</span></span><br><span class="line"><span class="string">JVM_SO_PATH=$&#123;JVM_SO_PATH%/*&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Compile way 1 (Please set JAVA_HOME first)</span></span><br><span class="line"><span class="string">gcc -o build/jni_demo jni_demo.cpp -I&quot;$&#123;JAVA_HOME&#125;/include&quot; -I&quot;$&#123;JAVA_HOME&#125;/include/linux&quot; -L&quot;$&#123;JVM_SO_PATH&#125;&quot; -lstdc++ -std</span>=gnu++17 -ljvm &amp;&amp; LD_LIBRARY_PATH=<span class="variable">$&#123;JVM_SO_PATH&#125;</span> build/jni_demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile way 2 (Please set JAVA_HOME first)</span></span><br><span class="line">C_INCLUDE_PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/include:<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux:<span class="variable">$&#123;C_INCLUDE_PATH&#125;</span> \</span><br><span class="line">CPLUS_INCLUDE_PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/include:<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux:<span class="variable">$&#123;CPLUS_INCLUDE_PATH&#125;</span> \</span><br><span class="line">LIBRARY_PATH=<span class="variable">$&#123;JVM_SO_PATH&#125;</span>:<span class="variable">$&#123;LIBRARY_PATH&#125;</span> \</span><br><span class="line">gcc -o build/jni_demo jni_demo.cpp -lstdc++ -std=gnu++17 -ljvm &amp;&amp; LD_LIBRARY_PATH=<span class="variable">$&#123;JVM_SO_PATH&#125;</span> build/jni_demo</span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JVM version: 10.0</span><br><span class="line">Hello from Java!</span><br></pre></td></tr></table></figure>
<p><strong>Tips:</strong></p>
<ul>
<li>Cannot find class: Maybe the javac version is greater than the jvm, double check that.</li>
</ul>
<p><strong>Cmake Example: (Share the same <code>main.cpp</code> as above)</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(jni_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(JAVA_HOME <span class="variable">$ENV</span>&#123;JAVA_HOME&#125;)</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;JAVA_HOME&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;env &#x27;JAVA_HOME&#x27; is required&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"><span class="comment"># For high jdk version</span></span><br><span class="line">file(GLOB LIB_JVM <span class="variable">$&#123;JAVA_HOME&#125;</span>/lib/server/libjvm.so)</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;LIB_JVM&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># For low jdk version</span></span><br><span class="line">    file(GLOB_RECURSE LIB_JVM <span class="variable">$&#123;JAVA_HOME&#125;</span>/jre/lib/*/server/libjvm.so)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;LIB_JVM&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;cannot find libjvm.so in <span class="variable">$&#123;JAVA_HOME&#125;</span>&quot;</span>)</span><br><span class="line">    endif()</span><br><span class="line">endif()</span><br><span class="line">add_library(jvm SHARED IMPORTED)</span><br><span class="line">set_target_properties(jvm PROPERTIES IMPORTED_LOCATION <span class="variable">$&#123;LIB_JVM&#125;</span>)</span><br><span class="line">target_include_directories(jvm INTERFACE <span class="variable">$&#123;JAVA_HOME&#125;</span>/include)</span><br><span class="line">target_include_directories(jvm INTERFACE <span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE jvm)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf build</span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">build/jni_demo</span><br></pre></td></tr></table></figure>
<h3 id="712-memory-leak"><a class="markdownIt-Anchor" href="#712-memory-leak"></a> 7.1.2 Memory Leak</h3>
<p><strong>Observations:</strong></p>
<ul>
<li>The local ref return by java function must be manually released, otherwise OOM may occur</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p jni_memory_leak_demo/build</span><br><span class="line"><span class="built_in">cd</span> jni_memory_leak_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; MemoryAllocator.java &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">public class MemoryAllocator &#123;</span><br><span class="line">    public byte[] allocateMemory(int size) &#123;</span><br><span class="line">        <span class="built_in">return</span> new byte[size];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; jni_memory_leak_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;jni.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;chrono&gt;</span></span><br><span class="line"><span class="comment">#include &lt;fstream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;thread&gt;</span></span><br><span class="line"></span><br><span class="line">constexpr const char* CURSOR_UP = <span class="string">&quot;\033[F&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#define ASSERT_TRUE(expr)                                                                      \</span></span><br><span class="line">    <span class="keyword">do</span> &#123;                                                                                       \</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="built_in">expr</span>)) &#123;                                                                         \</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;(LINE:&quot;</span> &lt;&lt; <span class="string">__LINE__ &lt;&lt; &quot;) Assertion failed: &quot; &lt;&lt; #expr &lt;&lt; std::endl; \</span></span><br><span class="line"><span class="string">            if (env-&gt;ExceptionOccurred()) &#123;                                                    \</span></span><br><span class="line"><span class="string">                env-&gt;ExceptionDescribe();                                                      \</span></span><br><span class="line"><span class="string">            &#125;                                                                                  \</span></span><br><span class="line"><span class="string">            jvm-&gt;DestroyJavaVM();                                                              \</span></span><br><span class="line"><span class="string">            exit(1);                                                                           \</span></span><br><span class="line"><span class="string">            __builtin_unreachable();                                                           \</span></span><br><span class="line"><span class="string">        &#125;                                                                                      \</span></span><br><span class="line"><span class="string">    &#125; while (0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main(int argc, char* argv[]) &#123;</span></span><br><span class="line"><span class="string">    const std::string help =</span></span><br><span class="line"><span class="string">            &quot;Usage: &quot; + std::string(argv[0]) + &quot; &lt;alloc_by_cpp|alloc_by_java&gt; &lt;keep|release&gt; [&lt;use_frame&gt;]&quot;;</span></span><br><span class="line"><span class="string">    if (argc &lt; 3) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; help &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (std::string(argv[1]) != &quot;alloc_by_cpp&quot; &amp;&amp; std::string(argv[1]) != &quot;alloc_by_java&quot;) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; help &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (std::string(argv[2]) != &quot;keep&quot; &amp;&amp; std::string(argv[2]) != &quot;release&quot;) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; help &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (argc == 4 &amp;&amp; std::string(argv[3]) != &quot;use_frame&quot;) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; help &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    const bool alloc_by_cpp = (std::string(argv[1]) == &quot;alloc_by_cpp&quot;);</span></span><br><span class="line"><span class="string">    const bool keep_memory = (std::string(argv[2]) == &quot;keep&quot;);</span></span><br><span class="line"><span class="string">    const bool use_frame = (argc == 4 &amp;&amp; std::string(argv[3]) == &quot;use_frame&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    JavaVM* jvm;</span></span><br><span class="line"><span class="string">    JNIEnv* env;</span></span><br><span class="line"><span class="string">    JavaVMInitArgs vm_args;</span></span><br><span class="line"><span class="string">    JavaVMOption options[2];</span></span><br><span class="line"><span class="string">    options[0].optionString = (char*)(&quot;-Djava.class.path=./&quot;);</span></span><br><span class="line"><span class="string">    options[1].optionString = (char*)(&quot;-Xmx1g&quot;);</span></span><br><span class="line"><span class="string">    vm_args.version = JNI_VERSION_1_8;</span></span><br><span class="line"><span class="string">    vm_args.nOptions = 2;</span></span><br><span class="line"><span class="string">    vm_args.options = options;</span></span><br><span class="line"><span class="string">    vm_args.ignoreUnrecognized = false;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jint res = JNI_CreateJavaVM(&amp;jvm, (void**)&amp;env, &amp;vm_args);</span></span><br><span class="line"><span class="string">    ASSERT_TRUE(res == JNI_OK);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jint version = env-&gt;GetVersion();</span></span><br><span class="line"><span class="string">    std::cout &lt;&lt; &quot;JVM version: &quot; &lt;&lt; ((version &gt;&gt; 16) &amp; 0x0f) &lt;&lt; &quot;.&quot; &lt;&lt; (version &amp; 0x0f) &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jclass cls = env-&gt;FindClass(&quot;MemoryAllocator&quot;);</span></span><br><span class="line"><span class="string">    ASSERT_TRUE(cls != nullptr);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jmethodID m_allocate_memory = env-&gt;GetMethodID(cls, &quot;allocateMemory&quot;, &quot;(I)[B&quot;);</span></span><br><span class="line"><span class="string">    ASSERT_TRUE(m_allocate_memory != nullptr);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jobject obj_memory_allocator = env-&gt;AllocObject(cls);</span></span><br><span class="line"><span class="string">    ASSERT_TRUE(obj_memory_allocator != nullptr);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    auto start = std::chrono::steady_clock::now();</span></span><br><span class="line"><span class="string">    while (true) &#123;</span></span><br><span class="line"><span class="string">        if (!keep_memory &amp;&amp; use_frame) &#123;</span></span><br><span class="line"><span class="string">            env-&gt;PushLocalFrame(1);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        const size_t _10M = 10 * 1024 * 1024;</span></span><br><span class="line"><span class="string">        jobject bytes = alloc_by_cpp ? env-&gt;NewByteArray(_10M)</span></span><br><span class="line"><span class="string">                                     : env-&gt;CallObjectMethod(obj_memory_allocator, m_allocate_memory, _10M);</span></span><br><span class="line"><span class="string">        ASSERT_TRUE(bytes != nullptr);</span></span><br><span class="line"><span class="string">        if (!keep_memory) &#123;</span></span><br><span class="line"><span class="string">            if (use_frame) &#123;</span></span><br><span class="line"><span class="string">                env-&gt;PopLocalFrame(nullptr);</span></span><br><span class="line"><span class="string">            &#125; else &#123;</span></span><br><span class="line"><span class="string">                env-&gt;DeleteLocalRef(bytes);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        std::ifstream iff(&quot;/proc/self/status&quot;);</span></span><br><span class="line"><span class="string">        std::string line;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        std::string vm_size;</span></span><br><span class="line"><span class="string">        std::string vm_rss;</span></span><br><span class="line"><span class="string">        std::string vm_hwm;</span></span><br><span class="line"><span class="string">        while (std::getline(iff, line)) &#123;</span></span><br><span class="line"><span class="string">            if (line.find(&quot;VmSize&quot;) != std::string::npos) &#123;</span></span><br><span class="line"><span class="string">                vm_size = line;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            if (line.find(&quot;VmRSS&quot;) != std::string::npos) &#123;</span></span><br><span class="line"><span class="string">                vm_rss = line;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            if (line.find(&quot;VmHWM&quot;) != std::string::npos) &#123;</span></span><br><span class="line"><span class="string">                vm_hwm = line;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; &quot;Memory Status:&quot; &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; &quot;    &quot; &lt;&lt; vm_size &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; &quot;    &quot; &lt;&lt; vm_rss &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; &quot;    &quot; &lt;&lt; vm_hwm &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        std::this_thread::sleep_for(std::chrono::milliseconds(10));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (std::chrono::duration_cast&lt;std::chrono::seconds&gt;(std::chrono::steady_clock::now() - start).count() &gt; 5) &#123;</span></span><br><span class="line"><span class="string">            break;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Move cursor up</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; CURSOR_UP &lt;&lt; CURSOR_UP &lt;&lt; CURSOR_UP &lt;&lt; CURSOR_UP;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    jvm-&gt;DestroyJavaVM();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">javac MemoryAllocator.java</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># libjvm.so may be in ($&#123;JAVA_HOME&#125;/lib/server, $&#123;JAVA_HOME&#125;/jre/lib/amd64/server)</span></span><br><span class="line"><span class="string">JVM_SO_PATH=$(find $(readlink -f $&#123;JAVA_HOME&#125;) -name &quot;libjvm.so&quot;)</span></span><br><span class="line"><span class="string">JVM_SO_PATH=$&#123;JVM_SO_PATH%/*&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">C_INCLUDE_PATH=$&#123;JAVA_HOME&#125;/include:$&#123;JAVA_HOME&#125;/include/linux:$&#123;C_INCLUDE_PATH&#125; \</span></span><br><span class="line"><span class="string">CPLUS_INCLUDE_PATH=$&#123;JAVA_HOME&#125;/include:$&#123;JAVA_HOME&#125;/include/linux:$&#123;CPLUS_INCLUDE_PATH&#125; \</span></span><br><span class="line"><span class="string">LIBRARY_PATH=$&#123;JVM_SO_PATH&#125;:$&#123;LIBRARY_PATH&#125; \</span></span><br><span class="line"><span class="string">gcc -o build/jni_memory_leak_demo jni_memory_leak_demo.cpp -lstdc++ -std=gnu++17 -ljvm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">LD_LIBRARY_PATH=$&#123;JVM_SO_PATH&#125; build/jni_memory_leak_demo alloc_by_cpp keep</span></span><br><span class="line"><span class="string">LD_LIBRARY_PATH=$&#123;JVM_SO_PATH&#125; build/jni_memory_leak_demo alloc_by_cpp release use_frame</span></span><br><span class="line"><span class="string">LD_LIBRARY_PATH=$&#123;JVM_SO_PATH&#125; build/jni_memory_leak_demo alloc_by_java keep use_frame</span></span><br><span class="line"><span class="string">LD_LIBRARY_PATH=$&#123;JVM_SO_PATH&#125; build/jni_memory_leak_demo alloc_by_java release</span></span><br></pre></td></tr></table></figure>
<h3 id="713-work-with-spring-fat-jar"><a class="markdownIt-Anchor" href="#713-work-with-spring-fat-jar"></a> 7.1.3 Work With Spring fat-jar</h3>
<p><strong>JNI cannot work smoothly with fat-jar built by plugin <code>spring-boot-maven-plugin</code>. Because the class path is started with <code>BOOT-INF/</code> or <code>BOOT-INF/lib/</code>, the default classloader cannot find it.</strong></p>
<p><strong>The following code can work with <code>org.springframework.boot:spring-boot-maven-plugin:2.1.4.RELEASE</code>, no guarantee that it can work with other versions because the Java API may vary.</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/liuyehcf/cpp-demo-projects/tree/main/jni/jni_spring_fat_jar_demo">jni_spring_fat_jar_demo</a></p>
<h2 id="72-libhdfs"><a class="markdownIt-Anchor" href="#72-libhdfs"></a> 7.2 libhdfs</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/hadoop/tree/trunk/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs">hadoop-libhdfs</a></p>
<p><strong><code>getJNIEnv</code>:</strong></p>
<ul>
<li>Each thread must have its own instance. Sharing this between different threads may cause unexpected issues</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * getJNIEnv: A helper function to get the JNIEnv* for the given thread.</span></span><br><span class="line"><span class="comment"> * If no JVM exists, then one will be created. JVM command line arguments</span></span><br><span class="line"><span class="comment"> * are obtained from the LIBHDFS_OPTS environment variable.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Implementation note: we rely on POSIX thread-local storage (tls).</span></span><br><span class="line"><span class="comment"> * This allows us to associate a destructor function with each thread, that</span></span><br><span class="line"><span class="comment"> * will detach the thread from the Java VM when the thread terminates.  If we</span></span><br><span class="line"><span class="comment"> * failt to do this, it will cause a memory leak.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * However, POSIX TLS is not the most efficient way to do things.  It requires a</span></span><br><span class="line"><span class="comment"> * key to be initialized before it can be used.  Since we don&#x27;t know if this key</span></span><br><span class="line"><span class="comment"> * is initialized at the start of this function, we have to lock a mutex first</span></span><br><span class="line"><span class="comment"> * and check.  Luckily, most operating systems support the more efficient</span></span><br><span class="line"><span class="comment"> * __thread construct, which is initialized by the linker.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param: None.</span></span><br><span class="line"><span class="comment"> * @return The JNIEnv* corresponding to the thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEnv* <span class="title">getJNIEnv</span><span class="params">(<span class="type">void</span>)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Build libhdfs:</strong> You need to download <a target="_blank" rel="noopener" href="https://github.com/apache/hadoop">hadoop</a> somewhere(this works well with tag <code>rel/release-3.4.0</code>), and set project path to env <code>export HADOOP_PATH=/path/to/hadoop</code>. And we need to comment out some of the hdfs classes initialization code if we don’t need hdfs:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/jni_helper.c b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/jni_helper.c</span></span><br><span class="line"><span class="comment">index 8f00a08b..797b0a82 100644</span></span><br><span class="line"><span class="comment">--- a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/jni_helper.c</span></span><br><span class="line"><span class="comment">+++ b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/jni_helper.c</span></span><br><span class="line"><span class="meta">@@ -745,16 +745,6 @@</span> static JNIEnv* getGlobalJNIEnv(void)</span><br><span class="line">                     &quot;with error: %d\n&quot;, rv);</span><br><span class="line">             return NULL;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-        // We use findClassAndInvokeMethod here because the jclasses in</span></span><br><span class="line"><span class="deletion">-        // jclasses.h have not loaded yet</span></span><br><span class="line"><span class="deletion">-        jthr = findClassAndInvokeMethod(env, NULL, STATIC, NULL, HADOOP_FS,</span></span><br><span class="line"><span class="deletion">-                &quot;loadFileSystems&quot;, &quot;()V&quot;);</span></span><br><span class="line"><span class="deletion">-        if (jthr) &#123;</span></span><br><span class="line"><span class="deletion">-            printExceptionAndFree(env, jthr, PRINT_EXC_ALL,</span></span><br><span class="line"><span class="deletion">-                    &quot;FileSystem: loadFileSystems failed&quot;);</span></span><br><span class="line"><span class="deletion">-            return NULL;</span></span><br><span class="line"><span class="deletion">-        &#125;</span></span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         //Attach this thread to the VM</span><br><span class="line">         vm = vmBuf[0];</span><br><span class="line"><span class="meta">@@ -832,12 +822,6 @@</span> JNIEnv* getJNIEnv(void)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     jthrowable jthr = NULL;</span><br><span class="line"><span class="deletion">-    jthr = initCachedClasses(state-&gt;env);</span></span><br><span class="line"><span class="deletion">-    if (jthr) &#123;</span></span><br><span class="line"><span class="deletion">-      printExceptionAndFree(state-&gt;env, jthr, PRINT_EXC_ALL,</span></span><br><span class="line"><span class="deletion">-                            &quot;initCachedClasses failed&quot;);</span></span><br><span class="line"><span class="deletion">-      goto fail;</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">     return state-&gt;env;</span><br><span class="line"></span><br><span class="line"> fail:</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p libhdfs_jni</span><br><span class="line"><span class="built_in">cd</span> libhdfs_jni</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.16)</span><br><span class="line"></span><br><span class="line">project(hdfs_jni)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(HADOOP_PATH <span class="variable">$ENV</span>&#123;HADOOP_PATH&#125;)</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;HADOOP_PATH&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;env &#x27;HADOOP_PATH&#x27; is required&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add target library</span></span><br><span class="line"><span class="built_in">set</span>(LIBHDFS_PATH <span class="variable">$&#123;HADOOP_PATH&#125;</span>/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs)</span><br><span class="line">file(GLOB LIBHDFS_SOURCES <span class="string">&quot;<span class="variable">$&#123;LIBHDFS_PATH&#125;</span>/*.c&quot;</span> <span class="string">&quot;<span class="variable">$&#123;LIBHDFS_PATH&#125;</span>/os/posix/*.c&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;LIBHDFS_SOURCES: <span class="variable">$&#123;LIBHDFS_SOURCES&#125;</span>&quot;</span>)</span><br><span class="line">add_library(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;LIBHDFS_SOURCES&#125;</span>)</span><br><span class="line">target_include_directories(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/include <span class="comment"># for empty config.h</span></span><br><span class="line">    <span class="variable">$&#123;LIBHDFS_PATH&#125;</span></span><br><span class="line">    <span class="variable">$&#123;LIBHDFS_PATH&#125;</span>/include</span><br><span class="line">    <span class="variable">$&#123;LIBHDFS_PATH&#125;</span>/os</span><br><span class="line">    <span class="variable">$&#123;LIBHDFS_PATH&#125;</span>/os/posix)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add x-platform dependency</span></span><br><span class="line">add_definitions(-DUSE_X_PLATFORM_DIRENT)</span><br><span class="line"><span class="built_in">set</span>(X_PLATFORM_PATH <span class="variable">$&#123;HADOOP_PATH&#125;</span>/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfspp/lib/x-platform)</span><br><span class="line">target_include_directories(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">    <span class="variable">$&#123;X_PLATFORM_PATH&#125;</span>/..)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dependency jvm</span></span><br><span class="line"><span class="built_in">set</span>(JAVA_HOME <span class="variable">$ENV</span>&#123;JAVA_HOME&#125;)</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;JAVA_HOME&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;env &#x27;JAVA_HOME&#x27; is required&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"><span class="comment"># For high jdk version</span></span><br><span class="line">file(GLOB LIB_JVM <span class="variable">$&#123;JAVA_HOME&#125;</span>/lib/server/libjvm.so)</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;LIB_JVM&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># For low jdk version</span></span><br><span class="line">    file(GLOB_RECURSE LIB_JVM <span class="variable">$&#123;JAVA_HOME&#125;</span>/jre/lib/*/server/libjvm.so)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;<span class="variable">$&#123;LIB_JVM&#125;</span>&quot;</span> STREQUAL <span class="string">&quot;&quot;</span>)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;cannot find libjvm.so in <span class="variable">$&#123;JAVA_HOME&#125;</span>&quot;</span>)</span><br><span class="line">    endif()</span><br><span class="line">endif()</span><br><span class="line">add_library(jvm SHARED IMPORTED)</span><br><span class="line">set_target_properties(jvm PROPERTIES IMPORTED_LOCATION <span class="variable">$&#123;LIB_JVM&#125;</span>)</span><br><span class="line">target_include_directories(jvm INTERFACE <span class="variable">$&#123;JAVA_HOME&#125;</span>/include)</span><br><span class="line">target_include_directories(jvm INTERFACE <span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE jvm)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p include</span><br><span class="line"><span class="built_in">touch</span> include/config.h</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br></pre></td></tr></table></figure>
<p>And we can use <code>build/libhdfs_jni.a</code> as following:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; libhdfs_jni_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;jni.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;thread&gt;</span></span><br><span class="line"><span class="comment">#include &lt;vector&gt;</span></span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> JNIEnv* getJNIEnv(void);</span><br><span class="line"></span><br><span class="line"><span class="comment">#define ASSERT(expr)                    \</span></span><br><span class="line">    <span class="keyword">if</span> (!(<span class="built_in">expr</span>)) &#123;                      \</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">env</span>-&gt;ExceptionOccurred()) &#123; \</span><br><span class="line">            <span class="built_in">env</span>-&gt;ExceptionDescribe();   \</span><br><span class="line">            <span class="built_in">exit</span>(1);                    \</span><br><span class="line">        &#125;                               \</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">        threads.emplace_back([i]() &#123;</span><br><span class="line">            auto* <span class="built_in">env</span> = getJNIEnv();</span><br><span class="line"></span><br><span class="line">            // Get java.lang.System</span><br><span class="line">            jclass cls_system = <span class="built_in">env</span>-&gt;FindClass(<span class="string">&quot;java/lang/System&quot;</span>);</span><br><span class="line">            ASSERT(cls_system != nullptr);</span><br><span class="line"></span><br><span class="line">            // Get out field</span><br><span class="line">            jfieldID f_out = <span class="built_in">env</span>-&gt;GetStaticFieldID(cls_system, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            jobject obj_out = <span class="built_in">env</span>-&gt;GetStaticObjectField(cls_system, f_out);</span><br><span class="line"></span><br><span class="line">            // Get Class</span><br><span class="line">            jclass cls_stream = <span class="built_in">env</span>-&gt;FindClass(<span class="string">&quot;java/io/PrintStream&quot;</span>);</span><br><span class="line">            ASSERT(cls_stream != nullptr);</span><br><span class="line"></span><br><span class="line">            // Get Method</span><br><span class="line">            jmethodID m_println = <span class="built_in">env</span>-&gt;GetMethodID(cls_stream, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">            ASSERT(m_println != nullptr);</span><br><span class="line"></span><br><span class="line">            // Invoke</span><br><span class="line">            std::string content = <span class="string">&quot;Hello world, this is thread: &quot;</span> + std::to_string(i);</span><br><span class="line">            jstring jcontent = <span class="built_in">env</span>-&gt;NewStringUTF(const_cast&lt;const char*&gt;((content).c_str()));</span><br><span class="line">            <span class="built_in">env</span>-&gt;CallVoidMethod(obj_out, m_println, jcontent);</span><br><span class="line">            <span class="built_in">env</span>-&gt;DeleteLocalRef(jcontent);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">        threads[i].<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># libjvm.so may be in ($&#123;JAVA_HOME&#125;/lib/server, $&#123;JAVA_HOME&#125;/jre/lib/amd64/server)</span></span><br><span class="line">JVM_SO_PATH=$(find $(<span class="built_in">readlink</span> -f <span class="variable">$&#123;JAVA_HOME&#125;</span>) -name <span class="string">&quot;libjvm.so&quot;</span>)</span><br><span class="line">JVM_SO_PATH=<span class="variable">$&#123;JVM_SO_PATH%/*&#125;</span></span><br><span class="line"></span><br><span class="line">C_INCLUDE_PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/include:<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux:<span class="variable">$&#123;C_INCLUDE_PATH&#125;</span> \</span><br><span class="line">CPLUS_INCLUDE_PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/include:<span class="variable">$&#123;JAVA_HOME&#125;</span>/include/linux:<span class="variable">$&#123;CPLUS_INCLUDE_PATH&#125;</span> \</span><br><span class="line">LIBRARY_PATH=<span class="variable">$&#123;JVM_SO_PATH&#125;</span>:<span class="variable">$&#123;LIBRARY_PATH&#125;</span> \</span><br><span class="line">gcc -o build/libhdfs_jni_demo libhdfs_jni_demo.cpp -lstdc++ -std=gnu++17 -Lbuild -lhdfs_jni -ljvm -lpthread &amp;&amp; LD_LIBRARY_PATH=<span class="variable">$&#123;JVM_SO_PATH&#125;</span> CLASSPATH= build/libhdfs_jni_demo</span><br></pre></td></tr></table></figure>
<h2 id="73-best-practice"><a class="markdownIt-Anchor" href="#73-best-practice"></a> 7.3 Best Practice</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/liuyehcf/cpp-demo-projects/tree/main/jni/jni_utils">jni_utils</a></p>
<h2 id="74-tips"><a class="markdownIt-Anchor" href="#74-tips"></a> 7.4 Tips</h2>
<h3 id="741-tricky-jvm-options"><a class="markdownIt-Anchor" href="#741-tricky-jvm-options"></a> 7.4.1 Tricky JVM options</h3>
<ol>
<li><code>-Djdk.lang.processReaperUseDefaultStackSize=true</code>
<ul>
<li><a target="_blank" rel="noopener" href="https://bugs.java.com/bugdatabase/view_bug?bug_id=8130425">JDK-8130425 : libjvm crash due to stack overflow in executables with 32k tbss/tdata</a></li>
<li><a target="_blank" rel="noopener" href="https://bugs.java.com/bugdatabase/view_bug?bug_id=8316968">JDK-8316968 : Add an option that allows to set the stack size of Process reaper threads</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/middleware/goldengate/big-data/21.1/gadbd/apache-hdfs-target.html#GUID-4B870E57-3219-4663-9EFD-41133B0EDE06">Apache HDFS</a></li>
</ul>
</li>
<li><code>-Xrs</code>: Reduces the use of operating system signals by the JVM
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">Java Platform, Standard Edition Tools Reference</a></li>
</ul>
</li>
</ol>
<h3 id="742-gc-vs-signal-sigsegv"><a class="markdownIt-Anchor" href="#742-gc-vs-signal-sigsegv"></a> 7.4.2 GC vs. signal SIGSEGV</h3>
<p>Here is an assumption: Jvm will use signal <code>SIGSEGV</code> to indicate that the gc process should run. And you can check it by <code>gdb</code> or <code>lldb</code> with a jni program, during which you may be interrupted frequently by <code>SIGSEGV</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Process 2494122 stopped</span><br><span class="line">* thread #1, name = &#x27;jni_demo&#x27;, stop reason = signal SIGSEGV: invalid address (fault address: 0x0)</span><br><span class="line">    frame #0: 0x00007fffe7c842b9</span><br><span class="line">-&gt;  0x7fffe7c842b9: movl   (%rsi), %eax</span><br><span class="line">    0x7fffe7c842bb: leaq   0xf8(%rbp), %rsi</span><br><span class="line">    0x7fffe7c842c2: vmovdqu %ymm0, (%rsi)</span><br><span class="line">    0x7fffe7c842c6: vmovdqu %ymm7, 0x20(%rsi)</span><br></pre></td></tr></table></figure>
<h3 id="743-how-to-add-jar-directory-to-classpah"><a class="markdownIt-Anchor" href="#743-how-to-add-jar-directory-to-classpah"></a> 7.4.3 How to add jar directory to classpah</h3>
<p>JNI doesn’t support wildcard <code>*</code>, so you need to generate all jar paths and join them with <code>:</code>, and then pass to <code>-Djava.class.path=</code> option.</p>
<h2 id="75-faq"><a class="markdownIt-Anchor" href="#75-faq"></a> 7.5 FAQ</h2>
<h3 id="751-javalangillegalmonitorstateexception"><a class="markdownIt-Anchor" href="#751-javalangillegalmonitorstateexception"></a> 7.5.1 java.lang.IllegalMonitorStateException</h3>
<p>JNI cannot work well with coroutines like <code>brpc's bthread</code> for several reasons (<a target="_blank" rel="noopener" href="https://github.com/apache/brpc/blob/a48d4cec87f448f80a93f265106422f1628ebf09/docs/cn/server.md?plain=1#L662">pthread mode</a>):</p>
<ul>
<li><code>Threading Model Mismatch</code>: JNI expects a specific threading model that aligns with Java’s managed threads. Coroutines, especially those implemented with bthread, may have different threading and execution models, leading to mismatches and unexpected behavior. JNI methods need to be called from specific threads, and coroutine libraries might not guarantee that.</li>
<li>Native Resource Management: Coroutines can suspend and resume execution, which complicates resource management in native code. Native code called via JNI might expect resources to be available for the duration of a method call, but coroutines can pause execution, potentially leading to resource leaks or other issues if the native code does not handle this correctly.</li>
<li>Synchronization Issues: Coroutines introduce their own scheduling and synchronization mechanisms, which can interfere with the synchronization primitives used in native code. This can lead to race conditions, deadlocks, or inconsistent state between the Java and native parts of an application.</li>
<li>Stack Management: Coroutines often manipulate the call stack in ways that traditional threading models do not. This can create problems for JNI, which relies on the standard call stack for invoking methods and managing local references. If a coroutine library like bthread changes the stack layout, it can disrupt JNI’s operation.</li>
<li>Callback Handling: JNI often involves callbacks from native code to Java, which can be problematic when using coroutines. The coroutine may not be in a state to handle a callback if it is suspended, leading to missed callbacks or crashes.</li>
<li>Context Switching Overhead: Coroutines are designed to minimize context switching overhead, but integrating them with JNI can reintroduce this overhead, negating the benefits of using coroutines in the first place.</li>
<li>Complexity in Debugging: The combination of Java, JNI, and coroutine libraries like bthread can make debugging very difficult. The interaction between the different layers can create complex bugs that are hard to reproduce and fix.</li>
</ul>
<h1 id="8-independent-projects"><a class="markdownIt-Anchor" href="#8-independent-projects"></a> 8 Independent Projects</h1>
<h2 id="81-pocoproject"><a class="markdownIt-Anchor" href="#81-pocoproject"></a> 8.1 Pocoproject</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b poco-1.13.3-release https://github.com/pocoproject/poco.git</span><br><span class="line"><span class="built_in">cd</span> poco</span><br><span class="line">cmake -B cmake-build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build cmake-build --config Release -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">sudo cmake --install cmake-build</span><br></pre></td></tr></table></figure>
<h3 id="811-logger"><a class="markdownIt-Anchor" href="#811-logger"></a> 8.1.1 Logger</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p poco_logger_demo</span><br><span class="line"><span class="built_in">cd</span> poco_logger_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(poco_logger_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(Poco REQUIRED COMPONENTS Foundation Net XML JSON)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> Poco::Foundation Poco::Net Poco::XML Poco::JSON)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; poco_logger_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/AutoPtr.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/ConsoleChannel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/FileChannel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/FormattingChannel.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Logger.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/PatternFormatter.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/SplitterChannel.h&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        Poco::AutoPtr&lt;Poco::ConsoleChannel&gt; console_channel(new Poco::ConsoleChannel);</span><br><span class="line">        Poco::AutoPtr&lt;Poco::PatternFormatter&gt; formatter(new Poco::PatternFormatter(<span class="string">&quot;%Y.%m.%d %H:%M:%S.%F &lt;%p&gt; %s: %t&quot;</span>));</span><br><span class="line">        Poco::AutoPtr&lt;Poco::FormattingChannel&gt; formatting_channel(</span><br><span class="line">                new Poco::FormattingChannel(formatter, console_channel));</span><br><span class="line">        Poco::Logger::root().setLevel(<span class="string">&quot;trace&quot;</span>);</span><br><span class="line">        Poco::Logger::root().setChannel(formatting_channel);</span><br><span class="line">        Poco::Logger::get(<span class="string">&quot;main_1&quot;</span>).information(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">        Poco::Logger::get(<span class="string">&quot;main_2&quot;</span>).information(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        Poco::AutoPtr&lt;Poco::FileChannel&gt; file_channel(new Poco::FileChannel(<span class="string">&quot;sample.log&quot;</span>));</span><br><span class="line">        file_channel-&gt;setProperty(<span class="string">&quot;rotation&quot;</span>, <span class="string">&quot;1 M&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Poco::AutoPtr&lt;Poco::PatternFormatter&gt; formatter(new Poco::PatternFormatter(<span class="string">&quot;%Y-%m-%d %H:%M:%S %s: %t&quot;</span>));</span><br><span class="line">        Poco::AutoPtr&lt;Poco::FormattingChannel&gt; formatting_channel(new Poco::FormattingChannel(formatter, file_channel));</span><br><span class="line"></span><br><span class="line">        Poco::Logger&amp; logger = Poco::Logger::create(<span class="string">&quot;FileLogger&quot;</span>, formatting_channel, Poco::Message::PRIO_INFORMATION);</span><br><span class="line">        logger.information(<span class="string">&quot;This is an informational message.&quot;</span>);</span><br><span class="line">        logger.warning(<span class="string">&quot;This is a warning message.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        Poco::AutoPtr&lt;Poco::ConsoleChannel&gt; console_channel(new Poco::ConsoleChannel);</span><br><span class="line"></span><br><span class="line">        Poco::AutoPtr&lt;Poco::FileChannel&gt; file_channel(new Poco::FileChannel(<span class="string">&quot;sample.log&quot;</span>));</span><br><span class="line">        file_channel-&gt;setProperty(<span class="string">&quot;rotation&quot;</span>, <span class="string">&quot;1 M&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Poco::AutoPtr&lt;Poco::SplitterChannel&gt; split_channel(new Poco::SplitterChannel);</span><br><span class="line">        split_channel-&gt;addChannel(console_channel);</span><br><span class="line">        split_channel-&gt;addChannel(file_channel);</span><br><span class="line"></span><br><span class="line">        Poco::AutoPtr&lt;Poco::PatternFormatter&gt; formatter(new Poco::PatternFormatter(<span class="string">&quot;%Y-%m-%d %H:%M:%S %s: %t&quot;</span>));</span><br><span class="line">        Poco::AutoPtr&lt;Poco::FormattingChannel&gt; formatting_channel(</span><br><span class="line">                new Poco::FormattingChannel(formatter, split_channel));</span><br><span class="line"></span><br><span class="line">        Poco::Logger&amp; logger =</span><br><span class="line">                Poco::Logger::create(<span class="string">&quot;MultiChannelLogger&quot;</span>, formatting_channel, Poco::Message::PRIO_INFORMATION);</span><br><span class="line">        logger.information(<span class="string">&quot;This is an informational message.&quot;</span>);</span><br><span class="line">        logger.warning(<span class="string">&quot;This is a warning message.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">build/poco_logger_demo</span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2024.05.30 08:23:56.061053 &lt;Information&gt; main_1: Hello, World!</span><br><span class="line">2024.05.30 08:23:56.061093 &lt;Information&gt; main_2: Hello, World!</span><br><span class="line">2024-05-30 08:23:56 MultiChannelLogger: This is an informational message.</span><br><span class="line">2024-05-30 08:23:56 MultiChannelLogger: This is a warning message.</span><br></pre></td></tr></table></figure>
<h4 id="8111-colorful-output"><a class="markdownIt-Anchor" href="#8111-colorful-output"></a> 8.1.1.1 Colorful Output</h4>
<p>You can refer to <a target="_blank" rel="noopener" href="https://github.com/ClickHouse/ClickHouse/blob/master/base/base/terminalColors.cpp">Clickhouse-base/base/terminalColors.cpp</a> for colorful output.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/liuyehcf/cpp-demo-projects/tree/main/pocoproject/logger/poco_logger_color_demo">poco_logger_color_demo</a></p>
<h3 id="812-json"><a class="markdownIt-Anchor" href="#812-json"></a> 8.1.2 JSON</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p poco_json_demo</span><br><span class="line"><span class="built_in">cd</span> poco_json_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(poco_json_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(Poco REQUIRED COMPONENTS Foundation Net XML JSON)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> Poco::Foundation Poco::Net Poco::XML Poco::JSON)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; poco_json_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Dynamic/Var.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/JSON/Parser.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/JSON/Stringifier.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sstream&gt;</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    // JSON string to parse</span><br><span class="line">    std::string jsonString = R<span class="string">&quot;(&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>John Doe<span class="string">&quot;,&quot;</span>age<span class="string">&quot;:30,&quot;</span>isDeveloper<span class="string">&quot;:true&#125;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    // Parse the JSON string</span><br><span class="line">    Poco::JSON::Parser parser;</span><br><span class="line">    Poco::Dynamic::Var result = parser.parse(jsonString);</span><br><span class="line">    Poco::JSON::Object::Ptr jsonObject = result.extract&lt;Poco::JSON::Object::Ptr&gt;();</span><br><span class="line"></span><br><span class="line">    // Extract values</span><br><span class="line">    std::string name = jsonObject-&gt;getValue&lt;std::string&gt;(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    int age = jsonObject-&gt;getValue&lt;int&gt;(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    bool isDeveloper = jsonObject-&gt;getValue&lt;bool&gt;(<span class="string">&quot;isDeveloper&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Name: &quot;</span> &lt;&lt; <span class="string">name &lt;&lt; &quot;, Age: &quot; &lt;&lt; age &lt;&lt; &quot;, Is Developer: &quot; &lt;&lt; isDeveloper &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Create a new JSON object</span></span><br><span class="line"><span class="string">    Poco::JSON::Object newObject;</span></span><br><span class="line"><span class="string">    newObject.set(&quot;newName&quot;, &quot;Jane Smith&quot;);</span></span><br><span class="line"><span class="string">    newObject.set(&quot;newAge&quot;, 28);</span></span><br><span class="line"><span class="string">    newObject.set(&quot;isNewDeveloper&quot;, false);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Convert to JSON string</span></span><br><span class="line"><span class="string">    std::stringstream ss;</span></span><br><span class="line"><span class="string">    newObject.stringify(ss);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    std::cout &lt;&lt; &quot;Generated JSON: &quot; &lt;&lt; ss.str() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/poco_json_demo</span></span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Name: John Doe, Age: 30, Is Developer: 1</span><br><span class="line">Generated JSON: &#123;&quot;isNewDeveloper&quot;:false,&quot;newAge&quot;:28,&quot;newName&quot;:&quot;Jane Smith&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="813-http"><a class="markdownIt-Anchor" href="#813-http"></a> 8.1.3 Http</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p poco_http_demo</span><br><span class="line"><span class="built_in">cd</span> poco_http_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(poco_http_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(Poco REQUIRED COMPONENTS Foundation Net Util)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> Poco::Foundation Poco::Net Poco::Util)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; poco_http_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPClientSession.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPRequest.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPRequestHandler.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPRequestHandlerFactory.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPResponse.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPServer.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPServerParams.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPServerRequest.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/HTTPServerResponse.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Net/ServerSocket.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/StreamCopier.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Util/ServerApplication.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sstream&gt;</span></span><br><span class="line"></span><br><span class="line">class HelloRequestHandler : public Poco::Net::HTTPRequestHandler &#123;</span><br><span class="line">public:</span><br><span class="line">    void handleRequest(Poco::Net::HTTPServerRequest&amp; request, Poco::Net::HTTPServerResponse&amp; response) override &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Received request from: &quot;</span> &lt;&lt; <span class="string">request.clientAddress().toString() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        response.setKeepAlive(request</span>.getKeepAlive());</span><br><span class="line">        response.setChunkedTransferEncoding(<span class="literal">true</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        std::ostream&amp; ostr = response.send();</span><br><span class="line">        ostr &lt;&lt; <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&quot;</span>;</span><br><span class="line">        ostr &lt;&lt; <span class="string">&quot;&lt;body&gt;&lt;h1&gt;Hello from Poco HTTP Server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">        ostr.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class HelloRequestHandlerFactory : public Poco::Net::HTTPRequestHandlerFactory &#123;</span><br><span class="line">public:</span><br><span class="line">    Poco::Net::HTTPRequestHandler* createRequestHandler(const Poco::Net::HTTPServerRequest&amp; request) override &#123;</span><br><span class="line">        <span class="built_in">return</span> new HelloRequestHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class HTTPServerApp : public Poco::Util::ServerApplication &#123;</span><br><span class="line">protected:</span><br><span class="line">    int main(const std::vector&lt;std::string&gt;&amp; args) &#123;</span><br><span class="line">        Poco::Net::ServerSocket svs(&#123;<span class="string">&quot;0.0.0.0&quot;</span>, 9080&#125;); // <span class="built_in">set</span> the server port here</span><br><span class="line">        /// Sets the following default values:</span><br><span class="line">        ///   - <span class="built_in">timeout</span>:              60 seconds</span><br><span class="line">        ///   - keepAlive:            <span class="literal">true</span></span><br><span class="line">        ///   - maxKeepAliveRequests: 0</span><br><span class="line">        ///   - keepAliveTimeout:     10 seconds</span><br><span class="line">        Poco::Net::HTTPServer server(new HelloRequestHandlerFactory(), svs, new Poco::Net::HTTPServerParams());</span><br><span class="line"></span><br><span class="line">        server.start();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;HTTP Server started on port 9080.&quot;</span> &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Wait for CTRL-C or kill</span></span><br><span class="line"><span class="string">        waitForTerminationRequest();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        server.stop();</span></span><br><span class="line"><span class="string">        return Application::EXIT_OK;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main(int argc, char** argv) &#123;</span></span><br><span class="line"><span class="string">    std</span>::thread server_thread([argc, argv]() &#123;</span><br><span class="line">        HTTPServerApp app;</span><br><span class="line">        app.run(argc, argv);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    std::this_thread::sleep_for(std::chrono::seconds(1));</span><br><span class="line"></span><br><span class="line">    Poco::Net::HTTPClientSession session(<span class="string">&quot;127.0.0.1&quot;</span>, 9080);</span><br><span class="line">    session.setKeepAlive(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        // First request</span><br><span class="line">        Poco::Net::HTTPRequest request(Poco::Net::HTTPRequest::HTTP_GET, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        request.setKeepAlive(<span class="literal">true</span>);</span><br><span class="line">        session.sendRequest(request);</span><br><span class="line"></span><br><span class="line">        Poco::Net::HTTPResponse response;</span><br><span class="line">        std::istream&amp; response_body_is = session.receiveResponse(response);</span><br><span class="line"></span><br><span class="line">        std::string response_body;</span><br><span class="line">        Poco::StreamCopier::copyToString(response_body_is, response_body);</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">response_body &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        // Second request reuse the same session</span></span><br><span class="line"><span class="string">        Poco::Net::HTTPRequest request(Poco::Net::HTTPRequest::HTTP_GET, &quot;/&quot;);</span></span><br><span class="line"><span class="string">        session.sendRequest(request);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Poco::Net::HTTPResponse response;</span></span><br><span class="line"><span class="string">        std::istream&amp; response_body_is = session.receiveResponse(response);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        std::string response_body</span>;</span><br><span class="line">        Poco::StreamCopier::copyToString(response_body_is, response_body);</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">response_body &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    server_thread.join();</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/poco_http_demo</span></span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP Server started on port 9080.</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello from Poco HTTP Server&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<h3 id="814-application"><a class="markdownIt-Anchor" href="#814-application"></a> 8.1.4 Application</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p poco_application_demo</span><br><span class="line"><span class="built_in">cd</span> poco_application_demo</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(poco_application_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_compile_options(-O3 -Wall)</span><br><span class="line"></span><br><span class="line">file(GLOB MY_PROJECT_SOURCES <span class="string">&quot;*.cpp&quot;</span>)</span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MY_PROJECT_SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line">find_package(Poco REQUIRED COMPONENTS Foundation Util)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> Poco::Foundation Poco::Util)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; poco_application_demo.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Util/Application.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Util/HelpFormatter.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Util/Option.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Poco/Util/OptionSet.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"></span><br><span class="line">class DemoApp : public Poco::Util::Application &#123;</span><br><span class="line">protected:</span><br><span class="line">    void initialize(Application&amp; self) &#123;</span><br><span class="line">        loadConfiguration();</span><br><span class="line">        Application::initialize(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void <span class="function"><span class="title">uninitialize</span></span>() &#123; Application::uninitialize(); &#125;</span><br><span class="line"></span><br><span class="line">    void defineOptions(Poco::Util::OptionSet&amp; options) &#123;</span><br><span class="line">        Application::defineOptions(options);</span><br><span class="line"></span><br><span class="line">        options.addOption(Poco::Util::Option(<span class="string">&quot;help&quot;</span>, <span class="string">&quot;h&quot;</span>, <span class="string">&quot;display help information&quot;</span>)</span><br><span class="line">                                  .required(<span class="literal">false</span>)</span><br><span class="line">                                  .repeatable(<span class="literal">false</span>)</span><br><span class="line">                                  .callback(Poco::Util::OptionCallback&lt;DemoApp&gt;(this, &amp;DemoApp::handleHelp)));</span><br><span class="line"></span><br><span class="line">        options.addOption(Poco::Util::Option(<span class="string">&quot;config-file&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;path of configuration file&quot;</span>)</span><br><span class="line">                                  .required(<span class="literal">false</span>)</span><br><span class="line">                                  .repeatable(<span class="literal">false</span>)</span><br><span class="line">                                  .argument(<span class="string">&quot;&lt;file&gt;&quot;</span>)</span><br><span class="line">                                  .binding(<span class="string">&quot;config-file&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void handleHelp(const std::string&amp; name, const std::string&amp; value) &#123;</span><br><span class="line">        _is_help = <span class="literal">true</span>;</span><br><span class="line">        Poco::Util::HelpFormatter helpFormatter(options());</span><br><span class="line">        helpFormatter.setCommand(commandName());</span><br><span class="line">        helpFormatter.setUsage(<span class="string">&quot;OPTIONS&quot;</span>);</span><br><span class="line">        helpFormatter.setHeader(<span class="string">&quot;A simple command line application that demonstrates parsing options with POCO.&quot;</span>);</span><br><span class="line">        helpFormatter.format(std::cout);</span><br><span class="line">        stopOptionsProcessing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int main(const std::vector&lt;std::string&gt;&amp; args) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_is_help) &#123;</span><br><span class="line">            <span class="built_in">return</span> Application::EXIT_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;config-file: &quot;</span> &lt;&lt; <span class="string">config().getString(&quot;config</span>-file<span class="string">&quot;, &quot;</span>unknow<span class="string">&quot;) &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return Application::EXIT_OK;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">private:</span></span><br><span class="line"><span class="string">    bool _is_help = false;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POCO_APP_MAIN(DemoApp)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j <span class="subst">$(( (cores=$(nproc)</span>)&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/poco_application_demo --help</span></span><br><span class="line"><span class="string"># --config is not ambiguous, so it can be parsed to --config-file</span></span><br><span class="line"><span class="string">build/poco_application_demo --config /etc/config.xml</span></span><br><span class="line"><span class="string">build/poco_application_demo --config-file /etc/config.xml</span></span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">usage: poco_application_demo OPTIONS</span><br><span class="line">A simple command line application that demonstrates parsing options with POCO.</span><br><span class="line"></span><br><span class="line">-h, --help                      display help information</span><br><span class="line">-C&lt;file&gt;, --config-file=&lt;file&gt;  path of configuration file</span><br><span class="line">config-file: /etc/config.xml</span><br></pre></td></tr></table></figure>
<h3 id="815-foundation"><a class="markdownIt-Anchor" href="#815-foundation"></a> 8.1.5 Foundation</h3>
<h4 id="8151-md5"><a class="markdownIt-Anchor" href="#8151-md5"></a> 8.1.5.1 MD5</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Poco/DigestStream.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Poco/HexBinaryEncoder.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Poco/MD5Engine.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create an MD5 engine</span></span><br><span class="line">    Poco::MD5Engine md5;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a DigestOutputStream that writes to the MD5 engine</span></span><br><span class="line">    <span class="function">Poco::DigestOutputStream <span class="title">dos</span><span class="params">(md5)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Input string to hash</span></span><br><span class="line">    std::string input = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write the input string to the DigestOutputStream</span></span><br><span class="line">    dos &lt;&lt; input;</span><br><span class="line">    dos.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the digest as a string of hexadecimal numbers</span></span><br><span class="line">    <span class="type">const</span> Poco::DigestEngine::Digest&amp; digest = md5.<span class="built_in">digest</span>();</span><br><span class="line">    <span class="function">std::string <span class="title">hash</span><span class="params">(Poco::DigestEngine::digestToHex(digest))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Print the hash</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;MD5 hash of &#x27;&quot;</span> &lt;&lt; input &lt;&lt; <span class="string">&quot;&#x27; is: &quot;</span> &lt;&lt; hash &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">gcc -o main main.cpp -lstdc++ -std=gnu++<span class="number">17</span> -lPocoFoundation</span><br><span class="line">./main</span><br></pre></td></tr></table></figure>
<h2 id="82-sqlpp11"><a class="markdownIt-Anchor" href="#82-sqlpp11"></a> 8.2 sqlpp11</h2>
<p><strong>How to integrate:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">target_link_libraries(xxx sqlpp11)</span><br></pre></td></tr></table></figure>
<p><strong>How to create cpp header files:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /tmp/foo.sql &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">CREATE TABLE foo (</span><br><span class="line">    <span class="built_in">id</span> bigint,</span><br><span class="line">    name varchar(50),</span><br><span class="line">    hasFun bool</span><br><span class="line">);</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">scripts/ddl2cpp  /tmp/foo.sql /tmp/foo my_ns</span><br></pre></td></tr></table></figure>
<h3 id="821-with-sqlite"><a class="markdownIt-Anchor" href="#821-with-sqlite"></a> 8.2.1 With Sqlite</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── contrib</span><br><span class="line">│   ├── SQLiteCpp</span><br><span class="line">│   └── sqlpp11</span><br><span class="line">├── main.cpp</span><br><span class="line">├── users.ddl</span><br><span class="line">└── users.h</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p sqlpp11_demo</span><br><span class="line"><span class="built_in">cd</span> sqlpp11_demo</span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download source code of these two project</span></span><br><span class="line">git submodule add https://github.com/rbock/sqlpp11.git contrib/sqlpp11</span><br><span class="line">git submodule add https://github.com/SRombauts/SQLiteCpp.git contrib/SQLiteCpp</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(sqlpp11_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include subdirectories</span></span><br><span class="line">add_subdirectory(contrib/sqlpp11)</span><br><span class="line">add_subdirectory(contrib/SQLiteCpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Link against libraries</span></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> sqlpp11)</span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> SQLiteCpp sqlite3 pthread dl)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ddl</span></span><br><span class="line"><span class="built_in">cat</span> &gt; users.ddl &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">CREATE TABLE <span class="built_in">users</span> (</span><br><span class="line">    <span class="built_in">id</span> INTEGER NOT NULL,</span><br><span class="line">    first_name TEXT NOT NULL,</span><br><span class="line">    last_name TEXT NOT NULL,</span><br><span class="line">    age INTEGER NOT NULL,</span><br><span class="line">    PRIMARY KEY(<span class="built_in">id</span>)</span><br><span class="line">);</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create headers  </span></span><br><span class="line">contrib/sqlpp11/scripts/ddl2cpp users.ddl <span class="built_in">users</span> Test</span><br><span class="line"></span><br><span class="line"><span class="comment"># main.cpp</span></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/all_of.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/custom_query.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/insert.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/sqlite3/sqlite3.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/sqlpp11.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/verbatim.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &quot;users.h&quot;</span></span><br><span class="line"></span><br><span class="line">template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">void <span class="built_in">print</span>(Db&amp; db, Assignment assignment) &#123;</span><br><span class="line">    typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">sqlpp::serialize(assignment, context).str() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    auto config = std::make_shared&lt;sqlpp</span>::sqlite3::connection_config&gt;();</span><br><span class="line">    config-&gt;path_to_database = <span class="string">&quot;:memory:&quot;</span>;</span><br><span class="line">    config-&gt;flags = SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE;</span><br><span class="line">    config-&gt;debug = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    auto conn_pool = std::make_shared&lt;sqlpp::sqlite3::connection_pool&gt;(config, 5);</span><br><span class="line"></span><br><span class="line">    auto db = conn_pool-&gt;get();</span><br><span class="line"></span><br><span class="line">    db.execute(R<span class="string">&quot;(CREATE TABLE users (</span></span><br><span class="line"><span class="string">                id INTEGER NOT NULL,</span></span><br><span class="line"><span class="string">                first_name TEXT NOT NULL,</span></span><br><span class="line"><span class="string">                last_name TEXT NOT NULL,</span></span><br><span class="line"><span class="string">                age INTEGER NOT NULL,</span></span><br><span class="line"><span class="string">                PRIMARY KEY(id)))&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Test::Users <span class="built_in">users</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000001, users.firstName = <span class="string">&quot;Emma&quot;</span>,</span><br><span class="line">                                                   users.lastName = <span class="string">&quot;Watson&quot;</span>, users.age = 15);</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000002, users.firstName = <span class="string">&quot;Leo&quot;</span>,</span><br><span class="line">                                                   users.lastName = <span class="string">&quot;Grant&quot;</span>, users.age = 18);</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = <span class="keyword">select</span>(sqlpp::all_of(<span class="built_in">users</span>)).from(<span class="built_in">users</span>).unconditionally();</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        <span class="keyword">for</span> (const auto&amp; row : db(query)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = select(sqlpp::all_of(users)).from(users).where(users.age &lt;= 20);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        for (const auto&amp; row : db(query)) &#123;</span></span><br><span class="line"><span class="string">            std</span>::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = sqlpp::remove_from(users).where(users.id == 10000001);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        db(query);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># compile and run</span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/sqlpp11_demo</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Sqlite3 debug: Preparing: &#x27;CREATE TABLE users (</span><br><span class="line">                id INTEGER NOT NULL,</span><br><span class="line">                first_name TEXT NOT NULL,</span><br><span class="line">                last_name TEXT NOT NULL,</span><br><span class="line">                age INTEGER NOT NULL,</span><br><span class="line">                PRIMARY KEY(id))&#x27;</span><br><span class="line">INSERT INTO users (id,first_name,last_name,age) VALUES(10000001,&#x27;Emma&#x27;,&#x27;Watson&#x27;,15)</span><br><span class="line">Sqlite3 debug: Preparing: &#x27;INSERT INTO users (id,first_name,last_name,age) VALUES(10000001,&#x27;Emma&#x27;,&#x27;Watson&#x27;,15)&#x27;</span><br><span class="line">INSERT INTO users (id,first_name,last_name,age) VALUES(10000002,&#x27;Leo&#x27;,&#x27;Grant&#x27;,18)</span><br><span class="line">Sqlite3 debug: Preparing: &#x27;INSERT INTO users (id,first_name,last_name,age) VALUES(10000002,&#x27;Leo&#x27;,&#x27;Grant&#x27;,18)&#x27;</span><br><span class="line">SELECT users.id,users.first_name,users.last_name,users.age FROM users</span><br><span class="line">Sqlite3 debug: Preparing: &#x27;SELECT users.id,users.first_name,users.last_name,users.age FROM users&#x27;</span><br><span class="line">Sqlite3 debug: Constructing bind result, using handle at 0x1f7de20</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de20</span><br><span class="line">Sqlite3 debug: binding integral result 0 at index: 0</span><br><span class="line">Sqlite3 debug: binding text result at index: 1</span><br><span class="line">Sqlite3 debug: binding text result at index: 2</span><br><span class="line">Sqlite3 debug: binding integral result 0 at index: 3</span><br><span class="line">    -&gt; id=10000001, firstName=Emma, lastName=Watson, age=15</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de20</span><br><span class="line">Sqlite3 debug: binding integral result 10000001 at index: 0</span><br><span class="line">Sqlite3 debug: binding text result at index: 1</span><br><span class="line">Sqlite3 debug: binding text result at index: 2</span><br><span class="line">Sqlite3 debug: binding integral result 15 at index: 3</span><br><span class="line">    -&gt; id=10000002, firstName=Leo, lastName=Grant, age=18</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de20</span><br><span class="line">SELECT users.id,users.first_name,users.last_name,users.age FROM users WHERE (users.age&lt;=20)</span><br><span class="line">Sqlite3 debug: Preparing: &#x27;SELECT users.id,users.first_name,users.last_name,users.age FROM users WHERE (users.age&lt;=20)&#x27;</span><br><span class="line">Sqlite3 debug: Constructing bind result, using handle at 0x1f7de40</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de40</span><br><span class="line">Sqlite3 debug: binding integral result 0 at index: 0</span><br><span class="line">Sqlite3 debug: binding text result at index: 1</span><br><span class="line">Sqlite3 debug: binding text result at index: 2</span><br><span class="line">Sqlite3 debug: binding integral result 0 at index: 3</span><br><span class="line">    -&gt; id=10000001, firstName=Emma, lastName=Watson, age=15</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de40</span><br><span class="line">Sqlite3 debug: binding integral result 10000001 at index: 0</span><br><span class="line">Sqlite3 debug: binding text result at index: 1</span><br><span class="line">Sqlite3 debug: binding text result at index: 2</span><br><span class="line">Sqlite3 debug: binding integral result 15 at index: 3</span><br><span class="line">    -&gt; id=10000002, firstName=Leo, lastName=Grant, age=18</span><br><span class="line">Sqlite3 debug: Accessing next row of handle at 0x1f7de40</span><br><span class="line">DELETE FROM users WHERE (users.id=10000001)</span><br><span class="line">Sqlite3 debug: Preparing: &#x27;DELETE FROM users WHERE (users.id=10000001)&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="822-with-mysql"><a class="markdownIt-Anchor" href="#822-with-mysql"></a> 8.2.2 With Mysql</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── contrib</span><br><span class="line">│   ├── mysql-connector-c-6.1.11-linux-glibc2.12-x86_64</span><br><span class="line">│   ├── mysql-connector-c-6.1.11-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">│   └── sqlpp11</span><br><span class="line">├── main.cpp</span><br><span class="line">├── users.ddl</span><br><span class="line">└── users.h</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p sqlpp11_demo</span><br><span class="line"><span class="built_in">cd</span> sqlpp11_demo</span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download source code of these two project</span></span><br><span class="line"><span class="built_in">mkdir</span> -p contrib</span><br><span class="line">wget -O contrib/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64.tar.gz https://downloads.mysql.com/archives/get/p/19/file/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">tar -zxf contrib/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64.tar.gz -C contrib</span><br><span class="line">git submodule add https://github.com/rbock/sqlpp11.git contrib/sqlpp11</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(sqlpp11_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># link_directories must be placed before add_executable or add_library</span></span><br><span class="line">include_directories(contrib/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64/include)</span><br><span class="line">link_directories(contrib/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64/lib)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include subdirectories</span></span><br><span class="line">add_subdirectory(contrib/sqlpp11)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Link against libraries</span></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> sqlpp11 mysqlclient)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ddl</span></span><br><span class="line"><span class="built_in">cat</span> &gt; users.ddl &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">CREATE TABLE <span class="built_in">users</span> (</span><br><span class="line">    <span class="built_in">id</span> BIGINT NOT NULL,</span><br><span class="line">    first_name VARCHAR(16) NOT NULL,</span><br><span class="line">    last_name VARCHAR(16) NOT NULL,</span><br><span class="line">    age SMALLINT NOT NULL,</span><br><span class="line">    PRIMARY KEY(<span class="built_in">id</span>)</span><br><span class="line">);</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create headers  </span></span><br><span class="line">contrib/sqlpp11/scripts/ddl2cpp users.ddl <span class="built_in">users</span> Test</span><br><span class="line"></span><br><span class="line"><span class="comment"># main.cpp</span></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/all_of.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/custom_query.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/insert.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/mysql/mysql.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/sqlpp11.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/verbatim.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &quot;users.h&quot;</span></span><br><span class="line"></span><br><span class="line">struct on_duplicate_key_update &#123;</span><br><span class="line">    std::string _serialized;</span><br><span class="line"></span><br><span class="line">    template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">    on_duplicate_key_update(Db&amp; db, Assignment assignment) &#123;</span><br><span class="line">        typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">        _serialized = <span class="string">&quot; ON DUPLICATE KEY UPDATE &quot;</span> + serialize(assignment, context).str();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">    auto operator()(Db&amp; db, Assignment assignment) -&gt; on_duplicate_key_update&amp; &#123;</span><br><span class="line">        typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">        _serialized += <span class="string">&quot;, &quot;</span> + serialize(assignment, context).str();</span><br><span class="line">        <span class="built_in">return</span> *this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    auto get() const -&gt; sqlpp::verbatim_t&lt;::sqlpp::no_value_t&gt; &#123; <span class="built_in">return</span> ::sqlpp::verbatim(_serialized); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">void <span class="built_in">print</span>(Db&amp; db, Assignment assignment) &#123;</span><br><span class="line">    typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">sqlpp::serialize(assignment, context).str() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    auto config = std::make_shared&lt;sqlpp</span>::mysql::connection_config&gt;();</span><br><span class="line">    config-&gt;user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    config-&gt;port = 13306;</span><br><span class="line">    config-&gt;password = <span class="string">&quot;Abcd1234&quot;</span>;</span><br><span class="line">    config-&gt;database = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    config-&gt;host = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    auto conn_pool = std::make_shared&lt;sqlpp::mysql::connection_pool&gt;(config, 5);</span><br><span class="line"></span><br><span class="line">    auto db = conn_pool-&gt;get();</span><br><span class="line"></span><br><span class="line">    Test::Users <span class="built_in">users</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::custom_query(</span><br><span class="line">                sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000001, users.firstName = <span class="string">&quot;Emma&quot;</span>, users.lastName = <span class="string">&quot;Watson&quot;</span>,</span><br><span class="line">                                              users.age = 15),</span><br><span class="line">                on_duplicate_key_update(db, users.firstName = <span class="string">&quot;Emma&quot;</span>)(db, users.lastName = <span class="string">&quot;Watson&quot;</span>)(db, users.age = 15)</span><br><span class="line">                        .get());</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::custom_query(</span><br><span class="line">                sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000002, users.firstName = <span class="string">&quot;Leo&quot;</span>, users.lastName = <span class="string">&quot;Grant&quot;</span>,</span><br><span class="line">                                              users.age = 18),</span><br><span class="line">                on_duplicate_key_update(db, users.firstName = <span class="string">&quot;Leo&quot;</span>)(db, users.lastName = <span class="string">&quot;Grant&quot;</span>)(db, users.age = 18)</span><br><span class="line">                        .get());</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = <span class="keyword">select</span>(sqlpp::all_of(<span class="built_in">users</span>)).from(<span class="built_in">users</span>).unconditionally();</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        <span class="keyword">for</span> (const auto&amp; row : db(query)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = select(sqlpp::all_of(users)).from(users).where(users.age &lt;= 20);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        for (const auto&amp; row : db(query)) &#123;</span></span><br><span class="line"><span class="string">            std</span>::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = sqlpp::remove_from(users).where(users.id == 10000001);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        db(query);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># compile and run</span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/sqlpp11_demo</span></span><br></pre></td></tr></table></figure>
<h3 id="823-with-mariadb"><a class="markdownIt-Anchor" href="#823-with-mariadb"></a> 8.2.3 With Mariadb</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── contrib</span><br><span class="line">│   ├── mariadb-connector-c</span><br><span class="line">│   └── sqlpp11</span><br><span class="line">├── main.cpp</span><br><span class="line">├── users.ddl</span><br><span class="line">└── users.h</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p sqlpp11_demo</span><br><span class="line"><span class="built_in">cd</span> sqlpp11_demo</span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download source code of these two project</span></span><br><span class="line">git submodule add https://github.com/mariadb-corporation/mariadb-connector-c.git contrib/mariadb-connector-c</span><br><span class="line">git submodule add https://github.com/rbock/sqlpp11.git contrib/sqlpp11</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(sqlpp11_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include subdirectories</span></span><br><span class="line">add_subdirectory(contrib/sqlpp11)</span><br><span class="line">add_subdirectory(contrib/mariadb-connector-c)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include header files</span></span><br><span class="line">target_include_directories (<span class="variable">$&#123;PROJECT_NAME&#125;</span> PUBLIC <span class="string">&quot;<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/contrib/mariadb-connector-c/include&quot;</span>)</span><br><span class="line">target_include_directories (<span class="variable">$&#123;PROJECT_NAME&#125;</span> PUBLIC <span class="string">&quot;<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/contrib/mariadb-connector-c/include&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Link against libraries</span></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> sqlpp11 mariadbclient)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ddl</span></span><br><span class="line"><span class="built_in">cat</span> &gt; users.ddl &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">CREATE TABLE <span class="built_in">users</span> (</span><br><span class="line">    <span class="built_in">id</span> BIGINT NOT NULL,</span><br><span class="line">    first_name VARCHAR(16) NOT NULL,</span><br><span class="line">    last_name VARCHAR(16) NOT NULL,</span><br><span class="line">    age SMALLINT NOT NULL,</span><br><span class="line">    PRIMARY KEY(<span class="built_in">id</span>)</span><br><span class="line">);</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create headers  </span></span><br><span class="line">contrib/sqlpp11/scripts/ddl2cpp users.ddl <span class="built_in">users</span> Test</span><br><span class="line"></span><br><span class="line"><span class="comment"># main.cpp</span></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/all_of.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/custom_query.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/insert.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/mysql/mysql.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/sqlpp11.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sqlpp11/verbatim.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &quot;users.h&quot;</span></span><br><span class="line"></span><br><span class="line">struct on_duplicate_key_update &#123;</span><br><span class="line">    std::string _serialized;</span><br><span class="line"></span><br><span class="line">    template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">    on_duplicate_key_update(Db&amp; db, Assignment assignment) &#123;</span><br><span class="line">        typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">        _serialized = <span class="string">&quot; ON DUPLICATE KEY UPDATE &quot;</span> + serialize(assignment, context).str();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">    auto operator()(Db&amp; db, Assignment assignment) -&gt; on_duplicate_key_update&amp; &#123;</span><br><span class="line">        typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">        _serialized += <span class="string">&quot;, &quot;</span> + serialize(assignment, context).str();</span><br><span class="line">        <span class="built_in">return</span> *this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    auto get() const -&gt; sqlpp::verbatim_t&lt;::sqlpp::no_value_t&gt; &#123; <span class="built_in">return</span> ::sqlpp::verbatim(_serialized); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template &lt;typename Db, typename Assignment&gt;</span><br><span class="line">void <span class="built_in">print</span>(Db&amp; db, Assignment assignment) &#123;</span><br><span class="line">    typename Db::_serializer_context_t context&#123;db&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">sqlpp::serialize(assignment, context).str() &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    auto config = std::make_shared&lt;sqlpp</span>::mysql::connection_config&gt;();</span><br><span class="line">    config-&gt;user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    config-&gt;port = 13306;</span><br><span class="line">    config-&gt;password = <span class="string">&quot;Abcd1234&quot;</span>;</span><br><span class="line">    config-&gt;database = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    config-&gt;host = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    auto conn_pool = std::make_shared&lt;sqlpp::mysql::connection_pool&gt;(config, 5);</span><br><span class="line"></span><br><span class="line">    auto db = conn_pool-&gt;get();</span><br><span class="line"></span><br><span class="line">    Test::Users <span class="built_in">users</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::custom_query(</span><br><span class="line">                sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000001, users.firstName = <span class="string">&quot;Emma&quot;</span>, users.lastName = <span class="string">&quot;Watson&quot;</span>,</span><br><span class="line">                                              users.age = 15),</span><br><span class="line">                on_duplicate_key_update(db, users.firstName = <span class="string">&quot;Emma&quot;</span>)(db, users.lastName = <span class="string">&quot;Watson&quot;</span>)(db, users.age = 15)</span><br><span class="line">                        .get());</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = sqlpp::custom_query(</span><br><span class="line">                sqlpp::insert_into(<span class="built_in">users</span>).<span class="built_in">set</span>(users.id = 10000002, users.firstName = <span class="string">&quot;Leo&quot;</span>, users.lastName = <span class="string">&quot;Grant&quot;</span>,</span><br><span class="line">                                              users.age = 18),</span><br><span class="line">                on_duplicate_key_update(db, users.firstName = <span class="string">&quot;Leo&quot;</span>)(db, users.lastName = <span class="string">&quot;Grant&quot;</span>)(db, users.age = 18)</span><br><span class="line">                        .get());</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        db(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        auto query = <span class="keyword">select</span>(sqlpp::all_of(<span class="built_in">users</span>)).from(<span class="built_in">users</span>).unconditionally();</span><br><span class="line">        <span class="built_in">print</span>(db, query);</span><br><span class="line">        <span class="keyword">for</span> (const auto&amp; row : db(query)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = select(sqlpp::all_of(users)).from(users).where(users.age &lt;= 20);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        for (const auto&amp; row : db(query)) &#123;</span></span><br><span class="line"><span class="string">            std</span>::cout &lt;&lt; <span class="string">&quot;    -&gt; id=&quot;</span> &lt;&lt; <span class="string">row.id &lt;&lt; &quot;, firstName=&quot; &lt;&lt; row</span>.firstName &lt;&lt; <span class="string">&quot;, lastName=&quot;</span> &lt;&lt; <span class="string">row.lastName</span></span><br><span class="line"><span class="string">                      &lt;&lt; &quot;, age=&quot; &lt;&lt; row</span>.age &lt;&lt; <span class="string">std::endl;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        auto query = sqlpp::remove_from(users).where(users.id == 10000001);</span></span><br><span class="line"><span class="string">        print(db, query);</span></span><br><span class="line"><span class="string">        db(query);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># compile and run</span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br></pre></td></tr></table></figure>
<p>You may be presented with the following error messages:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Error at contrib/mariadb-connector-c/cmake/install_plugins.cmake:11 (INSTALL):</span><br><span class="line">  INSTALL TARGETS given no LIBRARY DESTINATION for module target &quot;remote_io&quot;.</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  contrib/mariadb-connector-c/cmake/plugins.cmake:83 (INSTALL_PLUGIN)</span><br></pre></td></tr></table></figure>
<p>Just remove the line 83(<code>contrib/mariadb-connector-c/cmake/plugins.cmake:83</code>), which is</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL_PLUGIN(<span class="variable">$&#123;CC_PLUGIN_TARGET&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>And then compile again:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span><br><span class="line">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span><br><span class="line">build/sqlpp11_demo</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO users (id,first_name,last_name,age) VALUES(10000001,&#x27;Emma&#x27;,&#x27;Watson&#x27;,15)  ON DUPLICATE KEY UPDATE first_name=&#x27;Emma&#x27;, last_name=&#x27;Watson&#x27;, age=15</span><br><span class="line">INSERT INTO users (id,first_name,last_name,age) VALUES(10000002,&#x27;Leo&#x27;,&#x27;Grant&#x27;,18)  ON DUPLICATE KEY UPDATE first_name=&#x27;Leo&#x27;, last_name=&#x27;Grant&#x27;, age=18</span><br><span class="line">SELECT users.id,users.first_name,users.last_name,users.age FROM users</span><br><span class="line">    -&gt; id=10000001, firstName=Emma, lastName=Watson, age=15</span><br><span class="line">    -&gt; id=10000002, firstName=Leo, lastName=Grant, age=18</span><br><span class="line">SELECT users.id,users.first_name,users.last_name,users.age FROM users WHERE (users.age&lt;=20)</span><br><span class="line">    -&gt; id=10000001, firstName=Emma, lastName=Watson, age=15</span><br><span class="line">    -&gt; id=10000002, firstName=Leo, lastName=Grant, age=18</span><br><span class="line">DELETE FROM users WHERE (users.id=10000001)</span><br></pre></td></tr></table></figure>
<h2 id="83-libcurl"><a class="markdownIt-Anchor" href="#83-libcurl"></a> 8.3 libcurl</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://curl.se/">command line tool and library for transferring data with URLs (since 1998)</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://curl.se/libcurl/c/">The libcurl API</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/curl/curl">github-curl</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── contrib</span><br><span class="line">│   ├── curl-8.8.0</span><br><span class="line">│   └── curl-8.8.0.tar.gz</span><br><span class="line">└── main.cpp</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p curl_demo</span><br><span class="line"><span class="built_in">cd</span> curl_demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download source code of these two project</span></span><br><span class="line"><span class="built_in">mkdir</span> -p contrib</span><br><span class="line">wget -O contrib/curl-8.8.0.tar.gz https://curl.se/download/curl-8.8.0.tar.gz</span><br><span class="line">tar -zxf contrib/curl-8.8.0.tar.gz -C contrib</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"><span class="built_in">cat</span> &gt; CMakeLists.txt &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">cmake_minimum_required(VERSION 3.20)</span><br><span class="line"></span><br><span class="line">project(curl_demo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED True)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="variable">$&#123;PROJECT_NAME&#125;</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line">target_link_options(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE -static-libstdc++)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include subdirectories</span></span><br><span class="line">add_subdirectory(contrib/curl-8.8.0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Link against libraries</span></span><br><span class="line">target_link_libraries(<span class="variable">$&#123;PROJECT_NAME&#125;</span> CURL::libcurl)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; main.cpp &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#include &lt;curl/curl.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line">// This callback <span class="keyword">function</span> gets called by libcurl as soon as there is data received that needs to be saved.</span><br><span class="line">// The size of the data pointed to by *ptr is size multiplied by nmemb, it will not be zero terminated.</span><br><span class="line">// Return the number of bytes actually taken care of.</span><br><span class="line">// If that amount differs from the amount passed to your <span class="keyword">function</span>, it<span class="string">&#x27;ll signal an error to the library.</span></span><br><span class="line"><span class="string">size_t WriteCallback(void* contents, size_t size, size_t nmemb, void* userp) &#123;</span></span><br><span class="line"><span class="string">    ((std::string*)userp)-&gt;append((char*)contents, size * nmemb);</span></span><br><span class="line"><span class="string">    return size * nmemb;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    CURL* curl;</span></span><br><span class="line"><span class="string">    CURLcode res;</span></span><br><span class="line"><span class="string">    std::string readBuffer;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Initialize a CURL session</span></span><br><span class="line"><span class="string">    curl = curl_easy_init();</span></span><br><span class="line"><span class="string">    if (!curl) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; &quot;Failed to initialize CURL session&quot; &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">        return 1;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    struct curl_slist* headers = NULL; // Initialize header list</span></span><br><span class="line"><span class="string">    headers = curl_slist_append(headers, &quot;Content-Type: application/json&quot;);</span></span><br><span class="line"><span class="string">    headers = curl_slist_append(headers, &quot;Custom-Header: CustomValue&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Set the URL for the request</span></span><br><span class="line"><span class="string">    curl_easy_setopt(curl, CURLOPT_URL, &quot;http://jsonplaceholder.typicode.com/posts&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Set the custom headers</span></span><br><span class="line"><span class="string">    curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Set the callback function to save the data</span></span><br><span class="line"><span class="string">    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);</span></span><br><span class="line"><span class="string">    // Set the data pointer to save the response</span></span><br><span class="line"><span class="string">    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &amp;readBuffer);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Perform the HTTP request</span></span><br><span class="line"><span class="string">    res = curl_easy_perform(curl);</span></span><br><span class="line"><span class="string">    if (res != CURLE_OK) &#123;</span></span><br><span class="line"><span class="string">        std::cerr &lt;&lt; &quot;curl_easy_perform() failed: &quot; &lt;&lt; curl_easy_strerror(res) &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">        std::cout &lt;&lt; readBuffer &lt;&lt; std::endl;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Cleanup header list</span></span><br><span class="line"><span class="string">    curl_slist_free_all(headers);</span></span><br><span class="line"><span class="string">    // Cleanup CURL session</span></span><br><span class="line"><span class="string">    curl_easy_cleanup(curl);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># compile and run</span></span><br><span class="line"><span class="string">cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span></span><br><span class="line"><span class="string">cmake --build build -j $(( (cores=$(nproc))&gt;1?cores/2:1 ))</span></span><br><span class="line"><span class="string">build/curl_demo</span></span><br></pre></td></tr></table></figure>
<p><strong>Tips:</strong></p>
<ul>
<li>According to <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6624667/can-i-use-libcurls-curlopt-writefunction-with-a-c11-lambda-expression">Can I use libcurls CURLOPT_WRITEFUNCTION with a C++11 lambda expression?</a>, if you want to use lambda expression as the callback function, then declare the lambda with <code>+</code> before empty capture list <code>[]</code>, which is <code>+[]</code></li>
</ul>
<h1 id="9-assorted"><a class="markdownIt-Anchor" href="#9-assorted"></a> 9 Assorted</h1>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/fffaraz/awesome-cpp">Awesome C++ Projects</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/greg7mdp/parallel-hashmap">parallel-hashmap</a>：<code>parallel-hashmap</code>提供了一组高性能、并发安全的<code>map</code>，用于替换<code>std</code>以及<code>boost</code>中的<code>map</code>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/greg7mdp/parallel-hashmap/blob/master/phmap_gdb.py">phmap_gdb.py</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/yhirose/cpp-httplib">cpp-httplib</a>：<code>cpp-httplib</code>以头文件的方式提供<code>http</code>协议的相关支持</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nlohmann/json">json</a>：<code>json</code>库</li>
<li><a target="_blank" rel="noopener" href="https://blitiri.com.ar/p/libfiu/">libfiu(Failure Injection Unit)</a>：错误注入</li>
<li>bison: Parser</li>
<li><a target="_blank" rel="noopener" href="https://github.com/jeremy-rifkin/cpptrace">cpptrace</a></li>
</ol>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag"># 原创</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/06/Cpp-Tools-CMake/" rel="prev" title="Cpp-Tools-CMake">
      <i class="fa fa-chevron-left"></i> Cpp-Tools-CMake
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/06/Java-Issue-Logs/" rel="next" title="Java-Issue-Logs">
      Java-Issue-Logs <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY0My8xMDE5OA=="></div>
  </div>
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-gnu"><span class="nav-text"> 1 GNU</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-libbacktrace"><span class="nav-text"> 1.1 libbacktrace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-libunwind"><span class="nav-text"> 1.2 libunwind</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#121-how-to-automatically-generate-a-stacktrace-when-my-program-crashes"><span class="nav-text"> 1.2.1 How to automatically generate a stacktrace when my program crashes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-bison"><span class="nav-text"> 1.3 bison</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-boost"><span class="nav-text"> 2 boost</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-installation"><span class="nav-text"> 2.1 Installation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#211-package-manager"><span class="nav-text"> 2.1.1 Package Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#212-from-source"><span class="nav-text"> 2.1.2 From Source</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#213-demo"><span class="nav-text"> 2.1.3 Demo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-algorithm"><span class="nav-text"> 2.2 Algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#221-string"><span class="nav-text"> 2.2.1 String</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-hana"><span class="nav-text"> 2.3 Hana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-stacktrace"><span class="nav-text"> 2.4 Stacktrace</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#241-with-addr2line"><span class="nav-text"> 2.4.1 With addr2line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#242-with-libbacktrace"><span class="nav-text"> 2.4.2 With libbacktrace</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#25-reference"><span class="nav-text"> 2.5 Reference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-fmt"><span class="nav-text"> 3 fmt</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-facebook"><span class="nav-text"> 4 Facebook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#41-folly"><span class="nav-text"> 4.1 folly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#42-cachelib"><span class="nav-text"> 4.2 CacheLib</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-google"><span class="nav-text"> 5 Google</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#51-abseil"><span class="nav-text"> 5.1 abseil</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#52-gflag"><span class="nav-text"> 5.2 gflag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#53-glog"><span class="nav-text"> 5.3 glog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#531-print-stack-not-recommend"><span class="nav-text"> 5.3.1 Print Stack (Not Recommend)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#54-gtest"><span class="nav-text"> 5.4 gtest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#541-macros"><span class="nav-text"> 5.4.1 Macros</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#542-tips"><span class="nav-text"> 5.4.2 Tips</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#55-benchmark"><span class="nav-text"> 5.5 benchmark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#551-quick-benchmark"><span class="nav-text"> 5.5.1 quick-benchmark</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#552-tips"><span class="nav-text"> 5.5.2 Tips</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5521-benchmarkdonotoptimize"><span class="nav-text"> 5.5.2.1 benchmark::DoNotOptimize</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5522-run-specific-case"><span class="nav-text"> 5.5.2.2 Run Specific Case</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#553-reference"><span class="nav-text"> 5.5.3 Reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#56-gperftoolsgperftools"><span class="nav-text"> 5.6 gperftools&#x2F;gperftools</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#57-snappy"><span class="nav-text"> 5.7 snappy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#58-breakpad"><span class="nav-text"> 5.8 breakpad</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#59-protobuf"><span class="nav-text"> 5.9 protobuf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#510-leveldb"><span class="nav-text"> 5.10 leveldb</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-apache"><span class="nav-text"> 6 Apache</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#61-arrow"><span class="nav-text"> 6.1 arrow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#611-parquet-module"><span class="nav-text"> 6.1.1 Parquet Module</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#62-thrift"><span class="nav-text"> 6.2 thrift</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#63-brpc"><span class="nav-text"> 6.3 brpc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#631-faq"><span class="nav-text"> 6.3.1 FAQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#632-reference"><span class="nav-text"> 6.3.2 Reference</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-jni"><span class="nav-text"> 7 JNI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#71-example"><span class="nav-text"> 7.1 Example</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#711-hello-world"><span class="nav-text"> 7.1.1 Hello World</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#712-memory-leak"><span class="nav-text"> 7.1.2 Memory Leak</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#713-work-with-spring-fat-jar"><span class="nav-text"> 7.1.3 Work With Spring fat-jar</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#72-libhdfs"><span class="nav-text"> 7.2 libhdfs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#73-best-practice"><span class="nav-text"> 7.3 Best Practice</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#74-tips"><span class="nav-text"> 7.4 Tips</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#741-tricky-jvm-options"><span class="nav-text"> 7.4.1 Tricky JVM options</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#742-gc-vs-signal-sigsegv"><span class="nav-text"> 7.4.2 GC vs. signal SIGSEGV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#743-how-to-add-jar-directory-to-classpah"><span class="nav-text"> 7.4.3 How to add jar directory to classpah</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#75-faq"><span class="nav-text"> 7.5 FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#751-javalangillegalmonitorstateexception"><span class="nav-text"> 7.5.1 java.lang.IllegalMonitorStateException</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-independent-projects"><span class="nav-text"> 8 Independent Projects</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#81-pocoproject"><span class="nav-text"> 8.1 Pocoproject</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#811-logger"><span class="nav-text"> 8.1.1 Logger</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8111-colorful-output"><span class="nav-text"> 8.1.1.1 Colorful Output</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#812-json"><span class="nav-text"> 8.1.2 JSON</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#813-http"><span class="nav-text"> 8.1.3 Http</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#814-application"><span class="nav-text"> 8.1.4 Application</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#815-foundation"><span class="nav-text"> 8.1.5 Foundation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8151-md5"><span class="nav-text"> 8.1.5.1 MD5</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#82-sqlpp11"><span class="nav-text"> 8.2 sqlpp11</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#821-with-sqlite"><span class="nav-text"> 8.2.1 With Sqlite</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#822-with-mysql"><span class="nav-text"> 8.2.2 With Mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#823-with-mariadb"><span class="nav-text"> 8.2.3 With Mariadb</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#83-libcurl"><span class="nav-text"> 8.3 libcurl</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-assorted"><span class="nav-text"> 9 Assorted</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Liuyehcf"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Liuyehcf</p>
  <div class="site-description" itemprop="description">大音希声，大象无形</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">285</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liuyehcf</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'qhEhLuMeMOy1zgcBhkqUS6P8-gzGzoHsz',
      appKey     : 'uhkruDLNLNdL5rQjRBY2X9Ke',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
